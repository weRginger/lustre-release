cscope 15 /home/build/lustre-release/lustre/ldlm               0000414586
	@interval_tree.c

43 #ifde‡
__KERNEL__


44 
	~<lu°ª_dlm.h
>

46 
	~<libcfs/libcfs.h
>

48 
	~<öãrvÆ_åì.h
>

51 
	mINTERVAL_RED
 = 0,

52 
	mINTERVAL_BLACK
 = 1

55 
ölöe
 
	$node_is_À·_chûd
(
öãrvÆ_node
 *
node
)

57 
	`LASSERT
(
node
->
ö_∑ª¡
 !
NULL
);

58  
node
 =node->
ö_∑ª¡
->
ö_À·
;

59 
	}
}

61 
ölöe
 
	$node_is_right_chûd
(
öãrvÆ_node
 *
node
)

63 
	`LASSERT
(
node
->
ö_∑ª¡
 !
NULL
);

64  
node
 =node->
ö_∑ª¡
->
ö_right
;

65 
	}
}

67 
ölöe
 
	$node_is_ªd
(
öãrvÆ_node
 *
node
)

69  
node
->
ö_cﬁ‹
 =
INTERVAL_RED
;

70 
	}
}

72 
ölöe
 
	$node_is_bœck
(
öãrvÆ_node
 *
node
)

74  
node
->
ö_cﬁ‹
 =
INTERVAL_BLACK
;

75 
	}
}

77 
ölöe
 
	$exã¡_com∑ª
(
öãrvÆ_node_exã¡
 *
e1
,

78 
öãrvÆ_node_exã¡
 *
e2
)

80 
rc
;

81 i‡(
e1
->
°¨t
 =
e2
->start) {

82 i‡(
e1
->
íd
 < 
e2
->end)

83 
rc
 = -1;

84 i‡(
e1
->
íd
 > 
e2
->end)

85 
rc
 = 1;

87 
rc
 = 0;

89 i‡(
e1
->
°¨t
 < 
e2
->start)

90 
rc
 = -1;

92 
rc
 = 1;

94  
rc
;

95 
	}
}

97 
ölöe
 
	$exã¡_equÆ
(
öãrvÆ_node_exã¡
 *
e1
,

98 
öãrvÆ_node_exã¡
 *
e2
)

100  (
e1
->
°¨t
 =
e2
->°¨tË&& (e1->
íd
 ==É2->end);

101 
	}
}

103 
ölöe
 
	$exã¡_ovîœµed
(
öãrvÆ_node_exã¡
 *
e1
,

104 
öãrvÆ_node_exã¡
 *
e2
)

106  (
e1
->
°¨t
 <
e2
->
íd
) && (e2->start <=É1->end);

107 
	}
}

109 
ölöe
 
	$node_com∑ª
(
öãrvÆ_node
 *
n1
,

110 
öãrvÆ_node
 *
n2
)

112  
	`exã¡_com∑ª
(&
n1
->
ö_exã¡
, &
n2
->in_extent);

113 
	}
}

115 
	$node_equÆ
(
öãrvÆ_node
 *
n1
, öãrvÆ_nodê*
n2
)

117  
	`exã¡_equÆ
(&
n1
->
ö_exã¡
, &
n2
->in_extent);

118 
	}
}

120 
ölöe
 
__u64
 
	$max_u64
(
__u64
 
x
, __u64 
y
)

122  
x
 > 
y
 ? x : y;

123 
	}
}

125 
ölöe
 
__u64
 
	$mö_u64
(
__u64
 
x
, __u64 
y
)

127  
x
 < 
y
 ? x : y;

128 
	}
}

130 
	#öãrvÆ_f‹_óch
(
node
, 
roŸ
) \

131 
node
 = 
	`öãrvÆ_fú°
(
roŸ
);Çodê!
NULL
; \

132 
node
 = 
	`öãrvÆ_√xt
“ode))

	)

134 
	#öãrvÆ_f‹_óch_ªvî£
(
node
, 
roŸ
) \

135 
node
 = 
	`öãrvÆ_œ°
(
roŸ
);Çodê!
NULL
; \

136 
node
 = 
	`öãrvÆ_¥ev
“ode))

	)

138 
öãrvÆ_node
 *
	$öãrvÆ_fú°
(
öãrvÆ_node
 *
node
)

140 
ENTRY
;

142 i‡(!
node
)

143 
	`RETURN
(
NULL
);

144 
node
->
ö_À·
)

145 
node
 =Çode->
ö_À·
;

146 
	`RETURN
(
node
);

147 
	}
}

149 
öãrvÆ_node
 *
	$öãrvÆ_œ°
(
öãrvÆ_node
 *
node
)

151 
ENTRY
;

153 i‡(!
node
)

154 
	`RETURN
(
NULL
);

155 
node
->
ö_right
)

156 
node
 =Çode->
ö_right
;

157 
	`RETURN
(
node
);

158 
	}
}

160 
öãrvÆ_node
 *
	$öãrvÆ_√xt
(
öãrvÆ_node
 *
node
)

162 
ENTRY
;

164 i‡(!
node
)

165 
	`RETURN
(
NULL
);

166 i‡(
node
->
ö_right
)

167 
	`RETURN
(
	`öãrvÆ_fú°
(
node
->
ö_right
));

168 
node
->
ö_∑ª¡
 && 
	`node_is_right_chûd
(node))

169 
node
 =Çode->
ö_∑ª¡
;

170 
	`RETURN
(
node
->
ö_∑ª¡
);

171 
	}
}

173 
öãrvÆ_node
 *
	$öãrvÆ_¥ev
(
öãrvÆ_node
 *
node
)

175 
ENTRY
;

177 i‡(!
node
)

178 
	`RETURN
(
NULL
);

180 i‡(
node
->
ö_À·
)

181 
	`RETURN
(
	`öãrvÆ_œ°
(
node
->
ö_À·
));

183 
node
->
ö_∑ª¡
 && 
	`node_is_À·_chûd
(node))

184 
node
 =Çode->
ö_∑ª¡
;

186 
	`RETURN
(
node
->
ö_∑ª¡
);

187 
	}
}

189 
öãrvÆ_ôî
 
	$öãrvÆ_ôî©e
(
öãrvÆ_node
 *
roŸ
,

190 
öãrvÆ_ˇŒback_t
 
func
,

191 *
d©a
)

193 
öãrvÆ_node
 *
node
;

194 
öãrvÆ_ôî
 
rc
 = 
INTERVAL_ITER_CONT
;

195 
ENTRY
;

197 
	`öãrvÆ_f‹_óch
(
node
, 
roŸ
) {

198 
rc
 = 
	`func
(
node
, 
d©a
);

199 i‡(
rc
 =
INTERVAL_ITER_STOP
)

203 
	`RETURN
(
rc
);

204 
	}
}

205 
EXPORT_SYMBOL
(
öãrvÆ_ôî©e
);

207 
öãrvÆ_ôî
 
	$öãrvÆ_ôî©e_ªvî£
(
öãrvÆ_node
 *
roŸ
,

208 
öãrvÆ_ˇŒback_t
 
func
,

209 *
d©a
)

211 
öãrvÆ_node
 *
node
;

212 
öãrvÆ_ôî
 
rc
 = 
INTERVAL_ITER_CONT
;

213 
ENTRY
;

215 
	`öãrvÆ_f‹_óch_ªvî£
(
node
, 
roŸ
) {

216 
rc
 = 
	`func
(
node
, 
d©a
);

217 i‡(
rc
 =
INTERVAL_ITER_STOP
)

221 
	`RETURN
(
rc
);

222 
	}
}

223 
EXPORT_SYMBOL
(
öãrvÆ_ôî©e_ªvî£
);

227 
öãrvÆ_node
 *
	$öãrvÆ_föd
(
öãrvÆ_node
 *
roŸ
,

228 
öãrvÆ_node_exã¡
 *
ex
)

230 
öãrvÆ_node
 *
wÆk
 = 
roŸ
;

231 
rc
;

232 
ENTRY
;

234 
wÆk
) {

235 
rc
 = 
	`exã¡_com∑ª
(
ex
, &
wÆk
->
ö_exã¡
);

236 i‡(
rc
 == 0)

238 i‡(
rc
 < 0)

239 
wÆk
 = wÆk->
ö_À·
;

241 
wÆk
 = wÆk->
ö_right
;

244 
	`RETURN
(
wÆk
);

245 
	}
}

246 
EXPORT_SYMBOL
(
öãrvÆ_föd
);

248 
	$__rŸ©e_ch™ge_maxhigh
(
öãrvÆ_node
 *
node
,

249 
öãrvÆ_node
 *
rŸ©e
)

251 
__u64
 
À·_max
, 
right_max
;

253 
rŸ©e
->
ö_max_high
 = 
node
->in_max_high;

254 
À·_max
 = 
node
->
ö_À·
 ?Çode->ö_À·->
ö_max_high
 : 0;

255 
right_max
 = 
node
->
ö_right
 ?Çode->ö_right->
ö_max_high
 : 0;

256 
node
->
ö_max_high
 = 
	`max_u64
(
	`öãrvÆ_high
(node),

257 
	`max_u64
(
À·_max
,
right_max
));

258 
	}
}

263 
	$__rŸ©e_À·
(
öãrvÆ_node
 *
node
,

264 
öãrvÆ_node
 **
roŸ
)

266 
öãrvÆ_node
 *
right
 = 
node
->
ö_right
;

267 
öãrvÆ_node
 *
∑ª¡
 = 
node
->
ö_∑ª¡
;

269 
node
->
ö_right
 = 
right
->
ö_À·
;

270 i‡(
node
->
ö_right
)

271 
right
->
ö_À·
->
ö_∑ª¡
 = 
node
;

273 
right
->
ö_À·
 = 
node
;

274 
right
->
ö_∑ª¡
 = 
∑ª¡
;

275 i‡(
∑ª¡
) {

276 i‡(
	`node_is_À·_chûd
(
node
))

277 
∑ª¡
->
ö_À·
 = 
right
;

279 
∑ª¡
->
ö_right
 = 
right
;

281 *
roŸ
 = 
right
;

283 
node
->
ö_∑ª¡
 = 
right
;

286 
	`__rŸ©e_ch™ge_maxhigh
(
node
, 
right
);

287 
	}
}

292 
	$__rŸ©e_right
(
öãrvÆ_node
 *
node
,

293 
öãrvÆ_node
 **
roŸ
)

295 
öãrvÆ_node
 *
À·
 = 
node
->
ö_À·
;

296 
öãrvÆ_node
 *
∑ª¡
 = 
node
->
ö_∑ª¡
;

298 
node
->
ö_À·
 = 
À·
->
ö_right
;

299 i‡(
node
->
ö_À·
)

300 
À·
->
ö_right
->
ö_∑ª¡
 = 
node
;

301 
À·
->
ö_right
 = 
node
;

303 
À·
->
ö_∑ª¡
 = 
∑ª¡
;

304 i‡(
∑ª¡
) {

305 i‡(
	`node_is_right_chûd
(
node
))

306 
∑ª¡
->
ö_right
 = 
À·
;

308 
∑ª¡
->
ö_À·
 = 
À·
;

310 *
roŸ
 = 
À·
;

312 
node
->
ö_∑ª¡
 = 
À·
;

315 
	`__rŸ©e_ch™ge_maxhigh
(
node
, 
À·
);

316 
	}
}

318 
	#öãrvÆ_sw≠
(
a
, 
b
) do { \

319 
öãrvÆ_node
 *
c
 = 
a
;á = 
b
; b = c; \

320 } 0)

	)

329 
	$öãrvÆ_ö£π_cﬁ‹
(
öãrvÆ_node
 *
node
,

330 
öãrvÆ_node
 **
roŸ
)

332 
öãrvÆ_node
 *
∑ª¡
, *
g∑ª¡
;

333 
ENTRY
;

335 (
∑ª¡
 = 
node
->
ö_∑ª¡
Ë&& 
	`node_is_ªd
(parent)) {

336 
g∑ª¡
 = 
∑ª¡
->
ö_∑ª¡
;

338 i‡(
	`node_is_À·_chûd
(
∑ª¡
)) {

339 
öãrvÆ_node
 *
un˛e
;

340 
un˛e
 = 
g∑ª¡
->
ö_right
;

341 i‡(
un˛e
 && 
	`node_is_ªd
(uncle)) {

342 
un˛e
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

343 
∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

344 
g∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_RED
;

345 
node
 = 
g∑ª¡
;

349 i‡(
∑ª¡
->
ö_right
 =
node
) {

350 
	`__rŸ©e_À·
(
∑ª¡
, 
roŸ
);

351 
	`öãrvÆ_sw≠
(
node
, 
∑ª¡
);

354 
∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

355 
g∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_RED
;

356 
	`__rŸ©e_right
(
g∑ª¡
, 
roŸ
);

358 
öãrvÆ_node
 *
un˛e
;

359 
un˛e
 = 
g∑ª¡
->
ö_À·
;

360 i‡(
un˛e
 && 
	`node_is_ªd
(uncle)) {

361 
un˛e
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

362 
∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

363 
g∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_RED
;

364 
node
 = 
g∑ª¡
;

368 i‡(
	`node_is_À·_chûd
(
node
)) {

369 
	`__rŸ©e_right
(
∑ª¡
, 
roŸ
);

370 
	`öãrvÆ_sw≠
(
node
, 
∑ª¡
);

373 
∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

374 
g∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_RED
;

375 
	`__rŸ©e_À·
(
g∑ª¡
, 
roŸ
);

379 (*
roŸ
)->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

380 
EXIT
;

381 
	}
}

383 
öãrvÆ_node
 *
	$öãrvÆ_ö£π
(
öãrvÆ_node
 *
node
,

384 
öãrvÆ_node
 **
roŸ
)

387 
öãrvÆ_node
 **
p
, *
∑ª¡
 = 
NULL
;

388 
ENTRY
;

390 
	`LASSERT
(!
	`öãrvÆ_is_öåì
(
node
));

391 
p
 = 
roŸ
;

392 *
p
) {

393 
∑ª¡
 = *
p
;

394 i‡(
	`node_equÆ
(
∑ª¡
, 
node
))

395 
	`RETURN
(
∑ª¡
);

398 i‡(
∑ª¡
->
ö_max_high
 < 
	`öãrvÆ_high
(
node
))

399 
∑ª¡
->
ö_max_high
 = 
	`öãrvÆ_high
(
node
);

401 i‡(
	`node_com∑ª
(
node
, 
∑ª¡
) < 0)

402 
p
 = &
∑ª¡
->
ö_À·
;

404 
p
 = &
∑ª¡
->
ö_right
;

408 
node
->
ö_∑ª¡
 = 
∑ª¡
;

409 
node
->
ö_cﬁ‹
 = 
INTERVAL_RED
;

410 
node
->
ö_À·
 =Çode->
ö_right
 = 
NULL
;

411 *
p
 = 
node
;

413 
	`öãrvÆ_ö£π_cﬁ‹
(
node
, 
roŸ
);

414 
node
->
ö_öåì
 = 1;

416 
	`RETURN
(
NULL
);

417 
	}
}

418 
EXPORT_SYMBOL
(
öãrvÆ_ö£π
);

420 
ölöe
 
	$node_is_bœck_‹_0
(
öãrvÆ_node
 *
node
)

422  !
node
 || 
	`node_is_bœck
(node);

423 
	}
}

425 
	$öãrvÆ_îa£_cﬁ‹
(
öãrvÆ_node
 *
node
,

426 
öãrvÆ_node
 *
∑ª¡
,

427 
öãrvÆ_node
 **
roŸ
)

429 
öãrvÆ_node
 *
tmp
;

430 
ENTRY
;

432 
	`node_is_bœck_‹_0
(
node
Ë&&Çodê!*
roŸ
) {

433 i‡(
∑ª¡
->
ö_À·
 =
node
) {

434 
tmp
 = 
∑ª¡
->
ö_right
;

435 i‡(
	`node_is_ªd
(
tmp
)) {

436 
tmp
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

437 
∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_RED
;

438 
	`__rŸ©e_À·
(
∑ª¡
, 
roŸ
);

439 
tmp
 = 
∑ª¡
->
ö_right
;

441 i‡(
	`node_is_bœck_‹_0
(
tmp
->
ö_À·
) &&

442 
	`node_is_bœck_‹_0
(
tmp
->
ö_right
)) {

443 
tmp
->
ö_cﬁ‹
 = 
INTERVAL_RED
;

444 
node
 = 
∑ª¡
;

445 
∑ª¡
 = 
node
->
ö_∑ª¡
;

447 i‡(
	`node_is_bœck_‹_0
(
tmp
->
ö_right
)) {

448 
öãrvÆ_node
 *
o_À·
;

449 i‡((
o_À·
 = 
tmp
->
ö_À·
))

450 
o_À·
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

451 
tmp
->
ö_cﬁ‹
 = 
INTERVAL_RED
;

452 
	`__rŸ©e_right
(
tmp
, 
roŸ
);

453 
tmp
 = 
∑ª¡
->
ö_right
;

455 
tmp
->
ö_cﬁ‹
 = 
∑ª¡
->in_color;

456 
∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

457 i‡(
tmp
->
ö_right
)

458 
tmp
->
ö_right
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

459 
	`__rŸ©e_À·
(
∑ª¡
, 
roŸ
);

460 
node
 = *
roŸ
;

464 
tmp
 = 
∑ª¡
->
ö_À·
;

465 i‡(
	`node_is_ªd
(
tmp
)) {

466 
tmp
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

467 
∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_RED
;

468 
	`__rŸ©e_right
(
∑ª¡
, 
roŸ
);

469 
tmp
 = 
∑ª¡
->
ö_À·
;

471 i‡(
	`node_is_bœck_‹_0
(
tmp
->
ö_À·
) &&

472 
	`node_is_bœck_‹_0
(
tmp
->
ö_right
)) {

473 
tmp
->
ö_cﬁ‹
 = 
INTERVAL_RED
;

474 
node
 = 
∑ª¡
;

475 
∑ª¡
 = 
node
->
ö_∑ª¡
;

477 i‡(
	`node_is_bœck_‹_0
(
tmp
->
ö_À·
)) {

478 
öãrvÆ_node
 *
o_right
;

479 i‡((
o_right
 = 
tmp
->
ö_right
))

480 
o_right
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

481 
tmp
->
ö_cﬁ‹
 = 
INTERVAL_RED
;

482 
	`__rŸ©e_À·
(
tmp
, 
roŸ
);

483 
tmp
 = 
∑ª¡
->
ö_À·
;

485 
tmp
->
ö_cﬁ‹
 = 
∑ª¡
->in_color;

486 
∑ª¡
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

487 i‡(
tmp
->
ö_À·
)

488 
tmp
->
ö_À·
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

489 
	`__rŸ©e_right
(
∑ª¡
, 
roŸ
);

490 
node
 = *
roŸ
;

495 i‡(
node
)

496 
node
->
ö_cﬁ‹
 = 
INTERVAL_BLACK
;

497 
EXIT
;

498 
	}
}

504 
	$upd©e_maxhigh
(
öãrvÆ_node
 *
node
,

505 
__u64
 
ﬁd_maxhigh
)

507 
__u64
 
À·_max
, 
right_max
;

508 
ENTRY
;

510 
node
) {

511 
À·_max
 = 
node
->
ö_À·
 ?Çode->ö_À·->
ö_max_high
 : 0;

512 
right_max
 = 
node
->
ö_right
 ?Çode->ö_right->
ö_max_high
 : 0;

513 
node
->
ö_max_high
 = 
	`max_u64
(
	`öãrvÆ_high
(node),

514 
	`max_u64
(
À·_max
, 
right_max
));

516 i‡(
node
->
ö_max_high
 >
ﬁd_maxhigh
)

518 
node
 =Çode->
ö_∑ª¡
;

520 
EXIT
;

521 
	}
}

523 
	$öãrvÆ_îa£
(
öãrvÆ_node
 *
node
,

524 
öãrvÆ_node
 **
roŸ
)

526 
öãrvÆ_node
 *
chûd
, *
∑ª¡
;

527 
cﬁ‹
;

528 
ENTRY
;

530 
	`LASSERT
(
	`öãrvÆ_is_öåì
(
node
));

531 
node
->
ö_öåì
 = 0;

532 i‡(!
node
->
ö_À·
) {

533 
chûd
 = 
node
->
ö_right
;

534 } i‡(!
node
->
ö_right
) {

535 
chûd
 = 
node
->
ö_À·
;

537 
öãrvÆ_node
 *
ﬁd
 = 
node
;

539 
node
 = 
	`öãrvÆ_√xt
(node);

540 
chûd
 = 
node
->
ö_right
;

541 
∑ª¡
 = 
node
->
ö_∑ª¡
;

542 
cﬁ‹
 = 
node
->
ö_cﬁ‹
;

544 i‡(
chûd
)

545 
chûd
->
ö_∑ª¡
 = 
∑ª¡
;

546 i‡(
∑ª¡
 =
ﬁd
)

547 
∑ª¡
->
ö_right
 = 
chûd
;

549 
∑ª¡
->
ö_À·
 = 
chûd
;

551 
node
->
ö_cﬁ‹
 = 
ﬁd
->in_color;

552 
node
->
ö_right
 = 
ﬁd
->in_right;

553 
node
->
ö_À·
 = 
ﬁd
->in_left;

554 
node
->
ö_∑ª¡
 = 
ﬁd
->in_parent;

556 i‡(
ﬁd
->
ö_∑ª¡
) {

557 i‡(
	`node_is_À·_chûd
(
ﬁd
))

558 
ﬁd
->
ö_∑ª¡
->
ö_À·
 = 
node
;

560 
ﬁd
->
ö_∑ª¡
->
ö_right
 = 
node
;

562 *
roŸ
 = 
node
;

565 
ﬁd
->
ö_À·
->
ö_∑ª¡
 = 
node
;

566 i‡(
ﬁd
->
ö_right
)

567 
ﬁd
->
ö_right
->
ö_∑ª¡
 = 
node
;

568 
	`upd©e_maxhigh
(
chûd
 ? : 
∑ª¡
, 
node
->
ö_max_high
);

569 
	`upd©e_maxhigh
(
node
, 
ﬁd
->
ö_max_high
);

570 i‡(
∑ª¡
 =
ﬁd
)

571 
∑ª¡
 = 
node
;

572 
cﬁ‹
;

574 
∑ª¡
 = 
node
->
ö_∑ª¡
;

575 
cﬁ‹
 = 
node
->
ö_cﬁ‹
;

577 i‡(
chûd
)

578 
chûd
->
ö_∑ª¡
 = 
∑ª¡
;

579 i‡(
∑ª¡
) {

580 i‡(
	`node_is_À·_chûd
(
node
))

581 
∑ª¡
->
ö_À·
 = 
chûd
;

583 
∑ª¡
->
ö_right
 = 
chûd
;

585 *
roŸ
 = 
chûd
;

588 
	`upd©e_maxhigh
(
chûd
 ? : 
∑ª¡
, 
node
->
ö_max_high
);

590 
cﬁ‹
:

591 i‡(
cﬁ‹
 =
INTERVAL_BLACK
)

592 
	`öãrvÆ_îa£_cﬁ‹
(
chûd
, 
∑ª¡
, 
roŸ
);

593 
EXIT
;

594 
	}
}

595 
EXPORT_SYMBOL
(
öãrvÆ_îa£
);

597 
ölöe
 
	$öãrvÆ_may_ovîœp
(
öãrvÆ_node
 *
node
,

598 
öãrvÆ_node_exã¡
 *
ext
)

600  (
ext
->
°¨t
 <
node
->
ö_max_high
 &&

601 
ext
->
íd
 >
	`öãrvÆ_low
(
node
));

602 
	}
}

625 
öãrvÆ_ôî
 
	$öãrvÆ_£¨ch
(
öãrvÆ_node
 *
node
,

626 
öãrvÆ_node_exã¡
 *
ext
,

627 
öãrvÆ_ˇŒback_t
 
func
,

628 *
d©a
)

630 
öãrvÆ_node
 *
∑ª¡
;

631 
öãrvÆ_ôî
 
rc
 = 
INTERVAL_ITER_CONT
;

633 
ENTRY
;

635 
	`LASSERT
(
ext
 !
NULL
);

636 
	`LASSERT
(
func
 !
NULL
);

638 
node
) {

639 i‡(
ext
->
íd
 < 
	`öãrvÆ_low
(
node
)) {

640 i‡(
node
->
ö_À·
) {

641 
node
 =Çode->
ö_À·
;

644 } i‡(
	`öãrvÆ_may_ovîœp
(
node
, 
ext
)) {

645 i‡(
	`exã¡_ovîœµed
(
ext
, &
node
->
ö_exã¡
)) {

646 
rc
 = 
	`func
(
node
, 
d©a
);

647 i‡(
rc
 =
INTERVAL_ITER_STOP
)

651 i‡(
node
->
ö_À·
) {

652 
node
 =Çode->
ö_À·
;

655 i‡(
node
->
ö_right
) {

656 
node
 =Çode->
ö_right
;

661 
∑ª¡
 = 
node
->
ö_∑ª¡
;

662 
∑ª¡
) {

663 i‡(
	`node_is_À·_chûd
(
node
) &&

664 
∑ª¡
->
ö_right
) {

670 
node
 = 
∑ª¡
->
ö_right
;

673 
node
 = 
∑ª¡
;

674 
∑ª¡
 =Ö¨ít->
ö_∑ª¡
;

676 i‡(
∑ª¡
 =
NULL
 || !
	`öãrvÆ_may_ovîœp
’¨ít, 
ext
))

680 
	`RETURN
(
rc
);

681 
	}
}

682 
EXPORT_SYMBOL
(
öãrvÆ_£¨ch
);

684 
öãrvÆ_ôî
 
	$öãrvÆ_ovîœp_cb
(
öãrvÆ_node
 *
n
,

685 *
¨gs
)

687 *(*)
¨gs
 = 1;

688  
INTERVAL_ITER_STOP
;

689 
	}
}

691 
	$öãrvÆ_is_ovîœµed
(
öãrvÆ_node
 *
roŸ
,

692 
öãrvÆ_node_exã¡
 *
ext
)

694 
has
 = 0;

695 ()
	`öãrvÆ_£¨ch
(
roŸ
, 
ext
, 
öãrvÆ_ovîœp_cb
, &
has
);

696  
has
;

697 
	}
}

698 
EXPORT_SYMBOL
(
öãrvÆ_is_ovîœµed
);

729 
ölöe
 
__u64
 
	$öãrvÆ_ex∑nd_low
(
öãrvÆ_node
 *
roŸ
, 
__u64
 
low
)

732 i‡(
roŸ
 =
NULL
)

734  
low
;

735 
	}
}

737 
ölöe
 
__u64
 
	$öãrvÆ_ex∑nd_high
(
öãrvÆ_node
 *
node
, 
__u64
 
high
)

739 
__u64
 
ªsu…
 = ~0;

741 
node
 !
NULL
) {

742 i‡(
node
->
ö_max_high
 < 
high
)

745 i‡(
	`öãrvÆ_low
(
node
Ë> 
high
) {

746 
ªsu…
 = 
	`öãrvÆ_low
(
node
) - 1;

747 
node
 =Çode->
ö_À·
;

749 
node
 =Çode->
ö_right
;

753  
ªsu…
;

754 
	}
}

757 
	$öãrvÆ_ex∑nd
(
öãrvÆ_node
 *
roŸ
,

758 
öãrvÆ_node_exã¡
 *
ext
,

759 
öãrvÆ_node_exã¡
 *
limôî
)

763 
	`LASSERT
(
	`öãrvÆ_is_ovîœµed
(
roŸ
, 
ext
) == 0);

764 i‡(!
limôî
 ||Üimôî->
°¨t
 < 
ext
->start)

765 
ext
->
°¨t
 = 
	`öãrvÆ_ex∑nd_low
(
roŸ
,Éxt->start);

766 i‡(!
limôî
 ||Üimôî->
íd
 > 
ext
->end)

767 
ext
->
íd
 = 
	`öãrvÆ_ex∑nd_high
(
roŸ
,Éxt->end);

768 
	`LASSERT
(
	`öãrvÆ_is_ovîœµed
(
roŸ
, 
ext
) == 0);

769 
	}
}

	@l_lock.c

37 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

38 
	~<libcfs/libcfs.h
>

40 
	~<lu°ª_dlm.h
>

41 
	~<lu°ª_lib.h
>

51 
ldlm_ªsour˚
 *
	$lock_ªs_™d_lock
(
ldlm_lock
 *
lock
)

54 i‡(!
	`ldlm_is_ns_§v
(
lock
))

55 
	`•ö_lock
(&
lock
->
l_lock
);

57 
	`lock_ªs
(
lock
->
l_ªsour˚
);

59 
	`ldlm_£t_ªs_locked
(
lock
);

60  
lock
->
l_ªsour˚
;

61 
	}
}

62 
EXPORT_SYMBOL
(
lock_ªs_™d_lock
);

67 
	$u∆ock_ªs_™d_lock
(
ldlm_lock
 *
lock
)

70 
	`ldlm_˛ór_ªs_locked
(
lock
);

72 
	`u∆ock_ªs
(
lock
->
l_ªsour˚
);

73 i‡(!
	`ldlm_is_ns_§v
(
lock
))

74 
	`•ö_u∆ock
(&
lock
->
l_lock
);

75 
	}
}

76 
EXPORT_SYMBOL
(
u∆ock_ªs_™d_lock
);

	@ldlm_extent.c

52 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

54 
	~<libcfs/libcfs.h
>

55 
	~<lu°ª_dlm.h
>

56 
	~<obd_suµ‹t.h
>

57 
	~<obd.h
>

58 
	~<obd_˛ass.h
>

59 
	~<lu°ª_lib.h
>

61 
	~"ldlm_öã∫Æ.h
"

63 #ifde‡
HAVE_SERVER_SUPPORT


64 
	#LDLM_MAX_GROWN_EXTENT
 (32 * 1024 * 1024 - 1)

	)

73 
	$ldlm_exã¡_öã∫Æ_pﬁicy_fixup
(
ldlm_lock
 *
ªq
,

74 
ldlm_exã¡
 *
√w_ex
,

75 
c⁄Êi˘ög
)

77 
ldlm_mode
 
ªq_mode
 = 
ªq
->
l_ªq_mode
;

78 
__u64
 
ªq_°¨t
 = 
ªq
->
l_ªq_exã¡
.
°¨t
;

79 
__u64
 
ªq_íd
 = 
ªq
->
l_ªq_exã¡
.
íd
;

80 
__u64
 
ªq_Æign
, 
mask
;

82 i‡(
c⁄Êi˘ög
 > 32 && (
ªq_mode
 =
LCK_PW
 ||Ñeq_modê=
LCK_CW
)) {

83 i‡(
ªq_íd
 < 
ªq_°¨t
 + 
LDLM_MAX_GROWN_EXTENT
)

84 
√w_ex
->
íd
 = 
	`mö
(
ªq_°¨t
 + 
LDLM_MAX_GROWN_EXTENT
,

85 
√w_ex
->
íd
);

88 i‡(
√w_ex
->
°¨t
 =0 &&Çew_ex->
íd
 =
OBD_OBJECT_EOF
) {

89 
EXIT
;

97 
mask
 = 
PAGE_CACHE_SIZE
;

98 
ªq_Æign
 = (
ªq_íd
 + 1Ë| 
ªq_°¨t
;

99 i‡(
ªq_Æign
 !0 && (ªq_Æig¿& (
mask
 - 1)) == 0) {

100 (
ªq_Æign
 & 
mask
) == 0)

101 
mask
 <<= 1;

103 
mask
 -= 1;

107 
√w_ex
->
°¨t
 = (“ew_ex->°¨à- 1Ë| 
mask
) + 1;

108 
√w_ex
->
íd
 = (“ew_ex->íd + 1Ë& ~
mask
) - 1;

109 
	`LASSERTF
(
√w_ex
->
°¨t
 <
ªq_°¨t
,

110 "mask "
LPX64
" gø¡ sèπ "
LPU64
"Ñeq start "LPU64"\n",

111 
mask
, 
√w_ex
->
°¨t
, 
ªq_°¨t
);

112 
	`LASSERTF
(
√w_ex
->
íd
 >
ªq_íd
,

113 "mask "
LPX64
" gø¡Énd "
LPU64
"ÑeqÉnd "LPU64"\n",

114 
mask
, 
√w_ex
->
íd
, 
ªq_íd
);

115 
	}
}

129 
	$ldlm_exã¡_öã∫Æ_pﬁicy_gø¡ed
(
ldlm_lock
 *
ªq
,

130 
ldlm_exã¡
 *
√w_ex
)

132 
ldlm_ªsour˚
 *
ªs
 = 
ªq
->
l_ªsour˚
;

133 
ldlm_mode
 
ªq_mode
 = 
ªq
->
l_ªq_mode
;

134 
__u64
 
ªq_°¨t
 = 
ªq
->
l_ªq_exã¡
.
°¨t
;

135 
__u64
 
ªq_íd
 = 
ªq
->
l_ªq_exã¡
.
íd
;

136 
ldlm_öãrvÆ_åì
 *
åì
;

137 
öãrvÆ_node_exã¡
 
limôî
 = { 
√w_ex
->
°¨t
,Çew_ex->
íd
 };

138 
c⁄Êi˘ög
 = 0;

139 
idx
;

140 
ENTRY
;

142 
	`lockmode_vîify
(
ªq_mode
);

145 
idx
 = 0; idx < 
LCK_MODE_NUM
; idx++) {

146 
öãrvÆ_node_exã¡
 
ext
 = { 
ªq_°¨t
, 
ªq_íd
 };

148 
åì
 = &
ªs
->
Ã_ôªe
[
idx
];

149 i‡(
	`lockmode_com∑t
(
åì
->
lô_mode
, 
ªq_mode
))

152 
c⁄Êi˘ög
 +
åì
->
lô_size
;

153 i‡(
c⁄Êi˘ög
 > 4)

154 
limôî
.
°¨t
 = 
ªq_°¨t
;

156 i‡(
	`öãrvÆ_is_ovîœµed
(
åì
->
lô_roŸ
, &
ext
))

157 
	`CDEBUG
(
D_INFO
,

160 
ªq_mode
, 
åì
->
lô_mode
,Åªe->
lô_size
);

161 
	`öãrvÆ_ex∑nd
(
åì
->
lô_roŸ
, &
ext
, &
limôî
);

162 
limôî
.
°¨t
 = 
	`max
÷imôî.°¨t, 
ext
.start);

163 
limôî
.
íd
 = 
	`mö
÷imôî.íd, 
ext
.end);

164 i‡(
limôî
.
°¨t
 =
ªq_°¨t
 &&Üimôî.
íd
 =
ªq_íd
)

168 
√w_ex
->
°¨t
 = 
limôî
.start;

169 
√w_ex
->
íd
 = 
limôî
.end;

170 
	`LASSERT
(
√w_ex
->
°¨t
 <
ªq_°¨t
);

171 
	`LASSERT
(
√w_ex
->
íd
 >
ªq_íd
);

173 
	`ldlm_exã¡_öã∫Æ_pﬁicy_fixup
(
ªq
, 
√w_ex
, 
c⁄Êi˘ög
);

174 
EXIT
;

175 
	}
}

183 
	$ldlm_exã¡_öã∫Æ_pﬁicy_waôög
(
ldlm_lock
 *
ªq
,

184 
ldlm_exã¡
 *
√w_ex
)

186 
ldlm_ªsour˚
 *
ªs
 = 
ªq
->
l_ªsour˚
;

187 
ldlm_mode
 
ªq_mode
 = 
ªq
->
l_ªq_mode
;

188 
__u64
 
ªq_°¨t
 = 
ªq
->
l_ªq_exã¡
.
°¨t
;

189 
__u64
 
ªq_íd
 = 
ªq
->
l_ªq_exã¡
.
íd
;

190 
ldlm_lock
 *
lock
;

191 
c⁄Êi˘ög
 = 0;

192 
ENTRY
;

194 
	`lockmode_vîify
(
ªq_mode
);

197 
	`li°_f‹_óch_íåy
(
lock
, &
ªs
->
Ã_waôög
, 
l_ªs_lök
) {

198 
ldlm_exã¡
 *
l_exã¡
 = &
lock
->
l_pﬁicy_d©a
.l_extent;

201 i‡(
√w_ex
->
°¨t
 =
ªq_°¨t
 &&Çew_ex->
íd
 =
ªq_íd
) {

202 
EXIT
;

207 i‡(
ªq
 =
lock
)

213 i‡(
	`lockmode_com∑t
(
lock
->
l_ªq_mode
, 
ªq_mode
) &&

214 
lock
->
l_exp‹t
 !
ªq
->l_export)

219 ++
c⁄Êi˘ög
;

220 i‡(
c⁄Êi˘ög
 > 4)

221 
√w_ex
->
°¨t
 = 
ªq_°¨t
;

224 i‡(!
	`ldlm_exã¡_ovîœp
(
l_exã¡
, 
√w_ex
))

231 i‡(
	`ldlm_exã¡_ovîœp
(&
lock
->
l_ªq_exã¡
,&
ªq
->l_req_extent))

239 i‡(
l_exã¡
->
°¨t
 < 
ªq_°¨t
 && 
√w_ex
->start !=Ñeq_start) {

240 i‡(
l_exã¡
->
íd
 >
ªq_°¨t
)

241 
√w_ex
->
°¨t
 = 
ªq_°¨t
;

243 
√w_ex
->
°¨t
 = 
	`mö
(
l_exã¡
->
íd
+1, 
ªq_°¨t
);

251 i‡(
l_exã¡
->
íd
 > 
ªq_íd
) {

252 i‡(
l_exã¡
->
°¨t
 <
ªq_íd
)

253 
√w_ex
->
íd
 = 
	`max
(
lock
->
l_ªq_exã¡
.
°¨t
 - 1,

254 
ªq_íd
);

256 
√w_ex
->
íd
 = 
	`max
(
l_exã¡
->
°¨t
 - 1, 
ªq_íd
);

260 
	`ldlm_exã¡_öã∫Æ_pﬁicy_fixup
(
ªq
, 
√w_ex
, 
c⁄Êi˘ög
);

261 
EXIT
;

262 
	}
}

267 
	$ldlm_exã¡_pﬁicy
(
ldlm_ªsour˚
 *
ªs
,

268 
ldlm_lock
 *
lock
, 
__u64
 *
Êags
)

270 
ldlm_exã¡
 
√w_ex
 = { .
°¨t
 = 0, .
íd
 = 
OBD_OBJECT_EOF
 };

272 i‡(
lock
->
l_exp‹t
 =
NULL
)

282 i‡(
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
°¨t
 == 0 &&

283 
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
íd
 =
OBD_OBJECT_EOF
)

287 
	`ldlm_exã¡_öã∫Æ_pﬁicy_gø¡ed
(
lock
, &
√w_ex
);

288 
	`ldlm_exã¡_öã∫Æ_pﬁicy_waôög
(
lock
, &
√w_ex
);

290 i‡(
√w_ex
.
°¨t
 !
lock
->
l_pﬁicy_d©a
.
l_exã¡
.start ||

291 
√w_ex
.
íd
 !
lock
->
l_pﬁicy_d©a
.
l_exã¡
.end) {

292 *
Êags
 |
LDLM_FL_LOCK_CHANGED
;

293 
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
°¨t
 = 
√w_ex
.start;

294 
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
íd
 = 
√w_ex
.end;

296 
	}
}

298 
	$ldlm_check_c⁄ã¡i⁄
(
ldlm_lock
 *
lock
, 
c⁄ãnded_locks
)

300 
ldlm_ªsour˚
 *
ªs
 = 
lock
->
l_ªsour˚
;

301 
cfs_time_t
 
now
 = 
	`cfs_time_cuºít
();

303 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_SET_CONTENTION
))

306 
	`CDEBUG
(
D_DLMTRACE
, "c⁄ãndedÜock†%d\n", 
c⁄ãnded_locks
);

307 i‡(
c⁄ãnded_locks
 > 
	`ldlm_ªs_to_ns
(
ªs
)->
ns_c⁄ãnded_locks
)

308 
ªs
->
Ã_c⁄ã¡i⁄_time
 = 
now
;

309  
	`cfs_time_bef‹e
(
now
, 
	`cfs_time_add
(
ªs
->
Ã_c⁄ã¡i⁄_time
,

310 
	`cfs_time_£c⁄ds
(
	`ldlm_ªs_to_ns
(
ªs
)->
ns_c⁄ã¡i⁄_time
)));

311 
	}
}

313 
	sldlm_exã¡_com∑t_¨gs
 {

314 
li°_hód
 *
	mw‹k_li°
;

315 
ldlm_lock
 *
	mlock
;

316 
ldlm_mode
 
	mmode
;

317 *
	mlocks
;

318 *
	mcom∑t
;

321 
öãrvÆ_ôî
 
	$ldlm_exã¡_com∑t_cb
(
öãrvÆ_node
 *
n
,

322 *
d©a
)

324 
ldlm_exã¡_com∑t_¨gs
 *
¥iv
 = 
d©a
;

325 
ldlm_öãrvÆ
 *
node
 = 
	`to_ldlm_öãrvÆ
(
n
);

326 
ldlm_exã¡
 *
exã¡
;

327 
li°_hód
 *
w‹k_li°
 = 
¥iv
->work_list;

328 
ldlm_lock
 *
lock
, *
íq
 = 
¥iv
->lock;

329 
ldlm_mode
 
mode
 = 
¥iv
->mode;

330 
cou¡
 = 0;

331 
ENTRY
;

333 
	`LASSERT
(!
	`li°_em±y
(&
node
->
li_group
));

335 
	`li°_f‹_óch_íåy
(
lock
, &
node
->
li_group
, 
l_¶_pﬁicy
) {

337 
	`LASSERTF
(
mode
 =
lock
->
l_gø¡ed_mode
,

339 
ldlm_lock«me
[
mode
],

340 
ldlm_lock«me
[
lock
->
l_gø¡ed_mode
]);

341 
cou¡
++;

342 i‡(
lock
->
l_blockög_a°
 &&

343 
lock
->
l_gø¡ed_mode
 !
LCK_GROUP
)

344 
	`ldlm_add_a°_w‹k_ôem
(
lock
, 
íq
, 
w‹k_li°
);

348 
exã¡
 = 
	`ldlm_öãrvÆ_exã¡
(
node
);

349 i‡(!(
mode
 =
LCK_PR
 &&

350 
exã¡
->
°¨t
 =0 &&Éxã¡->
íd
 =
OBD_OBJECT_EOF
))

351 *
¥iv
->
locks
 +
cou¡
;

353 i‡(
¥iv
->
com∑t
)

354 *
¥iv
->
com∑t
 = 0;

356 
	`RETURN
(
INTERVAL_ITER_CONT
);

357 
	}
}

372 
	$ldlm_exã¡_com∑t_queue
(
li°_hód
 *
queue
, 
ldlm_lock
 *
ªq
,

373 
__u64
 *
Êags
, 
ldlm_îr‹
 *
îr
,

374 
li°_hód
 *
w‹k_li°
, *
c⁄ãnded_locks
)

376 
ldlm_ªsour˚
 *
ªs
 = 
ªq
->
l_ªsour˚
;

377 
ldlm_mode
 
ªq_mode
 = 
ªq
->
l_ªq_mode
;

378 
__u64
 
ªq_°¨t
 = 
ªq
->
l_ªq_exã¡
.
°¨t
;

379 
__u64
 
ªq_íd
 = 
ªq
->
l_ªq_exã¡
.
íd
;

380 
ldlm_lock
 *
lock
;

381 
check_c⁄ã¡i⁄
;

382 
com∑t
 = 1;

383 
sˇn
 = 0;

384 
ENTRY
;

386 
	`lockmode_vîify
(
ªq_mode
);

389 i‡(
queue
 =&
ªs
->
Ã_gø¡ed
) {

390 
ldlm_öãrvÆ_åì
 *
åì
;

391 
ldlm_exã¡_com∑t_¨gs
 
d©a
 = {.
w‹k_li°
 = work_list,

392 .
lock
 = 
ªq
,

393 .
locks
 = 
c⁄ãnded_locks
,

394 .
com∑t
 = &compat };

395 
öãrvÆ_node_exã¡
 
ex
 = { .
°¨t
 = 
ªq_°¨t
,

396 .
íd
 = 
ªq_íd
 };

397 
idx
, 
rc
;

399 
idx
 = 0; idx < 
LCK_MODE_NUM
; idx++) {

400 
åì
 = &
ªs
->
Ã_ôªe
[
idx
];

401 i‡(
åì
->
lô_roŸ
 =
NULL
)

404 
d©a
.
mode
 = 
åì
->
lô_mode
;

405 i‡(
	`lockmode_com∑t
(
ªq_mode
, 
åì
->
lô_mode
)) {

406 
ldlm_öãrvÆ
 *
node
;

407 
ldlm_exã¡
 *
exã¡
;

409 i‡(
ªq_mode
 !
LCK_GROUP
)

414 
node
 = 
	`to_ldlm_öãrvÆ
(
åì
->
lô_roŸ
);

415 
exã¡
 = 
	`ldlm_öãrvÆ_exã¡
(
node
);

416 i‡(
ªq
->
l_pﬁicy_d©a
.
l_exã¡
.
gid
 ==

417 
exã¡
->
gid
)

418 
	`RETURN
(2);

421 i‡(
åì
->
lô_mode
 =
LCK_GROUP
) {

422 i‡(*
Êags
 & 
LDLM_FL_BLOCK_NOWAIT
) {

423 
com∑t
 = -
EWOULDBLOCK
;

424 
de°roylock
;

427 *
Êags
 |
LDLM_FL_NO_TIMEOUT
;

428 i‡(!
w‹k_li°
)

429 
	`RETURN
(0);

433 
com∑t
 = 0;

434 
	`öãrvÆ_ôî©e
(
åì
->
lô_roŸ
,

435 
ldlm_exã¡_com∑t_cb
, &
d©a
);

439 i‡(!
w‹k_li°
) {

440 
rc
 = 
	`öãrvÆ_is_ovîœµed
(
åì
->
lô_roŸ
,&
ex
);

441 i‡(
rc
)

442 
	`RETURN
(0);

444 
	`öãrvÆ_£¨ch
(
åì
->
lô_roŸ
, &
ex
,

445 
ldlm_exã¡_com∑t_cb
, &
d©a
);

446 i‡(!
	`li°_em±y
(
w‹k_li°
Ë&& 
com∑t
)

447 
com∑t
 = 0;

451 
	`li°_f‹_óch_íåy
(
lock
, 
queue
, 
l_ªs_lök
) {

452 
check_c⁄ã¡i⁄
 = 1;

457 i‡(
ªq
 =
lock
)

460 i‡(
	`u∆ikñy
(
sˇn
)) {

466 i‡(
lock
->
l_ªq_mode
 !
LCK_GROUP
) {

471 
	`ldlm_ªsour˚_ö£π_lock_a·î
(
lock
, 
ªq
);

472 
	`li°_dñ_öô
(&
lock
->
l_ªs_lök
);

473 
	`ldlm_ªsour˚_ö£π_lock_a·î
(
ªq
, 
lock
);

474 
com∑t
 = 0;

477 i‡(
ªq
->
l_pﬁicy_d©a
.
l_exã¡
.
gid
 ==

478 
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
gid
) {

480 
	`ldlm_ªsour˚_ö£π_lock_a·î
(
lock
, 
ªq
);

481 
com∑t
 = 0;

488 i‡(
	`lockmode_com∑t
(
lock
->
l_ªq_mode
, 
ªq_mode
)) {

489 i‡(
ªq_mode
 =
LCK_PR
 &&

490 ((
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
°¨t
 <=

491 
ªq
->
l_pﬁicy_d©a
.
l_exã¡
.
°¨t
) &&

492 (
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
íd
 >=

493 
ªq
->
l_pﬁicy_d©a
.
l_exã¡
.
íd
))) {

514 i‡(!
	`ldlm_is_a°_£¡
(
lock
))

515 
	`RETURN
(
com∑t
);

520 i‡(
	`likñy
(
ªq_mode
 !
LCK_GROUP
))

525 i‡(
ªq
->
l_pﬁicy_d©a
.
l_exã¡
.
gid
 ==

526 
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
gid
) {

529 i‡(
lock
->
l_ªq_mode
 =lock->
l_gø¡ed_mode
)

530 
	`RETURN
(2);

538 i‡(*
Êags
 & 
LDLM_FL_BLOCK_NOWAIT
) {

539 
com∑t
 = -
EWOULDBLOCK
;

540 
de°roylock
;

548 
	`ldlm_ªsour˚_ö£π_lock_a·î
(
lock
, 
ªq
);

553 
	`RETURN
(0);

557 i‡(
	`u∆ikñy
(
ªq_mode
 =
LCK_GROUP
 &&

558 (
lock
->
l_ªq_mode
 !lock->
l_gø¡ed_mode
))) {

559 
sˇn
 = 1;

560 
com∑t
 = 0;

561 i‡(
lock
->
l_ªq_mode
 !
LCK_GROUP
) {

566 
	`ldlm_ªsour˚_ö£π_lock_a·î
(
lock
, 
ªq
);

567 
	`li°_dñ_öô
(&
lock
->
l_ªs_lök
);

568 
	`ldlm_ªsour˚_ö£π_lock_a·î
(
ªq
, 
lock
);

571 i‡(
ªq
->
l_pﬁicy_d©a
.
l_exã¡
.
gid
 ==

572 
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
gid
) {

574 
	`ldlm_ªsour˚_ö£π_lock_a·î
(
lock
, 
ªq
);

580 i‡(
	`u∆ikñy
(
lock
->
l_ªq_mode
 =
LCK_GROUP
)) {

584 i‡(*
Êags
 & 
LDLM_FL_BLOCK_NOWAIT
) {

585 
com∑t
 = -
EWOULDBLOCK
;

586 
de°roylock
;

588 *
Êags
 |
LDLM_FL_NO_TIMEOUT
;

590 } i‡(
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
íd
 < 
ªq_°¨t
 ||

591 
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
°¨t
 > 
ªq_íd
) {

594 } i‡(
lock
->
l_ªq_exã¡
.
íd
 < 
ªq_°¨t
 ||

595 
lock
->
l_ªq_exã¡
.
°¨t
 > 
ªq_íd
) {

597 
check_c⁄ã¡i⁄
 = 0;

600 i‡(!
w‹k_li°
)

601 
	`RETURN
(0);

604 i‡(
lock
->
l_ªq_mode
 =
LCK_PR
 &&

605 
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
°¨t
 == 0 &&

606 
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
íd
 =
OBD_OBJECT_EOF
)

607 
check_c⁄ã¡i⁄
 = 0;

609 *
c⁄ãnded_locks
 +
check_c⁄ã¡i⁄
;

611 
com∑t
 = 0;

612 i‡(
lock
->
l_blockög_a°
 &&

613 
lock
->
l_ªq_mode
 !
LCK_GROUP
)

614 
	`ldlm_add_a°_w‹k_ôem
(
lock
, 
ªq
, 
w‹k_li°
);

618 i‡(
	`ldlm_check_c⁄ã¡i⁄
(
ªq
, *
c⁄ãnded_locks
) &&

619 
com∑t
 == 0 &&

620 (*
Êags
 & 
LDLM_FL_DENY_ON_CONTENTION
) &&

621 
ªq
->
l_ªq_mode
 !
LCK_GROUP
 &&

622 
ªq_íd
 - 
ªq_°¨t
 <=

623 
	`ldlm_ªs_to_ns
(
ªq
->
l_ªsour˚
)->
ns_max_nﬁock_size
)

624 
	`GOTO
(
de°roylock
, 
com∑t
 = -
EUSERS
);

626 
	`RETURN
(
com∑t
);

627 
de°roylock
:

628 
	`li°_dñ_öô
(&
ªq
->
l_ªs_lök
);

629 
	`ldlm_lock_de°roy_nﬁock
(
ªq
);

630 *
îr
 = 
com∑t
;

631 
	`RETURN
(
com∑t
);

632 
	}
}

640 
	$disˇrd_bl_li°
(
li°_hód
 *
bl_li°
)

642 
li°_hód
 *
tmp
, *
pos
;

643 
ENTRY
;

645 
	`li°_f‹_óch_ß„
(
pos
, 
tmp
, 
bl_li°
) {

646 
ldlm_lock
 *
lock
 =

647 
	`li°_íåy
(
pos
, 
ldlm_lock
, 
l_bl_a°
);

649 
	`li°_dñ_öô
(&
lock
->
l_bl_a°
);

650 
	`LASSERT
(
	`ldlm_is_a°_£¡
(
lock
));

651 
	`ldlm_˛ór_a°_£¡
(
lock
);

652 
	`LASSERT
(
lock
->
l_bl_a°_run
 == 0);

653 
	`LASSERT
(
lock
->
l_blockög_lock
);

654 
	`LDLM_LOCK_RELEASE
(
lock
->
l_blockög_lock
);

655 
lock
->
l_blockög_lock
 = 
NULL
;

656 
	`LDLM_LOCK_RELEASE
(
lock
);

658 
EXIT
;

659 
	}
}

676 
	$ldlm_¥o˚ss_exã¡_lock
(
ldlm_lock
 *
lock
, 
__u64
 *
Êags
,

677 
fú°_íq
, 
ldlm_îr‹
 *
îr
,

678 
li°_hód
 *
w‹k_li°
)

680 
ldlm_ªsour˚
 *
ªs
 = 
lock
->
l_ªsour˚
;

681 
li°_hód
 
Ωc_li°
;

682 
rc
, 
rc2
;

683 
c⁄ãnded_locks
 = 0;

684 
ENTRY
;

686 
	`LASSERT
(
lock
->
l_gø¡ed_mode
 !lock->
l_ªq_mode
);

687 
	`LASSERT
(
	`li°_em±y
(&
ªs
->
Ã_c⁄vîtög
));

688 
	`LASSERT
(!(*
Êags
 & 
LDLM_FL_DENY_ON_CONTENTION
) ||

689 !
	`ldlm_is_a°_disˇrd_d©a
(
lock
));

690 
	`INIT_LIST_HEAD
(&
Ωc_li°
);

691 
	`check_ªs_locked
(
ªs
);

692 *
îr
 = 
ELDLM_OK
;

694 
	`¥ötk
("Hey Ziqi, it worked!\n");

696 i‡(!
fú°_íq
) {

702 
	`LASSERT
(*
Êags
 == 0);

703 
rc
 = 
	`ldlm_exã¡_com∑t_queue
(&
ªs
->
Ã_gø¡ed
, 
lock
, 
Êags
,

704 
îr
, 
NULL
, &
c⁄ãnded_locks
);

705 i‡(
rc
 == 1) {

706 
rc
 = 
	`ldlm_exã¡_com∑t_queue
(&
ªs
->
Ã_waôög
, 
lock
,

707 
Êags
, 
îr
, 
NULL
,

708 &
c⁄ãnded_locks
);

710 i‡(
rc
 == 0)

711 
	`RETURN
(
LDLM_ITER_STOP
);

713 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

715 i‡(!
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_CANCEL_EVICT_RACE
))

716 
	`ldlm_exã¡_pﬁicy
(
ªs
, 
lock
, 
Êags
);

717 
	`ldlm_gø¡_lock
(
lock
, 
w‹k_li°
);

718 
	`RETURN
(
LDLM_ITER_CONTINUE
);

721 
ª°¨t
:

722 
c⁄ãnded_locks
 = 0;

723 
rc
 = 
	`ldlm_exã¡_com∑t_queue
(&
ªs
->
Ã_gø¡ed
, 
lock
, 
Êags
, 
îr
,

724 &
Ωc_li°
, &
c⁄ãnded_locks
);

725 i‡(
rc
 < 0)

726 
	`GOTO
(
out
, 
rc
);

727 i‡(
rc
 == 2)

728 
gø¡
;

730 
rc2
 = 
	`ldlm_exã¡_com∑t_queue
(&
ªs
->
Ã_waôög
, 
lock
, 
Êags
, 
îr
,

731 &
Ωc_li°
, &
c⁄ãnded_locks
);

732 i‡(
rc2
 < 0)

733 
	`GOTO
(
out
, 
rc
 = 
rc2
);

735 i‡(
rc
 + 
rc2
 == 2) {

736 
gø¡
:

737 
	`ldlm_exã¡_pﬁicy
(
ªs
, 
lock
, 
Êags
);

738 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

739 
	`ldlm_gø¡_lock
(
lock
, 
NULL
);

747 i‡(
	`li°_em±y
(&
lock
->
l_ªs_lök
))

748 
	`ldlm_ªsour˚_add_lock
(
ªs
, &ªs->
Ã_waôög
, 
lock
);

749 
	`u∆ock_ªs
(
ªs
);

750 
rc
 = 
	`ldlm_run_a°_w‹k
(
	`ldlm_ªs_to_ns
(
ªs
), &
Ωc_li°
,

751 
LDLM_WORK_BL_AST
);

753 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_OST_FAIL_RACE
) &&

754 !
	`ns_is_˛õ¡
(
	`ldlm_ªs_to_ns
(
ªs
)))

755 
	`˛ass_Áû_exp‹t
(
lock
->
l_exp‹t
);

757 
	`lock_ªs
(
ªs
);

758 i‡(
rc
 =-
ERESTART
) {

764 i‡(
	`ldlm_is_de°royed
(
lock
)) {

765 *
îr
 = -
EAGAIN
;

766 
	`GOTO
(
out
, 
rc
 = -
EAGAIN
);

770 i‡(
lock
->
l_gø¡ed_mode
 =lock->
l_ªq_mode
) {

777 *
Êags
 &~
LDLM_FL_BLOCKED_MASK
;

778 
	`GOTO
(
out
, 
rc
 = 0);

781 
	`GOTO
(
ª°¨t
, 
rc
);

786 *
Êags
 |
LDLM_FL_BLOCK_GRANTED
 | 
LDLM_FL_NO_TIMEOUT
;

789 
	`RETURN
(0);

790 
out
:

791 i‡(!
	`li°_em±y
(&
Ωc_li°
)) {

792 
	`LASSERT
(!
	`ldlm_is_a°_disˇrd_d©a
(
lock
));

793 
	`disˇrd_bl_li°
(&
Ωc_li°
);

795 
	`RETURN
(
rc
);

796 
	}
}

804 
__u64
 
	$ldlm_exã¡_shi·_kms
(
ldlm_lock
 *
lock
, 
__u64
 
ﬁd_kms
)

806 
ldlm_ªsour˚
 *
ªs
 = 
lock
->
l_ªsour˚
;

807 
li°_hód
 *
tmp
;

808 
ldlm_lock
 *
lck
;

809 
__u64
 
kms
 = 0;

810 
ENTRY
;

815 
	`ldlm_£t_kms_ign‹e
(
lock
);

817 
	`li°_f‹_óch
(
tmp
, &
ªs
->
Ã_gø¡ed
) {

818 
lck
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
, 
l_ªs_lök
);

820 i‡(
	`ldlm_is_kms_ign‹e
(
lck
))

823 i‡(
lck
->
l_pﬁicy_d©a
.
l_exã¡
.
íd
 >
ﬁd_kms
)

824 
	`RETURN
(
ﬁd_kms
);

828 i‡(
lck
->
l_pﬁicy_d©a
.
l_exã¡
.
íd
 + 1 > 
kms
)

829 
kms
 = 
lck
->
l_pﬁicy_d©a
.
l_exã¡
.
íd
 + 1;

831 
	`LASSERTF
(
kms
 <
ﬁd_kms
, "km†"
LPU64
" old_kms "LPU64"\n", kms, old_kms);

833 
	`RETURN
(
kms
);

834 
	}
}

835 
EXPORT_SYMBOL
(
ldlm_exã¡_shi·_kms
);

837 
kmem_ˇche
 *
	gldlm_öãrvÆ_¶ab
;

838 
ldlm_öãrvÆ
 *
	$ldlm_öãrvÆ_Æloc
(
ldlm_lock
 *
lock
)

840 
ldlm_öãrvÆ
 *
node
;

841 
ENTRY
;

843 
	`LASSERT
(
lock
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_EXTENT
);

844 
	`OBD_SLAB_ALLOC_PTR_GFP
(
node
, 
ldlm_öãrvÆ_¶ab
, 
GFP_NOFS
);

845 i‡(
node
 =
NULL
)

846 
	`RETURN
(
NULL
);

848 
	`INIT_LIST_HEAD
(&
node
->
li_group
);

849 
	`ldlm_öãrvÆ_©èch
(
node
, 
lock
);

850 
	`RETURN
(
node
);

851 
	}
}

853 
	$ldlm_öãrvÆ_‰ì
(
ldlm_öãrvÆ
 *
node
)

855 i‡(
node
) {

856 
	`LASSERT
(
	`li°_em±y
(&
node
->
li_group
));

857 
	`LASSERT
(!
	`öãrvÆ_is_öåì
(&
node
->
li_node
));

858 
	`OBD_SLAB_FREE
(
node
, 
ldlm_öãrvÆ_¶ab
, (*node));

860 
	}
}

863 
	$ldlm_öãrvÆ_©èch
(
ldlm_öãrvÆ
 *
n
,

864 
ldlm_lock
 *
l
)

866 
	`LASSERT
(
l
->
l_åì_node
 =
NULL
);

867 
	`LASSERT
(
l
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_EXTENT
);

869 
	`li°_add_èû
(&
l
->
l_¶_pﬁicy
, &
n
->
li_group
);

870 
l
->
l_åì_node
 = 
n
;

871 
	}
}

873 
ldlm_öãrvÆ
 *
	$ldlm_öãrvÆ_dëach
(
ldlm_lock
 *
l
)

875 
ldlm_öãrvÆ
 *
n
 = 
l
->
l_åì_node
;

877 i‡(
n
 =
NULL
)

878  
NULL
;

880 
	`LASSERT
(!
	`li°_em±y
(&
n
->
li_group
));

881 
l
->
l_åì_node
 = 
NULL
;

882 
	`li°_dñ_öô
(&
l
->
l_¶_pﬁicy
);

884  
	`li°_em±y
(&
n
->
li_group
Ë?Ç : 
NULL
;

885 
	}
}

887 
ölöe
 
	$ldlm_mode_to_ödex
(
ldlm_mode
 
mode
)

889 
ödex
;

891 
	`LASSERT
(
mode
 != 0);

892 
	`LASSERT
(
	`IS_PO2
(
mode
));

893 
ödex
 = -1; 
mode
 != 0; index++, mode >>= 1)

895 
	`LASSERT
(
ödex
 < 
LCK_MODE_NUM
);

896  
ödex
;

897 
	}
}

900 
	$ldlm_exã¡_add_lock
(
ldlm_ªsour˚
 *
ªs
,

901 
ldlm_lock
 *
lock
)

903 
öãrvÆ_node
 *
found
, **
roŸ
;

904 
ldlm_öãrvÆ
 *
node
;

905 
ldlm_exã¡
 *
exã¡
;

906 
idx
;

908 
	`LASSERT
(
lock
->
l_gø¡ed_mode
 =lock->
l_ªq_mode
);

910 
node
 = 
lock
->
l_åì_node
;

911 
	`LASSERT
(
node
 !
NULL
);

912 
	`LASSERT
(!
	`öãrvÆ_is_öåì
(&
node
->
li_node
));

914 
idx
 = 
	`ldlm_mode_to_ödex
(
lock
->
l_gø¡ed_mode
);

915 
	`LASSERT
(
lock
->
l_gø¡ed_mode
 =1 << 
idx
);

916 
	`LASSERT
(
lock
->
l_gø¡ed_mode
 =
ªs
->
Ã_ôªe
[
idx
].
lô_mode
);

919 
exã¡
 = &
lock
->
l_pﬁicy_d©a
.
l_exã¡
;

920 
	`öãrvÆ_£t
(&
node
->
li_node
, 
exã¡
->
°¨t
,Éxã¡->
íd
);

922 
roŸ
 = &
ªs
->
Ã_ôªe
[
idx
].
lô_roŸ
;

923 
found
 = 
	`öãrvÆ_ö£π
(&
node
->
li_node
, 
roŸ
);

924 i‡(
found
) {

925 
ldlm_öãrvÆ
 *
tmp
 = 
	`ldlm_öãrvÆ_dëach
(
lock
);

926 
	`LASSERT
(
tmp
 !
NULL
);

927 
	`ldlm_öãrvÆ_‰ì
(
tmp
);

928 
	`ldlm_öãrvÆ_©èch
(
	`to_ldlm_öãrvÆ
(
found
), 
lock
);

930 
ªs
->
Ã_ôªe
[
idx
].
lô_size
++;

934 
	`ldlm_ªsour˚_add_lock
(
ªs
, &ªs->
Ã_gø¡ed
, 
lock
);

935 
	}
}

938 
	$ldlm_exã¡_u∆ök_lock
(
ldlm_lock
 *
lock
)

940 
ldlm_ªsour˚
 *
ªs
 = 
lock
->
l_ªsour˚
;

941 
ldlm_öãrvÆ
 *
node
 = 
lock
->
l_åì_node
;

942 
ldlm_öãrvÆ_åì
 *
åì
;

943 
idx
;

945 i‡(!
node
 || !
	`öãrvÆ_is_öåì
(&node->
li_node
))

948 
idx
 = 
	`ldlm_mode_to_ödex
(
lock
->
l_gø¡ed_mode
);

949 
	`LASSERT
(
lock
->
l_gø¡ed_mode
 =1 << 
idx
);

950 
åì
 = &
ªs
->
Ã_ôªe
[
idx
];

952 
	`LASSERT
(
åì
->
lô_roŸ
 !
NULL
);

954 
åì
->
lô_size
--;

955 
node
 = 
	`ldlm_öãrvÆ_dëach
(
lock
);

956 i‡(
node
) {

957 
	`öãrvÆ_îa£
(&
node
->
li_node
, &
åì
->
lô_roŸ
);

958 
	`ldlm_öãrvÆ_‰ì
(
node
);

960 
	}
}

962 
	$ldlm_exã¡_pﬁicy_wúe_to_loˇl
(c⁄° 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
,

963 
ldlm_pﬁicy_d©a
 *
Õﬁicy
)

965 
	`mem£t
(
Õﬁicy
, 0, (*lpolicy));

966 
Õﬁicy
->
l_exã¡
.
°¨t
 = 
wpﬁicy
->l_extent.start;

967 
Õﬁicy
->
l_exã¡
.
íd
 = 
wpﬁicy
->l_extent.end;

968 
Õﬁicy
->
l_exã¡
.
gid
 = 
wpﬁicy
->l_extent.gid;

969 
	}
}

971 
	$ldlm_exã¡_pﬁicy_loˇl_to_wúe
(c⁄° 
ldlm_pﬁicy_d©a
 *
Õﬁicy
,

972 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
)

974 
	`mem£t
(
wpﬁicy
, 0, (*wpolicy));

975 
wpﬁicy
->
l_exã¡
.
°¨t
 = 
Õﬁicy
->l_extent.start;

976 
wpﬁicy
->
l_exã¡
.
íd
 = 
Õﬁicy
->l_extent.end;

977 
wpﬁicy
->
l_exã¡
.
gid
 = 
Õﬁicy
->l_extent.gid;

978 
	}
}

	@ldlm_flock.c

57 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

59 
	~<lu°ª_dlm.h
>

60 
	~<obd_suµ‹t.h
>

61 
	~<obd_˛ass.h
>

62 
	~<lu°ª_lib.h
>

63 
	~<libcfs/li°.h
>

65 
	~"ldlm_öã∫Æ.h
"

67 
ldlm_Êock_blockög_a°
(
ldlm_lock
 *
lock
, 
ldlm_lock_desc
 *
desc
,

68 *
d©a
, 
Êag
);

78 
	#li°_f‹_ªmaöög_ß„
(
pos
, 
n
, 
hód
) \

79 
n
 = 
pos
->
√xt
;Öo†!(
hód
);Öo†n,Ç =Öos->√xt)

	)

81 
ölöe
 

82 
	$ldlm_ßme_Êock_ow√r
(
ldlm_lock
 *
lock
, ldlm_lock *
√w
)

84 ((
√w
->
l_pﬁicy_d©a
.
l_Êock
.
ow√r
 ==

85 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
ow√r
) &&

86 (
√w
->
l_exp‹t
 =
lock
->l_export));

87 
	}
}

89 
ölöe
 

90 
	$ldlm_Êocks_ovîœp
(
ldlm_lock
 *
lock
, ldlm_lock *
√w
)

92 ((
√w
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 <=

93 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
) &&

94 (
√w
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 >=

95 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
));

96 
	}
}

98 
ölöe
 
	$ldlm_Êock_blockög_lök
(
ldlm_lock
 *
ªq
,

99 
ldlm_lock
 *
lock
)

102 i‡(
ªq
->
l_exp‹t
 =
NULL
)

105 
	`LASSERT
(
	`hli°_unhashed
(&
ªq
->
l_exp_Êock_hash
));

107 
ªq
->
l_pﬁicy_d©a
.
l_Êock
.
blockög_ow√r
 =

108 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
ow√r
;

109 
ªq
->
l_pﬁicy_d©a
.
l_Êock
.
blockög_exp‹t
 =

110 
lock
->
l_exp‹t
;

111 
ªq
->
l_pﬁicy_d©a
.
l_Êock
.
blockög_ªfs
 = 0;

113 
	`cfs_hash_add
(
ªq
->
l_exp‹t
->
exp_Êock_hash
,

114 &
ªq
->
l_pﬁicy_d©a
.
l_Êock
.
ow√r
,

115 &
ªq
->
l_exp_Êock_hash
);

116 
	}
}

118 
ölöe
 
	$ldlm_Êock_blockög_u∆ök
(
ldlm_lock
 *
ªq
)

121 i‡(
ªq
->
l_exp‹t
 =
NULL
)

124 
	`check_ªs_locked
(
ªq
->
l_ªsour˚
);

125 i‡(
ªq
->
l_exp‹t
->
exp_Êock_hash
 !
NULL
 &&

126 !
	`hli°_unhashed
(&
ªq
->
l_exp_Êock_hash
))

127 
	`cfs_hash_dñ
(
ªq
->
l_exp‹t
->
exp_Êock_hash
,

128 &
ªq
->
l_pﬁicy_d©a
.
l_Êock
.
ow√r
,

129 &
ªq
->
l_exp_Êock_hash
);

130 
	}
}

132 
ölöe
 

133 
	$ldlm_Êock_de°roy
(
ldlm_lock
 *
lock
, 
ldlm_mode
 
mode
, 
__u64
 
Êags
)

135 
ENTRY
;

137 
	`LDLM_DEBUG
(
lock
, "ldlm_Êock_de°roy(mode: %d, fœgs: "
LPX64
")",

138 
mode
, 
Êags
);

141 
	`LASSERT
(
	`hli°_unhashed
(&
lock
->
l_exp_Êock_hash
));

143 
	`li°_dñ_öô
(&
lock
->
l_ªs_lök
);

144 i‡(
Êags
 =
LDLM_FL_WAIT_NOREPROC
) {

146 
lock
->
l_Êags
 |
LDLM_FL_LOCAL_ONLY
 | 
LDLM_FL_CBPENDING
;

150 
	`ldlm_lock_de¸ef_öã∫Æ_nﬁock
(
lock
, 
mode
);

153 
	`ldlm_lock_de°roy_nﬁock
(
lock
);

154 
EXIT
;

155 
	}
}

167 
	sldlm_Êock_lookup_cb_d©a
 {

168 
__u64
 *
	mbl_ow√r
;

169 
ldlm_lock
 *
	mlock
;

170 
obd_exp‹t
 *
	mexp
;

173 
	$ldlm_Êock_lookup_cb
(
cfs_hash
 *
hs
, 
cfs_hash_bd
 *
bd
,

174 
hli°_node
 *
hnode
, *
d©a
)

176 
ldlm_Êock_lookup_cb_d©a
 *
cb_d©a
 = 
d©a
;

177 
obd_exp‹t
 *
exp
 = 
	`cfs_hash_obje˘
(
hs
, 
hnode
);

178 
ldlm_lock
 *
lock
;

180 
lock
 = 
	`cfs_hash_lookup
(
exp
->
exp_Êock_hash
, 
cb_d©a
->
bl_ow√r
);

181 i‡(
lock
 =
NULL
)

185 
cb_d©a
->
lock
 =Üock;

186 
cb_d©a
->
exp
 = 
	`˛ass_exp‹t_gë
(exp);

189 
	}
}

192 
	$ldlm_Êock_dódlock
(
ldlm_lock
 *
ªq
, ldlm_lock *
bl_lock
)

194 
obd_exp‹t
 *
ªq_exp
 = 
ªq
->
l_exp‹t
;

195 
obd_exp‹t
 *
bl_exp
 = 
bl_lock
->
l_exp‹t
;

196 
__u64
 
ªq_ow√r
 = 
ªq
->
l_pﬁicy_d©a
.
l_Êock
.
ow√r
;

197 
__u64
 
bl_ow√r
 = 
bl_lock
->
l_pﬁicy_d©a
.
l_Êock
.
ow√r
;

200 i‡(
ªq_exp
 =
NULL
)

203 
	`˛ass_exp‹t_gë
(
bl_exp
);

205 
ldlm_Êock_lookup_cb_d©a
 
cb_d©a
 = {

206 .
bl_ow√r
 = &bl_owner,

207 .
lock
 = 
NULL
,

208 .
exp
 = 
NULL
 };

209 
obd_exp‹t
 *
bl_exp_√w
;

210 
ldlm_lock
 *
lock
 = 
NULL
;

211 
ldlm_Êock
 *
Êock
;

213 i‡(
bl_exp
->
exp_Êock_hash
 !
NULL
) {

214 
	`cfs_hash_f‹_óch_key
(
bl_exp
->
exp_obd
->
obd_nid_hash
,

215 &
bl_exp
->
exp_c⁄√˘i⁄
->
c_≥î
.
nid
,

216 
ldlm_Êock_lookup_cb
, &
cb_d©a
);

217 
lock
 = 
cb_d©a
.lock;

219 i‡(
lock
 =
NULL
)

222 
	`˛ass_exp‹t_put
(
bl_exp
);

223 
bl_exp
 = 
cb_d©a
.
exp
;

225 
	`LASSERT
(
ªq
 !
lock
);

226 
Êock
 = &
lock
->
l_pﬁicy_d©a
.
l_Êock
;

227 
	`LASSERT
(
Êock
->
ow√r
 =
bl_ow√r
);

228 
bl_ow√r
 = 
Êock
->
blockög_ow√r
;

229 
bl_exp_√w
 = 
	`˛ass_exp‹t_gë
(
Êock
->
blockög_exp‹t
);

230 
	`˛ass_exp‹t_put
(
bl_exp
);

232 
	`cfs_hash_put
(
bl_exp
->
exp_Êock_hash
, &
lock
->
l_exp_Êock_hash
);

233 
bl_exp
 = 
bl_exp_√w
;

235 i‡(
bl_exp
->
exp_Áûed
)

238 i‡(
bl_ow√r
 =
ªq_ow√r
 &&

239 (
bl_exp
->
exp_c⁄√˘i⁄
->
c_≥î
.
nid
 ==

240 
ªq_exp
->
exp_c⁄√˘i⁄
->
c_≥î
.
nid
)) {

241 
	`˛ass_exp‹t_put
(
bl_exp
);

245 
	`˛ass_exp‹t_put
(
bl_exp
);

248 
	}
}

250 
	$ldlm_Êock_ˇn˚l_⁄_dódlock
(
ldlm_lock
 *
lock
,

251 
li°_hód
 *
w‹k_li°
)

253 
	`CDEBUG
(
D_INFO
, "ª¥o˚s†dódlockÑeq=%p\n", 
lock
);

255 i‡((
	`exp_c⁄√˘_Êags
(
lock
->
l_exp‹t
) &

256 
OBD_CONNECT_FLOCK_DEAD
) == 0) {

257 
	`CERROR
("deadlock found, but client doesn't "

260 
	`LASSERT
(
lock
->
l_com∂ëi⁄_a°
);

261 
	`LASSERT
(!
	`ldlm_is_a°_£¡
(
lock
));

262 
lock
->
l_Êags
 |
LDLM_FL_AST_SENT
 | 
LDLM_FL_CANCEL_ON_BLOCK
 |

263 
LDLM_FL_FLOCK_DEADLOCK
;

264 
	`ldlm_Êock_blockög_u∆ök
(
lock
);

265 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

266 
	`ldlm_add_a°_w‹k_ôem
(
lock
, 
NULL
, 
w‹k_li°
);

268 
	}
}

289 
	$ldlm_¥o˚ss_Êock_lock
(
ldlm_lock
 *
ªq
, 
__u64
 *
Êags
, 
fú°_íq
,

290 
ldlm_îr‹
 *
îr
, 
li°_hód
 *
w‹k_li°
)

292 
ldlm_ªsour˚
 *
ªs
 = 
ªq
->
l_ªsour˚
;

293 
ldlm_«me•a˚
 *
ns
 = 
	`ldlm_ªs_to_ns
(
ªs
);

294 
li°_hód
 *
tmp
;

295 
li°_hód
 *
ow∆ocks
 = 
NULL
;

296 
ldlm_lock
 *
lock
 = 
NULL
;

297 
ldlm_lock
 *
√w
 = 
ªq
;

298 
ldlm_lock
 *
√w2
 = 
NULL
;

299 
ldlm_mode
 
mode
 = 
ªq
->
l_ªq_mode
;

300 
loˇl
 = 
	`ns_is_˛õ¡
(
ns
);

301 
added
 = (
mode
 =
LCK_NL
);

302 
ovîœps
 = 0;

303 
•lôãd
 = 0;

304 c⁄° 
ldlm_ˇŒback_suôe
 
nuŒ_cbs
 = { 
NULL
 };

305 
ENTRY
;

307 
	`CDEBUG
(
D_DLMTRACE
, "Êag†"
LPX64
" ow√∏"
LPU64
"Öid %u mode %u start "

308 
LPU64
"Énd "LPU64"\n", *
Êags
,

309 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
ow√r
,

310 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
pid
, 
mode
,

311 
ªq
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
,

312 
ªq
->
l_pﬁicy_d©a
.
l_Êock
.
íd
);

314 *
îr
 = 
ELDLM_OK
;

316 i‡(
loˇl
) {

319 
ªq
->
l_blockög_a°
 = 
NULL
;

322 
ªq
->
l_blockög_a°
 = 
ldlm_Êock_blockög_a°
;

325 
ª¥o˚ss
:

326 i‡((*
Êags
 =
LDLM_FL_WAIT_NOREPROC
Ë|| (
mode
 =
LCK_NL
)) {

329 
	`li°_f‹_óch
(
tmp
, &
ªs
->
Ã_gø¡ed
) {

330 
lock
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
,

331 
l_ªs_lök
);

332 i‡(
	`ldlm_ßme_Êock_ow√r
(
lock
, 
ªq
)) {

333 
ow∆ocks
 = 
tmp
;

338 
ª¥o˚ss_Áûed
 = 0;

339 
	`lockmode_vîify
(
mode
);

343 
	`li°_f‹_óch
(
tmp
, &
ªs
->
Ã_gø¡ed
) {

344 
lock
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
,

345 
l_ªs_lök
);

347 i‡(
	`ldlm_ßme_Êock_ow√r
(
lock
, 
ªq
)) {

348 i‡(!
ow∆ocks
)

349 
ow∆ocks
 = 
tmp
;

354 i‡(
	`lockmode_com∑t
(
lock
->
l_gø¡ed_mode
, 
mode
))

357 i‡(!
	`ldlm_Êocks_ovîœp
(
lock
, 
ªq
))

360 i‡(!
fú°_íq
) {

361 
ª¥o˚ss_Áûed
 = 1;

362 i‡(
	`ldlm_Êock_dódlock
(
ªq
, 
lock
)) {

363 
	`ldlm_Êock_ˇn˚l_⁄_dódlock
(
ªq
,

364 
w‹k_li°
);

365 
	`RETURN
(
LDLM_ITER_CONTINUE
);

370 i‡(*
Êags
 & 
LDLM_FL_BLOCK_NOWAIT
) {

371 
	`ldlm_Êock_de°roy
(
ªq
, 
mode
, *
Êags
);

372 *
îr
 = -
EAGAIN
;

373 
	`RETURN
(
LDLM_ITER_STOP
);

376 i‡(*
Êags
 & 
LDLM_FL_TEST_LOCK
) {

377 
	`ldlm_Êock_de°roy
(
ªq
, 
mode
, *
Êags
);

378 
ªq
->
l_ªq_mode
 = 
lock
->
l_gø¡ed_mode
;

379 
ªq
->
l_pﬁicy_d©a
.
l_Êock
.
pid
 =

380 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
pid
;

381 
ªq
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 =

382 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
;

383 
ªq
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 =

384 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
;

385 *
Êags
 |
LDLM_FL_LOCK_CHANGED
;

386 
	`RETURN
(
LDLM_ITER_STOP
);

391 
	`ldlm_Êock_blockög_lök
(
ªq
, 
lock
);

393 i‡(
	`ldlm_Êock_dódlock
(
ªq
, 
lock
)) {

394 
	`ldlm_Êock_blockög_u∆ök
(
ªq
);

395 
	`ldlm_Êock_de°roy
(
ªq
, 
mode
, *
Êags
);

396 *
îr
 = -
EDEADLK
;

397 
	`RETURN
(
LDLM_ITER_STOP
);

400 
	`ldlm_ªsour˚_add_lock
(
ªs
, &ªs->
Ã_waôög
, 
ªq
);

401 *
Êags
 |
LDLM_FL_BLOCK_GRANTED
;

402 
	`RETURN
(
LDLM_ITER_STOP
);

404 i‡(
ª¥o˚ss_Áûed
)

405 
	`RETURN
(
LDLM_ITER_CONTINUE
);

408 i‡(*
Êags
 & 
LDLM_FL_TEST_LOCK
) {

409 
	`ldlm_Êock_de°roy
(
ªq
, 
mode
, *
Êags
);

410 
ªq
->
l_ªq_mode
 = 
LCK_NL
;

411 *
Êags
 |
LDLM_FL_LOCK_CHANGED
;

412 
	`RETURN
(
LDLM_ITER_STOP
);

417 
	`ldlm_Êock_blockög_u∆ök
(
ªq
);

422 i‡(!
ow∆ocks
)

423 
ow∆ocks
 = &
ªs
->
Ã_gø¡ed
;

425 
	`li°_f‹_ªmaöög_ß„
(
ow∆ocks
, 
tmp
, &
ªs
->
Ã_gø¡ed
) {

426 
lock
 = 
	`li°_íåy
(
ow∆ocks
, 
ldlm_lock
, 
l_ªs_lök
);

428 i‡(!
	`ldlm_ßme_Êock_ow√r
(
lock
, 
√w
))

431 i‡(
lock
->
l_gø¡ed_mode
 =
mode
) {

436 i‡((
√w
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 >

437 (
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 + 1))

438 && (
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 !=

439 
OBD_OBJECT_EOF
))

442 i‡((
√w
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 <

443 (
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 - 1))

444 && (
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 != 0))

447 i‡(
√w
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 <

448 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
) {

449 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 =

450 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
;

452 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 =

453 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
;

456 i‡(
√w
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 >

457 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
) {

458 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 =

459 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
íd
;

461 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 =

462 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
;

465 i‡(
added
) {

466 
	`ldlm_Êock_de°roy
(
lock
, 
mode
, *
Êags
);

468 
√w
 = 
lock
;

469 
added
 = 1;

474 i‡(
√w
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 >

475 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
)

478 i‡(
√w
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 <

479 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
)

482 ++
ovîœps
;

484 i‡(
√w
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 <=

485 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
) {

486 i‡(
√w
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 <

487 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
) {

488 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 =

489 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 + 1;

492 
	`ldlm_Êock_de°roy
(
lock
,Üock->
l_ªq_mode
, *
Êags
);

495 i‡(
√w
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 >=

496 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
) {

497 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 =

498 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 - 1;

514 i‡(
√w2
 =
NULL
) {

515 
	`u∆ock_ªs_™d_lock
(
ªq
);

516 
√w2
 = 
	`ldlm_lock_¸óã
(
ns
, &
ªs
->
Ã_«me
, 
LDLM_FLOCK
,

517 
lock
->
l_gø¡ed_mode
, &
nuŒ_cbs
,

518 
NULL
, 0, 
LVB_T_NONE
);

519 
	`lock_ªs_™d_lock
(
ªq
);

520 i‡(
	`IS_ERR
(
√w2
)) {

521 
	`ldlm_Êock_de°roy
(
ªq
, 
lock
->
l_gø¡ed_mode
,

522 *
Êags
);

523 *
îr
 = 
	`PTR_ERR
(
√w2
);

524 
	`RETURN
(
LDLM_ITER_STOP
);

526 
ª¥o˚ss
;

529 
•lôãd
 = 1;

531 
√w2
->
l_gø¡ed_mode
 = 
lock
->l_granted_mode;

532 
√w2
->
l_pﬁicy_d©a
.
l_Êock
.
pid
 =

533 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
pid
;

534 
√w2
->
l_pﬁicy_d©a
.
l_Êock
.
ow√r
 =

535 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
ow√r
;

536 
√w2
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 =

537 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
;

538 
√w2
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 =

539 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 - 1;

540 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
 =

541 
√w
->
l_pﬁicy_d©a
.
l_Êock
.
íd
 + 1;

542 
√w2
->
l_c⁄n_exp‹t
 = 
lock
->l_conn_export;

543 i‡(
lock
->
l_exp‹t
 !
NULL
) {

544 
√w2
->
l_exp‹t
 = 
	`˛ass_exp‹t_lock_gë
(
lock
->l_export,Çew2);

545 i‡(
√w2
->
l_exp‹t
->
exp_lock_hash
 &&

546 
	`hli°_unhashed
(&
√w2
->
l_exp_hash
))

547 
	`cfs_hash_add
(
√w2
->
l_exp‹t
->
exp_lock_hash
,

548 &
√w2
->
l_ªmŸe_h™dÀ
,

549 &
√w2
->
l_exp_hash
);

551 i‡(*
Êags
 =
LDLM_FL_WAIT_NOREPROC
)

552 
	`ldlm_lock_addªf_öã∫Æ_nﬁock
(
√w2
,

553 
lock
->
l_gø¡ed_mode
);

556 
	`ldlm_ªsour˚_add_lock
(
ªs
, 
ow∆ocks
, 
√w2
);

557 
	`LDLM_LOCK_RELEASE
(
√w2
);

562 i‡(
•lôãd
 =0 && 
√w2
 !
NULL
)

563 
	`ldlm_lock_de°roy_nﬁock
(
√w2
);

566 
ªq
->
l_gø¡ed_mode
 =Ñeq->
l_ªq_mode
;

569 i‡(!
added
) {

570 
	`li°_dñ_öô
(&
ªq
->
l_ªs_lök
);

572 
	`ldlm_ªsour˚_add_lock
(
ªs
, 
ow∆ocks
, 
ªq
);

575 i‡(*
Êags
 !
LDLM_FL_WAIT_NOREPROC
) {

576 #ifde‡
HAVE_SERVER_SUPPORT


577 i‡(
fú°_íq
) {

587 i‡((
mode
 =
LCK_NL
Ë&& 
ovîœps
) {

588 
li°_hód
 
Ωc_li°
;

589 
rc
;

591 
	`INIT_LIST_HEAD
(&
Ωc_li°
);

592 
ª°¨t
:

593 
	`ldlm_ª¥o˚ss_queue
(
ªs
, &ªs->
Ã_waôög
,

594 &
Ωc_li°
);

596 
	`u∆ock_ªs_™d_lock
(
ªq
);

597 
rc
 = 
	`ldlm_run_a°_w‹k
(
ns
, &
Ωc_li°
,

598 
LDLM_WORK_CP_AST
);

599 
	`lock_ªs_™d_lock
(
ªq
);

600 i‡(
rc
 =-
ERESTART
)

601 
	`GOTO
(
ª°¨t
, 
rc
);

604 
	`LASSERT
(
ªq
->
l_com∂ëi⁄_a°
);

605 
	`ldlm_add_a°_w‹k_ôem
(
ªq
, 
NULL
, 
w‹k_li°
);

611 
	`CERROR
("IllegalÖarameter for client-side-only module.\n");

612 
	`LBUG
();

620 i‡(
added
)

621 
	`ldlm_Êock_de°roy
(
ªq
, 
mode
, *
Êags
);

623 
	`ldlm_ªsour˚_dump
(
D_INFO
, 
ªs
);

624 
	`RETURN
(
LDLM_ITER_CONTINUE
);

625 
	}
}

627 
	sldlm_Êock_waô_d©a
 {

628 
ldlm_lock
 *
	mfwd_lock
;

629 
	mfwd_gíî©i⁄
;

633 
	$ldlm_Êock_öãºu±ed_waô
(*
d©a
)

635 
ldlm_lock
 *
lock
;

636 
ENTRY
;

638 
lock
 = ((
ldlm_Êock_waô_d©a
 *)
d©a
)->
fwd_lock
;

641 
	`lock_ªs_™d_lock
(
lock
);

642 
	`ldlm_Êock_blockög_u∆ök
(
lock
);

645 
	`ldlm_£t_cb≥ndög
(
lock
);

646 
	`u∆ock_ªs_™d_lock
(
lock
);

648 
EXIT
;

649 
	}
}

662 
	$ldlm_Êock_com∂ëi⁄_a°
(
ldlm_lock
 *
lock
, 
__u64
 
Êags
, *
d©a
)

664 
fûe_lock
 *
gëlk
 = 
lock
->
l_a°_d©a
;

665 
obd_devi˚
 *
obd
;

666 
obd_imp‹t
 *
imp
 = 
NULL
;

667 
ldlm_Êock_waô_d©a
 
fwd
;

668 
l_waô_öfo
 
lwi
;

669 
ldlm_îr‹
 
îr
;

670 
rc
 = 0;

671 
ENTRY
;

673 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_LDLM_CP_CB_WAIT2
, 4);

674 i‡(
	`OBD_FAIL_PRECHECK
(
OBD_FAIL_LDLM_CP_CB_WAIT3
)) {

675 
	`lock_ªs_™d_lock
(
lock
);

676 
lock
->
l_Êags
 |
LDLM_FL_FAIL_LOC
;

677 
	`u∆ock_ªs_™d_lock
(
lock
);

678 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_LDLM_CP_CB_WAIT3
, 4);

680 
	`CDEBUG
(
D_DLMTRACE
, "Êags: "
LPX64
" data: %p getlk: %p\n",

681 
Êags
, 
d©a
, 
gëlk
);

683 
	`LASSERT
(
Êags
 !
LDLM_FL_WAIT_NOREPROC
);

685 i‡(
Êags
 & 
LDLM_FL_FAILED
)

686 
gø¡ed
;

688 i‡(!(
Êags
 & 
LDLM_FL_BLOCKED_MASK
)) {

689 i‡(
NULL
 =
d©a
)

691 
gø¡ed
;

693 
	`wake_up
(&
lock
->
l_waôq
);

694 
	`RETURN
(0);

697 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueueÑeturnedá blockedÜock, "

699 
fwd
.
fwd_lock
 = 
lock
;

700 
obd
 = 
	`˛ass_exp2obd
(
lock
->
l_c⁄n_exp‹t
);

703 i‡(
NULL
 !
obd
)

704 
imp
 = 
obd
->
u
.
˛i
.
˛_imp‹t
;

706 i‡(
NULL
 !
imp
) {

707 
	`•ö_lock
(&
imp
->
imp_lock
);

708 
fwd
.
fwd_gíî©i⁄
 = 
imp
->
imp_gíî©i⁄
;

709 
	`•ö_u∆ock
(&
imp
->
imp_lock
);

712 
lwi
 = 
	`LWI_TIMEOUT_INTR
(0, 
NULL
, 
ldlm_Êock_öãºu±ed_waô
, &
fwd
);

715 
rc
 = 
	`l_waô_evít
(
lock
->
l_waôq
, 
	`is_gø¡ed_‹_ˇn˚Œed
÷ock), &
lwi
);

717 i‡(
rc
) {

718 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue waking up: failed (%d)",

719 
rc
);

720 
	`RETURN
(
rc
);

723 
gø¡ed
:

724 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_LDLM_CP_CB_WAIT
, 10);

726 i‡(
	`OBD_FAIL_PRECHECK
(
OBD_FAIL_LDLM_CP_CB_WAIT4
)) {

727 
	`lock_ªs_™d_lock
(
lock
);

729 
lock
->
l_Êags
 |
LDLM_FL_FLOCK_DEADLOCK
 | 
LDLM_FL_CBPENDING
;

730 
	`u∆ock_ªs_™d_lock
(
lock
);

731 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_LDLM_CP_CB_WAIT4
, 4);

733 i‡(
	`OBD_FAIL_PRECHECK
(
OBD_FAIL_LDLM_CP_CB_WAIT5
)) {

734 
	`lock_ªs_™d_lock
(
lock
);

736 
lock
->
l_Êags
 |
LDLM_FL_FAIL_LOC
 |

737 
LDLM_FL_FLOCK_DEADLOCK
 | 
LDLM_FL_CBPENDING
;

738 
	`u∆ock_ªs_™d_lock
(
lock
);

739 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_LDLM_CP_CB_WAIT5
, 4);

742 
	`lock_ªs_™d_lock
(
lock
);

748 i‡(
	`ldlm_is_de°royed
(
lock
)) {

749 
	`u∆ock_ªs_™d_lock
(
lock
);

750 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue waking up: destroyed");

754 
	`RETURN
(-
EIO
);

758 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

765 i‡(
	`ldlm_is_Áûed
(
lock
Ë|| 
	`ldlm_is_Êock_dódlock
(lock)) {

766 
mode
;

768 i‡(
Êags
 & 
LDLM_FL_TEST_LOCK
)

769 
	`LASSERT
(
	`ldlm_is_ã°_lock
(
lock
));

771 i‡(
	`ldlm_is_ã°_lock
(
lock
Ë|| 
	`ldlm_is_Êock_dódlock
(lock))

772 
mode
 = 
	`Êock_ty≥
(
gëlk
);

774 
mode
 = 
lock
->
l_gø¡ed_mode
;

776 i‡(
	`ldlm_is_Êock_dódlock
(
lock
)) {

777 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue deadlock "

779 
rc
 = -
EDEADLK
;

781 
	`ldlm_Êock_de°roy
(
lock
, 
mode
, 
LDLM_FL_WAIT_NOREPROC
);

782 
	`u∆ock_ªs_™d_lock
(
lock
);

785 
	`wake_up
(&
lock
->
l_waôq
);

789 
	`RETURN
(
rc
 ? : -
EIO
);

792 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue granted");

794 i‡(
Êags
 & 
LDLM_FL_TEST_LOCK
) {

798 
	`LASSERT
(
	`ldlm_is_ã°_lock
(
lock
));

799 
	`ldlm_Êock_de°roy
(
lock
, 
	`Êock_ty≥
(
gëlk
),

800 
LDLM_FL_WAIT_NOREPROC
);

801 
lock
->
l_gø¡ed_mode
) {

802 
LCK_PR
:

803 
	`Êock_£t_ty≥
(
gëlk
, 
F_RDLCK
);

805 
LCK_PW
:

806 
	`Êock_£t_ty≥
(
gëlk
, 
F_WRLCK
);

809 
	`Êock_£t_ty≥
(
gëlk
, 
F_UNLCK
);

811 
	`Êock_£t_pid
(
gëlk
, (
pid_t
)
lock
->
l_pﬁicy_d©a
.
l_Êock
.
pid
);

812 
	`Êock_£t_°¨t
(
gëlk
,

813 (
loff_t
)
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
);

814 
	`Êock_£t_íd
(
gëlk
,

815 (
loff_t
)
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
);

817 
__u64
 
n‹ïroc
 = 
LDLM_FL_WAIT_NOREPROC
;

821 
	`ldlm_¥o˚ss_Êock_lock
(
lock
, &
n‹ïroc
, 1, &
îr
, 
NULL
);

823 
	`u∆ock_ªs_™d_lock
(
lock
);

824 
	`RETURN
(
rc
);

825 
	}
}

826 
EXPORT_SYMBOL
(
ldlm_Êock_com∂ëi⁄_a°
);

828 
	$ldlm_Êock_blockög_a°
(
ldlm_lock
 *
lock
, 
ldlm_lock_desc
 *
desc
,

829 *
d©a
, 
Êag
)

831 
ENTRY
;

833 
	`LASSERT
(
lock
);

834 
	`LASSERT
(
Êag
 =
LDLM_CB_CANCELING
);

837 
	`lock_ªs_™d_lock
(
lock
);

838 
	`ldlm_Êock_blockög_u∆ök
(
lock
);

839 
	`u∆ock_ªs_™d_lock
(
lock
);

840 
	`RETURN
(0);

841 
	}
}

843 
	$ldlm_Êock_pﬁicy_wúe_to_loˇl
(c⁄° 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
,

844 
ldlm_pﬁicy_d©a
 *
Õﬁicy
)

846 
	`mem£t
(
Õﬁicy
, 0, (*lpolicy));

847 
Õﬁicy
->
l_Êock
.
°¨t
 = 
wpﬁicy
->l_Êock.
lfw_°¨t
;

848 
Õﬁicy
->
l_Êock
.
íd
 = 
wpﬁicy
->l_Êock.
lfw_íd
;

849 
Õﬁicy
->
l_Êock
.
pid
 = 
wpﬁicy
->l_Êock.
lfw_pid
;

850 
Õﬁicy
->
l_Êock
.
ow√r
 = 
wpﬁicy
->l_Êock.
lfw_ow√r
;

851 
	}
}

853 
	$ldlm_Êock_pﬁicy_loˇl_to_wúe
(c⁄° 
ldlm_pﬁicy_d©a
 *
Õﬁicy
,

854 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
)

856 
	`mem£t
(
wpﬁicy
, 0, (*wpolicy));

857 
wpﬁicy
->
l_Êock
.
lfw_°¨t
 = 
Õﬁicy
->l_Êock.
°¨t
;

858 
wpﬁicy
->
l_Êock
.
lfw_íd
 = 
Õﬁicy
->l_Êock.
íd
;

859 
wpﬁicy
->
l_Êock
.
lfw_pid
 = 
Õﬁicy
->l_Êock.
pid
;

860 
wpﬁicy
->
l_Êock
.
lfw_ow√r
 = 
Õﬁicy
->l_Êock.
ow√r
;

861 
	}
}

867 
	$ldlm_exp‹t_Êock_hash
(
cfs_hash
 *
hs
, c⁄° *
key
, 
mask
)

869  
	`cfs_hash_u64_hash
(*(
__u64
 *)
key
, 
mask
);

870 
	}
}

873 
	$ldlm_exp‹t_Êock_key
(
hli°_node
 *
hnode
)

875 
ldlm_lock
 *
lock
;

877 
lock
 = 
	`hli°_íåy
(
hnode
, 
ldlm_lock
, 
l_exp_Êock_hash
);

878  &
lock
->
l_pﬁicy_d©a
.
l_Êock
.
ow√r
;

879 
	}
}

882 
	$ldlm_exp‹t_Êock_keycmp
(c⁄° *
key
, 
hli°_node
 *
hnode
)

884  !
	`memcmp
(
	`ldlm_exp‹t_Êock_key
(
hnode
), 
key
, (
__u64
));

885 
	}
}

888 
	$ldlm_exp‹t_Êock_obje˘
(
hli°_node
 *
hnode
)

890  
	`hli°_íåy
(
hnode
, 
ldlm_lock
, 
l_exp_Êock_hash
);

891 
	}
}

894 
	$ldlm_exp‹t_Êock_gë
(
cfs_hash
 *
hs
, 
hli°_node
 *
hnode
)

896 
ldlm_lock
 *
lock
;

897 
ldlm_Êock
 *
Êock
;

899 
lock
 = 
	`hli°_íåy
(
hnode
, 
ldlm_lock
, 
l_exp_Êock_hash
);

900 
	`LDLM_LOCK_GET
(
lock
);

902 
Êock
 = &
lock
->
l_pﬁicy_d©a
.
l_Êock
;

903 
	`LASSERT
(
Êock
->
blockög_exp‹t
 !
NULL
);

904 
	`˛ass_exp‹t_gë
(
Êock
->
blockög_exp‹t
);

905 
Êock
->
blockög_ªfs
++;

906 
	}
}

909 
	$ldlm_exp‹t_Êock_put
(
cfs_hash
 *
hs
, 
hli°_node
 *
hnode
)

911 
ldlm_lock
 *
lock
;

912 
ldlm_Êock
 *
Êock
;

914 
lock
 = 
	`hli°_íåy
(
hnode
, 
ldlm_lock
, 
l_exp_Êock_hash
);

915 
	`LDLM_LOCK_RELEASE
(
lock
);

917 
Êock
 = &
lock
->
l_pﬁicy_d©a
.
l_Êock
;

918 
	`LASSERT
(
Êock
->
blockög_exp‹t
 !
NULL
);

919 
	`˛ass_exp‹t_put
(
Êock
->
blockög_exp‹t
);

920 i‡(--
Êock
->
blockög_ªfs
 == 0) {

921 
Êock
->
blockög_ow√r
 = 0;

922 
Êock
->
blockög_exp‹t
 = 
NULL
;

924 
	}
}

926 
cfs_hash_›s
 
	gldlm_exp‹t_Êock_›s
 = {

927 .
hs_hash
 = 
ldlm_exp‹t_Êock_hash
,

928 .
	ghs_key
 = 
ldlm_exp‹t_Êock_key
,

929 .
	ghs_keycmp
 = 
ldlm_exp‹t_Êock_keycmp
,

930 .
	ghs_obje˘
 = 
ldlm_exp‹t_Êock_obje˘
,

931 .
	ghs_gë
 = 
ldlm_exp‹t_Êock_gë
,

932 .
	ghs_put
 = 
ldlm_exp‹t_Êock_put
,

933 .
	ghs_put_locked
 = 
ldlm_exp‹t_Êock_put
,

936 
	$ldlm_öô_Êock_exp‹t
(
obd_exp‹t
 *
exp
)

938 if–
	`°rcmp
(
exp
->
exp_obd
->
obd_ty≥
->
typ_«me
, 
LUSTRE_MDT_NAME
) != 0)

939 
	`RETURN
(0);

941 
exp
->
exp_Êock_hash
 =

942 
	`cfs_hash_¸óã
(
	`obd_uuid2°r
(&
exp
->
exp_˛õ¡_uuid
),

943 
HASH_EXP_LOCK_CUR_BITS
,

944 
HASH_EXP_LOCK_MAX_BITS
,

945 
HASH_EXP_LOCK_BKT_BITS
, 0,

946 
CFS_HASH_MIN_THETA
, 
CFS_HASH_MAX_THETA
,

947 &
ldlm_exp‹t_Êock_›s
,

948 
CFS_HASH_DEFAULT
 | 
CFS_HASH_NBLK_CHANGE
);

949 i‡(!
exp
->
exp_Êock_hash
)

950 
	`RETURN
(-
ENOMEM
);

952 
	`RETURN
(0);

953 
	}
}

955 
	$ldlm_de°roy_Êock_exp‹t
(
obd_exp‹t
 *
exp
)

957 
ENTRY
;

958 i‡(
exp
->
exp_Êock_hash
) {

959 
	`cfs_hash_puåef
(
exp
->
exp_Êock_hash
);

960 
exp
->
exp_Êock_hash
 = 
NULL
;

962 
EXIT
;

963 
	}
}

	@ldlm_inodebits.c

54 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

56 
	~<lu°ª_dlm.h
>

57 
	~<obd_suµ‹t.h
>

58 
	~<lu°ª_lib.h
>

59 
	~<obd_˛ass.h
>

61 
	~"ldlm_öã∫Æ.h
"

63 #ifde‡
HAVE_SERVER_SUPPORT


80 
	$ldlm_öodebôs_com∑t_queue
(
li°_hód
 *
queue
, 
ldlm_lock
 *
ªq
,

81 
li°_hód
 *
w‹k_li°
)

83 
li°_hód
 *
tmp
;

84 
ldlm_lock
 *
lock
;

85 
__u64
 
ªq_bôs
 = 
ªq
->
l_pﬁicy_d©a
.
l_öodebôs
.
bôs
;

86 
com∑t
 = 1;

87 
ENTRY
;

91 
	`LASSERT
(
ªq_bôs
 != 0);

93 
	`li°_f‹_óch
(
tmp
, 
queue
) {

94 
li°_hód
 *
mode_èû
;

96 
lock
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
, 
l_ªs_lök
);

101 i‡(
ªq
 =
lock
)

102 
	`RETURN
(
com∑t
);

105 
	`LASSERT
(
lock
->
l_¶_mode
.
¥ev
 !
NULL
);

106 
mode_èû
 = &
	`li°_íåy
(
lock
->
l_¶_mode
.
¥ev
,

107 
ldlm_lock
,

108 
l_¶_mode
)->
l_ªs_lök
;

113 i‡(
lock
->
l_ªq_mode
 =
LCK_COS
 && !
	`ldlm_is_cos_öcom∑t
(
ªq
) &&

114 !
	`ldlm_is_cos_íabÀd
(
ªq
)) {

116 
tmp
 = 
mode_èû
;

121 i‡(
	`lockmode_com∑t
(
lock
->
l_ªq_mode
, 
ªq
->l_req_mode)) {

123 
tmp
 = 
mode_èû
;

128 
li°_hód
 *
hód
;

131 
tmp
 = &
	`li°_íåy
(
lock
->
l_¶_pﬁicy
.
¥ev
,

132 
ldlm_lock
,

133 
l_¶_pﬁicy
)->
l_ªs_lök
;

136 i‡(
lock
->
l_pﬁicy_d©a
.
l_öodebôs
.
bôs
 & 
ªq_bôs
) {

140 i‡(
lock
->
l_ªq_mode
 =
LCK_COS
 &&

141 !
	`ldlm_is_cos_öcom∑t
(
ªq
) &&

142 
	`ldlm_is_cos_íabÀd
(
ªq
) &&

143 
lock
->
l_˛õ¡_cookõ
 =
ªq
->l_client_cookie)

144 
nŸ_c⁄Êi˘ög
;

146 i‡(!
w‹k_li°
)

147 
	`RETURN
(0);

149 
com∑t
 = 0;

153 i‡(
lock
->
l_blockög_a°
)

154 
	`ldlm_add_a°_w‹k_ôem
(
lock
, 
ªq
,

155 
w‹k_li°
);

156 
hód
 = &
lock
->
l_¶_pﬁicy
;

157 
	`li°_f‹_óch_íåy
(
lock
, 
hód
, 
l_¶_pﬁicy
)

158 i‡(
lock
->
l_blockög_a°
)

159 
	`ldlm_add_a°_w‹k_ôem
(
lock
, 
ªq
,

160 
w‹k_li°
);

162 
nŸ_c⁄Êi˘ög
:

163 i‡(
tmp
 =
mode_èû
)

166 
tmp
 =Åmp->
√xt
;

167 
lock
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
,

168 
l_ªs_lök
);

172 
	`RETURN
(
com∑t
);

173 
	}
}

190 
	$ldlm_¥o˚ss_öodebôs_lock
(
ldlm_lock
 *
lock
, 
__u64
 *
Êags
,

191 
fú°_íq
, 
ldlm_îr‹
 *
îr
,

192 
li°_hód
 *
w‹k_li°
)

194 
ldlm_ªsour˚
 *
ªs
 = 
lock
->
l_ªsour˚
;

195 
li°_hód
 
Ωc_li°
;

196 
rc
;

197 
ENTRY
;

199 
	`LASSERT
(
lock
->
l_gø¡ed_mode
 !lock->
l_ªq_mode
);

200 
	`LASSERT
(
	`li°_em±y
(&
ªs
->
Ã_c⁄vîtög
));

201 
	`INIT_LIST_HEAD
(&
Ωc_li°
);

202 
	`check_ªs_locked
(
ªs
);

205 i‡(!
fú°_íq
 || (*
Êags
 & 
LDLM_FL_BLOCK_NOWAIT
)) {

206 *
îr
 = 
ELDLM_LOCK_ABORTED
;

207 i‡(*
Êags
 & 
LDLM_FL_BLOCK_NOWAIT
)

208 *
îr
 = 
ELDLM_LOCK_WOULDBLOCK
;

210 
rc
 = 
	`ldlm_öodebôs_com∑t_queue
(&
ªs
->
Ã_gø¡ed
, 
lock
, 
NULL
);

211 i‡(!
rc
)

212 
	`RETURN
(
LDLM_ITER_STOP
);

213 
rc
 = 
	`ldlm_öodebôs_com∑t_queue
(&
ªs
->
Ã_waôög
, 
lock
, 
NULL
);

214 i‡(!
rc
)

215 
	`RETURN
(
LDLM_ITER_STOP
);

217 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

218 
	`ldlm_gø¡_lock
(
lock
, 
w‹k_li°
);

220 *
îr
 = 
ELDLM_OK
;

221 
	`RETURN
(
LDLM_ITER_CONTINUE
);

224 
ª°¨t
:

225 
rc
 = 
	`ldlm_öodebôs_com∑t_queue
(&
ªs
->
Ã_gø¡ed
, 
lock
, &
Ωc_li°
);

226 
rc
 +
	`ldlm_öodebôs_com∑t_queue
(&
ªs
->
Ã_waôög
, 
lock
, &
Ωc_li°
);

228 i‡(
rc
 != 2) {

235 i‡(
	`li°_em±y
(&
lock
->
l_ªs_lök
))

236 
	`ldlm_ªsour˚_add_lock
(
ªs
, &ªs->
Ã_waôög
, 
lock
);

237 
	`u∆ock_ªs
(
ªs
);

238 
rc
 = 
	`ldlm_run_a°_w‹k
(
	`ldlm_ªs_to_ns
(
ªs
), &
Ωc_li°
,

239 
LDLM_WORK_BL_AST
);

240 
	`lock_ªs
(
ªs
);

241 i‡(
rc
 =-
ERESTART
)

242 
	`GOTO
(
ª°¨t
, 
rc
);

243 *
Êags
 |
LDLM_FL_BLOCK_GRANTED
;

245 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

246 
	`ldlm_gø¡_lock
(
lock
, 
NULL
);

248 
	`RETURN
(0);

249 
	}
}

252 
	$ldlm_ibôs_pﬁicy_wúe_to_loˇl
(c⁄° 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
,

253 
ldlm_pﬁicy_d©a
 *
Õﬁicy
)

255 
	`mem£t
(
Õﬁicy
, 0, (*lpolicy));

256 
Õﬁicy
->
l_öodebôs
.
bôs
 = 
wpﬁicy
->l_inodebits.bits;

257 
	}
}

259 
	$ldlm_ibôs_pﬁicy_loˇl_to_wúe
(c⁄° 
ldlm_pﬁicy_d©a
 *
Õﬁicy
,

260 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
)

262 
	`mem£t
(
wpﬁicy
, 0, (*wpolicy));

263 
wpﬁicy
->
l_öodebôs
.
bôs
 = 
Õﬁicy
->l_inodebits.bits;

264 
	}
}

	@ldlm_internal.h

37 
	#MAX_STRING_SIZE
 128

	)

39 
ldlm_§v_«me•a˚_ƒ
;

40 
ldlm_˛i_«me•a˚_ƒ
;

41 
muãx
 
ldlm_§v_«me•a˚_lock
;

42 
li°_hód
 
ldlm_§v_«me•a˚_li°
;

43 
muãx
 
ldlm_˛i_«me•a˚_lock
;

44 
li°_hód
 
ldlm_˛i_a˘ive_«me•a˚_li°
;

45 
li°_hód
 
ldlm_˛i_öa˘ive_«me•a˚_li°
;

46 
ldlm_ˇn˚l_unu£d_locks_bef‹e_ª∂ay
;

48 
ölöe
 
	$ldlm_«me•a˚_ƒ_ªad
(
ldlm_side
 
˛õ¡
)

50  
˛õ¡
 =
LDLM_NAMESPACE_SERVER
 ?

51 
ldlm_§v_«me•a˚_ƒ
 : 
ldlm_˛i_«me•a˚_ƒ
;

52 
	}
}

54 
ölöe
 
	$ldlm_«me•a˚_ƒ_öc
(
ldlm_side
 
˛õ¡
)

56 i‡(
˛õ¡
 =
LDLM_NAMESPACE_SERVER
)

57 
ldlm_§v_«me•a˚_ƒ
++;

59 
ldlm_˛i_«me•a˚_ƒ
++;

60 
	}
}

62 
ölöe
 
	$ldlm_«me•a˚_ƒ_dec
(
ldlm_side
 
˛õ¡
)

64 i‡(
˛õ¡
 =
LDLM_NAMESPACE_SERVER
)

65 
ldlm_§v_«me•a˚_ƒ
--;

67 
ldlm_˛i_«me•a˚_ƒ
--;

68 
	}
}

70 
ölöe
 
li°_hód
 *
	$ldlm_«me•a˚_li°
(
ldlm_side
 
˛õ¡
)

72  
˛õ¡
 =
LDLM_NAMESPACE_SERVER
 ?

73 &
ldlm_§v_«me•a˚_li°
 : &
ldlm_˛i_a˘ive_«me•a˚_li°
;

74 
	}
}

76 
ölöe


77 
li°_hód
 *
	$ldlm_«me•a˚_öa˘ive_li°
(
ldlm_side
 
˛õ¡
)

79  
˛õ¡
 =
LDLM_NAMESPACE_SERVER
 ?

80 &
ldlm_§v_«me•a˚_li°
 : &
ldlm_˛i_öa˘ive_«me•a˚_li°
;

81 
	}
}

83 
ölöe
 
muãx
 *
	$ldlm_«me•a˚_lock
(
ldlm_side
 
˛õ¡
)

85  
˛õ¡
 =
LDLM_NAMESPACE_SERVER
 ?

86 &
ldlm_§v_«me•a˚_lock
 : &
ldlm_˛i_«me•a˚_lock
;

87 
	}
}

90 
ölöe
 
	$ldlm_ns_em±y
(
ldlm_«me•a˚
 *
ns
)

92  
	`©omic_ªad
(&
ns
->
ns_bªf
) == 0;

93 
	}
}

95 
ldlm_«me•a˚_move_to_a˘ive_locked
(
ldlm_«me•a˚
 *,

96 
ldlm_side
);

97 
ldlm_«me•a˚_move_to_öa˘ive_locked
(
ldlm_«me•a˚
 *,

98 
ldlm_side
);

99 
ldlm_«me•a˚
 *
ldlm_«me•a˚_fú°_locked
(
ldlm_side
);

103 
	eldlm_Ãu_Êags
 {

104 
	mLDLM_LRU_FLAG_AGED
 = 0x01,

105 
	mLDLM_LRU_FLAG_PASSED
 = 0x02,

106 
	mLDLM_LRU_FLAG_SHRINK
 = 0x04,

107 
	mLDLM_LRU_FLAG_LRUR
 = 0x08,

108 
	mLDLM_LRU_FLAG_NO_WAIT
 = 0x10,

110 
	mLDLM_LRU_FLAG_LRUR_NO_WAIT
 = 0x20,

113 
ldlm_ˇn˚l_Ãu
(
ldlm_«me•a˚
 *
ns
, 
ƒ
,

114 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
,

115 
ldlm_Ãu_Êags
 
Ãu_Êags
);

116 
ldlm_ˇn˚l_Ãu_loˇl
(
ldlm_«me•a˚
 *
ns
,

117 
li°_hód
 *
ˇn˚ls
, 
cou¡
, 
max
,

118 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
,

119 
ldlm_Ãu_Êags
 
Ãu_Êags
);

120 
ldlm_íqueue_mö
;

122 
kmem_ˇche
 *
ldlm_ªsour˚_¶ab
;

123 
kmem_ˇche
 *
ldlm_lock_¶ab
;

124 
kmem_ˇche
 *
ldlm_öãrvÆ_åì_¶ab
;

126 
ldlm_ªsour˚_puåef_locked
(
ldlm_ªsour˚
 *
ªs
);

127 
ldlm_ªsour˚_ö£π_lock_a·î
(
ldlm_lock
 *
‹igöÆ
,

128 
ldlm_lock
 *
√w
);

132 
	sldlm_cb_£t_¨g
 {

133 
±Ãpc_ªque°_£t
 *
	m£t
;

134 
	mty≥
;

135 
©omic_t
 
	mª°¨t
;

136 
li°_hód
 *
	mli°
;

137 
ldlm_gl_desc
 *
	mgl_desc
;

141 
	mLDLM_WORK_BL_AST
,

142 
	mLDLM_WORK_CP_AST
,

143 
	mLDLM_WORK_REVOKE_AST
,

144 
	mLDLM_WORK_GL_AST


145 } 
	tldlm_desc_a°_t
;

147 
ldlm_gø¡_lock
(
ldlm_lock
 *
lock
, 
li°_hód
 *
w‹k_li°
);

148 
ldlm_fûl_lvb
(
ldlm_lock
 *
lock
, 
ªq_ˇpsuÀ
 *
pûl
,

149 
ªq_loˇti⁄
 
loc
, *
d©a
, 
size
);

150 
ldlm_lock
 *

151 
ldlm_lock_¸óã
(
ldlm_«me•a˚
 *
ns
, c⁄° 
ldlm_ªs_id
 *,

152 
ldlm_ty≥
 
ty≥
, 
ldlm_mode
 
mode
,

153 c⁄° 
ldlm_ˇŒback_suôe
 *
cbs
,

154 *
d©a
, 
__u32
 
lvb_Àn
, 
lvb_ty≥
Üvb_type);

155 
ldlm_îr‹
 
ldlm_lock_íqueue
(
ldlm_«me•a˚
 *, 
ldlm_lock
 **,

156 *
cookõ
, 
__u64
 *
Êags
);

157 
ldlm_lock_addªf_öã∫Æ
(
ldlm_lock
 *, 
ldlm_mode
 
mode
);

158 
ldlm_lock_addªf_öã∫Æ_nﬁock
(
ldlm_lock
 *, 
ldlm_mode
 
mode
);

159 
ldlm_lock_de¸ef_öã∫Æ
(
ldlm_lock
 *, 
ldlm_mode
 
mode
);

160 
ldlm_lock_de¸ef_öã∫Æ_nﬁock
(
ldlm_lock
 *, 
ldlm_mode
 
mode
);

161 
ldlm_add_a°_w‹k_ôem
(
ldlm_lock
 *
lock
, ldlm_lock *
√w
,

162 
li°_hód
 *
w‹k_li°
);

163 #ifde‡
HAVE_SERVER_SUPPORT


164 
ldlm_ª¥o˚ss_queue
(
ldlm_ªsour˚
 *
ªs
, 
li°_hód
 *
queue
,

165 
li°_hód
 *
w‹k_li°
);

167 
ldlm_run_a°_w‹k
(
ldlm_«me•a˚
 *
ns
, 
li°_hód
 *
Ωc_li°
,

168 
ldlm_desc_a°_t
 
a°_ty≥
);

169 
ldlm_w‹k_gl_a°_lock
(
±Ãpc_ªque°_£t
 *
rq£t
, *
›aq
);

170 
ldlm_lock_ªmove_‰om_Ãu_check
(
ldlm_lock
 *
lock
,

171 
cfs_time_t
 
œ°_u£
);

172 
	#ldlm_lock_ªmove_‰om_Ãu
(
lock
Ë
	`ldlm_lock_ªmove_‰om_Ãu_check
÷ock, 0)

	)

173 
ldlm_lock_ªmove_‰om_Ãu_nﬁock
(
ldlm_lock
 *
lock
);

174 
ldlm_lock_add_to_Ãu_nﬁock
(
ldlm_lock
 *
lock
);

175 
ldlm_lock_add_to_Ãu
(
ldlm_lock
 *
lock
);

176 
ldlm_lock_touch_ö_Ãu
(
ldlm_lock
 *
lock
);

177 
ldlm_lock_de°roy_nﬁock
(
ldlm_lock
 *
lock
);

179 
ldlm_exp‹t_ˇn˚l_blocked_locks
(
obd_exp‹t
 *
exp
);

180 
ldlm_exp‹t_ˇn˚l_locks
(
obd_exp‹t
 *
exp
);

183 
ldlm_bl_to_thªad_lock
(
ldlm_«me•a˚
 *
ns
, 
ldlm_lock_desc
 *
ld
,

184 
ldlm_lock
 *
lock
);

185 
ldlm_bl_to_thªad_li°
(
ldlm_«me•a˚
 *
ns
,

186 
ldlm_lock_desc
 *
ld
,

187 
li°_hód
 *
ˇn˚ls
, 
cou¡
,

188 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
);

189 
ldlm_bl_thªad_wakeup
();

191 
ldlm_h™dÀ_bl_ˇŒback
(
ldlm_«me•a˚
 *
ns
,

192 
ldlm_lock_desc
 *
ld
, 
ldlm_lock
 *
lock
);

194 #ifde‡
HAVE_SERVER_SUPPORT


196 
ldlm_¥o˚ss_∂aö_lock
(
ldlm_lock
 *
lock
, 
__u64
 *
Êags
,

197 
fú°_íq
, 
ldlm_îr‹
 *
îr
,

198 
li°_hód
 *
w‹k_li°
);

201 
ldlm_¥o˚ss_öodebôs_lock
(
ldlm_lock
 *
lock
, 
__u64
 *
Êags
,

202 
fú°_íq
, 
ldlm_îr‹
 *
îr
,

203 
li°_hód
 *
w‹k_li°
);

207 #ifde‡
HAVE_SERVER_SUPPORT


208 
ldlm_¥o˚ss_exã¡_lock
(
ldlm_lock
 *
lock
, 
__u64
 *
Êags
,

209 
fú°_íq
, 
ldlm_îr‹
 *
îr
,

210 
li°_hód
 *
w‹k_li°
);

212 
ldlm_exã¡_add_lock
(
ldlm_ªsour˚
 *
ªs
, 
ldlm_lock
 *
lock
);

213 
ldlm_exã¡_u∆ök_lock
(
ldlm_lock
 *
lock
);

216 
ldlm_¥o˚ss_Êock_lock
(
ldlm_lock
 *
ªq
, 
__u64
 *
Êags
,

217 
fú°_íq
, 
ldlm_îr‹
 *
îr
,

218 
li°_hód
 *
w‹k_li°
);

219 
ldlm_öô_Êock_exp‹t
(
obd_exp‹t
 *
exp
);

220 
ldlm_de°roy_Êock_exp‹t
(
obd_exp‹t
 *
exp
);

223 
l_check_ns_lock
(
ldlm_«me•a˚
 *
ns
);

224 
l_check_no_ns_lock
(
ldlm_«me•a˚
 *
ns
);

226 
¥oc_dú_íåy
 *
ldlm_svc_¥oc_dú
;

228 
	sldlm_°©e
 {

229 
±Ãpc_£rvi˚
 *
	mldlm_cb_£rvi˚
;

230 
±Ãpc_£rvi˚
 *
	mldlm_ˇn˚l_£rvi˚
;

231 
±Ãpc_˛õ¡
 *
	mldlm_˛õ¡
;

232 
±Ãpc_c⁄√˘i⁄
 *
	mldlm_£rvî_c⁄n
;

233 
ldlm_bl_poﬁ
 *
	mldlm_bl_poﬁ
;

237 
kmem_ˇche
 *
ldlm_öãrvÆ_¶ab
;

238 
ldlm_öãrvÆ_©èch
(
ldlm_öãrvÆ
 *
n
, 
ldlm_lock
 *
l
);

239 
ldlm_öãrvÆ
 *
ldlm_öãrvÆ_dëach
(
ldlm_lock
 *
l
);

240 
ldlm_öãrvÆ
 *
ldlm_öãrvÆ_Æloc
(
ldlm_lock
 *
lock
);

241 
ldlm_öãrvÆ_‰ì
(
ldlm_öãrvÆ
 *
node
);

243 
ölöe
 
ldlm_exã¡
 *

244 
	$ldlm_öãrvÆ_exã¡
(
ldlm_öãrvÆ
 *
node
)

246 
ldlm_lock
 *
lock
;

247 
	`LASSERT
(!
	`li°_em±y
(&
node
->
li_group
));

249 
lock
 = 
	`li°_íåy
(
node
->
li_group
.
√xt
, 
ldlm_lock
,

250 
l_¶_pﬁicy
);

251  &
lock
->
l_pﬁicy_d©a
.
l_exã¡
;

252 
	}
}

254 
ldlm_öô
();

255 
ldlm_exô
();

257 
	eldlm_pﬁicy_ªs
 {

258 
	mLDLM_POLICY_CANCEL_LOCK
,

259 
	mLDLM_POLICY_KEEP_LOCK
,

260 
	mLDLM_POLICY_SKIP_LOCK


263 
	#LDLM_POOL_PROC_READER_SEQ_SHOW
(
v¨
, 
ty≥
) \

264 
Õrocfs_
##
v¨
##
	`_£q_show
(
£q_fûe
 *
m
, *
v
)\

266 
ldlm_poﬁ
 *
∂
 = 
m
->
¥iv©e
; \

267 
ty≥
 
tmp
; \

269 
	`•ö_lock
(&
∂
->
∂_lock
); \

270 
tmp
 = 
∂
->
∂_
##
v¨
; \

271 
	`•ö_u∆ock
(&
∂
->
∂_lock
); \

273  
	`Õrocfs_uöt_£q_show
(
m
, &
tmp
); \

275 
__
##
v¨
##
__dummy_ªad
 {;}

	)

277 
	#LDLM_POOL_PROC_WRITER
(
v¨
, 
ty≥
) \

278 
Õrocfs_wr_
##
	`v¨
(
fûe
 *file, \

279 c⁄° 
__u£r
 *
buf„r
, \

280 
cou¡
, *
d©a
) \

282 
ldlm_poﬁ
 *
∂
 = 
d©a
; \

283 
ty≥
 
tmp
; \

284 
rc
; \

286 
rc
 = 
	`Õrocfs_wr_uöt
(
fûe
, 
buf„r
, 
cou¡
, &
tmp
); \

287 i‡(
rc
 < 0) { \

288 
	`CERROR
("C™'à∑r£ u£∏öput,Ñ¯%d\n", 
rc
);\

289  
rc
; \

292 
	`•ö_lock
(&
∂
->
∂_lock
); \

293 
∂
->
∂_
##
v¨
 = 
tmp
; \

294 
	`•ö_u∆ock
(&
∂
->
∂_lock
); \

296  
rc
; \

298 
__
##
v¨
##
__dummy_wrôe
 {;}

	)

300 
ölöe
 

301 
	$ldlm_add_v¨
(
Õrocfs_v¨s
 *
v¨s
, 
¥oc_dú_íåy
 *
¥oc_dú
,

302 c⁄° *
«me
, *
d©a
, c⁄° 
fûe_›î©i⁄s
 *
›s
)

304 
	`¢¥ötf
((*)
v¨s
->
«me
, 
MAX_STRING_SIZE
, "%s",Çame);

305 
v¨s
->
d©a
 = data;

306 
v¨s
->
f›s
 = 
›s
;

307 
	`Õrocfs_add_v¨s
(
¥oc_dú
, 
v¨s
, 
NULL
);

308 
	}
}

310 
ölöe
 
	$is_gø¡ed_‹_ˇn˚Œed
(
ldlm_lock
 *
lock
)

312 
ªt
 = 0;

314 
	`lock_ªs_™d_lock
(
lock
);

315 i‡((
lock
->
l_ªq_mode
 =lock->
l_gø¡ed_mode
) &&

316 !
	`ldlm_is_˝_ªqd
(
lock
))

317 
ªt
 = 1;

318 i‡(
	`ldlm_is_Áûed
(
lock
Ë|| 
	`ldlm_is_ˇn˚l
(lock))

319 
ªt
 = 1;

320 
	`u∆ock_ªs_™d_lock
(
lock
);

322  
ªt
;

323 
	}
}

325 (*
	tldlm_pﬁicy_wúe_to_loˇl_t
)(c⁄° 
	tldlm_wúe_pﬁicy_d©a
 *,

326 
	tldlm_pﬁicy_d©a
 *);

327 (*
	tldlm_pﬁicy_loˇl_to_wúe_t
)(c⁄° 
	tldlm_pﬁicy_d©a
 *,

328 
	tldlm_wúe_pﬁicy_d©a
 *);

329 
	`ldlm_∂aö_pﬁicy_wúe_to_loˇl
(c⁄° 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
,

330 
ldlm_pﬁicy_d©a
 *
Õﬁicy
);

331 
	`ldlm_∂aö_pﬁicy_loˇl_to_wúe
(c⁄° 
ldlm_pﬁicy_d©a
 *
Õﬁicy
,

332 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
);

333 
	`ldlm_ibôs_pﬁicy_wúe_to_loˇl
(c⁄° 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
,

334 
ldlm_pﬁicy_d©a
 *
Õﬁicy
);

335 
	`ldlm_ibôs_pﬁicy_loˇl_to_wúe
(c⁄° 
ldlm_pﬁicy_d©a
 *
Õﬁicy
,

336 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
);

337 
	`ldlm_exã¡_pﬁicy_wúe_to_loˇl
(c⁄° 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
,

338 
ldlm_pﬁicy_d©a
 *
Õﬁicy
);

339 
	`ldlm_exã¡_pﬁicy_loˇl_to_wúe
(c⁄° 
ldlm_pﬁicy_d©a
 *
Õﬁicy
,

340 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
);

341 
	`ldlm_Êock_pﬁicy_wúe_to_loˇl
(c⁄° 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
,

342 
ldlm_pﬁicy_d©a
 *
Õﬁicy
);

343 
	`ldlm_Êock_pﬁicy_loˇl_to_wúe
(c⁄° 
ldlm_pﬁicy_d©a
 *
Õﬁicy
,

344 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
);

347 #ifde‡
HAVE_SERVER_SUPPORT


348 
__u64
 
ldlm_ª˛aim_thªshﬁd
;

349 
__u64
 
ldlm_lock_limô
;

350 
__u64
 
ldlm_ª˛aim_thªshﬁd_mb
;

351 
__u64
 
ldlm_lock_limô_mb
;

352 
≥r˝u_cou¡î
 
ldlm_gø¡ed_tŸÆ
;

354 
	`ldlm_ª˛aim_£tup
();

355 
	`ldlm_ª˛aim_˛ónup
();

356 
	`ldlm_ª˛aim_add
(
ldlm_lock
 *
lock
);

357 
	`ldlm_ª˛aim_dñ
(
ldlm_lock
 *
lock
);

358 
boﬁ
 
	`ldlm_ª˛aim_fuŒ
();

	@ldlm_lib.c

44 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

46 
	~<löux/kthªad.h
>

47 
	~<libcfs/libcfs.h
>

48 
	~<obd.h
>

49 
	~<obd_˛ass.h
>

50 
	~<lu°ª_dlm.h
>

51 
	~<lu°ª_√t.h
>

52 
	~<lu°ª_£c.h
>

53 
	~"ldlm_öã∫Æ.h
"

58 
	$imp‹t_£t_c⁄n
(
obd_imp‹t
 *
imp
, 
obd_uuid
 *
uuid
,

59 
¥i‹ôy
, 
¸óã
)

61 
±Ãpc_c⁄√˘i⁄
 *
±Ãpc_c⁄n
;

62 
obd_imp‹t_c⁄n
 *
imp_c⁄n
 = 
NULL
, *
ôem
;

63 
rc
 = 0;

64 
ENTRY
;

66 i‡(!
¸óã
 && !
¥i‹ôy
) {

67 
	`CDEBUG
(
D_HA
, "NothingÅo do\n");

68 
	`RETURN
(-
EINVAL
);

71 
±Ãpc_c⁄n
 = 
	`±Ãpc_uuid_to_c⁄√˘i⁄
(
uuid
);

72 i‡(!
±Ãpc_c⁄n
) {

73 
	`CDEBUG
(
D_HA
, "ˇn'àföd c⁄√˘i⁄ %s\n", 
uuid
->uuid);

74 
	`RETURN
 (-
ENOENT
);

77 i‡(
¸óã
) {

78 
	`OBD_ALLOC
(
imp_c⁄n
, (*imp_conn));

79 i‡(!
imp_c⁄n
) {

80 
	`GOTO
(
out_put
, 
rc
 = -
ENOMEM
);

84 
	`•ö_lock
(&
imp
->
imp_lock
);

85 
	`li°_f‹_óch_íåy
(
ôem
, &
imp
->
imp_c⁄n_li°
, 
oic_ôem
) {

86 i‡(
	`obd_uuid_equÆs
(
uuid
, &
ôem
->
oic_uuid
)) {

87 i‡(
¥i‹ôy
) {

88 
	`li°_dñ
(&
ôem
->
oic_ôem
);

89 
	`li°_add
(&
ôem
->
oic_ôem
,

90 &
imp
->
imp_c⁄n_li°
);

91 
ôem
->
oic_œ°_©ãm±
 = 0;

93 
	`CDEBUG
(
D_HA
, "imp %p@%s: foundÉxisting conn %s%s\n",

94 
imp
, imp->
imp_obd
->
obd_«me
, 
uuid
->uuid,

95 (
¥i‹ôy
 ? ", movedÅo head" : ""));

96 
	`•ö_u∆ock
(&
imp
->
imp_lock
);

97 
	`GOTO
(
out_‰ì
, 
rc
 = 0);

101 i‡(
¸óã
) {

102 
imp_c⁄n
->
oic_c⁄n
 = 
±Ãpc_c⁄n
;

103 
imp_c⁄n
->
oic_uuid
 = *
uuid
;

104 
imp_c⁄n
->
oic_œ°_©ãm±
 = 0;

105 i‡(
¥i‹ôy
)

106 
	`li°_add
(&
imp_c⁄n
->
oic_ôem
, &
imp
->
imp_c⁄n_li°
);

108 
	`li°_add_èû
(&
imp_c⁄n
->
oic_ôem
,

109 &
imp
->
imp_c⁄n_li°
);

110 
	`CDEBUG
(
D_HA
, "imp %p@%s:ádd connection %sát %s\n",

111 
imp
, imp->
imp_obd
->
obd_«me
, 
uuid
->uuid,

112 (
¥i‹ôy
 ? "head" : "tail"));

114 
	`•ö_u∆ock
(&
imp
->
imp_lock
);

115 
	`GOTO
(
out_‰ì
, 
rc
 = -
ENOENT
);

118 
	`•ö_u∆ock
(&
imp
->
imp_lock
);

119 
	`RETURN
(0);

120 
out_‰ì
:

121 i‡(
imp_c⁄n
)

122 
	`OBD_FREE
(
imp_c⁄n
, (*imp_conn));

123 
out_put
:

124 
	`±Ãpc_c⁄√˘i⁄_put
(
±Ãpc_c⁄n
);

125 
	`RETURN
(
rc
);

126 
	}
}

128 
	$imp‹t_£t_c⁄n_¥i‹ôy
(
obd_imp‹t
 *
imp
, 
obd_uuid
 *
uuid
)

130  
	`imp‹t_£t_c⁄n
(
imp
, 
uuid
, 1, 0);

131 
	}
}

133 
	$˛õ¡_imp‹t_add_c⁄n
(
obd_imp‹t
 *
imp
, 
obd_uuid
 *
uuid
,

134 
¥i‹ôy
)

136  
	`imp‹t_£t_c⁄n
(
imp
, 
uuid
, 
¥i‹ôy
, 1);

137 
	}
}

138 
EXPORT_SYMBOL
(
˛õ¡_imp‹t_add_c⁄n
);

140 
	$˛õ¡_imp‹t_dñ_c⁄n
(
obd_imp‹t
 *
imp
, 
obd_uuid
 *
uuid
)

142 
obd_imp‹t_c⁄n
 *
imp_c⁄n
;

143 
obd_exp‹t
 *
dlmexp
;

144 
rc
 = -
ENOENT
;

145 
ENTRY
;

147 
	`•ö_lock
(&
imp
->
imp_lock
);

148 i‡(
	`li°_em±y
(&
imp
->
imp_c⁄n_li°
)) {

149 
	`LASSERT
(!
imp
->
imp_c⁄√˘i⁄
);

150 
	`GOTO
(
out
, 
rc
);

153 
	`li°_f‹_óch_íåy
(
imp_c⁄n
, &
imp
->
imp_c⁄n_li°
, 
oic_ôem
) {

154 i‡(!
	`obd_uuid_equÆs
(
uuid
, &
imp_c⁄n
->
oic_uuid
))

156 
	`LASSERT
(
imp_c⁄n
->
oic_c⁄n
);

158 i‡(
imp_c⁄n
 =
imp
->
imp_c⁄n_cuºít
) {

159 
	`LASSERT
(
imp_c⁄n
->
oic_c⁄n
 =
imp
->
imp_c⁄√˘i⁄
);

161 i‡(
imp
->
imp_°©e
 !
LUSTRE_IMP_CLOSED
 &&

162 
imp
->
imp_°©e
 !
LUSTRE_IMP_DISCON
) {

163 
	`CERROR
("can'tÑemove current connection\n");

164 
	`GOTO
(
out
, 
rc
 = -
EBUSY
);

167 
	`±Ãpc_c⁄√˘i⁄_put
(
imp
->
imp_c⁄√˘i⁄
);

168 
imp
->
imp_c⁄√˘i⁄
 = 
NULL
;

170 
dlmexp
 = 
	`˛ass_c⁄n2exp‹t
(&
imp
->
imp_dlm_h™dÀ
);

171 i‡(
dlmexp
 && dlmexp->
exp_c⁄√˘i⁄
) {

172 
	`LASSERT
(
dlmexp
->
exp_c⁄√˘i⁄
 ==

173 
imp_c⁄n
->
oic_c⁄n
);

174 
	`±Ãpc_c⁄√˘i⁄_put
(
dlmexp
->
exp_c⁄√˘i⁄
);

175 
dlmexp
->
exp_c⁄√˘i⁄
 = 
NULL
;

179 
	`li°_dñ
(&
imp_c⁄n
->
oic_ôem
);

180 
	`±Ãpc_c⁄√˘i⁄_put
(
imp_c⁄n
->
oic_c⁄n
);

181 
	`OBD_FREE
(
imp_c⁄n
, (*imp_conn));

182 
	`CDEBUG
(
D_HA
, "imp %p@%s:Ñemove connection %s\n",

183 
imp
, imp->
imp_obd
->
obd_«me
, 
uuid
->uuid);

184 
rc
 = 0;

187 
out
:

188 
	`•ö_u∆ock
(&
imp
->
imp_lock
);

189 i‡(
rc
 =-
ENOENT
)

190 
	`CERROR
("c⁄√˘i⁄ %†nŸ found\n", 
uuid
->uuid);

191 
	`RETURN
(
rc
);

192 
	}
}

193 
EXPORT_SYMBOL
(
˛õ¡_imp‹t_dñ_c⁄n
);

199 
	$˛õ¡_imp‹t_föd_c⁄n
(
obd_imp‹t
 *
imp
, 
 ë_nid_t
 
≥î
,

200 
obd_uuid
 *
uuid
)

202 
obd_imp‹t_c⁄n
 *
c⁄n
;

203 
rc
 = -
ENOENT
;

204 
ENTRY
;

206 
	`•ö_lock
(&
imp
->
imp_lock
);

207 
	`li°_f‹_óch_íåy
(
c⁄n
, &
imp
->
imp_c⁄n_li°
, 
oic_ôem
) {

209 i‡(
	`˛ass_check_uuid
(&
c⁄n
->
oic_uuid
, 
≥î
)) {

210 *
uuid
 = 
c⁄n
->
oic_uuid
;

211 
rc
 = 0;

215 
	`•ö_u∆ock
(&
imp
->
imp_lock
);

216 
	`RETURN
(
rc
);

217 
	}
}

218 
EXPORT_SYMBOL
(
˛õ¡_imp‹t_föd_c⁄n
);

220 
	$˛õ¡_de°roy_imp‹t
(
obd_imp‹t
 *
imp
)

224 
	`˛ass_imp‹t_gë
(
imp
);

225 
	`˛ass_de°roy_imp‹t
(
imp
);

226 
	`•éΩc_imp‹t_£c_put
(
imp
);

227 
	`˛ass_imp‹t_put
(
imp
);

228 
	}
}

229 
EXPORT_SYMBOL
(
˛õ¡_de°roy_imp‹t
);

240 
	$osc_⁄_mdt
(*
obd«me
)

242 *
±r
;

244 
±r
 = 
	`°ºchr
(
obd«me
, '-');

245 i‡(
±r
 =
NULL
)

248 i‡(
	`°∫cmp
(
±r
 + 1, "MDT", 3) == 0)

252 
	}
}

261 
	$˛õ¡_obd_£tup
(
obd_devi˚
 *
obddev
, 
lu°ª_cfg
 *
lcfg
)

263 
˛õ¡_obd
 *
˛i
 = &
obddev
->
u
.cli;

264 
obd_imp‹t
 *
imp
;

265 
obd_uuid
 
£rvî_uuid
;

266 
rq_p‹èl
, 
Ω_p‹èl
, 
c⁄√˘_›
;

267 *
«me
 = 
obddev
->
obd_ty≥
->
typ_«me
;

268 
ldlm_ns_ty≥
 
ns_ty≥
 = 
LDLM_NS_TYPE_UNKNOWN
;

269 *
˛i_«me
 = 
	`lu°ª_cfg_buf
(
lcfg
, 0);

270 
rc
;

271 
ENTRY
;

275 i‡(!
	`°rcmp
(
«me
, 
LUSTRE_OSC_NAME
)) {

276 
rq_p‹èl
 = 
OST_REQUEST_PORTAL
;

277 
Ω_p‹èl
 = 
OSC_REPLY_PORTAL
;

278 
c⁄√˘_›
 = 
OST_CONNECT
;

279 
˛i
->
˛_•_me
 = 
LUSTRE_SP_CLI
;

280 
˛i
->
˛_•_to
 = 
LUSTRE_SP_OST
;

281 
ns_ty≥
 = 
LDLM_NS_TYPE_OSC
;

282 } i‡(!
	`°rcmp
(
«me
, 
LUSTRE_MDC_NAME
) ||

283 !
	`°rcmp
(
«me
, 
LUSTRE_LWP_NAME
)) {

284 
rq_p‹èl
 = 
MDS_REQUEST_PORTAL
;

285 
Ω_p‹èl
 = 
MDC_REPLY_PORTAL
;

286 
c⁄√˘_›
 = 
MDS_CONNECT
;

287 i‡(
	`is_lwp_⁄_o°
(
˛i_«me
))

288 
˛i
->
˛_•_me
 = 
LUSTRE_SP_OST
;

289 i‡(
	`is_lwp_⁄_mdt
(
˛i_«me
))

290 
˛i
->
˛_•_me
 = 
LUSTRE_SP_MDT
;

292 
˛i
->
˛_•_me
 = 
LUSTRE_SP_CLI
;

293 
˛i
->
˛_•_to
 = 
LUSTRE_SP_MDT
;

294 
ns_ty≥
 = 
LDLM_NS_TYPE_MDC
;

295 } i‡(!
	`°rcmp
(
«me
, 
LUSTRE_OSP_NAME
)) {

296 i‡(
	`°r°r
(
	`lu°ª_cfg_buf
(
lcfg
, 1), "OST"Ë=
NULL
) {

298 
c⁄√˘_›
 = 
MDS_CONNECT
;

299 
˛i
->
˛_•_to
 = 
LUSTRE_SP_MDT
;

300 
ns_ty≥
 = 
LDLM_NS_TYPE_MDC
;

301 
rq_p‹èl
 = 
OUT_PORTAL
;

304 
c⁄√˘_›
 = 
OST_CONNECT
;

305 
˛i
->
˛_•_to
 = 
LUSTRE_SP_OST
;

306 
ns_ty≥
 = 
LDLM_NS_TYPE_OSC
;

307 
rq_p‹èl
 = 
OST_REQUEST_PORTAL
;

309 
Ω_p‹èl
 = 
OSC_REPLY_PORTAL
;

310 
˛i
->
˛_•_me
 = 
LUSTRE_SP_MDT
;

311 } i‡(!
	`°rcmp
(
«me
, 
LUSTRE_MGC_NAME
)) {

312 
rq_p‹èl
 = 
MGS_REQUEST_PORTAL
;

313 
Ω_p‹èl
 = 
MGC_REPLY_PORTAL
;

314 
c⁄√˘_›
 = 
MGS_CONNECT
;

315 
˛i
->
˛_•_me
 = 
LUSTRE_SP_MGC
;

316 
˛i
->
˛_•_to
 = 
LUSTRE_SP_MGS
;

317 
˛i
->
˛_Êvr_mgc
.
sf_Ωc
 = 
SPTLRPC_FLVR_INVALID
;

318 
ns_ty≥
 = 
LDLM_NS_TYPE_MGC
;

320 
	`CERROR
("unknown client OBDÅype \"%s\", can't setup\n",

321 
«me
);

322 
	`RETURN
(-
EINVAL
);

325 i‡(
	`LUSTRE_CFG_BUFLEN
(
lcfg
, 1) < 1) {

326 
	`CERROR
("requiresá TARGET UUID\n");

327 
	`RETURN
(-
EINVAL
);

330 i‡(
	`LUSTRE_CFG_BUFLEN
(
lcfg
, 1) > 37) {

331 
	`CERROR
("client UUID must beÜessÅhan 38 characters\n");

332 
	`RETURN
(-
EINVAL
);

335 i‡(
	`LUSTRE_CFG_BUFLEN
(
lcfg
, 2) < 1) {

336 
	`CERROR
("setupÑequiresá SERVER UUID\n");

337 
	`RETURN
(-
EINVAL
);

340 i‡(
	`LUSTRE_CFG_BUFLEN
(
lcfg
, 2) > 37) {

341 
	`CERROR
("target UUID must beÜessÅhan 38 characters\n");

342 
	`RETURN
(-
EINVAL
);

345 
	`öô_rw£m
(&
˛i
->
˛_£m
);

346 
	`muãx_öô
(&
˛i
->
˛_mgc_muãx
);

347 
˛i
->
˛_c⁄n_cou¡
 = 0;

348 
	`mem˝y
(
£rvî_uuid
.
uuid
, 
	`lu°ª_cfg_buf
(
lcfg
, 2),

349 
	`mö_t
(, 
	`LUSTRE_CFG_BUFLEN
(
lcfg
, 2),

350 (
£rvî_uuid
)));

352 
˛i
->
˛_dúty_∑ges
 = 0;

353 
˛i
->
˛_avaû_gø¡
 = 0;

357 
	`˛õ¡_adju°_max_dúty
(
˛i
);

358 
	`INIT_LIST_HEAD
(&
˛i
->
˛_ˇche_waôîs
);

359 
	`INIT_LIST_HEAD
(&
˛i
->
˛_loi_ªady_li°
);

360 
	`INIT_LIST_HEAD
(&
˛i
->
˛_loi_hp_ªady_li°
);

361 
	`INIT_LIST_HEAD
(&
˛i
->
˛_loi_wrôe_li°
);

362 
	`INIT_LIST_HEAD
(&
˛i
->
˛_loi_ªad_li°
);

363 
	`•ö_lock_öô
(&
˛i
->
˛_loi_li°_lock
);

364 
	`©omic_£t
(&
˛i
->
˛_≥ndög_w_∑ges
, 0);

365 
	`©omic_£t
(&
˛i
->
˛_≥ndög_r_∑ges
, 0);

366 
˛i
->
˛_r_ö_Êight
 = 0;

367 
˛i
->
˛_w_ö_Êight
 = 0;

369 
	`•ö_lock_öô
(&
˛i
->
˛_ªad_Ωc_hi°
.
oh_lock
);

370 
	`•ö_lock_öô
(&
˛i
->
˛_wrôe_Ωc_hi°
.
oh_lock
);

371 
	`•ö_lock_öô
(&
˛i
->
˛_ªad_∑ge_hi°
.
oh_lock
);

372 
	`•ö_lock_öô
(&
˛i
->
˛_wrôe_∑ge_hi°
.
oh_lock
);

373 
	`•ö_lock_öô
(&
˛i
->
˛_ªad_off£t_hi°
.
oh_lock
);

374 
	`•ö_lock_öô
(&
˛i
->
˛_wrôe_off£t_hi°
.
oh_lock
);

377 
	`INIT_LIST_HEAD
(&
˛i
->
˛_Ãu_osc
);

378 
	`©omic_£t
(&
˛i
->
˛_Ãu_shrökîs
, 0);

379 
	`©omic_l⁄g_£t
(&
˛i
->
˛_Ãu_busy
, 0);

380 
	`©omic_l⁄g_£t
(&
˛i
->
˛_Ãu_ö_li°
, 0);

381 
	`INIT_LIST_HEAD
(&
˛i
->
˛_Ãu_li°
);

382 
	`•ö_lock_öô
(&
˛i
->
˛_Ãu_li°_lock
);

383 
	`©omic_l⁄g_£t
(&
˛i
->
˛_un°abÀ_cou¡
, 0);

384 
	`INIT_LIST_HEAD
(&
˛i
->
˛_shrök_li°
);

386 
	`öô_waôqueue_hód
(&
˛i
->
˛_de°roy_waôq
);

387 
	`©omic_£t
(&
˛i
->
˛_de°roy_ö_Êight
, 0);

388 #ifde‡
ENABLE_CHECKSUM


390 
˛i
->
˛_checksum
 = 1;

396 
˛i
->
˛_cksum_ty≥
 = cli->
˛_suµ_cksum_ty≥s
 = 
OBD_CKSUM_CRC32
;

398 
	`©omic_£t
(&
˛i
->
˛_ª£nds
, 
OSC_DEFAULT_RESENDS
);

404 
˛i
->
˛_max_∑ges_≥r_Ωc
 = 
	`mö_t
(, 
PTLRPC_MAX_BRW_PAGES
,

405 
LNET_MTU
 >> 
PAGE_CACHE_SHIFT
);

409 
˛i
->
˛_chunkbôs
 = 
PAGE_CACHE_SHIFT
;

411 i‡(!
	`°rcmp
(
«me
, 
LUSTRE_MDC_NAME
)) {

412 
˛i
->
˛_max_Ωcs_ö_Êight
 = 
OBD_MAX_RIF_DEFAULT
;

413 } i‡(
tŸÆøm_∑ges
 >> (20 - 
PAGE_CACHE_SHIFT
) <= 128 ) {

414 
˛i
->
˛_max_Ωcs_ö_Êight
 = 2;

415 } i‡(
tŸÆøm_∑ges
 >> (20 - 
PAGE_CACHE_SHIFT
) <= 256 ) {

416 
˛i
->
˛_max_Ωcs_ö_Êight
 = 3;

417 } i‡(
tŸÆøm_∑ges
 >> (20 - 
PAGE_CACHE_SHIFT
) <= 512 ) {

418 
˛i
->
˛_max_Ωcs_ö_Êight
 = 4;

420 i‡(
	`osc_⁄_mdt
(
obddev
->
obd_«me
))

421 
˛i
->
˛_max_Ωcs_ö_Êight
 = 
OBD_MAX_RIF_MAX
;

423 
˛i
->
˛_max_Ωcs_ö_Êight
 = 
OBD_MAX_RIF_DEFAULT
;

426 
	`•ö_lock_öô
(&
˛i
->
˛_mod_Ωcs_lock
);

427 
	`•ö_lock_öô
(&
˛i
->
˛_mod_Ωcs_hi°
.
oh_lock
);

428 
˛i
->
˛_max_mod_Ωcs_ö_Êight
 = 0;

429 
˛i
->
˛_mod_Ωcs_ö_Êight
 = 0;

430 
˛i
->
˛_˛o£_Ωcs_ö_Êight
 = 0;

431 
	`öô_waôqueue_hód
(&
˛i
->
˛_mod_Ωcs_waôq
);

432 
˛i
->
˛_mod_èg_bôm≠
 = 
NULL
;

434 i‡(
c⁄√˘_›
 =
MDS_CONNECT
) {

435 
˛i
->
˛_max_mod_Ωcs_ö_Êight
 = cli->
˛_max_Ωcs_ö_Êight
 - 1;

436 
	`OBD_ALLOC
(
˛i
->
˛_mod_èg_bôm≠
,

437 
	`BITS_TO_LONGS
(
OBD_MAX_RIF_MAX
) * ());

438 i‡(
˛i
->
˛_mod_èg_bôm≠
 =
NULL
)

439 
	`GOTO
(
îr
, 
rc
 = -
ENOMEM
);

442 
rc
 = 
	`ldlm_gë_ªf
();

443 i‡(
rc
) {

444 
	`CERROR
("ldlm_gë_ª‡Áûed: %d\n", 
rc
);

445 
	`GOTO
(
îr
, 
rc
);

448 
	`±Ãpc_öô_˛õ¡
(
rq_p‹èl
, 
Ω_p‹èl
, 
«me
,

449 &
obddev
->
obd_ldlm_˛õ¡
);

451 
imp
 = 
	`˛ass_√w_imp‹t
(
obddev
);

452 i‡(
imp
 =
NULL
)

453 
	`GOTO
(
îr_ldlm
, 
rc
 = -
ENOENT
);

454 
imp
->
imp_˛õ¡
 = &
obddev
->
obd_ldlm_˛õ¡
;

455 
imp
->
imp_c⁄√˘_›
 = 
c⁄√˘_›
;

456 
	`mem˝y
(
˛i
->
˛_èrgë_uuid
.
uuid
, 
	`lu°ª_cfg_buf
(
lcfg
, 1),

457 
	`LUSTRE_CFG_BUFLEN
(
lcfg
, 1));

458 
	`˛ass_imp‹t_put
(
imp
);

460 
rc
 = 
	`˛õ¡_imp‹t_add_c⁄n
(
imp
, &
£rvî_uuid
, 1);

461 i‡(
rc
) {

462 
	`CERROR
("can'tádd initial connection\n");

463 
	`GOTO
(
îr_imp‹t
, 
rc
);

466 
˛i
->
˛_imp‹t
 = 
imp
;

468 
˛i
->
˛_max_mds_ósize
 = (
lov_mds_md_v3
);

470 i‡(
	`LUSTRE_CFG_BUFLEN
(
lcfg
, 3) > 0) {

471 i‡(!
	`°rcmp
(
	`lu°ª_cfg_°rög
(
lcfg
, 3), "inactive")) {

472 
	`CDEBUG
(
D_HA
, "marking %s %s->%sás inactive\n",

473 
«me
, 
obddev
->
obd_«me
,

474 
˛i
->
˛_èrgë_uuid
.
uuid
);

475 
	`•ö_lock
(&
imp
->
imp_lock
);

476 
imp
->
imp_dó˘ive
 = 1;

477 
	`•ö_u∆ock
(&
imp
->
imp_lock
);

481 
obddev
->
obd_«me•a˚
 = 
	`ldlm_«me•a˚_√w
(obddev, obddev->
obd_«me
,

482 
LDLM_NAMESPACE_CLIENT
,

483 
LDLM_NAMESPACE_GREEDY
,

484 
ns_ty≥
);

485 i‡(
obddev
->
obd_«me•a˚
 =
NULL
) {

486 
	`CERROR
("UnableÅo create clientÇamespace - %s\n",

487 
obddev
->
obd_«me
);

488 
	`GOTO
(
îr_imp‹t
, 
rc
 = -
ENOMEM
);

491 
	`RETURN
(
rc
);

493 
îr_imp‹t
:

494 
	`˛ass_de°roy_imp‹t
(
imp
);

495 
îr_ldlm
:

496 
	`ldlm_put_ªf
();

497 
îr
:

498 i‡(
˛i
->
˛_mod_èg_bôm≠
 !
NULL
)

499 
	`OBD_FREE
(
˛i
->
˛_mod_èg_bôm≠
,

500 
	`BITS_TO_LONGS
(
OBD_MAX_RIF_MAX
) * ());

501 
˛i
->
˛_mod_èg_bôm≠
 = 
NULL
;

502 
	`RETURN
(
rc
);

504 
	}
}

505 
EXPORT_SYMBOL
(
˛õ¡_obd_£tup
);

507 
	$˛õ¡_obd_˛ónup
(
obd_devi˚
 *
obddev
)

509 
˛õ¡_obd
 *
˛i
 = &
obddev
->
u
.cli;

510 
ENTRY
;

512 
	`ldlm_«me•a˚_‰ì_po°
(
obddev
->
obd_«me•a˚
);

513 
obddev
->
obd_«me•a˚
 = 
NULL
;

515 
	`obd_˛ónup_˛õ¡_imp‹t
(
obddev
);

516 
	`LASSERT
(
obddev
->
u
.
˛i
.
˛_imp‹t
 =
NULL
);

518 
	`ldlm_put_ªf
();

520 i‡(
˛i
->
˛_mod_èg_bôm≠
 !
NULL
)

521 
	`OBD_FREE
(
˛i
->
˛_mod_èg_bôm≠
,

522 
	`BITS_TO_LONGS
(
OBD_MAX_RIF_MAX
) * ());

523 
˛i
->
˛_mod_èg_bôm≠
 = 
NULL
;

525 
	`RETURN
(0);

526 
	}
}

527 
EXPORT_SYMBOL
(
˛õ¡_obd_˛ónup
);

530 
	$˛õ¡_c⁄√˘_imp‹t
(c⁄° 
lu_ív
 *
ív
,

531 
obd_exp‹t
 **
exp
,

532 
obd_devi˚
 *
obd
, 
obd_uuid
 *
˛uuid
,

533 
obd_c⁄√˘_d©a
 *
d©a
, *
loˇld©a
)

535 
˛õ¡_obd
 *
˛i
 = &
obd
->
u
.cli;

536 
obd_imp‹t
 *
imp
 = 
˛i
->
˛_imp‹t
;

537 
obd_c⁄√˘_d©a
 *
ocd
;

538 
lu°ª_h™dÀ
 
c⁄n
 = { 0 };

539 
rc
;

540 
boﬁ
 
is_mdc
 = 
Ál£
;

541 
ENTRY
;

543 *
exp
 = 
NULL
;

544 
	`down_wrôe
(&
˛i
->
˛_£m
);

545 i‡(
˛i
->
˛_c⁄n_cou¡
 > 0)

546 
	`GOTO
(
out_£m
, 
rc
 = -
EALREADY
);

548 
rc
 = 
	`˛ass_c⁄√˘
(&
c⁄n
, 
obd
, 
˛uuid
);

549 i‡(
rc
)

550 
	`GOTO
(
out_£m
, 
rc
);

552 
˛i
->
˛_c⁄n_cou¡
++;

553 *
exp
 = 
	`˛ass_c⁄n2exp‹t
(&
c⁄n
);

555 
	`LASSERT
(
obd
->
obd_«me•a˚
);

557 
imp
->
imp_dlm_h™dÀ
 = 
c⁄n
;

558 
rc
 = 
	`±Ãpc_öô_imp‹t
(
imp
);

559 i‡(
rc
 != 0)

560 
	`GOTO
(
out_ldlm
, 
rc
);

562 
ocd
 = &
imp
->
imp_c⁄√˘_d©a
;

563 i‡(
d©a
) {

564 *
ocd
 = *
d©a
;

565 
is_mdc
 = 
	`°∫cmp
(
imp
->
imp_obd
->
obd_ty≥
->
typ_«me
,

566 
LUSTRE_MDC_NAME
, 3) == 0;

567 i‡(
is_mdc
)

568 
d©a
->
ocd_c⁄√˘_Êags
 |
OBD_CONNECT_MULTIMODRPCS
;

569 
imp
->
imp_c⁄√˘_Êags_‹ig
 = 
d©a
->
ocd_c⁄√˘_Êags
;

572 
rc
 = 
	`±Ãpc_c⁄√˘_imp‹t
(
imp
);

573 i‡(
rc
 != 0) {

574 
	`LASSERT
 (
imp
->
imp_°©e
 =
LUSTRE_IMP_DISCON
);

575 
	`GOTO
(
out_ldlm
, 
rc
);

577 
	`LASSERT
(*
exp
 !
NULL
 && (*exp)->
exp_c⁄√˘i⁄
);

579 i‡(
d©a
) {

580 
	`LASSERTF
((
ocd
->
ocd_c⁄√˘_Êags
 & 
d©a
->ocd_connect_flags) ==

581 
ocd
->
ocd_c⁄√˘_Êags
, "ﬁd "
LPX64
",Çew "LPX64"\n",

582 
d©a
->
ocd_c⁄√˘_Êags
, 
ocd
->ocd_connect_flags);

583 
d©a
->
ocd_c⁄√˘_Êags
 = 
ocd
->ocd_connect_flags;

586 i‡(
is_mdc
)

587 
d©a
->
ocd_c⁄√˘_Êags
 &~
OBD_CONNECT_MULTIMODRPCS
;

590 
	`±Ãpc_pögî_add_imp‹t
(
imp
);

592 
EXIT
;

594 i‡(
rc
) {

595 
out_ldlm
:

596 
˛i
->
˛_c⁄n_cou¡
--;

597 
	`˛ass_disc⁄√˘
(*
exp
);

598 *
exp
 = 
NULL
;

600 
out_£m
:

601 
	`up_wrôe
(&
˛i
->
˛_£m
);

603  
rc
;

604 
	}
}

605 
EXPORT_SYMBOL
(
˛õ¡_c⁄√˘_imp‹t
);

607 
	$˛õ¡_disc⁄√˘_exp‹t
(
obd_exp‹t
 *
exp
)

609 
obd_devi˚
 *
obd
 = 
	`˛ass_exp2obd
(
exp
);

610 
˛õ¡_obd
 *
˛i
;

611 
obd_imp‹t
 *
imp
;

612 
rc
 = 0, 
îr
;

613 
ENTRY
;

615 i‡(!
obd
) {

616 
	`CERROR
("övÆidÉxp‹àf‹ disc⁄√˘:Éx∞%∞cookõ "
LPX64
"\n",

617 
exp
,Éx∞?Éxp->
exp_h™dÀ
.
h_cookõ
 : -1);

618 
	`RETURN
(-
EINVAL
);

621 
˛i
 = &
obd
->
u
.cli;

622 
imp
 = 
˛i
->
˛_imp‹t
;

624 
	`down_wrôe
(&
˛i
->
˛_£m
);

625 
	`CDEBUG
(
D_INFO
, "disc⁄√˘ %†- %zu\n", 
obd
->
obd_«me
,

626 
˛i
->
˛_c⁄n_cou¡
);

628 i‡(
˛i
->
˛_c⁄n_cou¡
 == 0) {

629 
	`CERROR
("disconnecting disconnected device (%s)\n",

630 
obd
->
obd_«me
);

631 
	`GOTO
(
out_disc⁄√˘
, 
rc
 = -
EINVAL
);

634 
˛i
->
˛_c⁄n_cou¡
--;

635 i‡(
˛i
->
˛_c⁄n_cou¡
 != 0)

636 
	`GOTO
(
out_disc⁄√˘
, 
rc
 = 0);

641 
	`•ö_lock
(&
imp
->
imp_lock
);

642 
imp
->
imp_dó˘ive
 = 1;

643 
	`•ö_u∆ock
(&
imp
->
imp_lock
);

648 ()
	`±Ãpc_pögî_dñ_imp‹t
(
imp
);

650 i‡(
obd
->
obd_«me•a˚
 !
NULL
) {

652 
	`ldlm_˛i_ˇn˚l_unu£d
(
obd
->
obd_«me•a˚
, 
NULL
,

653 
obd
->
obd_f‹˚
 ? 
LCF_LOCAL
 : 0, 
NULL
);

654 
	`ldlm_«me•a˚_‰ì_¥i‹
(
obd
->
obd_«me•a˚
, 
imp
, obd->
obd_f‹˚
);

659 
	`up_wrôe
(&
˛i
->
˛_£m
);

660 
rc
 = 
	`±Ãpc_disc⁄√˘_imp‹t
(
imp
, 0);

661 
	`down_wrôe
(&
˛i
->
˛_£m
);

663 
	`±Ãpc_övÆid©e_imp‹t
(
imp
);

665 
EXIT
;

667 
out_disc⁄√˘
:

670 
îr
 = 
	`˛ass_disc⁄√˘
(
exp
);

671 i‡(!
rc
 && 
îr
)

672 
rc
 = 
îr
;

674 
	`up_wrôe
(&
˛i
->
˛_£m
);

676 
	`RETURN
(
rc
);

677 
	}
}

678 
EXPORT_SYMBOL
(
˛õ¡_disc⁄√˘_exp‹t
);

680 #ifde‡
HAVE_SERVER_SUPPORT


681 
	$£rvî_disc⁄√˘_exp‹t
(
obd_exp‹t
 *
exp
)

683 
rc
;

684 
ENTRY
;

687 
rc
 = 
	`˛ass_disc⁄√˘
(
exp
);

689 i‡(
exp
->
exp_imp_ªvî£
)

690 
	`±Ãpc_˛ónup_imp
(
exp
->
exp_imp_ªvî£
);

692 
	`ldlm_bl_thªad_wakeup
();

695 
	`•ö_lock
(&
exp
->
exp_lock
);

696 !
	`li°_em±y
(&
exp
->
exp_out°™dög_ª∂õs
)) {

697 
±Ãpc_ª∂y_°©e
 *
rs
 =

698 
	`li°_íåy
(
exp
->
exp_out°™dög_ª∂õs
.
√xt
,

699 
±Ãpc_ª∂y_°©e
, 
rs_exp_li°
);

700 
±Ãpc_£rvi˚_∑π
 *
sv˝t
 = 
rs
->
rs_sv˝t
;

702 
	`•ö_lock
(&
sv˝t
->
s˝_ªp_lock
);

704 
	`li°_dñ_öô
(&
rs
->
rs_exp_li°
);

705 
	`•ö_lock
(&
rs
->
rs_lock
);

706 
	`±Ãpc_scheduÀ_difficu…_ª∂y
(
rs
);

707 
	`•ö_u∆ock
(&
rs
->
rs_lock
);

709 
	`•ö_u∆ock
(&
sv˝t
->
s˝_ªp_lock
);

711 
	`•ö_u∆ock
(&
exp
->
exp_lock
);

713 
	`RETURN
(
rc
);

714 
	}
}

715 
EXPORT_SYMBOL
(
£rvî_disc⁄√˘_exp‹t
);

721 
	$èrgë_h™dÀ_ªc⁄√˘
(
lu°ª_h™dÀ
 *
c⁄n
,

722 
obd_exp‹t
 *
exp
,

723 
obd_uuid
 *
˛uuid
)

725 
obd_devi˚
 *
èrgë
;

726 
lu°ª_h™dÀ
 *
hdl
;

727 
cfs_time_t
 
now
;

728 
cfs_time_t
 
dódlöe
;

729 
timeout
;

730 
rc
 = 0;

731 
ENTRY
;

733 
hdl
 = &
exp
->
exp_imp_ªvî£
->
imp_ªmŸe_h™dÀ
;

734 i‡(!
exp
->
exp_c⁄√˘i⁄
 || !
	`lu°ª_h™dÀ_is_u£d
(
hdl
)) {

735 
c⁄n
->
cookõ
 = 
exp
->
exp_h™dÀ
.
h_cookõ
;

736 
	`CDEBUG
(
D_HA
, "connectÉxport for UUID '%s'át %p,"

737 " cookõ "
LPX64
"\n", 
˛uuid
->
uuid
, 
exp
, 
c⁄n
->
cookõ
);

738 
	`RETURN
(0);

741 
èrgë
 = 
exp
->
exp_obd
;

744 i‡(
	`memcmp
(&
c⁄n
->
cookõ
, &
hdl
->cookie,  conn->cookie)) {

745 
	`LCONSOLE_WARN
("%s:álready connected client %s (at %s) "

746 "wôh h™dÀ "
LPX64
". Rejecting client "

748 "wôh h™dÀ "
LPX64
"\n", 
èrgë
->
obd_«me
,

749 
	`obd_uuid2°r
(&
exp
->
exp_˛õ¡_uuid
),

750 
	`obd_exp‹t_nid2°r
(
exp
),

751 
hdl
->
cookõ
, 
c⁄n
->cookie);

752 
	`mem£t
(
c⁄n
, 0,  *conn);

756 
	`RETURN
(-
EALREADY
);

759 i‡(!
èrgë
->
obd_ªcovîög
) {

760 
	`LCONSOLE_WARN
("%s: Client %s (at %s)Ñeconnecting\n",

761 
èrgë
->
obd_«me
, 
	`obd_uuid2°r
(&
exp
->
exp_˛õ¡_uuid
),

762 
	`obd_exp‹t_nid2°r
(
exp
));

763 
	`GOTO
(
out_Æªady
, 
rc
);

766 
now
 = 
	`cfs_time_cuºít
();

767 
dódlöe
 = 
	`cfs_timî_dódlöe
(&
èrgë
->
obd_ªcovîy_timî
);

768 i‡(
	`cfs_time_bef‹e
(
now
, 
dódlöe
)) {

769 
timeout
 = 
	`cfs_duøti⁄_£c
(
	`cfs_time_sub
(
dódlöe
, 
now
));

770 
	`LCONSOLE_WARN
("%s: Client %s (at %s)Ñeconnecting,"

772 " %d:%.02d\n", 
èrgë
->
obd_«me
,

773 
	`obd_uuid2°r
(&
exp
->
exp_˛õ¡_uuid
),

774 
	`obd_exp‹t_nid2°r
(
exp
),

775 
èrgë
->
obd_max_ªcovîabÀ_˛õ¡s
,

776 
timeout
 / 60,Åimeout % 60);

778 
timeout
 = 
	`cfs_duøti⁄_£c
(
	`cfs_time_sub
(
now
, 
dódlöe
));

779 
	`LCONSOLE_WARN
("%s: RecoveryálreadyÖassed deadline"

783 
èrgë
->
obd_«me
, 
timeout
 / 60,Åimeout % 60);

786 
out_Æªady
:

787 
c⁄n
->
cookõ
 = 
exp
->
exp_h™dÀ
.
h_cookõ
;

791 
	`RETURN
(
EALREADY
);

792 
	}
}

794 
	$èrgë_˛õ¡_add_cb
(
obd_devi˚
 *
obd
, 
__u64
 
å™¢o
, *
cb_d©a
,

795 
îr‹
)

797 
obd_exp‹t
 *
exp
 = 
cb_d©a
;

799 
	`CDEBUG
(
D_RPCTRACE
, "%s: committing for initial connect of %s\n",

800 
obd
->
obd_«me
, 
exp
->
exp_˛õ¡_uuid
.
uuid
);

802 
	`•ö_lock
(&
exp
->
exp_lock
);

803 
exp
->
exp_√ed_sync
 = 0;

804 
	`•ö_u∆ock
(&
exp
->
exp_lock
);

805 
	`˛ass_exp‹t_cb_put
(
exp
);

806 
	}
}

809 
check_™d_°¨t_ªcovîy_timî
(
obd_devi˚
 *
obd
,

810 
±Ãpc_ªque°
 *
ªq
, 
√w_˛õ¡
);

815 
	$ªv_imp‹t_Êags_upd©e
(
obd_imp‹t
 *
ªvimp
,

816 
±Ãpc_ªque°
 *
ªq
)

818 
rc
;

819 
obd_c⁄√˘_d©a
 *
d©a
;

821 
d©a
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_CONNECT_DATA
);

823 i‡(
d©a
->
ocd_c⁄√˘_Êags
 & 
OBD_CONNECT_AT
)

824 
ªvimp
->
imp_msghdr_Êags
 |
MSGHDR_AT_SUPPORT
;

826 
ªvimp
->
imp_msghdr_Êags
 &~
MSGHDR_AT_SUPPORT
;

828 
ªvimp
->
imp_msghdr_Êags
 |
MSGHDR_CKSUM_INCOMPAT18
;

830 
rc
 = 
	`•éΩc_imp‹t_£c_ad≠t
(
ªvimp
, 
ªq
->
rq_svc_˘x
, &ªq->
rq_Êvr
);

831 i‡(
rc
) {

832 
	`CERROR
("%s: cannot getÑeverse import %s security:Ñc = %d\n",

833 
ªvimp
->
imp_˛õ¡
->
˛i_«me
,

834 
	`libcfs_id2°r
(
ªq
->
rq_≥î
), 
rc
);

835  
rc
;

839 
	}
}

847 
	$ªv_imp‹t_öô
(
obd_exp‹t
 *
exp‹t
)

849 
obd_devi˚
 *
obd
 = 
exp‹t
->
exp_obd
;

850 
obd_imp‹t
 *
ªvimp
;

852 
	`LASSERT
(
exp‹t
->
exp_imp_ªvî£
 =
NULL
);

854 
ªvimp
 = 
	`˛ass_√w_imp‹t
(
obd
);

855 i‡(
ªvimp
 =
NULL
)

856  -
ENOMEM
;

858 
ªvimp
->
imp_ªmŸe_h™dÀ
.
cookõ
 = 0ULL;

859 
ªvimp
->
imp_˛õ¡
 = &
obd
->
obd_ldlm_˛õ¡
;

860 
ªvimp
->
imp_dlm_Áke
 = 1;

863 
	`•ö_lock
(&
exp‹t
->
exp_lock
);

864 
exp‹t
->
exp_imp_ªvî£
 = 
ªvimp
;

865 
	`•ö_u∆ock
(&
exp‹t
->
exp_lock
);

866 
	`˛ass_imp‹t_put
(
ªvimp
);

869 
	}
}

870 
EXPORT_SYMBOL
(
ªv_imp‹t_öô
);

881 
	$ªv_imp‹t_ªc⁄√˘
(
obd_exp‹t
 *
exp
,

882 
±Ãpc_ªque°
 *
ªq
)

884 
obd_imp‹t
 *
ªvimp
 = 
exp
->
exp_imp_ªvî£
;

885 
lu°ª_h™dÀ
 *
lh
;

886 
rc
;

889 
	`±Ãpc_imp‹t_íãr_ª£nd
(
ªvimp
);

891 i‡(
ªvimp
->
imp_c⁄√˘i⁄
 !
NULL
)

892 
	`±Ãpc_c⁄√˘i⁄_put
(
ªvimp
->
imp_c⁄√˘i⁄
);

899 
lh
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_CONN
);

900 
ªvimp
->
imp_ªmŸe_h™dÀ
 = *
lh
;

904 
ªvimp
->
imp_msg_magic
 = 
ªq
->
rq_ªqmsg
->
lm_magic
;

906 
ªvimp
->
imp_c⁄√˘i⁄
 = 
	`±Ãpc_c⁄√˘i⁄_addªf
(
exp
->
exp_c⁄√˘i⁄
);

908 
rc
 = 
	`ªv_imp‹t_Êags_upd©e
(
ªvimp
, 
ªq
);

909 i‡(
rc
 != 0) {

913  
rc
;

917  
	`±Ãpc_imp‹t_ªcovîy_°©e_machöe
(
ªvimp
);

918 
	}
}

920 
	$èrgë_h™dÀ_c⁄√˘
(
±Ãpc_ªque°
 *
ªq
)

922 
obd_devi˚
 *
èrgë
 = 
NULL
;

923 
obd_exp‹t
 *
exp‹t
 = 
NULL
;

926 
lu°ª_h™dÀ
 
c⁄n
;

927 
lu°ª_h™dÀ
 *
tmp
;

928 
obd_uuid
 
tgtuuid
;

929 
obd_uuid
 
˛uuid
;

930 *
°r
;

931 
rc
 = 0;

932 *
èrgë_°¨t
;

933 
èrgë_Àn
;

934 
boﬁ
 
mds_c⁄n
 = 
Ál£
, 
lw_˛õ¡
 = false;

935 
boﬁ
 
mds_mds_c⁄n
 = 
Ál£
;

936 
boﬁ
 
√w_mds_mds_c⁄n
 = 
Ál£
;

937 
boﬁ
 
èrgë_ª„ªn˚d
 = 
Ál£
;

938 
obd_c⁄√˘_d©a
 *
d©a
, *
tmpd©a
;

939 
size
, 
tmpsize
;

940 
 ë_nid_t
 *
˛õ¡_nid
 = 
NULL
;

941 
ENTRY
;

943 
	`OBD_RACE
(
OBD_FAIL_TGT_CONN_RACE
);

945 
°r
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_TGTUUID
);

946 i‡(
°r
 =
NULL
) {

947 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "badÅarget UUID for connect");

948 
	`GOTO
(
out
, 
rc
 = -
EINVAL
);

951 
	`obd_°r2uuid
(&
tgtuuid
, 
°r
);

952 
èrgë
 = 
	`˛ass_uuid2obd
(&
tgtuuid
);

953 i‡(!
èrgë
)

954 
èrgë
 = 
	`˛ass_«me2obd
(
°r
);

956 i‡(!
èrgë
) {

957 
	`deuuidify
(
°r
, 
NULL
, &
èrgë_°¨t
, &
èrgë_Àn
);

958 
	`LCONSOLE_ERROR_MSG
(0x137, "%s:Çotávailable for connect "

961 "mou¡ed o¿thêŸhî sîvî.\n", 
°r
,

962 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
));

963 
	`GOTO
(
out
, 
rc
 = -
ENODEV
);

966 
	`•ö_lock
(&
èrgë
->
obd_dev_lock
);

967 i‡(
èrgë
->
obd_°›pög
 || !èrgë->
obd_£t_up
) {

968 
	`•ö_u∆ock
(&
èrgë
->
obd_dev_lock
);

970 
	`deuuidify
(
°r
, 
NULL
, &
èrgë_°¨t
, &
èrgë_Àn
);

971 
	`LCONSOLE_INFO
("%.*s: Notávailable for connect from %s (%s)\n",

972 
èrgë_Àn
, 
èrgë_°¨t
,

973 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
),

974 (
èrgë
->
obd_°›pög
 ?

976 
	`GOTO
(
out
, 
rc
 = -
ENODEV
);

979 i‡(
èrgë
->
obd_no_c⁄n
) {

980 
	`•ö_u∆ock
(&
èrgë
->
obd_dev_lock
);

982 
	`CDEBUG
(
D_INFO
, "%s: TemporarilyÑefusing client connection "

983 "‰om %s\n", 
èrgë
->
obd_«me
,

984 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
));

985 
	`GOTO
(
out
, 
rc
 = -
EAGAIN
);

991 
	`˛ass_ö¸ef
(
èrgë
, 
__func__
, 
cuºít
);

992 
èrgë_ª„ªn˚d
 = 
åue
;

994 
èrgë
->
obd_c⁄n_ö¥ogªss
++;

995 
	`•ö_u∆ock
(&
èrgë
->
obd_dev_lock
);

997 
°r
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_CLUUID
);

998 i‡(
°r
 =
NULL
) {

999 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "bad client UUID for connect");

1000 
	`GOTO
(
out
, 
rc
 = -
EINVAL
);

1003 
	`obd_°r2uuid
(&
˛uuid
, 
°r
);

1005 
tmp
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_CONN
);

1006 i‡(
tmp
 =
NULL
)

1007 
	`GOTO
(
out
, 
rc
 = -
EPROTO
);

1009 
c⁄n
 = *
tmp
;

1011 
size
 = 
	`ªq_ˇpsuÀ_gë_size
(&
ªq
->
rq_pûl
, &
RMF_CONNECT_DATA
,

1012 
RCL_CLIENT
);

1013 
d©a
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_CONNECT_DATA
);

1014 i‡(!
d©a
)

1015 
	`GOTO
(
out
, 
rc
 = -
EPROTO
);

1017 
rc
 = 
	`ªq_ˇpsuÀ_£rvî_∑ck
(&
ªq
->
rq_pûl
);

1018 i‡(
rc
)

1019 
	`GOTO
(
out
, 
rc
);

1021 #i‡
LUSTRE_VERSION_CODE
 < 
	`OBD_OCD_VERSION
(3, 0, 53, 0)

1031 i‡(!(
d©a
->
ocd_c⁄√˘_Êags
 & 
OBD_CONNECT_FULL20
))

1032 
	`GOTO
(
out
, 
rc
 = -
EPROTO
);

1035 i‡(
	`lu°ª_msg_gë_›_Êags
(
ªq
->
rq_ªqmsg
Ë& 
MSG_CONNECT_LIBCLIENT
) {

1036 i‡(
d©a
->
ocd_vîsi⁄
 < 
LUSTRE_VERSION_CODE
 -

1037 
LUSTRE_VERSION_ALLOWED_OFFSET
 ||

1038 
d©a
->
ocd_vîsi⁄
 > 
LUSTRE_VERSION_CODE
 +

1039 
LUSTRE_VERSION_ALLOWED_OFFSET
) {

1040 
	`DEBUG_REQ
(
D_WARNING
, 
ªq
, "Refusing %s (%d.%d.%d.%d) "

1042 
d©a
->
ocd_vîsi⁄
 < 
LUSTRE_VERSION_CODE
 ?

1044 
	`OBD_OCD_VERSION_MAJOR
(
d©a
->
ocd_vîsi⁄
),

1045 
	`OBD_OCD_VERSION_MINOR
(
d©a
->
ocd_vîsi⁄
),

1046 
	`OBD_OCD_VERSION_PATCH
(
d©a
->
ocd_vîsi⁄
),

1047 
	`OBD_OCD_VERSION_FIX
(
d©a
->
ocd_vîsi⁄
));

1048 
d©a
 = 
	`ªq_ˇpsuÀ_£rvî_sized_gë
(&
ªq
->
rq_pûl
,

1049 &
RMF_CONNECT_DATA
,

1050 
	`off£tof
(
	`ty≥of
(*
d©a
), 
ocd_vîsi⁄
) +

1051 (
d©a
->
ocd_vîsi⁄
));

1052 i‡(
d©a
) {

1053 
d©a
->
ocd_c⁄√˘_Êags
 = 
OBD_CONNECT_VERSION
;

1054 
d©a
->
ocd_vîsi⁄
 = 
LUSTRE_VERSION_CODE
;

1056 
	`GOTO
(
out
, 
rc
 = -
EPROTO
);

1063 
lw_˛õ¡
 = (
d©a
->
ocd_c⁄√˘_Êags
 & 
OBD_CONNECT_LIGHTWEIGHT
) != 0;

1065 i‡(
	`lu°ª_msg_gë_›_Êags
(
ªq
->
rq_ªqmsg
Ë& 
MSG_CONNECT_INITIAL
) {

1066 
mds_c⁄n
 = (
d©a
->
ocd_c⁄√˘_Êags
 & 
OBD_CONNECT_MDS
) != 0;

1067 
mds_mds_c⁄n
 = (
d©a
->
ocd_c⁄√˘_Êags
 &

1068 
OBD_CONNECT_MDS_MDS
) != 0;

1076 i‡(!
lw_˛õ¡
 &&

1077 (
d©a
->
ocd_c⁄√˘_Êags
 & 
OBD_CONNECT_MDS_MDS
) &&

1078 (
d©a
->
ocd_c⁄√˘_Êags
 & 
OBD_CONNECT_FID
) &&

1079 (
d©a
->
ocd_c⁄√˘_Êags
 & 
OBD_CONNECT_VERSION
)) {

1080 
__u32
 
maj‹
 = 
	`OBD_OCD_VERSION_MAJOR
(
d©a
->
ocd_vîsi⁄
);

1081 
__u32
 
mö‹
 = 
	`OBD_OCD_VERSION_MINOR
(
d©a
->
ocd_vîsi⁄
);

1082 
__u32
 
∑tch
 = 
	`OBD_OCD_VERSION_PATCH
(
d©a
->
ocd_vîsi⁄
);

1086 i‡(
	`u∆ikñy
(
maj‹
 !
LUSTRE_MAJOR
 ||

1087 
mö‹
 !
LUSTRE_MINOR
 ||

1088 
	`abs
(
∑tch
 - 
LUSTRE_PATCH
) > 3)) {

1089 
	`LCONSOLE_WARN
("%s (%u.%u.%u.%u)ÑefusedÅhe "

1092 
èrgë
->
obd_«me
, 
LUSTRE_MAJOR
,

1093 
LUSTRE_MINOR
, 
LUSTRE_PATCH
, 
LUSTRE_FIX
,

1094 
maj‹
, 
mö‹
, 
∑tch
,

1095 
	`OBD_OCD_VERSION_FIX
(
d©a
->
ocd_vîsi⁄
),

1096 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
), 
°r
);

1098 
	`GOTO
(
out
, 
rc
 = -
EPROTO
);

1104 i‡(
	`obd_uuid_equÆs
(&
˛uuid
, &
èrgë
->
obd_uuid
))

1105 
d⁄t_check_exp‹ts
;

1107 
exp‹t
 = 
	`cfs_hash_lookup
(
èrgë
->
obd_uuid_hash
, &
˛uuid
);

1108 i‡(!
exp‹t
)

1109 
no_exp‹t
;

1113 
	`•ö_lock
(&
exp‹t
->
exp_lock
);

1115 i‡(
exp‹t
->
exp_c⁄√˘ög
) {

1116 
	`•ö_u∆ock
(&
exp‹t
->
exp_lock
);

1117 
	`LCONSOLE_WARN
("%s: Export %pálready connecting from %s\n",

1118 
exp‹t
->
exp_obd
->
obd_«me
,Éxport,

1119 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
));

1120 
	`˛ass_exp‹t_put
(
exp‹t
);

1121 
exp‹t
 = 
NULL
;

1122 
rc
 = -
EALREADY
;

1123 } i‡((
mds_c⁄n
 || 
lw_˛õ¡
Ë&& 
exp‹t
->
exp_c⁄√˘i⁄
 !
NULL
) {

1124 
	`•ö_u∆ock
(&
exp‹t
->
exp_lock
);

1125 i‡(
ªq
->
rq_≥î
.
nid
 !
exp‹t
->
exp_c⁄√˘i⁄
->
c_≥î
.nid)

1127 
	`LCONSOLE_WARN
("%s: Received %s connection from "

1129 
èrgë
->
obd_«me
, 
mds_c⁄n
 ? "MDS" : "LWP",

1130 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
),

1131 
	`libcfs_nid2°r
(
exp‹t
->
exp_c⁄√˘i⁄
->
c_≥î
.
nid
));

1134 
	`LCONSOLE_WARN
("%s: ReceivedÇew %s connection from "

1136 
èrgë
->
obd_«me
, 
mds_c⁄n
 ? "MDS" : "LWP",

1137 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
));

1138 
	`˛ass_Áû_exp‹t
(
exp‹t
);

1139 
	`˛ass_exp‹t_put
(
exp‹t
);

1140 
exp‹t
 = 
NULL
;

1141 
rc
 = 0;

1142 } i‡(
exp‹t
->
exp_c⁄√˘i⁄
 !
NULL
 &&

1143 
ªq
->
rq_≥î
.
nid
 !
exp‹t
->
exp_c⁄√˘i⁄
->
c_≥î
.nid &&

1144 (
	`lu°ª_msg_gë_›_Êags
(
ªq
->
rq_ªqmsg
) &

1145 
MSG_CONNECT_INITIAL
)) {

1146 
	`•ö_u∆ock
(&
exp‹t
->
exp_lock
);

1148 
	`LCONSOLE_WARN
("%s: Client %s seen onÇewÇid %s when "

1150 
èrgë
->
obd_«me
, 
˛uuid
.
uuid
,

1151 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
),

1152 
	`libcfs_nid2°r
(

1153 
exp‹t
->
exp_c⁄√˘i⁄
->
c_≥î
.
nid
));

1154 
rc
 = -
EALREADY
;

1155 
	`˛ass_exp‹t_put
(
exp‹t
);

1156 
exp‹t
 = 
NULL
;

1158 
exp‹t
->
exp_c⁄√˘ög
 = 1;

1159 
	`•ö_u∆ock
(&
exp‹t
->
exp_lock
);

1160 
	`LASSERT
(
exp‹t
->
exp_obd
 =
èrgë
);

1162 
rc
 = 
	`èrgë_h™dÀ_ªc⁄√˘
(&
c⁄n
, 
exp‹t
, &
˛uuid
);

1166 i‡(!
exp‹t
) {

1167 
no_exp‹t
:

1168 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_TGT_DELAY_CONNECT
, 2 * 
obd_timeout
);

1169 } i‡(
ªq
->
rq_exp‹t
 =
NULL
 &&

1170 
	`©omic_ªad
(&
exp‹t
->
exp_Ωc_cou¡
) > 0) {

1171 
	`LCONSOLE_WARN
("%s: Client %s (at %s)Ñefused connection, "

1173 
èrgë
->
obd_«me
, 
˛uuid
.
uuid
,

1174 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
),

1175 
	`©omic_ªad
(&
exp‹t
->
exp_ªfcou¡
));

1176 
	`GOTO
(
out
, 
rc
 = -
EBUSY
);

1177 } i‡(
	`lu°ª_msg_gë_c⁄n_˙t
(
ªq
->
rq_ªqmsg
) == 1) {

1178 i‡(!
	`°r°r
(
˛uuid
.
uuid
, "mdt"))

1179 
	`LCONSOLE_WARN
("%s: RejectingÑeconnect fromÅhe "

1182 
èrgë
->
obd_«me
, 
˛uuid
.
uuid
,

1183 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
));

1184 
	`GOTO
(
out
, 
rc
 = -
EALREADY
);

1186 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_TGT_DELAY_RECONNECT
, 2 * 
obd_timeout
);

1189 i‡(
rc
 < 0) {

1190 
	`GOTO
(
out
, 
rc
);

1193 
	`CDEBUG
(
D_HA
, "%s: c⁄√˘i⁄ from %s@%†%°"
LPU64
"Éxp %p cur %ldÜast %ld\n",

1194 
èrgë
->
obd_«me
, 
˛uuid
.
uuid
, 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
),

1195 
èrgë
->
obd_ªcovîög
 ? "ªcovîög/" : "", 
d©a
->
ocd_å™¢o
,

1196 
exp‹t
, ()
	`cfs_time_cuºít_£c
(),

1197 
exp‹t
 ? (Îxp‹t->
exp_œ°_ªque°_time
 : 0);

1201 i‡(!
lw_˛õ¡
 && 
rc
 =0 && 
èrgë
->
obd_ªcovîög
)

1202 
	`check_™d_°¨t_ªcovîy_timî
(
èrgë
, 
ªq
, 
exp‹t
 =
NULL
);

1206 i‡(
rc
 =
EALREADY
) {

1207 
	`lu°ª_msg_add_›_Êags
(
ªq
->
rq_ªpmsg
, 
MSG_CONNECT_RECONNECT
);

1208 
rc
 = 0;

1210 
	`LASSERT
(
rc
 == 0);

1214 i‡(
èrgë
->
obd_ª∂ayabÀ
)

1215 
	`lu°ª_msg_add_›_Êags
(
ªq
->
rq_ªpmsg
, 
MSG_CONNECT_REPLAYABLE
);

1216 
˛õ¡_nid
 = &
ªq
->
rq_≥î
.
nid
;

1218 i‡(
exp‹t
 =
NULL
) {

1222 i‡(
èrgë
->
obd_ªcovîög
 && !
lw_˛õ¡
 && !
mds_mds_c⁄n
) {

1223 
cfs_time_t
 
t
;

1224 
c
;

1225 
i
;

1226 
k
;

1227 
s
;

1229 
c
 = 
	`©omic_ªad
(&
èrgë
->
obd_c⁄√˘ed_˛õ¡s
);

1230 
i
 = 
	`©omic_ªad
(&
èrgë
->
obd_lock_ª∂ay_˛õ¡s
);

1231 
k
 = 
èrgë
->
obd_max_ªcovîabÀ_˛õ¡s
;

1232 
s
 = 
èrgë
->
obd_°Æe_˛õ¡s
;

1233 
t
 = 
	`cfs_timî_dódlöe
(&
èrgë
->
obd_ªcovîy_timî
);

1234 
t
 = 
	`cfs_time_sub
—, 
	`cfs_time_cuºít
());

1235 
t
 = 
	`cfs_duøti⁄_£c
(t);

1236 
	`LCONSOLE_WARN
("%s: Denying connection forÇew client %s"

1240 
èrgë
->
obd_«me
, 
˛uuid
.
uuid
,

1241 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
), 
k
,

1242 
c
 - 
i
, i, 
s
, ()
t
 / 60,

1243 ()
t
 % 60);

1244 
rc
 = -
EBUSY
;

1246 
d⁄t_check_exp‹ts
:

1247 
rc
 = 
	`obd_c⁄√˘
(
ªq
->
rq_svc_thªad
->
t_ív
,

1248 &
exp‹t
, 
èrgë
, &
˛uuid
, 
d©a
,

1249 
˛õ¡_nid
);

1250 i‡(
mds_c⁄n
 && 
	`OBD_FAIL_CHECK
(
OBD_FAIL_TGT_RCVG_FLAG
))

1251 
	`lu°ª_msg_add_›_Êags
(
ªq
->
rq_ªpmsg
,

1252 
MSG_CONNECT_RECOVERING
);

1253 i‡(
rc
 == 0) {

1254 
c⁄n
.
cookõ
 = 
exp‹t
->
exp_h™dÀ
.
h_cookõ
;

1255 
rc
 = 
	`ªv_imp‹t_öô
(
exp‹t
);

1258 i‡(
mds_mds_c⁄n
)

1259 
√w_mds_mds_c⁄n
 = 
åue
;

1262 
rc
 = 
	`obd_ªc⁄√˘
(
ªq
->
rq_svc_thªad
->
t_ív
,

1263 
exp‹t
, 
èrgë
, &
˛uuid
, 
d©a
, 
˛õ¡_nid
);

1265 i‡(
rc
)

1266 
	`GOTO
(
out
, 
rc
);

1268 
	`LASSERT
(
èrgë
->
u
.
obt
.
obt_magic
 =
OBT_MAGIC
);

1269 
d©a
->
ocd_ö°™˚
 = 
èrgë
->
u
.
obt
.
obt_ö°™˚
;

1273 i‡(
d©a
) {

1274 
tmpsize
 = 
	`ªq_ˇpsuÀ_gë_size
(&
ªq
->
rq_pûl
, &
RMF_CONNECT_DATA
,

1275 
RCL_SERVER
);

1276 
tmpd©a
 = 
	`ªq_ˇpsuÀ_£rvî_gë
(&
ªq
->
rq_pûl
,

1277 &
RMF_CONNECT_DATA
);

1281 
	`mem˝y
(
tmpd©a
, 
d©a
, 
	`mö
(
tmpsize
, 
size
));

1291 
	`±Ãpc_ªque°_ch™ge_exp‹t
(
ªq
, 
exp‹t
);

1293 
	`•ö_lock
(&
exp‹t
->
exp_lock
);

1294 i‡(
exp‹t
->
exp_c⁄n_˙t
 >
	`lu°ª_msg_gë_c⁄n_˙t
(
ªq
->
rq_ªqmsg
)) {

1295 
	`•ö_u∆ock
(&
exp‹t
->
exp_lock
);

1296 
	`CDEBUG
(
D_RPCTRACE
, "%s: %sálready connectedát greater "

1298 
˛uuid
.
uuid
, 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
),

1299 
exp‹t
->
exp_c⁄n_˙t
,

1300 
	`lu°ª_msg_gë_c⁄n_˙t
(
ªq
->
rq_ªqmsg
));

1302 
	`GOTO
(
out
, 
rc
 = -
EALREADY
);

1304 
	`LASSERT
(
	`lu°ª_msg_gë_c⁄n_˙t
(
ªq
->
rq_ªqmsg
) > 0);

1305 
exp‹t
->
exp_c⁄n_˙t
 = 
	`lu°ª_msg_gë_c⁄n_˙t
(
ªq
->
rq_ªqmsg
);

1308 i‡(
	`lu°ª_msg_gë_›_Êags
(
ªq
->
rq_ªqmsg
Ë& 
MSG_CONNECT_LIBCLIENT
) {

1309 
exp‹t
->
exp_lib˛õ¡
 = 1;

1310 
	`•ö_u∆ock
(&
exp‹t
->
exp_lock
);

1312 
	`•ö_lock
(&
èrgë
->
obd_dev_lock
);

1313 
	`li°_dñ_öô
(&
exp‹t
->
exp_obd_chaö_timed
);

1314 
	`•ö_u∆ock
(&
èrgë
->
obd_dev_lock
);

1316 
	`•ö_u∆ock
(&
exp‹t
->
exp_lock
);

1319 i‡(
exp‹t
->
exp_c⁄√˘i⁄
 !
NULL
) {

1321 i‡((
exp‹t
->
exp_c⁄√˘i⁄
->
c_≥î
.
nid
 !
ªq
->
rq_≥î
.nid) &&

1322 !
	`hli°_unhashed
(&
exp‹t
->
exp_nid_hash
))

1323 
	`cfs_hash_dñ
(
exp‹t
->
exp_obd
->
obd_nid_hash
,

1324 &
exp‹t
->
exp_c⁄√˘i⁄
->
c_≥î
.
nid
,

1325 &
exp‹t
->
exp_nid_hash
);

1327 
	`±Ãpc_c⁄√˘i⁄_put
(
exp‹t
->
exp_c⁄√˘i⁄
);

1330 
exp‹t
->
exp_c⁄√˘i⁄
 = 
	`±Ãpc_c⁄√˘i⁄_gë
(
ªq
->
rq_≥î
,

1331 
ªq
->
rq_£lf
,

1332 &
˛uuid
);

1333 i‡(
	`hli°_unhashed
(&
exp‹t
->
exp_nid_hash
))

1334 
	`cfs_hash_add
(
exp‹t
->
exp_obd
->
obd_nid_hash
,

1335 &
exp‹t
->
exp_c⁄√˘i⁄
->
c_≥î
.
nid
,

1336 &
exp‹t
->
exp_nid_hash
);

1338 
	`lu°ª_msg_£t_h™dÀ
(
ªq
->
rq_ªpmsg
, &
c⁄n
);

1340 
rc
 = 
	`ªv_imp‹t_ªc⁄√˘
(
exp‹t
, 
ªq
);

1341 i‡(
rc
 != 0)

1342 
	`GOTO
(
out
, 
rc
);

1344 i‡(
èrgë
->
obd_ªcovîög
 && !
exp‹t
->
exp_ö_ªcovîy
 && !
lw_˛õ¡
) {

1345 
has_å™¢o
;

1346 
__u64
 
å™¢o
 = 
d©a
->
ocd_å™¢o
;

1348 
	`•ö_lock
(&
exp‹t
->
exp_lock
);

1351 i‡(
exp‹t
->
exp_Áûed
) {

1352 
	`•ö_u∆ock
(&
exp‹t
->
exp_lock
);

1353 
	`GOTO
(
out
, 
rc
 = -
ENODEV
);

1355 
exp‹t
->
exp_ö_ªcovîy
 = 1;

1356 
exp‹t
->
exp_ªq_ª∂ay_√eded
 = 1;

1357 
exp‹t
->
exp_lock_ª∂ay_√eded
 = 1;

1358 
	`•ö_u∆ock
(&
exp‹t
->
exp_lock
);

1360 
has_å™¢o
 = !!(
	`lu°ª_msg_gë_›_Êags
(
ªq
->
rq_ªqmsg
) &

1361 
MSG_CONNECT_TRANSNO
);

1362 i‡(
has_å™¢o
 && 
å™¢o
 == 0)

1363 
	`CWARN
("Connect with zeroÅransno!\n");

1365 i‡(
has_å™¢o
 && 
å™¢o
 > 0 &&

1366 
å™¢o
 < 
èrgë
->
obd_√xt_ªcovîy_å™¢o
 &&

1367 
å™¢o
 > 
èrgë
->
obd_œ°_commôãd
) {

1369 
	`•ö_lock
(&
èrgë
->
obd_ªcovîy_èsk_lock
);

1370 i‡(
å™¢o
 < 
èrgë
->
obd_√xt_ªcovîy_å™¢o
)

1371 
èrgë
->
obd_√xt_ªcovîy_å™¢o
 = 
å™¢o
;

1372 
	`•ö_u∆ock
(&
èrgë
->
obd_ªcovîy_èsk_lock
);

1375 
	`©omic_öc
(&
èrgë
->
obd_ªq_ª∂ay_˛õ¡s
);

1376 
	`©omic_öc
(&
èrgë
->
obd_lock_ª∂ay_˛õ¡s
);

1383 i‡(
√w_mds_mds_c⁄n
)

1384 
èrgë
->
obd_max_ªcovîabÀ_˛õ¡s
++;

1385 i‡(
	`©omic_öc_ªtu∫
(&
èrgë
->
obd_c⁄√˘ed_˛õ¡s
) ==

1386 
èrgë
->
obd_max_ªcovîabÀ_˛õ¡s
)

1387 
	`wake_up
(&
èrgë
->
obd_√xt_å™¢o_waôq
);

1391 i‡(
èrgë
->
obd_ªcovîög
 && !
lw_˛õ¡
)

1392 
	`lu°ª_msg_add_›_Êags
(
ªq
->
rq_ªpmsg
, 
MSG_CONNECT_RECOVERING
);

1394 
out
:

1395 i‡(
exp‹t
) {

1396 
	`•ö_lock
(&
exp‹t
->
exp_lock
);

1397 
exp‹t
->
exp_c⁄√˘ög
 = 0;

1398 
	`•ö_u∆ock
(&
exp‹t
->
exp_lock
);

1400 
	`˛ass_exp‹t_put
(
exp‹t
);

1402 i‡(
èrgë_ª„ªn˚d
 =
åue
 && 
èrgë
 !
NULL
) {

1403 
	`•ö_lock
(&
èrgë
->
obd_dev_lock
);

1404 
èrgë
->
obd_c⁄n_ö¥ogªss
--;

1405 
	`•ö_u∆ock
(&
èrgë
->
obd_dev_lock
);

1407 
	`˛ass_de¸ef
(
èrgë
, 
__func__
, 
cuºít
);

1409 
ªq
->
rq_°©us
 = 
rc
;

1410 
	`RETURN
(
rc
);

1411 
	}
}

1413 
	$èrgë_h™dÀ_disc⁄√˘
(
±Ãpc_ªque°
 *
ªq
)

1415 
rc
;

1416 
ENTRY
;

1418 
rc
 = 
	`ªq_ˇpsuÀ_£rvî_∑ck
(&
ªq
->
rq_pûl
);

1419 i‡(
rc
)

1420 
	`RETURN
(
rc
);

1423 
ªq
->
rq_°©us
 = 
	`obd_disc⁄√˘
(
	`˛ass_exp‹t_gë
‘eq->
rq_exp‹t
));

1425 
	`RETURN
(0);

1426 
	}
}

1428 
	$èrgë_de°roy_exp‹t
(
obd_exp‹t
 *
exp
)

1430 
obd_imp‹t
 *
imp
 = 
NULL
;

1433 
	`•ö_lock
(&
exp
->
exp_lock
);

1434 i‡(
exp
->
exp_imp_ªvî£
 !
NULL
) {

1435 
imp
 = 
exp
->
exp_imp_ªvî£
;

1436 
exp
->
exp_imp_ªvî£
 = 
NULL
;

1438 
	`•ö_u∆ock
(&
exp
->
exp_lock
);

1439 i‡(
imp
 !
NULL
)

1440 
	`˛õ¡_de°roy_imp‹t
(
imp
);

1442 
	`LASSERT_ATOMIC_ZERO
(&
exp
->
exp_locks_cou¡
);

1443 
	`LASSERT_ATOMIC_ZERO
(&
exp
->
exp_Ωc_cou¡
);

1444 
	`LASSERT_ATOMIC_ZERO
(&
exp
->
exp_cb_cou¡
);

1445 
	`LASSERT_ATOMIC_ZERO
(&
exp
->
exp_ª∂ay_cou¡
);

1446 
	}
}

1447 
EXPORT_SYMBOL
(
èrgë_de°roy_exp‹t
);

1452 
	$èrgë_ªque°_c›y_gë
(
±Ãpc_ªque°
 *
ªq
)

1454 
	`˛ass_exp‹t_Ωc_öc
(
ªq
->
rq_exp‹t
);

1455 
	`LASSERT
(
	`li°_em±y
(&
ªq
->
rq_li°
));

1456 
	`INIT_LIST_HEAD
(&
ªq
->
rq_ª∂ay_li°
);

1459 
	`©omic_öc
(&
ªq
->
rq_ªfcou¡
);

1461 
	`©omic_öc
(&
ªq
->
rq_exp‹t
->
exp_ª∂ay_cou¡
);

1462 
	}
}

1464 
	$èrgë_ªque°_c›y_put
(
±Ãpc_ªque°
 *
ªq
)

1466 
	`LASSERT
(
	`li°_em±y
(&
ªq
->
rq_ª∂ay_li°
));

1467 
	`LASSERT_ATOMIC_POS
(&
ªq
->
rq_exp‹t
->
exp_ª∂ay_cou¡
);

1469 
	`©omic_dec
(&
ªq
->
rq_exp‹t
->
exp_ª∂ay_cou¡
);

1470 
	`˛ass_exp‹t_Ωc_dec
(
ªq
->
rq_exp‹t
);

1471 
	`±Ãpc_£rvî_dr›_ªque°
(
ªq
);

1472 
	}
}

1474 
	$èrgë_exp_íqueue_ªq_ª∂ay
(
±Ãpc_ªque°
 *
ªq
)

1476 
__u64
 
å™¢o
 = 
	`lu°ª_msg_gë_å™¢o
(
ªq
->
rq_ªqmsg
);

1477 
obd_exp‹t
 *
exp
 = 
ªq
->
rq_exp‹t
;

1478 
±Ãpc_ªque°
 *
ªqôî
;

1479 
±Ãpc_ªque°
 *
dup_ªq
 = 
NULL
;

1480 
dup
 = 0;

1482 
	`LASSERT
(
exp
);

1484 
	`•ö_lock
(&
exp
->
exp_lock
);

1485 
	`li°_f‹_óch_íåy
(
ªqôî
, &
exp
->
exp_ªq_ª∂ay_queue
,

1486 
rq_ª∂ay_li°
) {

1487 i‡(
	`lu°ª_msg_gë_å™¢o
(
ªqôî
->
rq_ªqmsg
Ë=
å™¢o
) {

1488 
dup_ªq
 = 
ªqôî
;

1489 
dup
 = 1;

1494 i‡(
dup
) {

1496 i‡((
	`lu°ª_msg_gë_Êags
(
ªq
->
rq_ªqmsg
) &

1497 (
MSG_RESENT
 | 
MSG_REPLAY
)) != (MSG_RESENT | MSG_REPLAY))

1498 
	`CERROR
("invalid flags %x ofÑesentÑeplay\n",

1499 
	`lu°ª_msg_gë_Êags
(
ªq
->
rq_ªqmsg
));

1501 i‡(
	`lu°ª_msg_gë_Êags
(
ªq
->
rq_ªqmsg
Ë& 
MSG_REPLAY
) {

1502 
__u32
 
√w_c⁄n
;

1504 
√w_c⁄n
 = 
	`lu°ª_msg_gë_c⁄n_˙t
(
ªq
->
rq_ªqmsg
);

1505 i‡(
√w_c⁄n
 >

1506 
	`lu°ª_msg_gë_c⁄n_˙t
(
dup_ªq
->
rq_ªqmsg
))

1507 
	`lu°ª_msg_£t_c⁄n_˙t
(
dup_ªq
->
rq_ªqmsg
,

1508 
√w_c⁄n
);

1511 
	`li°_add_èû
(&
ªq
->
rq_ª∂ay_li°
,

1512 &
exp
->
exp_ªq_ª∂ay_queue
);

1515 
	`•ö_u∆ock
(&
exp
->
exp_lock
);

1516  
dup
;

1517 
	}
}

1519 
	$èrgë_exp_dequeue_ªq_ª∂ay
(
±Ãpc_ªque°
 *
ªq
)

1521 
	`LASSERT
(!
	`li°_em±y
(&
ªq
->
rq_ª∂ay_li°
));

1522 
	`LASSERT
(
ªq
->
rq_exp‹t
);

1524 
	`•ö_lock
(&
ªq
->
rq_exp‹t
->
exp_lock
);

1525 
	`li°_dñ_öô
(&
ªq
->
rq_ª∂ay_li°
);

1526 
	`•ö_u∆ock
(&
ªq
->
rq_exp‹t
->
exp_lock
);

1527 
	}
}

1529 
	$èrgë_föish_ªcovîy
(
lu_èrgë
 *
lut
)

1531 
obd_devi˚
 *
obd
 = 
lut
->
lut_obd
;

1532 
ENTRY
;

1535 i‡(
obd
->
obd_ªcovîy_°¨t
) {

1536 
time_t
 
ñ≠£d_time
 = 
	`max_t
—ime_t, 1, 
	`cfs_time_cuºít_£c
() -

1537 
obd
->
obd_ªcovîy_°¨t
);

1538 
	`LCONSOLE_INFO
("%s: Recovery overáfter %d:%.02d, of %d clients "

1539 "%dÑecovîedánd %d %†evi˘ed.\n", 
obd
->
obd_«me
,

1540 ()
ñ≠£d_time
 / 60, ()elapsed_time % 60,

1541 
obd
->
obd_max_ªcovîabÀ_˛õ¡s
,

1542 
	`©omic_ªad
(&
obd
->
obd_c⁄√˘ed_˛õ¡s
),

1543 
obd
->
obd_°Æe_˛õ¡s
,

1544 
obd
->
obd_°Æe_˛õ¡s
 == 1 ? "was" : "were");

1547 
	`ldlm_ª¥o˚ss_Æl_ns
(
obd
->
obd_«me•a˚
);

1548 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1549 i‡(!
	`li°_em±y
(&
obd
->
obd_ªq_ª∂ay_queue
) ||

1550 !
	`li°_em±y
(&
obd
->
obd_lock_ª∂ay_queue
) ||

1551 !
	`li°_em±y
(&
obd
->
obd_föÆ_ªq_queue
)) {

1552 
	`CERROR
("%s: Recovery queues ( %s%s%s)áreÇotÉmpty\n",

1553 
obd
->
obd_«me
,

1554 
	`li°_em±y
(&
obd
->
obd_ªq_ª∂ay_queue
) ? "" : "req ",

1555 
	`li°_em±y
(&
obd
->
obd_lock_ª∂ay_queue
) ? \

1557 
	`li°_em±y
(&
obd
->
obd_föÆ_ªq_queue
) ? \

1559 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1560 
	`LBUG
();

1562 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1564 
obd
->
obd_ªcovîy_íd
 = 
	`cfs_time_cuºít_£c
();

1567 i‡(
	`OBT
(
obd
Ë&& 
	`OBP
(obd, 
po°ªcov
)) {

1568 
rc
 = 
	`OBP
(
obd
, 
po°ªcov
)(obd);

1569 i‡(
rc
 < 0)

1570 
	`LCONSOLE_WARN
("%s: PostÑecovery failed,Ñc %d\n",

1571 
obd
->
obd_«me
, 
rc
);

1573 
EXIT
;

1574 
	}
}

1576 
	$ab‹t_ªq_ª∂ay_queue
(
obd_devi˚
 *
obd
)

1578 
±Ãpc_ªque°
 *
ªq
, *
n
;

1579 
li°_hód
 
ab‹t_li°
;

1581 
	`INIT_LIST_HEAD
(&
ab‹t_li°
);

1582 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1583 
	`li°_•li˚_öô
(&
obd
->
obd_ªq_ª∂ay_queue
, &
ab‹t_li°
);

1584 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1585 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
n
, &
ab‹t_li°
, 
rq_li°
) {

1586 
	`DEBUG_REQ
(
D_WARNING
, 
ªq
, "aborted:");

1587 
ªq
->
rq_°©us
 = -
ENOTCONN
;

1588 i‡(
	`±Ãpc_îr‹
(
ªq
)) {

1589 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
,

1592 
	`èrgë_exp_dequeue_ªq_ª∂ay
(
ªq
);

1593 
	`èrgë_ªque°_c›y_put
(
ªq
);

1595 
	}
}

1597 
	$ab‹t_lock_ª∂ay_queue
(
obd_devi˚
 *
obd
)

1599 
±Ãpc_ªque°
 *
ªq
, *
n
;

1600 
li°_hód
 
ab‹t_li°
;

1602 
	`INIT_LIST_HEAD
(&
ab‹t_li°
);

1603 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1604 
	`li°_•li˚_öô
(&
obd
->
obd_lock_ª∂ay_queue
, &
ab‹t_li°
);

1605 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1606 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
n
, &
ab‹t_li°
, 
rq_li°
) {

1607 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "aborted:");

1608 
ªq
->
rq_°©us
 = -
ENOTCONN
;

1609 i‡(
	`±Ãpc_îr‹
(
ªq
)) {

1610 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
,

1613 
	`èrgë_ªque°_c›y_put
(
ªq
);

1615 
	}
}

1626 
	$èrgë_˛ónup_ªcovîy
(
obd_devi˚
 *
obd
)

1628 
±Ãpc_ªque°
 *
ªq
, *
n
;

1629 
li°_hód
 
˛ón_li°
;

1631 
	`INIT_LIST_HEAD
(&
˛ón_li°
);

1632 
	`•ö_lock
(&
obd
->
obd_dev_lock
);

1633 i‡(!
obd
->
obd_ªcovîög
) {

1634 
	`•ö_u∆ock
(&
obd
->
obd_dev_lock
);

1635 
EXIT
;

1638 
obd
->
obd_ªcovîög
 = obd->
obd_ab‹t_ªcovîy
 = 0;

1639 
	`•ö_u∆ock
(&
obd
->
obd_dev_lock
);

1641 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1642 
	`èrgë_ˇn˚l_ªcovîy_timî
(
obd
);

1643 
	`li°_•li˚_öô
(&
obd
->
obd_ªq_ª∂ay_queue
, &
˛ón_li°
);

1644 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1646 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
n
, &
˛ón_li°
, 
rq_li°
) {

1647 
	`LASSERT
(
ªq
->
rq_ª∂y_°©e
 =
NULL
);

1648 
	`èrgë_exp_dequeue_ªq_ª∂ay
(
ªq
);

1649 
	`èrgë_ªque°_c›y_put
(
ªq
);

1652 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1653 
	`li°_•li˚_öô
(&
obd
->
obd_lock_ª∂ay_queue
, &
˛ón_li°
);

1654 
	`li°_•li˚_öô
(&
obd
->
obd_föÆ_ªq_queue
, &
˛ón_li°
);

1655 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1657 
	`li°_f‹_óch_íåy_ß„
(
ªq
, 
n
, &
˛ón_li°
, 
rq_li°
) {

1658 
	`LASSERT
(
ªq
->
rq_ª∂y_°©e
 =
NULL
);

1659 
	`èrgë_ªque°_c›y_put
(
ªq
);

1662 
EXIT
;

1663 
	}
}

1664 
EXPORT_SYMBOL
(
èrgë_˛ónup_ªcovîy
);

1667 
	$èrgë_ˇn˚l_ªcovîy_timî
(
obd_devi˚
 *
obd
)

1669 
	`CDEBUG
(
D_HA
, "%s: c™˚»ªcovîyÅimî\n", 
obd
->
obd_«me
);

1670 
	`cfs_timî_dißrm
(&
obd
->
obd_ªcovîy_timî
);

1671 
	}
}

1673 
	$èrgë_°¨t_ªcovîy_timî
(
obd_devi˚
 *
obd
)

1675 i‡(
obd
->
obd_ªcovîy_°¨t
 != 0)

1678 
	`•ö_lock
(&
obd
->
obd_dev_lock
);

1679 i‡(!
obd
->
obd_ªcovîög
 || obd->
obd_ab‹t_ªcovîy
) {

1680 
	`•ö_u∆ock
(&
obd
->
obd_dev_lock
);

1684 
	`LASSERT
(
obd
->
obd_ªcovîy_timeout
 != 0);

1686 i‡(
obd
->
obd_ªcovîy_°¨t
 != 0) {

1687 
	`•ö_u∆ock
(&
obd
->
obd_dev_lock
);

1691 
	`cfs_timî_¨m
(&
obd
->
obd_ªcovîy_timî
,

1692 
	`cfs_time_shi·
(
obd
->
obd_ªcovîy_timeout
));

1693 
obd
->
obd_ªcovîy_°¨t
 = 
	`cfs_time_cuºít_£c
();

1694 
	`•ö_u∆ock
(&
obd
->
obd_dev_lock
);

1696 
	`LCONSOLE_WARN
("%s: Will be inÑecovery forátÜeast %d:%.02d, "

1698 
obd
->
obd_«me
,

1699 
obd
->
obd_ªcovîy_timeout
 / 60,

1700 
obd
->
obd_ªcovîy_timeout
 % 60,

1701 
obd
->
obd_max_ªcovîabÀ_˛õ¡s
,

1702 (
obd
->
obd_max_ªcovîabÀ_˛õ¡s
 == 1) ? "" : "s",

1703 (
obd
->
obd_max_ªcovîabÀ_˛õ¡s
 == 1) ? "s": "");

1704 
	}
}

1712 
	$exãnd_ªcovîy_timî
(
obd_devi˚
 *
obd
, 
dπ
, 
boﬁ
 
exãnd
)

1714 
cfs_time_t
 
now
;

1715 
cfs_time_t
 
íd
;

1716 
cfs_duøti⁄_t
 
À·
;

1717 
to
;

1719 
	`•ö_lock
(&
obd
->
obd_dev_lock
);

1720 i‡(!
obd
->
obd_ªcovîög
 || obd->
obd_ab‹t_ªcovîy
) {

1721 
	`•ö_u∆ock
(&
obd
->
obd_dev_lock
);

1724 
	`LASSERT
(
obd
->
obd_ªcovîy_°¨t
 != 0);

1726 
now
 = 
	`cfs_time_cuºít_£c
();

1727 
to
 = 
obd
->
obd_ªcovîy_timeout
;

1728 
íd
 = 
obd
->
obd_ªcovîy_°¨t
 + 
to
;

1729 
À·
 = 
	`cfs_time_sub
(
íd
, 
now
);

1731 i‡(
exãnd
 && (
dπ
 > 
À·
)) {

1732 
to
 +
dπ
 - 
À·
;

1733 } i‡(!
exãnd
 && (
dπ
 > 
to
)) {

1734 
to
 = 
dπ
;

1737 i‡(
to
 > 
obd
->
obd_ªcovîy_time_h¨d
)

1738 
to
 = 
obd
->
obd_ªcovîy_time_h¨d
;

1739 i‡(
obd
->
obd_ªcovîy_timeout
 < 
to
) {

1740 
obd
->
obd_ªcovîy_timeout
 = 
to
;

1741 
íd
 = 
obd
->
obd_ªcovîy_°¨t
 + 
to
;

1742 
	`cfs_timî_¨m
(&
obd
->
obd_ªcovîy_timî
,

1743 
	`cfs_time_shi·
(
íd
 - 
now
));

1745 
	`•ö_u∆ock
(&
obd
->
obd_dev_lock
);

1747 
	`CDEBUG
(
D_HA
, "%s:ÑecoveryÅimer willÉxpire in %u seconds\n",

1748 
obd
->
obd_«me
, ()
	`cfs_time_sub
(
íd
, 
now
));

1749 
	}
}

1763 
	$check_™d_°¨t_ªcovîy_timî
(
obd_devi˚
 *
obd
,

1764 
±Ãpc_ªque°
 *
ªq
,

1765 
√w_˛õ¡
)

1767 
£rvi˚_time
 = 
	`lu°ª_msg_gë_£rvi˚_time
(
ªq
->
rq_ªqmsg
);

1768 
obd_devi˚_èrgë
 *
obt
 = &
obd
->
u
.obt;

1770 i‡(!
√w_˛õ¡
 && 
£rvi˚_time
)

1773 
	`©_mósuªd
(&
ªq
->
rq_rqbd
->
rqbd_sv˝t
->
s˝_©_e°im©e
,

1774 
£rvi˚_time
);

1776 
	`èrgë_°¨t_ªcovîy_timî
(
obd
);

1780 
£rvi˚_time
 = 
	`©_e°2timeout
(service_time);

1785 
£rvi˚_time
 +2 * 
INITIAL_CONNECT_TIMEOUT
;

1787 
	`LASSERT
(
obt
->
obt_magic
 =
OBT_MAGIC
);

1788 
£rvi˚_time
 +2 * (
CONNECTION_SWITCH_MAX
 + 
CONNECTION_SWITCH_INC
);

1789 i‡(
£rvi˚_time
 > 
obd
->
obd_ªcovîy_timeout
 && !
√w_˛õ¡
)

1790 
	`exãnd_ªcovîy_timî
(
obd
, 
£rvi˚_time
, 
Ál£
);

1791 
	}
}

1794 
ölöe
 
	$exp_c⁄√˘_hó…hy
(
obd_exp‹t
 *
exp
)

1796  (
exp
->
exp_ö_ªcovîy
);

1797 
	}
}

1800 
ölöe
 
	$exp_ªq_ª∂ay_hó…hy
(
obd_exp‹t
 *
exp
)

1802  (!
exp
->
exp_ªq_ª∂ay_√eded
 ||

1803 
	`©omic_ªad
(&
exp
->
exp_ª∂ay_cou¡
) > 0);

1804 
	}
}

1807 
ölöe
 
	$exp_ªq_ª∂ay_hó…hy_‹_‰om_mdt
(
obd_exp‹t
 *
exp
)

1809  (
	`exp_c⁄√˘_Êags
(
exp
Ë& 
OBD_CONNECT_MDS_MDS
) ||

1810 
	`exp_ªq_ª∂ay_hó…hy
(
exp
);

1811 
	}
}

1814 
ölöe
 
	$exp_lock_ª∂ay_hó…hy
(
obd_exp‹t
 *
exp
)

1816  (!
exp
->
exp_lock_ª∂ay_√eded
 ||

1817 
	`©omic_ªad
(&
exp
->
exp_ª∂ay_cou¡
) > 0);

1818 
	}
}

1820 
ölöe
 
	$exp_vbr_hó…hy
(
obd_exp‹t
 *
exp
)

1822  (!
exp
->
exp_vbr_Áûed
);

1823 
	}
}

1825 
ölöe
 
	$exp_föished
(
obd_exp‹t
 *
exp
)

1827  (
exp
->
exp_ö_ªcovîy
 && !exp->
exp_lock_ª∂ay_√eded
);

1828 
	}
}

1830 
ölöe
 
	$exp_föished_‹_‰om_mdt
(
obd_exp‹t
 *
exp
)

1832  (
	`exp_c⁄√˘_Êags
(
exp
Ë& 
OBD_CONNECT_MDS_MDS
) ||

1833 
	`exp_föished
(
exp
);

1834 
	}
}

1836 
	$check_f‹_√xt_å™¢o
(
lu_èrgë
 *
lut
)

1838 
±Ãpc_ªque°
 *
ªq
 = 
NULL
;

1839 
obd_devi˚
 *
obd
 = 
lut
->
lut_obd
;

1840 
èrgë_di°ribuã_txn_d©a
 *
tdtd
 = 
lut
->
lut_tdtd
;

1841 
wake_up
 = 0, 
c⁄√˘ed
, 
com∂ëed
, 
queue_Àn
;

1842 
__u64
 
ªq_å™¢o
 = 0;

1843 
__u64
 
upd©e_å™¢o
 = 0;

1844 
__u64
 
√xt_å™¢o
 = 0;

1845 
ENTRY
;

1847 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1848 i‡(!
	`li°_em±y
(&
obd
->
obd_ªq_ª∂ay_queue
)) {

1849 
ªq
 = 
	`li°_íåy
(
obd
->
obd_ªq_ª∂ay_queue
.
√xt
,

1850 
±Ãpc_ªque°
, 
rq_li°
);

1851 
ªq_å™¢o
 = 
	`lu°ª_msg_gë_å™¢o
(
ªq
->
rq_ªqmsg
);

1854 i‡(
tdtd
 !
NULL
)

1855 
upd©e_å™¢o
 = 
	`di°ribuã_txn_gë_√xt_å™¢o
(
tdtd
);

1857 
c⁄√˘ed
 = 
	`©omic_ªad
(&
obd
->
obd_c⁄√˘ed_˛õ¡s
);

1858 
com∂ëed
 = 
c⁄√˘ed
 - 
	`©omic_ªad
(&
obd
->
obd_ªq_ª∂ay_˛õ¡s
);

1859 
queue_Àn
 = 
obd
->
obd_ªque°s_queued_f‹_ªcovîy
;

1860 
√xt_å™¢o
 = 
obd
->
obd_√xt_ªcovîy_å™¢o
;

1862 
	`CDEBUG
(
D_HA
, "max: %d, connected: %d, completed: %d, queue_len: %d, "

1863 "ªq_å™¢o: "
LPU64
",Çext_transno: "LPU64"\n",

1864 
obd
->
obd_max_ªcovîabÀ_˛õ¡s
, 
c⁄√˘ed
, 
com∂ëed
,

1865 
queue_Àn
, 
ªq_å™¢o
, 
√xt_å™¢o
);

1867 i‡(
obd
->
obd_ab‹t_ªcovîy
) {

1868 
	`CDEBUG
(
D_HA
, "waking forábortedÑecovery\n");

1869 
wake_up
 = 1;

1870 } i‡(
obd
->
obd_ªcovîy_expúed
) {

1871 
	`CDEBUG
(
D_HA
, "waking forÉxpiredÑecovery\n");

1872 
wake_up
 = 1;

1873 } i‡(
tdtd
 !
NULL
 && 
ªq
 != NULL &&

1874 
	`is_ªq_ª∂ayed_by_upd©e
(
ªq
)) {

1875 
	`LASSERTF
(
ªq_å™¢o
 < 
√xt_å™¢o
, "ªq_å™¢ÿ"
LPU64


1876 "√xt_å™¢o"
LPU64
"\n", 
ªq_å™¢o
, 
√xt_å™¢o
);

1877 
	`CDEBUG
(
D_HA
, "wakög f‹ du∂iˇãÑeq ("
LPU64
")\n",

1878 
ªq_å™¢o
);

1879 
wake_up
 = 1;

1880 } i‡(
ªq_å™¢o
 =
√xt_å™¢o
 ||

1881 (
upd©e_å™¢o
 !0 && upd©e_å™¢ÿ<
√xt_å™¢o
)) {

1882 
	`CDEBUG
(
D_HA
, "wakög f‹Çexà("
LPD64
")\n", 
√xt_å™¢o
);

1883 
wake_up
 = 1;

1884 } i‡(
queue_Àn
 > 0 &&

1885 
queue_Àn
 =
	`©omic_ªad
(&
obd
->
obd_ªq_ª∂ay_˛õ¡s
)) {

1886 
d_lvl
 = 
D_HA
;

1888 
	`LASSERTF
(
ªq_å™¢o
 >
√xt_å™¢o
,

1889 "ªq_å™¢o: "
LPU64
",Çext_transno: "LPU64"\n",

1890 
ªq_å™¢o
, 
√xt_å™¢o
);

1891 i‡(
ªq_å™¢o
 > 
obd
->
obd_œ°_commôãd
 &&

1892 !
obd
->
obd_vîsi⁄_ªcov
)

1893 
d_lvl
 = 
D_ERROR
;

1894 
	`CDEBUG
(
d_lvl
,

1896 
LPD64
", ql: %d, comp: %d, conn: %d,Çext: "LPD64

1897 ",Çext_upd©ê"
LPD64
"Üast_committed: "LPD64")\n",

1898 
obd
->
obd_«me
, obd->
obd_vîsi⁄_ªcov
 ? "ON" : "OFF",

1899 
√xt_å™¢o
, 
queue_Àn
, 
com∂ëed
, 
c⁄√˘ed
,

1900 
ªq_å™¢o
, 
upd©e_å™¢o
, 
obd
->
obd_œ°_commôãd
);

1901 
obd
->
obd_√xt_ªcovîy_å™¢o
 = 
ªq_å™¢o
;

1902 
wake_up
 = 1;

1903 } i‡(
	`©omic_ªad
(&
obd
->
obd_ªq_ª∂ay_˛õ¡s
) == 0) {

1904 
	`CDEBUG
(
D_HA
, "waking for completedÑecovery\n");

1905 
wake_up
 = 1;

1906 } i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_MDS_RECOVERY_ACCEPTS_GAPS
)) {

1907 
	`CDEBUG
(
D_HA
, "acceptingÅransno gaps isÉxplicitlyállowed"

1908 " by faû_lock, wakög u∞("
LPD64
")\n", 
√xt_å™¢o
);

1909 
obd
->
obd_√xt_ªcovîy_å™¢o
 = 
ªq_å™¢o
;

1910 
wake_up
 = 1;

1912 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1913  
wake_up
;

1914 
	}
}

1916 
	$check_f‹_√xt_lock
(
lu_èrgë
 *
lut
)

1918 
obd_devi˚
 *
obd
 = 
lut
->
lut_obd
;

1919 
wake_up
 = 0;

1921 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1922 i‡(!
	`li°_em±y
(&
obd
->
obd_lock_ª∂ay_queue
)) {

1923 
	`CDEBUG
(
D_HA
, "waking forÇextÜock\n");

1924 
wake_up
 = 1;

1925 } i‡(
	`©omic_ªad
(&
obd
->
obd_lock_ª∂ay_˛õ¡s
) == 0) {

1926 
	`CDEBUG
(
D_HA
, "waking for completedÜockÑeplay\n");

1927 
wake_up
 = 1;

1928 } i‡(
obd
->
obd_ab‹t_ªcovîy
) {

1929 
	`CDEBUG
(
D_HA
, "waking forábortedÑecovery\n");

1930 
wake_up
 = 1;

1931 } i‡(
obd
->
obd_ªcovîy_expúed
) {

1932 
	`CDEBUG
(
D_HA
, "waking forÉxpiredÑecovery\n");

1933 
wake_up
 = 1;

1935 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1937  
wake_up
;

1938 
	}
}

1945 
èrgë_ªcovîy_ovî£î
(
lu_èrgë
 *
lut
,

1946 (*
check_routöe
)(
lu_èrgë
 *),

1947 (*
hó…h_check
)(
obd_exp‹t
 *))

1949 
obd_devi˚
 *
obd
 = 
lut
->
lut_obd
;

1950 
èrgë_di°ribuã_txn_d©a
 *
tdtd
;

1951 
ª≥©
:

1952 i‡((
obd
->
obd_ªcovîy_°¨t
 !0Ë&& (
	`cfs_time_cuºít_£c
() >=

1953 (
obd
->
obd_ªcovîy_°¨t
 + obd->
obd_ªcovîy_time_h¨d
))) {

1954 
__u64
 
√xt_upd©e_å™¢o
 = 0;

1958 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1959 i‡(
lut
->
lut_tdtd
 !
NULL
) {

1960 
√xt_upd©e_å™¢o
 =

1961 
	`di°ribuã_txn_gë_√xt_å™¢o
(
lut
->
lut_tdtd
);

1963 
tdtd
 = 
lut
->
lut_tdtd
;

1967 i‡(
√xt_upd©e_å™¢o
 == 0) {

1968 
l_waô_öfo
 
lwi
 = { 0 };

1970 
	`l_waô_evít
(
tdtd
->
tdtd_ªcovîy_thªads_waôq
,

1971 
	`©omic_ªad
(

1972 &
tdtd
->
tdtd_ªcovîy_thªads_cou¡
) == 0,

1973 &
lwi
);

1975 
√xt_upd©e_å™¢o
 =

1976 
	`di°ribuã_txn_gë_√xt_å™¢o
(

1977 
lut
->
lut_tdtd
);

1981 i‡(
√xt_upd©e_å™¢o
 !0 && !
obd
->
obd_ab‹t_ªcovîy
) {

1982 
obd
->
obd_√xt_ªcovîy_å™¢o
 = 
√xt_upd©e_å™¢o
;

1983 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

1988 
	`˛ass_disc⁄√˘_°Æe_exp‹ts
(
obd
,

1989 
exp_föished_‹_‰om_mdt
);

1992 
	`ab‹t_ªq_ª∂ay_queue
(
obd
);

1993 
	`ab‹t_lock_ª∂ay_queue
(
obd
);

1994 
	`CDEBUG
(
D_HA
, "%s:Åhîê¨ê°û»upd©êª∂ay ("
LPX64


1995 ")öÅhêqueue.\n", 
obd
->
obd_«me
,

1996 
√xt_upd©e_å™¢o
);

1998 
obd
->
obd_ab‹t_ªcovîy
 = 1;

1999 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2000 
	`CWARN
("%sÑecovery isáborted by hardÅimeout\n",

2001 
obd
->
obd_«me
);

2005 
	`waô_evít_timeout
(
obd
->
obd_√xt_å™¢o_waôq
,

2006 
	`check_routöe
(
lut
),

2007 
	`m£cs_to_jiffõs
(60 * 
MSEC_PER_SEC
)) == 0)

2010 i‡(
obd
->
obd_ab‹t_ªcovîy
) {

2011 
	`CWARN
("recovery isáborted,ÉvictÉxports inÑecovery\n");

2012 i‡(
lut
->
lut_tdtd
 !
NULL
) {

2013 
l_waô_öfo
 
lwi
 = { 0 };

2015 
tdtd
 = 
lut
->
lut_tdtd
;

2018 
	`l_waô_evít
(
tdtd
->
tdtd_ªcovîy_thªads_waôq
,

2019 
	`©omic_ªad
(&
tdtd
->
tdtd_ªcovîy_thªads_cou¡
) == 0,

2020 &
lwi
);

2022 
	`dåq_li°_dump
(
lut
->
lut_tdtd
, 
D_ERROR
);

2023 
	`dåq_li°_de°roy
(
lut
->
lut_tdtd
);

2027 
	`˛ass_disc⁄√˘_°Æe_exp‹ts
(
obd
, 
exp_föished
);

2029 } i‡(
obd
->
obd_ªcovîy_expúed
) {

2030 
obd
->
obd_ªcovîy_expúed
 = 0;

2032 
	`LCONSOLE_WARN
("%s:Ñecovery isÅimed out, "

2033 "evi˘ sèÀÉxp‹ts\n", 
obd
->
obd_«me
);

2035 
	`˛ass_disc⁄√˘_°Æe_exp‹ts
(
obd
, 
hó…h_check
);

2038 
	`•ö_lock
(&
obd
->
obd_dev_lock
);

2039 
obd
->
obd_vîsi⁄_ªcov
 = 1;

2040 
	`•ö_u∆ock
(&
obd
->
obd_dev_lock
);

2045 
	`exãnd_ªcovîy_timî
(
obd
, 
RECONNECT_DELAY_MAX
, 
åue
);

2047 
ª≥©
;

2050 
	}
}

2052 
±Ãpc_ªque°
 *
	$èrgë_√xt_ª∂ay_lock
(
lu_èrgë
 *
lut
)

2054 
obd_devi˚
 *
obd
 = 
lut
->
lut_obd
;

2055 
±Ãpc_ªque°
 *
ªq
 = 
NULL
;

2057 
	`CDEBUG
(
D_HA
, "Waiting forÜock\n");

2058 i‡(
	`èrgë_ªcovîy_ovî£î
(
lut
, 
check_f‹_√xt_lock
,

2059 
exp_lock_ª∂ay_hó…hy
))

2060 
	`ab‹t_lock_ª∂ay_queue
(
obd
);

2062 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2063 i‡(!
	`li°_em±y
(&
obd
->
obd_lock_ª∂ay_queue
)) {

2064 
ªq
 = 
	`li°_íåy
(
obd
->
obd_lock_ª∂ay_queue
.
√xt
,

2065 
±Ãpc_ªque°
, 
rq_li°
);

2066 
	`li°_dñ_öô
(&
ªq
->
rq_li°
);

2067 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2069 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2070 
	`LASSERT
(
	`li°_em±y
(&
obd
->
obd_lock_ª∂ay_queue
));

2071 
	`LASSERT
(
	`©omic_ªad
(&
obd
->
obd_lock_ª∂ay_˛õ¡s
) == 0);

2073 
	`˛ass_disc⁄√˘_°Æe_exp‹ts
(
obd
, 
exp_vbr_hó…hy
);

2075  
ªq
;

2076 
	}
}

2078 
±Ãpc_ªque°
 *
	$èrgë_√xt_föÆ_pög
(
obd_devi˚
 *
obd
)

2080 
±Ãpc_ªque°
 *
ªq
 = 
NULL
;

2082 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2083 i‡(!
	`li°_em±y
(&
obd
->
obd_föÆ_ªq_queue
)) {

2084 
ªq
 = 
	`li°_íåy
(
obd
->
obd_föÆ_ªq_queue
.
√xt
,

2085 
±Ãpc_ªque°
, 
rq_li°
);

2086 
	`li°_dñ_öô
(&
ªq
->
rq_li°
);

2087 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2088 i‡(
ªq
->
rq_exp‹t
->
exp_ö_ªcovîy
) {

2089 
	`•ö_lock
(&
ªq
->
rq_exp‹t
->
exp_lock
);

2090 
ªq
->
rq_exp‹t
->
exp_ö_ªcovîy
 = 0;

2091 
	`•ö_u∆ock
(&
ªq
->
rq_exp‹t
->
exp_lock
);

2094 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2096  
ªq
;

2097 
	}
}

2099 
	$h™dÀ_ªcovîy_ªq
(
±Ãpc_thªad
 *
thªad
,

2100 
±Ãpc_ªque°
 *
ªq
,

2101 
svc_h™dÀr_t
 
h™dÀr
)

2103 
ENTRY
;

2109 i‡(
ªq
->
rq_exp‹t
->
exp_disc⁄√˘ed
)

2110 
RETURN_EXIT
;

2112 
ªq
->
rq_£ssi⁄
.
lc_thªad
 = 
thªad
;

2113 
ªq
->
rq_svc_thªad
 = 
thªad
;

2114 
ªq
->
rq_svc_thªad
->
t_ív
->
À_£s
 = &ªq->
rq_£ssi⁄
;

2117 
	`lu_c⁄ãxt_íãr
(&
thªad
->
t_ív
->
À_˘x
);

2118 ()
	`h™dÀr
(
ªq
);

2119 
	`lu_c⁄ãxt_exô
(&
thªad
->
t_ív
->
À_˘x
);

2122 i‡(!
	`exp_föished
(
ªq
->
rq_exp‹t
)) {

2123 
to
 = 
obd_timeout
;

2129 i‡(!
AT_OFF
) {

2130 
±Ãpc_£rvi˚_∑π
 *
sv˝t
;

2132 
sv˝t
 = 
ªq
->
rq_rqbd
->
rqbd_sv˝t
;

2138 
to
 = 
	`max
(()
	`©_e°2timeout
(

2139 
	`©_gë
(&
sv˝t
->
s˝_©_e°im©e
)),

2140 ()
	`lu°ª_msg_gë_timeout
(
ªq
->
rq_ªqmsg
));

2145 
to
 +2 * 
	`lu°ª_msg_gë_£rvi˚_time
(
ªq
->
rq_ªqmsg
);

2147 
	`exãnd_ªcovîy_timî
(
	`˛ass_exp2obd
(
ªq
->
rq_exp‹t
), 
to
, 
åue
);

2149 
EXIT
;

2150 
	}
}

2153 
	$check_f‹_ªcovîy_ªady
(
lu_èrgë
 *
lut
)

2155 
obd_devi˚
 *
obd
 = 
lut
->
lut_obd
;

2156 
˛¡s
 = 
	`©omic_ªad
(&
obd
->
obd_c⁄√˘ed_˛õ¡s
);

2158 
	`CDEBUG
(
D_HA
, "connected %d stale %d max_recoverable_clients %d"

2159 "áb‹à%dÉxpúed %d\n", 
˛¡s
, 
obd
->
obd_°Æe_˛õ¡s
,

2160 
obd
->
obd_max_ªcovîabÀ_˛õ¡s
, obd->
obd_ab‹t_ªcovîy
,

2161 
obd
->
obd_ªcovîy_expúed
);

2163 i‡(!
obd
->
obd_ab‹t_ªcovîy
 && !obd->
obd_ªcovîy_expúed
) {

2164 
	`LASSERT
(
˛¡s
 <
obd
->
obd_max_ªcovîabÀ_˛õ¡s
);

2165 i‡(
˛¡s
 + 
obd
->
obd_°Æe_˛õ¡s
 <

2166 
obd
->
obd_max_ªcovîabÀ_˛õ¡s
)

2170 i‡(
lut
->
lut_tdtd
 !
NULL
) {

2171 i‡(!
lut
->
lut_tdtd
->
tdtd_ª∂ay_ªady
 &&

2172 !
obd
->
obd_ab‹t_ªcovîy
) {

2175 
	`exãnd_ªcovîy_timî
(
obd
, obd->
obd_ªcovîy_timeout
,

2176 
åue
);

2177 
	`CDEBUG
(
D_HA
, "%s updateÑecovery isÇotÑeady,"

2178 "ÉxãndÑecovîy %d\n", 
obd
->
obd_«me
,

2179 
obd
->
obd_ªcovîy_timeout
);

2182 
	`dåq_li°_dump
(
lut
->
lut_tdtd
, 
D_HA
);

2187 
	}
}

2190 
	mREQUEST_RECOVERY
 = 1,

2191 
	mUPDATE_RECOVERY
 = 2,

2194 
__u64
 
	$gë_√xt_ª∂ay_ªq_å™¢o
(
obd_devi˚
 *
obd
)

2196 
__u64
 
å™¢o
 = 0;

2198 i‡(!
	`li°_em±y
(&
obd
->
obd_ªq_ª∂ay_queue
)) {

2199 
±Ãpc_ªque°
 *
ªq
;

2201 
ªq
 = 
	`li°_íåy
(
obd
->
obd_ªq_ª∂ay_queue
.
√xt
,

2202 
±Ãpc_ªque°
, 
rq_li°
);

2203 
å™¢o
 = 
	`lu°ª_msg_gë_å™¢o
(
ªq
->
rq_ªqmsg
);

2206  
å™¢o
;

2207 
	}
}

2209 
__u64
 
	$gë_√xt_å™¢o
(
lu_èrgë
 *
lut
, *
ty≥
)

2211 
obd_devi˚
 *
obd
 = 
lut
->
lut_obd
;

2212 
èrgë_di°ribuã_txn_d©a
 *
tdtd
 = 
lut
->
lut_tdtd
;

2213 
__u64
 
å™¢o
 = 0;

2214 
__u64
 
upd©e_å™¢o
;

2215 
ENTRY
;

2217 
å™¢o
 = 
	`gë_√xt_ª∂ay_ªq_å™¢o
(
obd
);

2218 i‡(
ty≥
 !
NULL
)

2219 *
ty≥
 = 
REQUEST_RECOVERY
;

2221 i‡(
tdtd
 =
NULL
)

2222 
	`RETURN
(
å™¢o
);

2224 
upd©e_å™¢o
 = 
	`di°ribuã_txn_gë_√xt_å™¢o
(
tdtd
);

2225 i‡(
å™¢o
 =0 || (å™¢ÿ>
upd©e_å™¢o
 &&

2226 
upd©e_å™¢o
 != 0)) {

2227 
å™¢o
 = 
upd©e_å™¢o
;

2228 i‡(
ty≥
 !
NULL
)

2229 *
ty≥
 = 
UPDATE_RECOVERY
;

2232 
	`RETURN
(
å™¢o
);

2233 
	}
}

2246 
	$dr›_du∂iˇã_ª∂ay_ªq
(
lu_ív
 *
ív
,

2247 
obd_devi˚
 *
obd
,

2248 
±Ãpc_ªque°
 *
ªq
)

2250 
	`DEBUG_REQ
(
D_HA
, 
ªq
, "ªmovêt"
LPD64
" from %s because of duplicate"

2252 
	`lu°ª_msg_gë_å™¢o
(
ªq
->
rq_ªqmsg
),

2253 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
));

2257 i‡(
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
Ë=
MDS_REINT
) {

2258 
	`ªq_ˇpsuÀ_£t
(&
ªq
->
rq_pûl
, &
RQF_MDS_REINT
);

2259 
ªq
->
rq_°©us
 = 
	`ªq_ˇpsuÀ_£rvî_∑ck
(&ªq->
rq_pûl
);

2260 i‡(
	`likñy
(
ªq
->
rq_exp‹t
))

2261 
	`èrgë_commôãd_to_ªq
(
ªq
);

2262 
	`lu°ª_msg_£t_å™¢o
(
ªq
->
rq_ªpmsg
,Ñeq->
rq_å™¢o
);

2263 
	`èrgë_£nd_ª∂y
(
ªq
,Ñeq->
rq_°©us
, 0);

2265 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "wrong opc" "from %s\n",

2266 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
));

2268 
	`èrgë_exp_dequeue_ªq_ª∂ay
(
ªq
);

2269 
	`èrgë_ªque°_c›y_put
(
ªq
);

2270 
obd
->
obd_ª∂ayed_ªque°s
++;

2271 
	}
}

2273 
	$ª∂ay_ªque°_‹_upd©e
(
lu_ív
 *
ív
,

2274 
lu_èrgë
 *
lut
,

2275 
èrgë_ªcovîy_d©a
 *
åd
,

2276 
±Ãpc_thªad
 *
thªad
)

2278 
obd_devi˚
 *
obd
 = 
lut
->
lut_obd
;

2279 
±Ãpc_ªque°
 *
ªq
 = 
NULL
;

2280 
ty≥
;

2281 
__u64
 
å™¢o
;

2282 
ENTRY
;

2284 
	`CDEBUG
(
D_HA
, "Waôög f‹Åøn¢ÿ"
LPD64
"\n",

2285 
obd
->
obd_√xt_ªcovîy_å™¢o
);

2289 
èrgë_di°ribuã_txn_d©a
 *
tdtd
 = 
lut
->
lut_tdtd
;

2291 
	`CFS_FAIL_TIMEOUT
(
OBD_FAIL_TGT_REPLAY_DELAY2
, 
cfs_Áû_vÆ
);

2298 
	`CFS_FAIL_TIMEOUT_MS
(
OBD_FAIL_TGT_REPLAY_DELAY
, 300);

2300 i‡(
	`èrgë_ªcovîy_ovî£î
(
lut
, 
check_f‹_√xt_å™¢o
,

2301 
exp_ªq_ª∂ay_hó…hy_‹_‰om_mdt
)) {

2302 
	`ab‹t_ªq_ª∂ay_queue
(
obd
);

2303 
	`ab‹t_lock_ª∂ay_queue
(
obd
);

2304 
ab‹t
;

2307 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2308 
å™¢o
 = 
	`gë_√xt_å™¢o
(
lut
, &
ty≥
);

2309 i‡(
ty≥
 =
REQUEST_RECOVERY
 && 
å™¢o
 != 0) {

2313 
ªq
 = 
	`li°_íåy
(
obd
->
obd_ªq_ª∂ay_queue
.
√xt
,

2314 
±Ãpc_ªque°
, 
rq_li°
);

2316 
	`li°_dñ_öô
(&
ªq
->
rq_li°
);

2317 
obd
->
obd_ªque°s_queued_f‹_ªcovîy
--;

2318 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2322 i‡(
	`is_ªq_ª∂ayed_by_upd©e
(
ªq
)) {

2323 
di°ribuã_txn_ª∂ay_ªq
 *
dåq
;

2325 
dåq
 = 
	`di°ribuã_txn_lookup_föish_li°
(
tdtd
,

2326 
ªq
->
rq_xid
);

2327 
	`LASSERT
(
dåq
 !
NULL
);

2328 
	`•ö_lock
(&
tdtd
->
tdtd_ª∂ay_li°_lock
);

2329 
	`li°_dñ_öô
(&
dåq
->
dåq_li°
);

2330 
	`•ö_u∆ock
(&
tdtd
->
tdtd_ª∂ay_li°_lock
);

2331 
	`dåq_de°roy
(
dåq
);

2333 
	`dr›_du∂iˇã_ª∂ay_ªq
(
ív
, 
obd
, 
ªq
);

2338 
	`LASSERT
(
åd
->
åd_¥o˚ssög_èsk
 =
	`cuºít_pid
());

2339 
	`DEBUG_REQ
(
D_HA
, 
ªq
, "¥o˚ssögÅ"
LPD64
" from %s",

2340 
	`lu°ª_msg_gë_å™¢o
(
ªq
->
rq_ªqmsg
),

2341 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
));

2343 
	`h™dÀ_ªcovîy_ªq
(
thªad
, 
ªq
,

2344 
åd
->
åd_ªcovîy_h™dÀr
);

2349 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2350 
obd
->
obd_√xt_ªcovîy_å™¢o
++;

2351 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2352 
	`èrgë_exp_dequeue_ªq_ª∂ay
(
ªq
);

2353 
	`èrgë_ªque°_c›y_put
(
ªq
);

2354 
obd
->
obd_ª∂ayed_ªque°s
++;

2355 } i‡(
ty≥
 =
UPDATE_RECOVERY
 && 
å™¢o
 != 0) {

2356 
di°ribuã_txn_ª∂ay_ªq
 *
dåq
;

2357 
rc
;

2359 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2361 
	`LASSERT
(
tdtd
 !
NULL
);

2362 
dåq
 = 
	`di°ribuã_txn_gë_√xt_ªq
(
tdtd
);

2363 
	`lu_c⁄ãxt_íãr
(&
thªad
->
t_ív
->
À_˘x
);

2364 
rc
 = 
tdtd
->
	`tdtd_ª∂ay_h™dÀr
(
ív
,Ådtd, 
dåq
);

2365 
	`lu_c⁄ãxt_exô
(&
thªad
->
t_ív
->
À_˘x
);

2366 
	`exãnd_ªcovîy_timî
(
obd
, 
obd_timeout
, 
åue
);

2368 i‡(
rc
 =0 && 
dåq
->
dåq_xid
 != 0) {

2369 
	`CDEBUG
(
D_HA
, "Movêx"
LPU64
"Å"LPU64

2370 "ÅÿföishÜi°\n", 
dåq
->
dåq_xid
,

2371 
dåq
->
dåq_ma°î_å™¢o
);

2374 
	`•ö_lock
(&
tdtd
->
tdtd_ª∂ay_li°_lock
);

2375 
	`li°_add
(&
dåq
->
dåq_li°
,

2376 &
tdtd
->
tdtd_ª∂ay_föish_li°
);

2377 
	`•ö_u∆ock
(&
tdtd
->
tdtd_ª∂ay_li°_lock
);

2379 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2380 i‡(
å™¢o
 =
obd
->
obd_√xt_ªcovîy_å™¢o
)

2381 
obd
->
obd_√xt_ªcovîy_å™¢o
++;

2382 i‡(
å™¢o
 >

2383 
obd
->
obd_√xt_ªcovîy_å™¢o
)

2384 
obd
->
obd_√xt_ªcovîy_å™¢o
 =

2385 
å™¢o
 + 1;

2386 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2388 
	`dåq_de°roy
(
dåq
);

2391 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2392 
ab‹t
:

2393 
	`LASSERT
(
	`li°_em±y
(&
obd
->
obd_ªq_ª∂ay_queue
));

2394 
	`LASSERT
(
	`©omic_ªad
(&
obd
->
obd_ªq_ª∂ay_˛õ¡s
) == 0);

2396 
	`˛ass_disc⁄√˘_°Æe_exp‹ts
(
obd
, 
exp_vbr_hó…hy
);

2400 
	}
}

2402 
	$èrgë_ªcovîy_thªad
(*
¨g
)

2404 
lu_èrgë
 *
lut
 = 
¨g
;

2405 
obd_devi˚
 *
obd
 = 
lut
->
lut_obd
;

2406 
±Ãpc_ªque°
 *
ªq
;

2407 
èrgë_ªcovîy_d©a
 *
åd
 = &
obd
->
obd_ªcovîy_d©a
;

2408 
dñè
;

2409 
lu_ív
 *
ív
;

2410 
±Ãpc_thªad
 *
thªad
 = 
NULL
;

2411 
rc
 = 0;

2412 
ENTRY
;

2414 
	`unsh¨e_fs_°ru˘
();

2415 
	`OBD_ALLOC_PTR
(
thªad
);

2416 i‡(
thªad
 =
NULL
)

2417 
	`RETURN
(-
ENOMEM
);

2419 
	`OBD_ALLOC_PTR
(
ív
);

2420 i‡(
ív
 =
NULL
) {

2421 
	`OBD_FREE_PTR
(
thªad
);

2422 
	`RETURN
(-
ENOMEM
);

2425 
rc
 = 
	`lu_c⁄ãxt_öô
(&
ív
->
À_˘x
, 
LCT_MD_THREAD
 | 
LCT_DT_THREAD
);

2426 i‡(
rc
) {

2427 
	`OBD_FREE_PTR
(
thªad
);

2428 
	`OBD_FREE_PTR
(
ív
);

2429 
	`RETURN
(
rc
);

2432 
thªad
->
t_ív
 = 
ív
;

2433 
thªad
->
t_id
 = -1;

2434 
ív
->
À_˘x
.
lc_thªad
 = 
thªad
;

2435 
	`tgt_io_thªad_öô
(
thªad
);

2436 
thªad
->
t_w©chdog
 = 
NULL
;

2438 
	`CDEBUG
(
D_HA
, "%s: sèπedÑecovîyÅhªadÖid %d\n", 
obd
->
obd_«me
,

2439 
	`cuºít_pid
());

2440 
åd
->
åd_¥o˚ssög_èsk
 = 
	`cuºít_pid
();

2442 
	`•ö_lock
(&
obd
->
obd_dev_lock
);

2443 
obd
->
obd_ªcovîög
 = 1;

2444 
	`•ö_u∆ock
(&
obd
->
obd_dev_lock
);

2445 
	`com∂ëe
(&
åd
->
åd_°¨tög
);

2448 i‡(
	`èrgë_ªcovîy_ovî£î
(
lut
, 
check_f‹_ªcovîy_ªady
,

2449 
exp_c⁄√˘_hó…hy
)) {

2450 
	`ab‹t_ªq_ª∂ay_queue
(
obd
);

2451 
	`ab‹t_lock_ª∂ay_queue
(
obd
);

2452 i‡(
lut
->
lut_tdtd
 !
NULL
)

2453 
	`dåq_li°_de°roy
(
lut
->
lut_tdtd
);

2457 
dñè
 = 
jiffõs
;

2458 
	`CDEBUG
(
D_INFO
, "1:Ñeque°Ñïœy sègê- %d clõ¡†‰omÅ"
LPU64
"\n",

2459 
	`©omic_ªad
(&
obd
->
obd_ªq_ª∂ay_˛õ¡s
),

2460 
obd
->
obd_√xt_ªcovîy_å™¢o
);

2461 
	`ª∂ay_ªque°_‹_upd©e
(
ív
, 
lut
, 
åd
, 
thªad
);

2466 
	`CDEBUG
(
D_INFO
, "2:ÜockÑeplay stage - %d clients\n",

2467 
	`©omic_ªad
(&
obd
->
obd_lock_ª∂ay_˛õ¡s
));

2468 (
ªq
 = 
	`èrgë_√xt_ª∂ay_lock
(
lut
))) {

2469 
	`LASSERT
(
åd
->
åd_¥o˚ssög_èsk
 =
	`cuºít_pid
());

2470 
	`DEBUG_REQ
(
D_HA
, 
ªq
, "processingÜock from %s: ",

2471 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
));

2472 
	`h™dÀ_ªcovîy_ªq
(
thªad
, 
ªq
,

2473 
åd
->
åd_ªcovîy_h™dÀr
);

2474 
	`èrgë_ªque°_c›y_put
(
ªq
);

2475 
obd
->
obd_ª∂ayed_locks
++;

2482 
	`CFS_FAIL_TIMEOUT
(
OBD_FAIL_TGT_REPLAY_RECONNECT
, 
cfs_Áû_vÆ
);

2483 
	`CDEBUG
(
D_INFO
, "3: final stage -ÖrocessÑecovery completionÖings\n");

2485 
	`tgt_boŸ_ïoch_upd©e
(
lut
);

2488 
	`•ö_lock
(&
obd
->
obd_dev_lock
);

2489 
obd
->
obd_ªcovîög
 = obd->
obd_ab‹t_ªcovîy
 = 0;

2490 
	`•ö_u∆ock
(&
obd
->
obd_dev_lock
);

2491 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2492 
	`èrgë_ˇn˚l_ªcovîy_timî
(
obd
);

2493 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2494 (
ªq
 = 
	`èrgë_√xt_föÆ_pög
(
obd
))) {

2495 
	`LASSERT
(
åd
->
åd_¥o˚ssög_èsk
 =
	`cuºít_pid
());

2496 
	`DEBUG_REQ
(
D_HA
, 
ªq
, "processing finalÖing from %s: ",

2497 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
));

2498 
	`h™dÀ_ªcovîy_ªq
(
thªad
, 
ªq
,

2499 
åd
->
åd_ªcovîy_h™dÀr
);

2503 
	`±Ãpc_upd©e_exp‹t_timî
(
ªq
->
rq_exp‹t
, 0);

2504 
	`èrgë_ªque°_c›y_put
(
ªq
);

2507 
dñè
 = 
	`jiffõs_to_m£cs
(
jiffõs
 - dñèË/ 
MSEC_PER_SEC
;

2508 
	`CDEBUG
(
D_INFO
,"4:Ñecovery completed in %lus - %d/%dÑeqs/locks\n",

2509 
dñè
, 
obd
->
obd_ª∂ayed_ªque°s
, obd->
obd_ª∂ayed_locks
);

2510 i‡(
dñè
 > 
OBD_RECOVERY_TIME_SOFT
) {

2511 
	`CWARN
("tooÜongÑecovery -ÑeadÜogs\n");

2512 
	`libcfs_debug_dum∂og
();

2515 
	`èrgë_föish_ªcovîy
(
lut
);

2517 
	`lu_c⁄ãxt_föi
(&
ív
->
À_˘x
);

2518 
åd
->
åd_¥o˚ssög_èsk
 = 0;

2519 
	`com∂ëe
(&
åd
->
åd_föishög
);

2521 
	`tgt_io_thªad_d⁄e
(
thªad
);

2522 
	`OBD_FREE_PTR
(
thªad
);

2523 
	`OBD_FREE_PTR
(
ív
);

2524 
	`RETURN
(
rc
);

2525 
	}
}

2527 
	$èrgë_°¨t_ªcovîy_thªad
(
lu_èrgë
 *
lut
,

2528 
svc_h™dÀr_t
 
h™dÀr
)

2530 
obd_devi˚
 *
obd
 = 
lut
->
lut_obd
;

2531 
rc
 = 0;

2532 
èrgë_ªcovîy_d©a
 *
åd
 = &
obd
->
obd_ªcovîy_d©a
;

2533 
ödex
;

2535 
	`mem£t
(
åd
, 0, (*trd));

2536 
	`öô_com∂ëi⁄
(&
åd
->
åd_°¨tög
);

2537 
	`öô_com∂ëi⁄
(&
åd
->
åd_föishög
);

2538 
åd
->
åd_ªcovîy_h™dÀr
 = 
h™dÀr
;

2540 
rc
 = 
	`£rvî_«me2ödex
(
obd
->
obd_«me
, &
ödex
, 
NULL
);

2541 i‡(
rc
 < 0)

2542  
rc
;

2544 i‡(!
	`IS_ERR
(
	`kthªad_run
(
èrgë_ªcovîy_thªad
,

2545 
lut
, "tgt_ªcovî_%d", 
ödex
))) {

2546 
	`waô_f‹_com∂ëi⁄
(&
åd
->
åd_°¨tög
);

2547 
	`LASSERT
(
obd
->
obd_ªcovîög
 != 0);

2549 
rc
 = -
ECHILD
;

2552  
rc
;

2553 
	}
}

2555 
	$èrgë_°›_ªcovîy_thªad
(
obd_devi˚
 *
obd
)

2557 i‡(
obd
->
obd_ªcovîy_d©a
.
åd_¥o˚ssög_èsk
 > 0) {

2558 
èrgë_ªcovîy_d©a
 *
åd
 = &
obd
->
obd_ªcovîy_d©a
;

2560 
	`•ö_lock
(&
obd
->
obd_dev_lock
);

2561 i‡(
obd
->
obd_ªcovîög
) {

2562 
	`CERROR
("%s: Ab‹tögÑecovîy\n", 
obd
->
obd_«me
);

2563 
obd
->
obd_ab‹t_ªcovîy
 = 1;

2564 
	`wake_up
(&
obd
->
obd_√xt_å™¢o_waôq
);

2566 
	`•ö_u∆ock
(&
obd
->
obd_dev_lock
);

2567 
	`waô_f‹_com∂ëi⁄
(&
åd
->
åd_föishög
);

2569 
	}
}

2570 
EXPORT_SYMBOL
(
èrgë_°›_ªcovîy_thªad
);

2572 
	$èrgë_ªcovîy_föi
(
obd_devi˚
 *
obd
)

2574 
	`˛ass_disc⁄√˘_exp‹ts
(
obd
);

2575 
	`èrgë_°›_ªcovîy_thªad
(
obd
);

2576 
	`èrgë_˛ónup_ªcovîy
(
obd
);

2577 
	}
}

2578 
EXPORT_SYMBOL
(
èrgë_ªcovîy_föi
);

2580 
	$èrgë_ªcovîy_expúed
(
ˇ°meh¨dî
)

2582 
obd_devi˚
 *
obd
 = (obd_devi˚ *)
ˇ°meh¨dî
;

2583 
	`CDEBUG
(
D_HA
, "%s:ÑecoveryÅimed out; %d clientsáre still inÑecovery"

2585 
obd
->
obd_«me
, 
	`©omic_ªad
(&obd->
obd_lock_ª∂ay_˛õ¡s
),

2586 
	`cfs_time_cuºít_£c
()- 
obd
->
obd_ªcovîy_°¨t
,

2587 
	`©omic_ªad
(&
obd
->
obd_c⁄√˘ed_˛õ¡s
));

2589 
obd
->
obd_ªcovîy_expúed
 = 1;

2590 
	`wake_up
(&
obd
->
obd_√xt_å™¢o_waôq
);

2591 
	}
}

2593 
	$èrgë_ªcovîy_öô
(
lu_èrgë
 *
lut
, 
svc_h™dÀr_t
 
h™dÀr
)

2595 
obd_devi˚
 *
obd
 = 
lut
->
lut_obd
;

2597 i‡(
obd
->
obd_max_ªcovîabÀ_˛õ¡s
 == 0) {

2599 
	`tgt_boŸ_ïoch_upd©e
(
lut
);

2603 
	`CDEBUG
(
D_HA
, "RECOVERY: service %s, %dÑecoverable clients, "

2604 "œ°_å™¢ÿ"
LPU64
"\n", 
obd
->
obd_«me
,

2605 
obd
->
obd_max_ªcovîabÀ_˛õ¡s
, obd->
obd_œ°_commôãd
);

2606 
	`LASSERT
(
obd
->
obd_°›pög
 == 0);

2607 
obd
->
obd_√xt_ªcovîy_å™¢o
 = obd->
obd_œ°_commôãd
 + 1;

2608 
obd
->
obd_ªcovîy_°¨t
 = 0;

2609 
obd
->
obd_ªcovîy_íd
 = 0;

2611 
	`cfs_timî_öô
(&
obd
->
obd_ªcovîy_timî
, 
èrgë_ªcovîy_expúed
, obd);

2612 
	`èrgë_°¨t_ªcovîy_thªad
(
lut
, 
h™dÀr
);

2613 
	}
}

2614 
EXPORT_SYMBOL
(
èrgë_ªcovîy_öô
);

2616 
	$èrgë_¥o˚ss_ªq_Êags
(
obd_devi˚
 *
obd
,

2617 
±Ãpc_ªque°
 *
ªq
)

2619 
obd_exp‹t
 *
exp
 = 
ªq
->
rq_exp‹t
;

2620 
	`LASSERT
(
exp
 !
NULL
);

2621 i‡(
	`lu°ª_msg_gë_Êags
(
ªq
->
rq_ªqmsg
Ë& 
MSG_REQ_REPLAY_DONE
) {

2623 
	`•ö_lock
(&
exp
->
exp_lock
);

2624 i‡(
exp
->
exp_ªq_ª∂ay_√eded
) {

2625 
exp
->
exp_ªq_ª∂ay_√eded
 = 0;

2626 
	`•ö_u∆ock
(&
exp
->
exp_lock
);

2628 
	`LASSERT_ATOMIC_POS
(&
obd
->
obd_ªq_ª∂ay_˛õ¡s
);

2629 
	`©omic_dec
(&
obd
->
obd_ªq_ª∂ay_˛õ¡s
);

2631 
	`•ö_u∆ock
(&
exp
->
exp_lock
);

2634 i‡(
	`lu°ª_msg_gë_Êags
(
ªq
->
rq_ªqmsg
Ë& 
MSG_LOCK_REPLAY_DONE
) {

2637 
	`•ö_lock
(&
exp
->
exp_lock
);

2638 i‡(
exp
->
exp_lock_ª∂ay_√eded
) {

2639 
exp
->
exp_lock_ª∂ay_√eded
 = 0;

2640 
	`•ö_u∆ock
(&
exp
->
exp_lock
);

2642 
	`LASSERT_ATOMIC_POS
(&
obd
->
obd_lock_ª∂ay_˛õ¡s
);

2643 
	`©omic_dec
(&
obd
->
obd_lock_ª∂ay_˛õ¡s
);

2645 
	`•ö_u∆ock
(&
exp
->
exp_lock
);

2649 
	}
}

2651 
	$èrgë_queue_ªcovîy_ªque°
(
±Ãpc_ªque°
 *
ªq
,

2652 
obd_devi˚
 *
obd
)

2654 
__u64
 
å™¢o
 = 
	`lu°ª_msg_gë_å™¢o
(
ªq
->
rq_ªqmsg
);

2655 
±Ãpc_ªque°
 *
ªqôî
;

2656 
ö£πed
 = 0;

2657 
ENTRY
;

2659 i‡(
obd
->
obd_ªcovîy_d©a
.
åd_¥o˚ssög_èsk
 =
	`cuºít_pid
()) {

2661 
	`RETURN
(1);

2664 
	`èrgë_¥o˚ss_ªq_Êags
(
obd
, 
ªq
);

2666 i‡(
	`lu°ª_msg_gë_Êags
(
ªq
->
rq_ªqmsg
Ë& 
MSG_LOCK_REPLAY_DONE
) {

2669 
	`èrgë_ªque°_c›y_gë
(
ªq
);

2670 
	`DEBUG_REQ
(
D_HA
, 
ªq
, "queue finalÑeq");

2671 
	`wake_up
(&
obd
->
obd_√xt_å™¢o_waôq
);

2672 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2673 i‡(
obd
->
obd_ªcovîög
) {

2674 
	`li°_add_èû
(&
ªq
->
rq_li°
,

2675 &
obd
->
obd_föÆ_ªq_queue
);

2677 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2678 
	`èrgë_ªque°_c›y_put
(
ªq
);

2679 
	`RETURN
(
obd
->
obd_°›pög
 ? -
ENOTCONN
 : 1);

2681 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2682 
	`RETURN
(0);

2684 i‡(
	`lu°ª_msg_gë_Êags
(
ªq
->
rq_ªqmsg
Ë& 
MSG_REQ_REPLAY_DONE
) {

2686 
	`èrgë_ªque°_c›y_gë
(
ªq
);

2687 
	`DEBUG_REQ
(
D_HA
, 
ªq
, "queueÜockÑeplayÑeq");

2688 
	`wake_up
(&
obd
->
obd_√xt_å™¢o_waôq
);

2689 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2690 
	`LASSERT
(
obd
->
obd_ªcovîög
);

2692 i‡(!
ªq
->
rq_exp‹t
->
exp_ö_ªcovîy
) {

2693 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2694 
	`èrgë_ªque°_c›y_put
(
ªq
);

2695 
	`RETURN
(-
ENOTCONN
);

2697 
	`LASSERT
(
ªq
->
rq_exp‹t
->
exp_lock_ª∂ay_√eded
);

2698 
	`li°_add_èû
(&
ªq
->
rq_li°
, &
obd
->
obd_lock_ª∂ay_queue
);

2699 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2700 
	`RETURN
(0);

2707 i‡(!
å™¢o
) {

2708 
	`INIT_LIST_HEAD
(&
ªq
->
rq_li°
);

2709 
	`DEBUG_REQ
(
D_HA
, 
ªq
, "not queueing");

2710 
	`RETURN
(1);

2723 
	`CDEBUG
(
D_HA
, "NexàªcovîyÅøn¢o: "
LPU64


2724 ", cuºít: "
LPU64
",Ñeplaying\n",

2725 
obd
->
obd_√xt_ªcovîy_å™¢o
, 
å™¢o
);

2730 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2731 i‡(
å™¢o
 < 
obd
->
obd_√xt_ªcovîy_å™¢o
 &&

2732 !
	`is_ªq_ª∂ayed_by_upd©e
(
ªq
)) {

2734 
	`LASSERT
(
	`li°_em±y
(&
ªq
->
rq_li°
));

2735 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2736 
	`RETURN
(1);

2738 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2740 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_TGT_REPLAY_DROP
))

2741 
	`RETURN
(0);

2743 
	`èrgë_ªque°_c›y_gë
(
ªq
);

2744 i‡(!
ªq
->
rq_exp‹t
->
exp_ö_ªcovîy
) {

2745 
	`èrgë_ªque°_c›y_put
(
ªq
);

2746 
	`RETURN
(-
ENOTCONN
);

2748 
	`LASSERT
(
ªq
->
rq_exp‹t
->
exp_ªq_ª∂ay_√eded
);

2750 i‡(
	`èrgë_exp_íqueue_ªq_ª∂ay
(
ªq
)) {

2751 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "droppingÑesent queuedÑeq");

2752 
	`èrgë_ªque°_c›y_put
(
ªq
);

2753 
	`RETURN
(0);

2757 
	`•ö_lock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2758 
	`LASSERT
(
obd
->
obd_ªcovîög
);

2759 
	`li°_f‹_óch_íåy
(
ªqôî
, &
obd
->
obd_ªq_ª∂ay_queue
, 
rq_li°
) {

2760 i‡(
	`lu°ª_msg_gë_å™¢o
(
ªqôî
->
rq_ªqmsg
Ë> 
å™¢o
) {

2761 
	`li°_add_èû
(&
ªq
->
rq_li°
, &
ªqôî
->rq_list);

2762 
ö£πed
 = 1;

2763 
added
;

2766 i‡(
	`u∆ikñy
(
	`lu°ª_msg_gë_å™¢o
(
ªqôî
->
rq_ªqmsg
) ==

2767 
å™¢o
)) {

2768 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "droppingÑeplay:Åransno "

2770 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2771 
	`èrgë_exp_dequeue_ªq_ª∂ay
(
ªq
);

2772 
	`èrgë_ªque°_c›y_put
(
ªq
);

2773 
	`RETURN
(0);

2776 
added
:

2777 i‡(!
ö£πed
)

2778 
	`li°_add_èû
(&
ªq
->
rq_li°
, &
obd
->
obd_ªq_ª∂ay_queue
);

2780 
obd
->
obd_ªque°s_queued_f‹_ªcovîy
++;

2781 
	`•ö_u∆ock
(&
obd
->
obd_ªcovîy_èsk_lock
);

2782 
	`wake_up
(&
obd
->
obd_√xt_å™¢o_waôq
);

2783 
	`RETURN
(0);

2784 
	}
}

2786 
	$èrgë_h™dÀ_pög
(
±Ãpc_ªque°
 *
ªq
)

2788 
	`obd_pög
(
ªq
->
rq_svc_thªad
->
t_ív
,Ñeq->
rq_exp‹t
);

2789  
	`ªq_ˇpsuÀ_£rvî_∑ck
(&
ªq
->
rq_pûl
);

2790 
	}
}

2792 
	$èrgë_commôãd_to_ªq
(
±Ãpc_ªque°
 *
ªq
)

2794 
obd_exp‹t
 *
exp
 = 
ªq
->
rq_exp‹t
;

2796 i‡(!
exp
->
exp_obd
->
obd_no_å™¢o
 && 
ªq
->
rq_ªpmsg
 !
NULL
)

2797 
	`lu°ª_msg_£t_œ°_commôãd
(
ªq
->
rq_ªpmsg
,

2798 
exp
->
exp_œ°_commôãd
);

2800 
	`DEBUG_REQ
(
D_IOCTL
, 
ªq
, "not sendingÜast_committed update (%d/"

2801 "%d)", 
exp
->
exp_obd
->
obd_no_å™¢o
,

2802 
ªq
->
rq_ªpmsg
 =
NULL
);

2804 
	`CDEBUG
(
D_INFO
, "œ°_commôãd "
LPU64
",Åransno "LPU64", xid "LPU64"\n",

2805 
exp
->
exp_œ°_commôãd
, 
ªq
->
rq_å™¢o
,Ñeq->
rq_xid
);

2806 
	}
}

2813 
	$èrgë_∑ck_poﬁ_ª∂y
(
±Ãpc_ªque°
 *
ªq
)

2815 
obd_devi˚
 *
obd
;

2816 
ENTRY
;

2820 i‡(
	`u∆ikñy
(!
ªq
->
rq_exp‹t
 || !ªq->rq_exp‹t->
exp_obd
 ||

2821 !
	`exp_c⁄√˘_Ãu_ªsize
(
ªq
->
rq_exp‹t
))) {

2822 
	`lu°ª_msg_£t_¶v
(
ªq
->
rq_ªpmsg
, 0);

2823 
	`lu°ª_msg_£t_limô
(
ªq
->
rq_ªpmsg
, 0);

2824 
	`RETURN
(0);

2828 
obd
 = 
ªq
->
rq_exp‹t
->
exp_obd
;

2830 
	`ªad_lock
(&
obd
->
obd_poﬁ_lock
);

2831 
	`lu°ª_msg_£t_¶v
(
ªq
->
rq_ªpmsg
, 
obd
->
obd_poﬁ_¶v
);

2832 
	`lu°ª_msg_£t_limô
(
ªq
->
rq_ªpmsg
, 
obd
->
obd_poﬁ_limô
);

2833 
	`ªad_u∆ock
(&
obd
->
obd_poﬁ_lock
);

2835 
	`RETURN
(0);

2836 
	}
}

2838 
	$èrgë_£nd_ª∂y_msg
(
±Ãpc_ªque°
 *
ªq
,

2839 
rc
, 
Áû_id
)

2841 i‡(
	`OBD_FAIL_CHECK_ORSET
(
Áû_id
 & ~
OBD_FAIL_ONCE
, OBD_FAIL_ONCE)) {

2842 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "droppingÑeply");

2843  -
ECOMM
;

2847 i‡(
ªq
->
rq_ªqmsg
 &&

2848 
	`u∆ikñy
(
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
Ë=
MDS_REINT
 &&

2849 
	`OBD_FAIL_CHECK
(
OBD_FAIL_MDS_REINT_MULTI_NET_REP
)))

2850  -
ECOMM
;

2852 i‡(
	`u∆ikñy
(
rc
)) {

2853 
	`DEBUG_REQ
(
D_NET
, 
ªq
, "¥o˚ssögÉº‹ (%d)", 
rc
);

2854 
ªq
->
rq_°©us
 = 
rc
;

2855  
	`±Ãpc_£nd_îr‹
(
ªq
, 1);

2857 
	`DEBUG_REQ
(
D_NET
, 
ªq
, "sendingÑeply");

2860  
	`±Ãpc_£nd_ª∂y
(
ªq
, 
PTLRPC_REPLY_MAYBE_DIFFICULT
);

2861 
	}
}

2863 
	$èrgë_£nd_ª∂y
(
±Ãpc_ªque°
 *
ªq
, 
rc
, 
Áû_id
)

2865 
±Ãpc_£rvi˚_∑π
 *
sv˝t
;

2866 
√åc
;

2867 
±Ãpc_ª∂y_°©e
 *
rs
;

2868 
obd_exp‹t
 *
exp
;

2869 
ENTRY
;

2871 i‡(
ªq
->
rq_no_ª∂y
) {

2872 
EXIT
;

2876 
sv˝t
 = 
ªq
->
rq_rqbd
->
rqbd_sv˝t
;

2877 
rs
 = 
ªq
->
rq_ª∂y_°©e
;

2878 i‡(
rs
 =
NULL
 || !rs->
rs_difficu…
) {

2880 
	`èrgë_£nd_ª∂y_msg
 (
ªq
, 
rc
, 
Áû_id
);

2881 
EXIT
;

2886 
	`LASSERT
(
ªq
->
rq_exp‹t
 !
NULL
);

2888 
	`LASSERT
(
rs
->
rs_sv˝t
 =
sv˝t
);

2891 
	`LASSERT
(!
rs
->
rs_scheduÀd
);

2892 
	`LASSERT
(!
rs
->
rs_scheduÀd_evî
);

2893 
	`LASSERT
(!
rs
->
rs_h™dÀd
);

2894 
	`LASSERT
(!
rs
->
rs_⁄_√t
);

2895 
	`LASSERT
(
rs
->
rs_exp‹t
 =
NULL
);

2896 
	`LASSERT
(
	`li°_em±y
(&
rs
->
rs_obd_li°
));

2897 
	`LASSERT
(
	`li°_em±y
(&
rs
->
rs_exp_li°
));

2899 
exp
 = 
	`˛ass_exp‹t_gë
(
ªq
->
rq_exp‹t
);

2902 
rs
->
rs_scheduÀd
 = 1;

2903 
rs
->
rs_⁄_√t
 = 1;

2904 
rs
->
rs_xid
 = 
ªq
->
rq_xid
;

2905 
rs
->
rs_å™¢o
 = 
ªq
->
rq_å™¢o
;

2906 
rs
->
rs_exp‹t
 = 
exp
;

2907 
rs
->
rs_›c
 = 
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
);

2909 
	`•ö_lock
(&
exp
->
exp_uncommôãd_ª∂õs_lock
);

2910 
	`CDEBUG
(
D_NET
, "r†å™¢ÿ"
LPU64
",Üast committed = "LPU64"\n",

2911 
rs
->
rs_å™¢o
, 
exp
->
exp_œ°_commôãd
);

2912 i‡(
rs
->
rs_å™¢o
 > 
exp
->
exp_œ°_commôãd
) {

2914 
	`li°_add_èû
(&
rs
->
rs_obd_li°
,

2915 &
exp
->
exp_uncommôãd_ª∂õs
);

2917 
	`•ö_u∆ock
(&
exp
->
exp_uncommôãd_ª∂õs_lock
);

2919 
	`•ö_lock
(&
exp
->
exp_lock
);

2920 
	`li°_add_èû
(&
rs
->
rs_exp_li°
, &
exp
->
exp_out°™dög_ª∂õs
);

2921 
	`•ö_u∆ock
(&
exp
->
exp_lock
);

2923 
√åc
 = 
	`èrgë_£nd_ª∂y_msg
(
ªq
, 
rc
, 
Áû_id
);

2925 
	`•ö_lock
(&
sv˝t
->
s˝_ªp_lock
);

2927 
	`©omic_öc
(&
sv˝t
->
s˝_ƒïs_difficu…
);

2929 i‡(
√åc
 != 0) {

2935 
rs
->
rs_⁄_√t
 = 0;

2936 
	`±Ãpc_rs_addªf
(
rs
);

2939 
	`•ö_lock
(&
rs
->
rs_lock
);

2940 i‡(
rs
->
rs_å™¢o
 <
exp
->
exp_œ°_commôãd
 ||

2941 (!
rs
->
rs_⁄_√t
 && !rs->
rs_no_ack
) ||

2942 
	`li°_em±y
(&
rs
->
rs_exp_li°
) ||

2943 
	`li°_em±y
(&
rs
->
rs_obd_li°
)) {

2944 
	`CDEBUG
(
D_HA
, "ScheduleÑeply immediately\n");

2945 
	`±Ãpc_di•©ch_difficu…_ª∂y
(
rs
);

2947 
	`li°_add
(&
rs
->
rs_li°
, &
sv˝t
->
s˝_ªp_a˘ive
);

2948 
rs
->
rs_scheduÀd
 = 0;

2950 
	`•ö_u∆ock
(&
rs
->
rs_lock
);

2951 
	`•ö_u∆ock
(&
sv˝t
->
s˝_ªp_lock
);

2952 
EXIT
;

2953 
	}
}

2955 
ldlm_mode
 
	glck_com∑t_¨øy
[] = {

2956 [
LCK_EX
] = 
LCK_COMPAT_EX
,

2957 [
LCK_PW
] = 
LCK_COMPAT_PW
,

2958 [
LCK_PR
] = 
LCK_COMPAT_PR
,

2959 [
LCK_CW
] = 
LCK_COMPAT_CW
,

2960 [
LCK_CR
] = 
LCK_COMPAT_CR
,

2961 [
LCK_NL
] = 
LCK_COMPAT_NL
,

2962 [
LCK_GROUP
] = 
LCK_COMPAT_GROUP
,

2963 [
LCK_COS
] = 
LCK_COMPAT_COS
,

2970 
	$ldlm_îr‹2î∫o
(
ldlm_îr‹
 
îr‹
)

2972 
ªsu…
;

2974 
îr‹
) {

2975 
ELDLM_OK
:

2976 
ELDLM_LOCK_MATCHED
:

2977 
ªsu…
 = 0;

2979 
ELDLM_LOCK_CHANGED
:

2980 
ªsu…
 = -
ESTALE
;

2982 
ELDLM_LOCK_ABORTED
:

2983 
ªsu…
 = -
ENAVAIL
;

2985 
ELDLM_LOCK_REPLACED
:

2986 
ªsu…
 = -
ESRCH
;

2988 
ELDLM_NO_LOCK_DATA
:

2989 
ªsu…
 = -
ENOENT
;

2991 
ELDLM_NAMESPACE_EXISTS
:

2992 
ªsu…
 = -
EEXIST
;

2994 
ELDLM_BAD_NAMESPACE
:

2995 
ªsu…
 = -
EBADF
;

2998 i‡((()
îr‹
) < 0) {

2999 
ªsu…
 = 
îr‹
;

3001 
	`CERROR
("InvÆid DLMÑesu… code: %d\n", 
îr‹
);

3002 
ªsu…
 = -
EPROTO
;

3005  
ªsu…
;

3006 
	}
}

3007 
EXPORT_SYMBOL
(
ldlm_îr‹2î∫o
);

3012 
ldlm_îr‹
 
	$ldlm_î∫o2îr‹
(
îr_no
)

3014 
îr‹
;

3016 
îr_no
) {

3018 
îr‹
 = 
ELDLM_OK
;

3020 -
ESTALE
:

3021 
îr‹
 = 
ELDLM_LOCK_CHANGED
;

3023 -
ENAVAIL
:

3024 
îr‹
 = 
ELDLM_LOCK_ABORTED
;

3026 -
ESRCH
:

3027 
îr‹
 = 
ELDLM_LOCK_REPLACED
;

3029 -
ENOENT
:

3030 
îr‹
 = 
ELDLM_NO_LOCK_DATA
;

3032 -
EEXIST
:

3033 
îr‹
 = 
ELDLM_NAMESPACE_EXISTS
;

3035 -
EBADF
:

3036 
îr‹
 = 
ELDLM_BAD_NAMESPACE
;

3039 
îr‹
 = 
îr_no
;

3041  
îr‹
;

3042 
	}
}

3044 #i‡
LUSTRE_TRACKS_LOCK_EXP_REFS


3045 
	$ldlm_dump_exp‹t_locks
(
obd_exp‹t
 *
exp
)

3047 
	`•ö_lock
(&
exp
->
exp_locks_li°_gu¨d
);

3048 i‡(!
	`li°_em±y
(&
exp
->
exp_locks_li°
)) {

3049 
ldlm_lock
 *
lock
;

3051 
	`CERROR
("dumpingÜocks forÉxport %p,"

3052 "ign‹êi‡thêunmou¡ d€¢'àh™g\n", 
exp
);

3053 
	`li°_f‹_óch_íåy
(
lock
, &
exp
->
exp_locks_li°
,

3054 
l_exp_ªfs_lök
)

3055 
	`LDLM_ERROR
(
lock
, "lock:");

3057 
	`•ö_u∆ock
(&
exp
->
exp_locks_li°_gu¨d
);

3058 
	}
}

3061 #ifde‡
HAVE_SERVER_SUPPORT


3062 
	$èrgë_bulk_timeout
(*
d©a
)

3064 
ENTRY
;

3068 
	`RETURN
(1);

3069 
	}
}

3071 
ölöe
 c⁄° *
	$bulk2ty≥
(
±Ãpc_ªque°
 *
ªq
)

3073 i‡(
ªq
->
rq_bulk_ªad
)

3075 i‡(
ªq
->
rq_bulk_wrôe
)

3078 
	}
}

3080 
	$èrgë_bulk_io
(
obd_exp‹t
 *
exp
, 
±Ãpc_bulk_desc
 *
desc
,

3081 
l_waô_öfo
 *
lwi
)

3083 
±Ãpc_ªque°
 *
ªq
 = 
desc
->
bd_ªq
;

3084 
time_t
 
°¨t
 = 
	`cfs_time_cuºít_£c
();

3085 
time_t
 
dódlöe
;

3086 
rc
 = 0;

3088 
ENTRY
;

3091 i‡(
	`u∆ikñy
(
	`©omic_ªad
(&
exp
->
exp_obd
->
obd_evi˘_ö¥ogªss
))) {

3092 *
lwi
 = 
	`LWI_INTR
(
NULL
, NULL);

3093 
rc
 = 
	`l_waô_evít
(
exp
->
exp_obd
->
obd_evi˘_ö¥ogªss_waôq
,

3094 !
	`©omic_ªad
(&
exp
->
exp_obd
->

3095 
obd_evi˘_ö¥ogªss
),

3096 
lwi
);

3100 i‡(
exp
->
exp_Áûed
 ||

3101 
exp
->
exp_c⁄n_˙t
 > 
	`lu°ª_msg_gë_c⁄n_˙t
(
ªq
->
rq_ªqmsg
)) {

3102 
rc
 = -
ENOTCONN
;

3104 i‡(
ªq
->
rq_bulk_ªad
)

3105 
rc
 = 
	`•éΩc_svc_wøp_bulk
(
ªq
, 
desc
);

3107 i‡((
exp
->
exp_c⁄√˘_d©a
.
ocd_c⁄√˘_Êags
 &

3108 
OBD_CONNECT_BULK_MBITS
) != 0)

3109 
ªq
->
rq_mbôs
 = 
	`lu°ª_msg_gë_mbôs
‘eq->
rq_ªqmsg
);

3111 
ªq
->
rq_mbôs
 =Ñeq->
rq_xid
;

3113 i‡(
rc
 == 0)

3114 
rc
 = 
	`±Ãpc_°¨t_bulk_å™s„r
(
desc
);

3117 i‡(
rc
 < 0) {

3118 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "bulk %s failed:Ñc %d",

3119 
	`bulk2ty≥
(
ªq
), 
rc
);

3120 
	`RETURN
(
rc
);

3123 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_MDS_SENDPAGE
)) {

3124 
	`±Ãpc_ab‹t_bulk
(
desc
);

3125 
	`RETURN
(0);

3129 
dódlöe
 = 
°¨t
 + 
bulk_timeout
;

3130 i‡(
dódlöe
 > 
ªq
->
rq_dódlöe
)

3131 
dódlöe
 = 
ªq
->
rq_dódlöe
;

3134 
timeoué
 = 
dódlöe
 - 
	`cfs_time_cuºít_£c
();

3135 
cfs_duøti⁄_t
 
timeout
 = 
timeoué
 <= 0 ?

3136 
CFS_TICK
 : 
	`cfs_time_£c⁄ds
(
timeoué
);

3137 
time_t
 
rq_dódlöe
;

3139 *
lwi
 = 
	`LWI_TIMEOUT_INTERVAL
(
timeout
, 
	`cfs_time_£c⁄ds
(1),

3140 
èrgë_bulk_timeout
, 
desc
);

3141 
rc
 = 
	`l_waô_evít
(
desc
->
bd_waôq
,

3142 !
	`±Ãpc_£rvî_bulk_a˘ive
(
desc
) ||

3143 
exp
->
exp_Áûed
 ||

3144 
exp
->
exp_c⁄n_˙t
 >

3145 
	`lu°ª_msg_gë_c⁄n_˙t
(
ªq
->
rq_ªqmsg
),

3146 
lwi
);

3147 
	`LASSERT
(
rc
 =0 ||Ñ¯=-
ETIMEDOUT
);

3149 
rq_dódlöe
 = 
	`ACCESS_ONCE
(
ªq
->rq_deadline);

3150 
dódlöe
 = 
°¨t
 + 
bulk_timeout
;

3151 i‡(
dódlöe
 > 
rq_dódlöe
)

3152 
dódlöe
 = 
rq_dódlöe
;

3153 } (
rc
 =-
ETIMEDOUT
) &&

3154 (
dódlöe
 > 
	`cfs_time_cuºít_£c
()));

3156 i‡(
rc
 =-
ETIMEDOUT
) {

3157 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "timeout on bulk %sáfter %ld%+lds",

3158 
	`bulk2ty≥
(
ªq
), 
dódlöe
 - 
°¨t
,

3159 
	`cfs_time_cuºít_£c
(Ë- 
dódlöe
);

3160 
	`±Ãpc_ab‹t_bulk
(
desc
);

3161 } i‡(
exp
->
exp_Áûed
) {

3162 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "Eviction on bulk %s",

3163 
	`bulk2ty≥
(
ªq
));

3164 
rc
 = -
ENOTCONN
;

3165 
	`±Ãpc_ab‹t_bulk
(
desc
);

3166 } i‡(
exp
->
exp_c⁄n_˙t
 >

3167 
	`lu°ª_msg_gë_c⁄n_˙t
(
ªq
->
rq_ªqmsg
)) {

3168 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "Reconnect on bulk %s",

3169 
	`bulk2ty≥
(
ªq
));

3171 
rc
 = -
ETIMEDOUT
;

3172 
	`±Ãpc_ab‹t_bulk
(
desc
);

3173 } i‡(
desc
->
bd_Áûuª
) {

3174 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "networkÉrror on bulk %s",

3175 
	`bulk2ty≥
(
ªq
));

3177 
rc
 = -
ETIMEDOUT
;

3179 i‡(
ªq
->
rq_bulk_wrôe
)

3180 
rc
 = 
	`•éΩc_svc_unwøp_bulk
(
ªq
, 
desc
);

3181 i‡(
rc
 =0 && 
desc
->
bd_nob_å™s„ºed
 !desc->
bd_nob
) {

3182 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "truncated bulk %s %d(%d)",

3183 
	`bulk2ty≥
(
ªq
), 
desc
->
bd_nob_å™s„ºed
,

3184 
desc
->
bd_nob
);

3186 
rc
 = -
ETIMEDOUT
;

3190 
	`RETURN
(
rc
);

3191 
	}
}

3192 
EXPORT_SYMBOL
(
èrgë_bulk_io
);

	@ldlm_lock.c

42 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

44 
	~<libcfs/libcfs.h
>

46 
	~<lu°ª_swab.h
>

47 
	~<obd_˛ass.h
>

49 
	~"ldlm_öã∫Æ.h
"

52 *
	gldlm_lock«me
[] = {

54 [
LCK_EX
] = "EX",

55 [
LCK_PW
] = "PW",

56 [
LCK_PR
] = "PR",

57 [
LCK_CW
] = "CW",

58 [
LCK_CR
] = "CR",

59 [
LCK_NL
] = "NL",

60 [
LCK_GROUP
] = "GROUP",

61 [
LCK_COS
] = "COS"

63 
EXPORT_SYMBOL
(
ldlm_lock«me
);

65 *
	gldlm_ty≥«me
[] = {

66 [
LDLM_PLAIN
] = "PLN",

67 [
LDLM_EXTENT
] = "EXT",

68 [
LDLM_FLOCK
] = "FLK",

69 [
LDLM_IBITS
] = "IBT",

72 
ldlm_pﬁicy_wúe_to_loˇl_t
 
	gldlm_pﬁicy_wúe_to_loˇl
[] = {

73 [
LDLM_PLAIN
 - 
LDLM_MIN_TYPE
] = 
ldlm_∂aö_pﬁicy_wúe_to_loˇl
,

74 [
LDLM_EXTENT
 - 
LDLM_MIN_TYPE
] = 
ldlm_exã¡_pﬁicy_wúe_to_loˇl
,

75 [
LDLM_FLOCK
 - 
LDLM_MIN_TYPE
] = 
ldlm_Êock_pﬁicy_wúe_to_loˇl
,

76 [
LDLM_IBITS
 - 
LDLM_MIN_TYPE
] = 
ldlm_ibôs_pﬁicy_wúe_to_loˇl
,

79 
ldlm_pﬁicy_loˇl_to_wúe_t
 
	gldlm_pﬁicy_loˇl_to_wúe
[] = {

80 [
LDLM_PLAIN
 - 
LDLM_MIN_TYPE
] = 
ldlm_∂aö_pﬁicy_loˇl_to_wúe
,

81 [
LDLM_EXTENT
 - 
LDLM_MIN_TYPE
] = 
ldlm_exã¡_pﬁicy_loˇl_to_wúe
,

82 [
LDLM_FLOCK
 - 
LDLM_MIN_TYPE
] = 
ldlm_Êock_pﬁicy_loˇl_to_wúe
,

83 [
LDLM_IBITS
 - 
LDLM_MIN_TYPE
] = 
ldlm_ibôs_pﬁicy_loˇl_to_wúe
,

89 
	$ldlm_c⁄vît_pﬁicy_to_wúe
(
ldlm_ty≥
 
ty≥
,

90 c⁄° 
ldlm_pﬁicy_d©a
 *
Õﬁicy
,

91 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
)

93 
ldlm_pﬁicy_loˇl_to_wúe_t
 
c⁄vît
;

95 
c⁄vît
 = 
ldlm_pﬁicy_loˇl_to_wúe
[
ty≥
 - 
LDLM_MIN_TYPE
];

97 
	`c⁄vît
(
Õﬁicy
, 
wpﬁicy
);

98 
	}
}

103 
	$ldlm_c⁄vît_pﬁicy_to_loˇl
(
obd_exp‹t
 *
exp
, 
ldlm_ty≥
 
ty≥
,

104 c⁄° 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
,

105 
ldlm_pﬁicy_d©a
 *
Õﬁicy
)

107 
ldlm_pﬁicy_wúe_to_loˇl_t
 
c⁄vît
;

109 
c⁄vît
 = 
ldlm_pﬁicy_wúe_to_loˇl
[
ty≥
 - 
LDLM_MIN_TYPE
];

111 
	`c⁄vît
(
wpﬁicy
, 
Õﬁicy
);

112 
	}
}

114 c⁄° *
	$ldlm_ô2°r
(
ldlm_öã¡_Êags
 
ô
)

116 
ô
) {

117 
IT_OPEN
:

119 
IT_CREAT
:

121 (
IT_OPEN
 | 
IT_CREAT
):

123 
IT_READDIR
:

125 
IT_GETATTR
:

127 
IT_LOOKUP
:

129 
IT_UNLINK
:

131 
IT_GETXATTR
:

133 
IT_LAYOUT
:

136 
	`CERROR
("Unknow¿öã¡ 0x%08x\n", 
ô
);

139 
	}
}

140 
EXPORT_SYMBOL
(
ldlm_ô2°r
);

142 
kmem_ˇche
 *
ldlm_lock_¶ab
;

144 #ifde‡
HAVE_SERVER_SUPPORT


145 
ldlm_¥o˚ssög_pﬁicy
 
	gldlm_¥o˚ssög_pﬁicy_èbÀ
[] = {

146 [
LDLM_PLAIN
] = 
ldlm_¥o˚ss_∂aö_lock
,

147 [
LDLM_EXTENT
] = 
ldlm_¥o˚ss_exã¡_lock
,

148 [
LDLM_FLOCK
] = 
ldlm_¥o˚ss_Êock_lock
,

149 [
LDLM_IBITS
] = 
ldlm_¥o˚ss_öodebôs_lock
,

152 
ldlm_¥o˚ssög_pﬁicy
 
	$ldlm_gë_¥o˚ssög_pﬁicy
(
ldlm_ªsour˚
 *
ªs
)

154  
ldlm_¥o˚ssög_pﬁicy_èbÀ
[
ªs
->
Ã_ty≥
];

155 
	}
}

156 
EXPORT_SYMBOL
(
ldlm_gë_¥o˚ssög_pﬁicy
);

159 
	$ldlm_ªgi°î_öã¡
(
ldlm_«me•a˚
 *
ns
, 
ldlm_ªs_pﬁicy
 
¨g
)

161 
ns
->
ns_pﬁicy
 = 
¨g
;

162 
	}
}

163 
EXPORT_SYMBOL
(
ldlm_ªgi°î_öã¡
);

178 
ldlm_lock
 *
	$ldlm_lock_gë
(
ldlm_lock
 *
lock
)

180 
	`©omic_öc
(&
lock
->
l_ªfc
);

181  
lock
;

182 
	}
}

183 
EXPORT_SYMBOL
(
ldlm_lock_gë
);

190 
	$ldlm_lock_put
(
ldlm_lock
 *
lock
)

192 
ENTRY
;

194 
	`LASSERT
(
lock
->
l_ªsour˚
 !
LP_POISON
);

195 
	`LASSERT
(
	`©omic_ªad
(&
lock
->
l_ªfc
) > 0);

196 i‡(
	`©omic_dec_™d_ã°
(&
lock
->
l_ªfc
)) {

197 
ldlm_ªsour˚
 *
ªs
;

199 
	`LDLM_DEBUG
(
lock
,

202 
ªs
 = 
lock
->
l_ªsour˚
;

203 
	`LASSERT
(
	`ldlm_is_de°royed
(
lock
));

204 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_exp_li°
));

205 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_ªs_lök
));

206 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_≥ndög_chaö
));

208 
	`Õrocfs_cou¡î_de¸
(
	`ldlm_ªs_to_ns
(
ªs
)->
ns_°©s
,

209 
LDLM_NSS_LOCKS
);

210 
	`lu_ªf_dñ
(&
ªs
->
Ã_ª„ªn˚
, "lock", 
lock
);

211 
	`ldlm_ªsour˚_puåef
(
ªs
);

212 
lock
->
l_ªsour˚
 = 
NULL
;

213 i‡(
lock
->
l_exp‹t
) {

214 
	`˛ass_exp‹t_lock_put
(
lock
->
l_exp‹t
,Üock);

215 
lock
->
l_exp‹t
 = 
NULL
;

218 i‡(
lock
->
l_lvb_d©a
 !
NULL
)

219 
	`OBD_FREE_LARGE
(
lock
->
l_lvb_d©a
,Üock->
l_lvb_Àn
);

221 
	`ldlm_öãrvÆ_‰ì
(
	`ldlm_öãrvÆ_dëach
(
lock
));

222 
	`lu_ªf_föi
(&
lock
->
l_ª„ªn˚
);

223 
	`OBD_FREE_RCU
(
lock
, (*lock), &lock->
l_h™dÀ
);

226 
EXIT
;

227 
	}
}

228 
EXPORT_SYMBOL
(
ldlm_lock_put
);

233 
	$ldlm_lock_ªmove_‰om_Ãu_nﬁock
(
ldlm_lock
 *
lock
)

235 
rc
 = 0;

236 i‡(!
	`li°_em±y
(&
lock
->
l_Ãu
)) {

237 
ldlm_«me•a˚
 *
ns
 = 
	`ldlm_lock_to_ns
(
lock
);

239 
	`LASSERT
(
lock
->
l_ªsour˚
->
Ã_ty≥
 !
LDLM_FLOCK
);

240 
	`li°_dñ_öô
(&
lock
->
l_Ãu
);

241 
	`LASSERT
(
ns
->
ns_ƒ_unu£d
 > 0);

242 
ns
->
ns_ƒ_unu£d
--;

243 
rc
 = 1;

245  
rc
;

246 
	}
}

259 
	$ldlm_lock_ªmove_‰om_Ãu_check
(
ldlm_lock
 *
lock
, 
cfs_time_t
 
œ°_u£
)

261 
ldlm_«me•a˚
 *
ns
 = 
	`ldlm_lock_to_ns
(
lock
);

262 
rc
 = 0;

264 
ENTRY
;

265 i‡(
	`ldlm_is_ns_§v
(
lock
)) {

266 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_Ãu
));

267 
	`RETURN
(0);

270 
	`•ö_lock
(&
ns
->
ns_lock
);

271 i‡(
œ°_u£
 =0 ||Üa°_u£ =
lock
->
l_œ°_u£d
)

272 
rc
 = 
	`ldlm_lock_ªmove_‰om_Ãu_nﬁock
(
lock
);

273 
	`•ö_u∆ock
(&
ns
->
ns_lock
);

275 
	`RETURN
(
rc
);

276 
	}
}

281 
	$ldlm_lock_add_to_Ãu_nﬁock
(
ldlm_lock
 *
lock
)

283 
ldlm_«me•a˚
 *
ns
 = 
	`ldlm_lock_to_ns
(
lock
);

285 
lock
->
l_œ°_u£d
 = 
	`cfs_time_cuºít
();

286 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_Ãu
));

287 
	`LASSERT
(
lock
->
l_ªsour˚
->
Ã_ty≥
 !
LDLM_FLOCK
);

288 
	`li°_add_èû
(&
lock
->
l_Ãu
, &
ns
->
ns_unu£d_li°
);

289 
	`ldlm_˛ór_skù≥d
(
lock
);

290 
	`LASSERT
(
ns
->
ns_ƒ_unu£d
 >= 0);

291 
ns
->
ns_ƒ_unu£d
++;

292 
	}
}

298 
	$ldlm_lock_add_to_Ãu
(
ldlm_lock
 *
lock
)

300 
ldlm_«me•a˚
 *
ns
 = 
	`ldlm_lock_to_ns
(
lock
);

302 
ENTRY
;

303 
	`•ö_lock
(&
ns
->
ns_lock
);

304 
	`ldlm_lock_add_to_Ãu_nﬁock
(
lock
);

305 
	`•ö_u∆ock
(&
ns
->
ns_lock
);

306 
EXIT
;

307 
	}
}

313 
	$ldlm_lock_touch_ö_Ãu
(
ldlm_lock
 *
lock
)

315 
ldlm_«me•a˚
 *
ns
 = 
	`ldlm_lock_to_ns
(
lock
);

317 
ENTRY
;

318 i‡(
	`ldlm_is_ns_§v
(
lock
)) {

319 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_Ãu
));

320 
EXIT
;

324 
	`•ö_lock
(&
ns
->
ns_lock
);

325 i‡(!
	`li°_em±y
(&
lock
->
l_Ãu
)) {

326 
	`ldlm_lock_ªmove_‰om_Ãu_nﬁock
(
lock
);

327 
	`ldlm_lock_add_to_Ãu_nﬁock
(
lock
);

329 
	`•ö_u∆ock
(&
ns
->
ns_lock
);

330 
EXIT
;

331 
	}
}

352 
	$ldlm_lock_de°roy_öã∫Æ
(
ldlm_lock
 *
lock
)

354 
ENTRY
;

356 i‡(
lock
->
l_ªadîs
 ||Üock->
l_wrôîs
) {

357 
	`LDLM_ERROR
(
lock
, "lock still hasÑeferences");

358 
	`LBUG
();

361 i‡(!
	`li°_em±y
(&
lock
->
l_ªs_lök
)) {

362 
	`LDLM_ERROR
(
lock
, "lock still onÑesource");

363 
	`LBUG
();

366 i‡(
	`ldlm_is_de°royed
(
lock
)) {

367 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_Ãu
));

368 
EXIT
;

371 
	`ldlm_£t_de°royed
(
lock
);

373 i‡(
lock
->
l_exp‹t
 &&Üock->l_exp‹t->
exp_lock_hash
) {

379 
	`cfs_hash_dñ
(
lock
->
l_exp‹t
->
exp_lock_hash
,

380 &
lock
->
l_ªmŸe_h™dÀ
, &lock->
l_exp_hash
);

383 
	`ldlm_lock_ªmove_‰om_Ãu
(
lock
);

384 
	`˛ass_h™dÀ_unhash
(&
lock
->
l_h™dÀ
);

390 i‡(
lock
->
l_exp‹t
)

391 
	`˛ass_exp‹t_put
(
lock
->
l_exp‹t
);

392 
lock
->
l_exp‹t
 = 
NULL
;

393 i‡(
lock
->
l_exp‹t
 &&Üock->
l_com∂ëi⁄_a°
)

394 
lock
->
	`l_com∂ëi⁄_a°
(lock, 0);

396 
EXIT
;

398 
	}
}

403 
	$ldlm_lock_de°roy
(
ldlm_lock
 *
lock
)

405 
fú°
;

406 
ENTRY
;

407 
	`lock_ªs_™d_lock
(
lock
);

408 
fú°
 = 
	`ldlm_lock_de°roy_öã∫Æ
(
lock
);

409 
	`u∆ock_ªs_™d_lock
(
lock
);

412 i‡(
fú°
) {

413 
	`lu_ªf_dñ
(&
lock
->
l_ª„ªn˚
, "hash",Üock);

414 
	`LDLM_LOCK_RELEASE
(
lock
);

416 
EXIT
;

417 
	}
}

422 
	$ldlm_lock_de°roy_nﬁock
(
ldlm_lock
 *
lock
)

424 
fú°
;

425 
ENTRY
;

426 
fú°
 = 
	`ldlm_lock_de°roy_öã∫Æ
(
lock
);

428 i‡(
fú°
) {

429 
	`lu_ªf_dñ
(&
lock
->
l_ª„ªn˚
, "hash",Üock);

430 
	`LDLM_LOCK_RELEASE
(
lock
);

432 
EXIT
;

433 
	}
}

436 
	$lock_h™dÀ_addªf
(*
lock
)

438 
	`LDLM_LOCK_GET
((
ldlm_lock
 *)
lock
);

439 
	}
}

441 
	$lock_h™dÀ_‰ì
(*
lock
, 
size
)

443 
	`LASSERT
(
size
 =(
ldlm_lock
));

444 
	`OBD_SLAB_FREE
(
lock
, 
ldlm_lock_¶ab
, 
size
);

445 
	}
}

447 
p‹èls_h™dÀ_›s
 
	glock_h™dÀ_›s
 = {

448 .
h›_addªf
 = 
lock_h™dÀ_addªf
,

449 .
	gh›_‰ì
 = 
lock_h™dÀ_‰ì
,

460 
ldlm_lock
 *
	$ldlm_lock_√w
(
ldlm_ªsour˚
 *
ªsour˚
)

462 
ldlm_lock
 *
lock
;

463 
ENTRY
;

465 i‡(
ªsour˚
 =
NULL
)

466 
	`LBUG
();

468 
	`OBD_SLAB_ALLOC_PTR_GFP
(
lock
, 
ldlm_lock_¶ab
, 
GFP_NOFS
);

469 i‡(
lock
 =
NULL
)

470 
	`RETURN
(
NULL
);

472 
	`•ö_lock_öô
(&
lock
->
l_lock
);

473 
lock
->
l_ªsour˚
 = 
ªsour˚
;

474 
	`lu_ªf_add
(&
ªsour˚
->
Ã_ª„ªn˚
, "lock", 
lock
);

476 
	`©omic_£t
(&
lock
->
l_ªfc
, 2);

477 
	`INIT_LIST_HEAD
(&
lock
->
l_ªs_lök
);

478 
	`INIT_LIST_HEAD
(&
lock
->
l_Ãu
);

479 
	`INIT_LIST_HEAD
(&
lock
->
l_≥ndög_chaö
);

480 
	`INIT_LIST_HEAD
(&
lock
->
l_bl_a°
);

481 
	`INIT_LIST_HEAD
(&
lock
->
l_˝_a°
);

482 
	`INIT_LIST_HEAD
(&
lock
->
l_rk_a°
);

483 
	`öô_waôqueue_hód
(&
lock
->
l_waôq
);

484 
lock
->
l_blockög_lock
 = 
NULL
;

485 
	`INIT_LIST_HEAD
(&
lock
->
l_¶_mode
);

486 
	`INIT_LIST_HEAD
(&
lock
->
l_¶_pﬁicy
);

487 
	`INIT_HLIST_NODE
(&
lock
->
l_exp_hash
);

488 
	`INIT_HLIST_NODE
(&
lock
->
l_exp_Êock_hash
);

490 
	`Õrocfs_cou¡î_ö¸
(
	`ldlm_ªs_to_ns
(
ªsour˚
)->
ns_°©s
,

491 
LDLM_NSS_LOCKS
);

492 
	`INIT_LIST_HEAD
(&
lock
->
l_h™dÀ
.
h_lök
);

493 
	`˛ass_h™dÀ_hash
(&
lock
->
l_h™dÀ
, &
lock_h™dÀ_›s
);

495 
	`lu_ªf_öô
(&
lock
->
l_ª„ªn˚
);

496 
	`lu_ªf_add
(&
lock
->
l_ª„ªn˚
, "hash",Üock);

497 
lock
->
l_ˇŒback_timeout
 = 0;

499 #i‡
LUSTRE_TRACKS_LOCK_EXP_REFS


500 
	`INIT_LIST_HEAD
(&
lock
->
l_exp_ªfs_lök
);

501 
lock
->
l_exp_ªfs_ƒ
 = 0;

502 
lock
->
l_exp_ªfs_èrgë
 = 
NULL
;

504 
	`INIT_LIST_HEAD
(&
lock
->
l_exp_li°
);

506 
	`RETURN
(
lock
);

507 
	}
}

514 
	$ldlm_lock_ch™ge_ªsour˚
(
ldlm_«me•a˚
 *
ns
, 
ldlm_lock
 *
lock
,

515 c⁄° 
ldlm_ªs_id
 *
√w_ªsid
)

517 
ldlm_ªsour˚
 *
ﬁdªs
 = 
lock
->
l_ªsour˚
;

518 
ldlm_ªsour˚
 *
√wªs
;

519 
ty≥
;

520 
ENTRY
;

522 
	`LASSERT
(
	`ns_is_˛õ¡
(
ns
));

524 
	`lock_ªs_™d_lock
(
lock
);

525 i‡(
	`memcmp
(
√w_ªsid
, &
lock
->
l_ªsour˚
->
Ã_«me
,

526 (
lock
->
l_ªsour˚
->
Ã_«me
)) == 0) {

528 
	`u∆ock_ªs_™d_lock
(
lock
);

529 
	`RETURN
(0);

532 
	`LASSERT
(
√w_ªsid
->
«me
[0] != 0);

535 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_ªs_lök
));

537 
ty≥
 = 
ﬁdªs
->
Ã_ty≥
;

538 
	`u∆ock_ªs_™d_lock
(
lock
);

540 
√wªs
 = 
	`ldlm_ªsour˚_gë
(
ns
, 
NULL
, 
√w_ªsid
, 
ty≥
, 1);

541 i‡(
	`IS_ERR
(
√wªs
))

542 
	`RETURN
(
	`PTR_ERR
(
√wªs
));

544 
	`lu_ªf_add
(&
√wªs
->
Ã_ª„ªn˚
, "lock", 
lock
);

551 
	`•ö_lock
(&
lock
->
l_lock
);

552 
ﬁdªs
 = 
lock
->
l_ªsour˚
;

553 i‡(
ﬁdªs
 < 
√wªs
) {

554 
	`lock_ªs
(
ﬁdªs
);

555 
	`lock_ªs_√°ed
(
√wªs
, 
LRT_NEW
);

557 
	`lock_ªs
(
√wªs
);

558 
	`lock_ªs_√°ed
(
ﬁdªs
, 
LRT_NEW
);

560 
	`LASSERT
(
	`memcmp
(
√w_ªsid
, &
ﬁdªs
->
Ã_«me
,

561  
ﬁdªs
->
Ã_«me
) != 0);

562 
lock
->
l_ªsour˚
 = 
√wªs
;

563 
	`u∆ock_ªs
(
ﬁdªs
);

564 
	`u∆ock_ªs_™d_lock
(
lock
);

567 
	`lu_ªf_dñ
(&
ﬁdªs
->
Ã_ª„ªn˚
, "lock", 
lock
);

568 
	`ldlm_ªsour˚_puåef
(
ﬁdªs
);

570 
	`RETURN
(0);

571 
	}
}

582 
	$ldlm_lock2h™dÀ
(c⁄° 
ldlm_lock
 *
lock
, 
lu°ª_h™dÀ
 *
lockh
)

584 
lockh
->
cookõ
 = 
lock
->
l_h™dÀ
.
h_cookõ
;

585 
	}
}

586 
EXPORT_SYMBOL
(
ldlm_lock2h™dÀ
);

594 
ldlm_lock
 *
	$__ldlm_h™dÀ2lock
(c⁄° 
lu°ª_h™dÀ
 *
h™dÀ
,

595 
__u64
 
Êags
)

597 
ldlm_lock
 *
lock
;

598 
ENTRY
;

600 
	`LASSERT
(
h™dÀ
);

602 
lock
 = 
	`˛ass_h™dÀ2obje˘
(
h™dÀ
->
cookõ
, 
NULL
);

603 i‡(
lock
 =
NULL
)

604 
	`RETURN
(
NULL
);

608 i‡((
Êags
 =0Ë&& !
	`ldlm_is_de°royed
(
lock
)) {

609 
	`lu_ªf_add
(&
lock
->
l_ª„ªn˚
, "h™dÀ", 
cuºít
);

610 
	`RETURN
(
lock
);

613 
	`lock_ªs_™d_lock
(
lock
);

615 
	`LASSERT
(
lock
->
l_ªsour˚
 !
NULL
);

617 
	`lu_ªf_add_©omic
(&
lock
->
l_ª„ªn˚
, "h™dÀ", 
cuºít
);

618 i‡(
	`u∆ikñy
(
	`ldlm_is_de°royed
(
lock
))) {

619 
	`u∆ock_ªs_™d_lock
(
lock
);

620 
	`CDEBUG
(
D_INFO
, "lockáÃódy de°royed:Üock %p\n", 
lock
);

621 
	`LDLM_LOCK_PUT
(
lock
);

622 
	`RETURN
(
NULL
);

626 i‡(
Êags
 != 0) {

627 i‡((
lock
->
l_Êags
 & 
Êags
) != 0) {

628 
	`u∆ock_ªs_™d_lock
(
lock
);

629 
	`LDLM_LOCK_PUT
(
lock
);

630 
	`RETURN
(
NULL
);

633 
lock
->
l_Êags
 |
Êags
;

636 
	`u∆ock_ªs_™d_lock
(
lock
);

637 
	`RETURN
(
lock
);

638 
	}
}

639 
EXPORT_SYMBOL
(
__ldlm_h™dÀ2lock
);

646 
	$ldlm_lock2desc
(
ldlm_lock
 *
lock
, 
ldlm_lock_desc
 *
desc
)

648 
	`ldlm_ªs2desc
(
lock
->
l_ªsour˚
, &
desc
->l_resource);

649 
desc
->
l_ªq_mode
 = 
lock
->l_req_mode;

650 
desc
->
l_gø¡ed_mode
 = 
lock
->l_granted_mode;

651 
	`ldlm_c⁄vît_pﬁicy_to_wúe
(
lock
->
l_ªsour˚
->
Ã_ty≥
,

652 &
lock
->
l_pﬁicy_d©a
,

653 &
desc
->
l_pﬁicy_d©a
);

654 
	}
}

661 
	$ldlm_add_bl_w‹k_ôem
(
ldlm_lock
 *
lock
, ldlm_lock *
√w
,

662 
li°_hód
 *
w‹k_li°
)

664 i‡(!
	`ldlm_is_a°_£¡
(
lock
)) {

665 
	`LDLM_DEBUG
(
lock
, "lock incompatible; sending blocking AST.");

666 
	`ldlm_£t_a°_£¡
(
lock
);

669 i‡(
	`ldlm_is_a°_disˇrd_d©a
(
√w
))

670 
	`ldlm_£t_disˇrd_d©a
(
lock
);

671 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_bl_a°
));

672 
	`li°_add
(&
lock
->
l_bl_a°
, 
w‹k_li°
);

673 
	`LDLM_LOCK_GET
(
lock
);

674 
	`LASSERT
(
lock
->
l_blockög_lock
 =
NULL
);

675 
lock
->
l_blockög_lock
 = 
	`LDLM_LOCK_GET
(
√w
);

677 
	}
}

682 
	$ldlm_add_˝_w‹k_ôem
(
ldlm_lock
 *
lock
,

683 
li°_hód
 *
w‹k_li°
)

685 i‡(!
	`ldlm_is_˝_ªqd
(
lock
)) {

686 
	`ldlm_£t_˝_ªqd
(
lock
);

687 
	`LDLM_DEBUG
(
lock
, "lock granted; sending completion AST.");

688 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_˝_a°
));

689 
	`li°_add
(&
lock
->
l_˝_a°
, 
w‹k_li°
);

690 
	`LDLM_LOCK_GET
(
lock
);

692 
	}
}

700 
	$ldlm_add_a°_w‹k_ôem
(
ldlm_lock
 *
lock
, ldlm_lock *
√w
,

701 
li°_hód
 *
w‹k_li°
)

703 
ENTRY
;

704 
	`check_ªs_locked
(
lock
->
l_ªsour˚
);

705 i‡(
√w
)

706 
	`ldlm_add_bl_w‹k_ôem
(
lock
, 
√w
, 
w‹k_li°
);

708 
	`ldlm_add_˝_w‹k_ôem
(
lock
, 
w‹k_li°
);

709 
EXIT
;

710 
	}
}

717 
	$ldlm_lock_addªf
(
lu°ª_h™dÀ
 *
lockh
, 
ldlm_mode
 
mode
)

719 
ldlm_lock
 *
lock
;

721 
lock
 = 
	`ldlm_h™dÀ2lock
(
lockh
);

722 
	`LASSERTF
(
lock
 !
NULL
, "N⁄-exi°ögÜock: "
LPX64
"\n", 
lockh
->
cookõ
);

723 
	`ldlm_lock_addªf_öã∫Æ
(
lock
, 
mode
);

724 
	`LDLM_LOCK_PUT
(
lock
);

725 
	}
}

726 
EXPORT_SYMBOL
(
ldlm_lock_addªf
);

735 
	$ldlm_lock_addªf_öã∫Æ_nﬁock
(
ldlm_lock
 *
lock
,

736 
ldlm_mode
 
mode
)

738 
	`ldlm_lock_ªmove_‰om_Ãu
(
lock
);

739 i‡(
mode
 & (
LCK_NL
 | 
LCK_CR
 | 
LCK_PR
)) {

740 
lock
->
l_ªadîs
++;

741 
	`lu_ªf_add_©omic
(&
lock
->
l_ª„ªn˚
, "reader",Üock);

743 i‡(
mode
 & (
LCK_EX
 | 
LCK_CW
 | 
LCK_PW
 | 
LCK_GROUP
 | 
LCK_COS
)) {

744 
lock
->
l_wrôîs
++;

745 
	`lu_ªf_add_©omic
(&
lock
->
l_ª„ªn˚
, "writer",Üock);

747 
	`LDLM_LOCK_GET
(
lock
);

748 
	`lu_ªf_add_©omic
(&
lock
->
l_ª„ªn˚
, "user",Üock);

749 
	`LDLM_DEBUG
(
lock
, "ldlm_lock_addªf(%s)", 
ldlm_lock«me
[
mode
]);

750 
	}
}

760 
	$ldlm_lock_addªf_åy
(
lu°ª_h™dÀ
 *
lockh
, 
ldlm_mode
 
mode
)

762 
ldlm_lock
 *
lock
;

763 
ªsu…
;

765 
ªsu…
 = -
EAGAIN
;

766 
lock
 = 
	`ldlm_h™dÀ2lock
(
lockh
);

767 i‡(
lock
 !
NULL
) {

768 
	`lock_ªs_™d_lock
(
lock
);

769 i‡(
lock
->
l_ªadîs
 !0 ||Üock->
l_wrôîs
 != 0 ||

770 !
	`ldlm_is_cb≥ndög
(
lock
)) {

771 
	`ldlm_lock_addªf_öã∫Æ_nﬁock
(
lock
, 
mode
);

772 
ªsu…
 = 0;

774 
	`u∆ock_ªs_™d_lock
(
lock
);

775 
	`LDLM_LOCK_PUT
(
lock
);

777  
ªsu…
;

778 
	}
}

779 
EXPORT_SYMBOL
(
ldlm_lock_addªf_åy
);

786 
	$ldlm_lock_addªf_öã∫Æ
(
ldlm_lock
 *
lock
, 
ldlm_mode
 
mode
)

788 
	`lock_ªs_™d_lock
(
lock
);

789 
	`ldlm_lock_addªf_öã∫Æ_nﬁock
(
lock
, 
mode
);

790 
	`u∆ock_ªs_™d_lock
(
lock
);

791 
	}
}

800 
	$ldlm_lock_de¸ef_öã∫Æ_nﬁock
(
ldlm_lock
 *
lock
,

801 
ldlm_mode
 
mode
)

803 
	`LDLM_DEBUG
(
lock
, "ldlm_lock_de¸ef(%s)", 
ldlm_lock«me
[
mode
]);

804 i‡(
mode
 & (
LCK_NL
 | 
LCK_CR
 | 
LCK_PR
)) {

805 
	`LASSERT
(
lock
->
l_ªadîs
 > 0);

806 
	`lu_ªf_dñ
(&
lock
->
l_ª„ªn˚
, "reader",Üock);

807 
lock
->
l_ªadîs
--;

809 i‡(
mode
 & (
LCK_EX
 | 
LCK_CW
 | 
LCK_PW
 | 
LCK_GROUP
 | 
LCK_COS
)) {

810 
	`LASSERT
(
lock
->
l_wrôîs
 > 0);

811 
	`lu_ªf_dñ
(&
lock
->
l_ª„ªn˚
, "writer",Üock);

812 
lock
->
l_wrôîs
--;

815 
	`lu_ªf_dñ
(&
lock
->
l_ª„ªn˚
, "user",Üock);

816 
	`LDLM_LOCK_RELEASE
(
lock
);

817 
	}
}

827 
	$ldlm_lock_de¸ef_öã∫Æ
(
ldlm_lock
 *
lock
, 
ldlm_mode
 
mode
)

829 
ldlm_«me•a˚
 *
ns
;

830 
ENTRY
;

832 
	`lock_ªs_™d_lock
(
lock
);

834 
ns
 = 
	`ldlm_lock_to_ns
(
lock
);

836 
	`ldlm_lock_de¸ef_öã∫Æ_nﬁock
(
lock
, 
mode
);

838 i‡((
	`ldlm_is_loˇl
(
lock
Ë||Üock->
l_ªq_mode
 =
LCK_GROUP
) &&

839 !
lock
->
l_ªadîs
 && !lock->
l_wrôîs
) {

849 
	`ldlm_£t_cb≥ndög
(
lock
);

852 i‡(!
lock
->
l_ªadîs
 && !lock->
l_wrôîs
 && 
	`ldlm_is_cb≥ndög
(lock)) {

855 i‡(
	`ldlm_is_ns_§v
(
lock
Ë&&Üock->
l_exp‹t
)

856 
	`CERROR
("FL_CBPENDING set onÇon-localÜock--justá "

859 
	`LDLM_DEBUG
(
lock
, "final decref done on cbpendingÜock");

861 
	`LDLM_LOCK_GET
(
lock
);

862 
	`ldlm_lock_ªmove_‰om_Ãu
(
lock
);

863 
	`u∆ock_ªs_™d_lock
(
lock
);

865 i‡(
	`ldlm_is_Áû_loc
(
lock
))

866 
	`OBD_RACE
(
OBD_FAIL_LDLM_CP_BL_RACE
);

868 i‡(
	`ldlm_is_©omic_cb
(
lock
) ||

869 
	`ldlm_bl_to_thªad_lock
(
ns
, 
NULL
, 
lock
) != 0)

870 
	`ldlm_h™dÀ_bl_ˇŒback
(
ns
, 
NULL
, 
lock
);

871 } i‡(
	`ns_is_˛õ¡
(
ns
) &&

872 !
lock
->
l_ªadîs
 && !lock->
l_wrôîs
 &&

873 !
	`ldlm_is_no_Ãu
(
lock
) &&

874 !
	`ldlm_is_bl_a°
(
lock
)) {

876 
	`LDLM_DEBUG
(
lock
, "addÜock intoÜruÜist");

880 
	`ldlm_lock_add_to_Ãu
(
lock
);

881 
	`u∆ock_ªs_™d_lock
(
lock
);

883 i‡(
	`ldlm_is_Áû_loc
(
lock
))

884 
	`OBD_RACE
(
OBD_FAIL_LDLM_CP_BL_RACE
);

889 i‡(!
	`exp_c⁄√˘_ˇn˚l£t
(
lock
->
l_c⁄n_exp‹t
) &&

890 !
	`ns_c⁄√˘_Ãu_ªsize
(
ns
))

891 
	`ldlm_ˇn˚l_Ãu
(
ns
, 0, 
LCF_ASYNC
, 0);

893 
	`LDLM_DEBUG
(
lock
, "doÇotáddÜock intoÜruÜist");

894 
	`u∆ock_ªs_™d_lock
(
lock
);

897 
EXIT
;

898 
	}
}

903 
	$ldlm_lock_de¸ef
(
lu°ª_h™dÀ
 *
lockh
, 
ldlm_mode
 
mode
)

905 
ldlm_lock
 *
lock
 = 
	`__ldlm_h™dÀ2lock
(
lockh
, 0);

906 
	`LASSERTF
(
lock
 !
NULL
, "N⁄-exi°ögÜock: "
LPX64
"\n", 
lockh
->
cookõ
);

907 
	`ldlm_lock_de¸ef_öã∫Æ
(
lock
, 
mode
);

908 
	`LDLM_LOCK_PUT
(
lock
);

909 
	}
}

910 
EXPORT_SYMBOL
(
ldlm_lock_de¸ef
);

918 
	$ldlm_lock_de¸ef_™d_ˇn˚l
(
lu°ª_h™dÀ
 *
lockh
,

919 
ldlm_mode
 
mode
)

921 
ldlm_lock
 *
lock
 = 
	`__ldlm_h™dÀ2lock
(
lockh
, 0);

922 
ENTRY
;

924 
	`LASSERT
(
lock
 !
NULL
);

926 
	`LDLM_DEBUG
(
lock
, "ldlm_lock_de¸ef(%s)", 
ldlm_lock«me
[
mode
]);

927 
	`lock_ªs_™d_lock
(
lock
);

928 
	`ldlm_£t_cb≥ndög
(
lock
);

929 
	`u∆ock_ªs_™d_lock
(
lock
);

930 
	`ldlm_lock_de¸ef_öã∫Æ
(
lock
, 
mode
);

931 
	`LDLM_LOCK_PUT
(
lock
);

932 
	}
}

933 
EXPORT_SYMBOL
(
ldlm_lock_de¸ef_™d_ˇn˚l
);

935 
	s¶_ö£π_poöt
 {

936 
li°_hód
 *
	mªs_lök
;

937 
li°_hód
 *
	mmode_lök
;

938 
li°_hód
 *
	mpﬁicy_lök
;

955 
	$£¨ch_gø¡ed_lock
(
li°_hód
 *
queue
,

956 
ldlm_lock
 *
ªq
,

957 
¶_ö£π_poöt
 *
¥ev
)

959 
li°_hód
 *
tmp
;

960 
ldlm_lock
 *
lock
, *
mode_íd
, *
pﬁicy_íd
;

961 
ENTRY
;

963 
	`li°_f‹_óch
(
tmp
, 
queue
) {

964 
lock
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
, 
l_ªs_lök
);

966 
mode_íd
 = 
	`li°_íåy
(
lock
->
l_¶_mode
.
¥ev
,

967 
ldlm_lock
, 
l_¶_mode
);

969 i‡(
lock
->
l_ªq_mode
 !
ªq
->l_req_mode) {

971 
tmp
 = &
mode_íd
->
l_ªs_lök
;

976 i‡(
lock
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_PLAIN
) {

978 
¥ev
->
ªs_lök
 = &
mode_íd
->
l_ªs_lök
;

979 
¥ev
->
mode_lök
 = &
mode_íd
->
l_¶_mode
;

980 
¥ev
->
pﬁicy_lök
 = &
ªq
->
l_¶_pﬁicy
;

981 
EXIT
;

983 } i‡(
lock
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_IBITS
) {

985 
pﬁicy_íd
 =

986 
	`li°_íåy
(
lock
->
l_¶_pﬁicy
.
¥ev
,

987 
ldlm_lock
,

988 
l_¶_pﬁicy
);

990 i‡(
lock
->
l_pﬁicy_d©a
.
l_öodebôs
.
bôs
 ==

991 
ªq
->
l_pﬁicy_d©a
.
l_öodebôs
.
bôs
) {

994 
¥ev
->
ªs_lök
 =

995 &
pﬁicy_íd
->
l_ªs_lök
;

996 
¥ev
->
mode_lök
 =

997 &
pﬁicy_íd
->
l_¶_mode
;

998 
¥ev
->
pﬁicy_lök
 =

999 &
pﬁicy_íd
->
l_¶_pﬁicy
;

1000 
EXIT
;

1004 i‡(
pﬁicy_íd
 =
mode_íd
)

1009 
tmp
 = 
pﬁicy_íd
->
l_ªs_lök
.
√xt
;

1010 
lock
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
,

1011 
l_ªs_lök
);

1016 
¥ev
->
ªs_lök
 = &
mode_íd
->
l_ªs_lök
;

1017 
¥ev
->
mode_lök
 = &
mode_íd
->
l_¶_mode
;

1018 
¥ev
->
pﬁicy_lök
 = &
ªq
->
l_¶_pﬁicy
;

1019 
EXIT
;

1022 
	`LDLM_ERROR
(
lock
,"isÇot LDLM_PLAIN or LDLM_IBITSÜock");

1023 
	`LBUG
();

1029 
¥ev
->
ªs_lök
 = 
queue
->prev;

1030 
¥ev
->
mode_lök
 = &
ªq
->
l_¶_mode
;

1031 
¥ev
->
pﬁicy_lök
 = &
ªq
->
l_¶_pﬁicy
;

1032 
EXIT
;

1034 
	}
}

1040 
	$ldlm_gø¡ed_li°_add_lock
(
ldlm_lock
 *
lock
,

1041 
¶_ö£π_poöt
 *
¥ev
)

1043 
ldlm_ªsour˚
 *
ªs
 = 
lock
->
l_ªsour˚
;

1044 
ENTRY
;

1046 
	`check_ªs_locked
(
ªs
);

1048 
	`ldlm_ªsour˚_dump
(
D_INFO
, 
ªs
);

1049 
	`LDLM_DEBUG
(
lock
, "AboutÅoáddÜock:");

1051 i‡(
	`ldlm_is_de°royed
(
lock
)) {

1052 
	`CDEBUG
(
D_OTHER
, "Lock destroyed,ÇotáddingÅoÑesource\n");

1056 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_ªs_lök
));

1057 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_¶_mode
));

1058 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_¶_pﬁicy
));

1064 i‡(&
lock
->
l_ªs_lök
 !
¥ev
->
ªs_lök
)

1065 
	`li°_add
(&
lock
->
l_ªs_lök
, 
¥ev
->
ªs_lök
);

1066 i‡(&
lock
->
l_¶_mode
 !
¥ev
->
mode_lök
)

1067 
	`li°_add
(&
lock
->
l_¶_mode
, 
¥ev
->
mode_lök
);

1068 i‡(&
lock
->
l_¶_pﬁicy
 !
¥ev
->
pﬁicy_lök
)

1069 
	`li°_add
(&
lock
->
l_¶_pﬁicy
, 
¥ev
->
pﬁicy_lök
);

1071 
EXIT
;

1072 
	}
}

1078 
	$ldlm_gø¡_lock_wôh_skùli°
(
ldlm_lock
 *
lock
)

1080 
¶_ö£π_poöt
 
¥ev
;

1081 
ENTRY
;

1083 
	`LASSERT
(
lock
->
l_ªq_mode
 =lock->
l_gø¡ed_mode
);

1085 
	`£¨ch_gø¡ed_lock
(&
lock
->
l_ªsour˚
->
Ã_gø¡ed
,Üock, &
¥ev
);

1086 
	`ldlm_gø¡ed_li°_add_lock
(
lock
, &
¥ev
);

1087 
EXIT
;

1088 
	}
}

1101 
	$ldlm_gø¡_lock
(
ldlm_lock
 *
lock
, 
li°_hód
 *
w‹k_li°
)

1103 
ldlm_ªsour˚
 *
ªs
 = 
lock
->
l_ªsour˚
;

1104 
ENTRY
;

1106 
	`check_ªs_locked
(
ªs
);

1108 
lock
->
l_gø¡ed_mode
 =Üock->
l_ªq_mode
;

1110 i‡(
w‹k_li°
 && 
lock
->
l_com∂ëi⁄_a°
 !
NULL
)

1111 
	`ldlm_add_a°_w‹k_ôem
(
lock
, 
NULL
, 
w‹k_li°
);

1118 i‡(
lock
->
l_ªq_mode
 == 0 ||

1119 
lock
->
l_ªq_mode
 =
LCK_NL
 ||

1120 
	`ldlm_is_ã°_lock
(
lock
) ||

1121 
	`ldlm_is_Êock_dódlock
(
lock
))

1122 
RETURN_EXIT
;

1124 i‡(
ªs
->
Ã_ty≥
 =
LDLM_PLAIN
 ||Ñes->Ã_ty≥ =
LDLM_IBITS
)

1125 
	`ldlm_gø¡_lock_wôh_skùli°
(
lock
);

1126 i‡(
ªs
->
Ã_ty≥
 =
LDLM_EXTENT
)

1127 
	`ldlm_exã¡_add_lock
(
ªs
, 
lock
);

1129 
	`ldlm_ªsour˚_add_lock
(
ªs
, &ªs->
Ã_gø¡ed
, 
lock
);

1131 
	`ldlm_poﬁ_add
(&
	`ldlm_ªs_to_ns
(
ªs
)->
ns_poﬁ
, 
lock
);

1132 
EXIT
;

1133 
	}
}

1138 
	slock_m©ch_d©a
 {

1139 
ldlm_lock
 *
	mlmd_ﬁd
;

1140 
ldlm_lock
 *
	mlmd_lock
;

1141 
ldlm_mode
 *
	mlmd_mode
;

1142 
ldlm_pﬁicy_d©a
 *
	mlmd_pﬁicy
;

1143 
__u64
 
	mlmd_Êags
;

1144 
	mlmd_uƒef
;

1154 
	$lock_m©ches
(
ldlm_lock
 *
lock
, 
lock_m©ch_d©a
 *
d©a
)

1156 
ldlm_pﬁicy_d©a
 *
Õﬁ
 = &
lock
->
l_pﬁicy_d©a
;

1157 
ldlm_mode
 
m©ch
;

1159 i‡(
lock
 =
d©a
->
lmd_ﬁd
)

1160  
INTERVAL_ITER_STOP
;

1164 i‡(
	`ldlm_is_ex˛
(
lock
))

1165  
INTERVAL_ITER_CONT
;

1173 i‡(
	`ldlm_is_cb≥ndög
(
lock
) &&

1174 !(
d©a
->
lmd_Êags
 & 
LDLM_FL_CBPENDING
))

1175  
INTERVAL_ITER_CONT
;

1176 i‡(!
d©a
->
lmd_uƒef
 && 
	`ldlm_is_cb≥ndög
(
lock
) &&

1177 
lock
->
l_ªadîs
 =0 &&Üock->
l_wrôîs
 == 0)

1178  
INTERVAL_ITER_CONT
;

1180 i‡(!(
lock
->
l_ªq_mode
 & *
d©a
->
lmd_mode
))

1181  
INTERVAL_ITER_CONT
;

1182 
m©ch
 = 
lock
->
l_ªq_mode
;

1184 
lock
->
l_ªsour˚
->
Ã_ty≥
) {

1185 
LDLM_EXTENT
:

1186 i‡(
Õﬁ
->
l_exã¡
.
°¨t
 > 
d©a
->
lmd_pﬁicy
->l_extent.start ||

1187 
Õﬁ
->
l_exã¡
.
íd
 < 
d©a
->
lmd_pﬁicy
->l_extent.end)

1188  
INTERVAL_ITER_CONT
;

1190 i‡(
	`u∆ikñy
(
m©ch
 =
LCK_GROUP
) &&

1191 
d©a
->
lmd_pﬁicy
->
l_exã¡
.
gid
 !
LDLM_GID_ANY
 &&

1192 
Õﬁ
->
l_exã¡
.
gid
 !
d©a
->
lmd_pﬁicy
->l_extent.gid)

1193  
INTERVAL_ITER_CONT
;

1195 
LDLM_IBITS
:

1198 i‡((
Õﬁ
->
l_öodebôs
.
bôs
 &

1199 
d©a
->
lmd_pﬁicy
->
l_öodebôs
.
bôs
) !=

1200 
d©a
->
lmd_pﬁicy
->
l_öodebôs
.
bôs
)

1201  
INTERVAL_ITER_CONT
;

1209 i‡(!
d©a
->
lmd_uƒef
 && 
	`LDLM_HAVE_MASK
(
lock
, 
GONE
))

1210  
INTERVAL_ITER_CONT
;

1212 i‡(!
	`equi
(
d©a
->
lmd_Êags
 & 
LDLM_FL_LOCAL_ONLY
, 
	`ldlm_is_loˇl
(
lock
)))

1213  
INTERVAL_ITER_CONT
;

1215 i‡(
d©a
->
lmd_Êags
 & 
LDLM_FL_TEST_LOCK
) {

1216 
	`LDLM_LOCK_GET
(
lock
);

1217 
	`ldlm_lock_touch_ö_Ãu
(
lock
);

1219 
	`ldlm_lock_addªf_öã∫Æ_nﬁock
(
lock
, 
m©ch
);

1222 *
d©a
->
lmd_mode
 = 
m©ch
;

1223 
d©a
->
lmd_lock
 = 
lock
;

1225  
INTERVAL_ITER_STOP
;

1226 
	}
}

1228 
	$ôªe_ovîœp_cb
(
öãrvÆ_node
 *
ö
, *
¨gs
)

1230 
ldlm_öãrvÆ
 *
node
 = 
	`to_ldlm_öãrvÆ
(
ö
);

1231 
lock_m©ch_d©a
 *
d©a
 = 
¨gs
;

1232 
ldlm_lock
 *
lock
;

1233 
rc
;

1235 
	`li°_f‹_óch_íåy
(
lock
, &
node
->
li_group
, 
l_¶_pﬁicy
) {

1236 
rc
 = 
	`lock_m©ches
(
lock
, 
d©a
);

1237 i‡(
rc
 =
INTERVAL_ITER_STOP
)

1238  
INTERVAL_ITER_STOP
;

1240  
INTERVAL_ITER_CONT
;

1241 
	}
}

1251 
ldlm_lock
 *
	$£¨ch_ôªe
(
ldlm_ªsour˚
 *
ªs
,

1252 
lock_m©ch_d©a
 *
d©a
)

1254 
öãrvÆ_node_exã¡
 
ext
 = {

1255 .
°¨t
 = 
d©a
->
lmd_pﬁicy
->
l_exã¡
.start,

1256 .
íd
 = 
d©a
->
lmd_pﬁicy
->
l_exã¡
.end

1258 
idx
;

1260 
idx
 = 0; idx < 
LCK_MODE_NUM
; idx++) {

1261 
ldlm_öãrvÆ_åì
 *
åì
 = &
ªs
->
Ã_ôªe
[
idx
];

1263 i‡(
åì
->
lô_roŸ
 =
NULL
)

1266 i‡(!(
åì
->
lô_mode
 & *
d©a
->
lmd_mode
))

1269 
	`öãrvÆ_£¨ch
(
åì
->
lô_roŸ
, &
ext
,

1270 
ôªe_ovîœp_cb
, 
d©a
);

1272  
d©a
->
lmd_lock
;

1273 
	}
}

1284 
ldlm_lock
 *
	$£¨ch_queue
(
li°_hód
 *
queue
,

1285 
lock_m©ch_d©a
 *
d©a
)

1287 
ldlm_lock
 *
lock
;

1288 
rc
;

1290 
	`li°_f‹_óch_íåy
(
lock
, 
queue
, 
l_ªs_lök
) {

1291 
rc
 = 
	`lock_m©ches
(
lock
, 
d©a
);

1292 i‡(
rc
 =
INTERVAL_ITER_STOP
)

1293  
d©a
->
lmd_lock
;

1295  
NULL
;

1296 
	}
}

1298 
	$ldlm_lock_Áû_m©ch_locked
(
ldlm_lock
 *
lock
)

1300 i‡((
lock
->
l_Êags
 & 
LDLM_FL_FAIL_NOTIFIED
) == 0) {

1301 
lock
->
l_Êags
 |
LDLM_FL_FAIL_NOTIFIED
;

1302 
	`wake_up_Æl
(&
lock
->
l_waôq
);

1304 
	}
}

1305 
EXPORT_SYMBOL
(
ldlm_lock_Áû_m©ch_locked
);

1307 
	$ldlm_lock_Áû_m©ch
(
ldlm_lock
 *
lock
)

1309 
	`lock_ªs_™d_lock
(
lock
);

1310 
	`ldlm_lock_Áû_m©ch_locked
(
lock
);

1311 
	`u∆ock_ªs_™d_lock
(
lock
);

1312 
	}
}

1321 
	$ldlm_lock_Ælow_m©ch_locked
(
ldlm_lock
 *
lock
)

1323 
	`ldlm_£t_lvb_ªady
(
lock
);

1324 
	`wake_up_Æl
(&
lock
->
l_waôq
);

1325 
	}
}

1326 
EXPORT_SYMBOL
(
ldlm_lock_Ælow_m©ch_locked
);

1332 
	$ldlm_lock_Ælow_m©ch
(
ldlm_lock
 *
lock
)

1334 
	`lock_ªs_™d_lock
(
lock
);

1335 
	`ldlm_lock_Ælow_m©ch_locked
(
lock
);

1336 
	`u∆ock_ªs_™d_lock
(
lock
);

1337 
	}
}

1338 
EXPORT_SYMBOL
(
ldlm_lock_Ælow_m©ch
);

1370 
ldlm_mode
 
	$ldlm_lock_m©ch
(
ldlm_«me•a˚
 *
ns
, 
__u64
 
Êags
,

1371 c⁄° 
ldlm_ªs_id
 *
ªs_id
,

1372 
ldlm_ty≥
 
ty≥
,

1373 
ldlm_pﬁicy_d©a
 *
pﬁicy
,

1374 
ldlm_mode
 
mode
,

1375 
lu°ª_h™dÀ
 *
lockh
, 
uƒef
)

1377 
lock_m©ch_d©a
 
d©a
 = {

1378 .
lmd_ﬁd
 = 
NULL
,

1379 .
lmd_lock
 = 
NULL
,

1380 .
lmd_mode
 = &
mode
,

1381 .
lmd_pﬁicy
 = 
pﬁicy
,

1382 .
lmd_Êags
 = 
Êags
,

1383 .
lmd_uƒef
 = 
uƒef
,

1385 
ldlm_ªsour˚
 *
ªs
;

1386 
ldlm_lock
 *
lock
;

1387 
rc
 = 0;

1388 
ENTRY
;

1390 i‡(
ns
 =
NULL
) {

1391 
d©a
.
lmd_ﬁd
 = 
	`ldlm_h™dÀ2lock
(
lockh
);

1392 
	`LASSERT
(
d©a
.
lmd_ﬁd
 !
NULL
);

1394 
ns
 = 
	`ldlm_lock_to_ns
(
d©a
.
lmd_ﬁd
);

1395 
ªs_id
 = &
d©a
.
lmd_ﬁd
->
l_ªsour˚
->
Ã_«me
;

1396 
ty≥
 = 
d©a
.
lmd_ﬁd
->
l_ªsour˚
->
Ã_ty≥
;

1397 *
d©a
.
lmd_mode
 = d©a.
lmd_ﬁd
->
l_ªq_mode
;

1400 
ªs
 = 
	`ldlm_ªsour˚_gë
(
ns
, 
NULL
, 
ªs_id
, 
ty≥
, 0);

1401 i‡(
	`IS_ERR
(
ªs
)) {

1402 
	`LASSERT
(
d©a
.
lmd_ﬁd
 =
NULL
);

1403 
	`RETURN
(0);

1406 
	`LDLM_RESOURCE_ADDREF
(
ªs
);

1407 
	`lock_ªs
(
ªs
);

1409 i‡(
ªs
->
Ã_ty≥
 =
LDLM_EXTENT
)

1410 
lock
 = 
	`£¨ch_ôªe
(
ªs
, &
d©a
);

1412 
lock
 = 
	`£¨ch_queue
(&
ªs
->
Ã_gø¡ed
, &
d©a
);

1413 i‡(
lock
 !
NULL
)

1414 
	`GOTO
(
out
, 
rc
 = 1);

1415 i‡(
Êags
 & 
LDLM_FL_BLOCK_GRANTED
)

1416 
	`GOTO
(
out
, 
rc
 = 0);

1417 
lock
 = 
	`£¨ch_queue
(&
ªs
->
Ã_c⁄vîtög
, &
d©a
);

1418 i‡(
lock
 !
NULL
)

1419 
	`GOTO
(
out
, 
rc
 = 1);

1420 
lock
 = 
	`£¨ch_queue
(&
ªs
->
Ã_waôög
, &
d©a
);

1421 i‡(
lock
 !
NULL
)

1422 
	`GOTO
(
out
, 
rc
 = 1);

1424 
EXIT
;

1425 
out
:

1426 
	`u∆ock_ªs
(
ªs
);

1427 
	`LDLM_RESOURCE_DELREF
(
ªs
);

1428 
	`ldlm_ªsour˚_puåef
(
ªs
);

1430 i‡(
lock
) {

1431 
	`ldlm_lock2h™dÀ
(
lock
, 
lockh
);

1432 i‡((
Êags
 & 
LDLM_FL_LVB_READY
) &&

1433 (!
	`ldlm_is_lvb_ªady
(
lock
))) {

1434 
__u64
 
waô_Êags
 = 
LDLM_FL_LVB_READY
 |

1435 
LDLM_FL_DESTROYED
 | 
LDLM_FL_FAIL_NOTIFIED
;

1436 
l_waô_öfo
 
lwi
;

1437 i‡(
lock
->
l_com∂ëi⁄_a°
) {

1438 
îr
 = 
lock
->
	`l_com∂ëi⁄_a°
(lock,

1439 
LDLM_FL_WAIT_NOREPROC
,

1440 
NULL
);

1441 i‡(
îr
) {

1442 i‡(
Êags
 & 
LDLM_FL_TEST_LOCK
)

1443 
	`LDLM_LOCK_RELEASE
(
lock
);

1445 
	`ldlm_lock_de¸ef_öã∫Æ
(
lock
,

1446 
mode
);

1447 
rc
 = 0;

1448 
out2
;

1452 
lwi
 = 
	`LWI_TIMEOUT_INTR
(
	`cfs_time_£c⁄ds
(
obd_timeout
),

1453 
NULL
, 
LWI_ON_SIGNAL_NOOP
, NULL);

1456 
	`l_waô_evít
(
lock
->
l_waôq
,

1457 
lock
->
l_Êags
 & 
waô_Êags
,

1458 &
lwi
);

1459 i‡(!
	`ldlm_is_lvb_ªady
(
lock
)) {

1460 i‡(
Êags
 & 
LDLM_FL_TEST_LOCK
)

1461 
	`LDLM_LOCK_RELEASE
(
lock
);

1463 
	`ldlm_lock_de¸ef_öã∫Æ
(
lock
, 
mode
);

1464 
rc
 = 0;

1468 
out2
:

1469 i‡(
rc
) {

1470 
	`LDLM_DEBUG
(
lock
, "m©ched ("
LPU64
" "LPU64")",

1471 (
ty≥
 =
LDLM_PLAIN
 ||Åy≥ =
LDLM_IBITS
) ?

1472 
ªs_id
->
«me
[2] : 
pﬁicy
->
l_exã¡
.
°¨t
,

1473 (
ty≥
 =
LDLM_PLAIN
 ||Åy≥ =
LDLM_IBITS
) ?

1474 
ªs_id
->
«me
[3] : 
pﬁicy
->
l_exã¡
.
íd
);

1477 i‡(
lock
->
l_c⁄n_exp‹t
 &&

1478 
	`•éΩc_imp‹t_check_˘x
(

1479 
	`˛ass_exp2˛iimp
(
lock
->
l_c⁄n_exp‹t
))) {

1480 i‡(!(
Êags
 & 
LDLM_FL_TEST_LOCK
))

1481 
	`ldlm_lock_de¸ef_öã∫Æ
(
lock
, 
mode
);

1482 
rc
 = 0;

1485 i‡(
Êags
 & 
LDLM_FL_TEST_LOCK
)

1486 
	`LDLM_LOCK_RELEASE
(
lock
);

1488 } i‡(!(
Êags
 & 
LDLM_FL_TEST_LOCK
)) {

1489 
	`LDLM_DEBUG_NOLOCK
("not matchedÇs %pÅype %u mode %uÑes "

1490 
LPU64
"/"LPU64" ("LPU64" "LPU64")", 
ns
,

1491 
ty≥
, 
mode
, 
ªs_id
->
«me
[0],Ñes_id->name[1],

1492 (
ty≥
 =
LDLM_PLAIN
 ||Åy≥ =
LDLM_IBITS
) ?

1493 
ªs_id
->
«me
[2] :
pﬁicy
->
l_exã¡
.
°¨t
,

1494 (
ty≥
 =
LDLM_PLAIN
 ||Åy≥ =
LDLM_IBITS
) ?

1495 
ªs_id
->
«me
[3] : 
pﬁicy
->
l_exã¡
.
íd
);

1497 i‡(
d©a
.
lmd_ﬁd
 !
NULL
)

1498 
	`LDLM_LOCK_PUT
(
d©a
.
lmd_ﬁd
);

1500  
rc
 ? 
mode
 : 0;

1501 
	}
}

1502 
EXPORT_SYMBOL
(
ldlm_lock_m©ch
);

1504 
ldlm_mode
 
	$ldlm_ªvÆid©e_lock_h™dÀ
(
lu°ª_h™dÀ
 *
lockh
,

1505 
__u64
 *
bôs
)

1507 
ldlm_lock
 *
lock
;

1508 
ldlm_mode
 
mode
 = 0;

1509 
ENTRY
;

1511 
lock
 = 
	`ldlm_h™dÀ2lock
(
lockh
);

1512 i‡(
lock
 !
NULL
) {

1513 
	`lock_ªs_™d_lock
(
lock
);

1514 i‡(
	`LDLM_HAVE_MASK
(
lock
, 
GONE
))

1515 
	`GOTO
(
out
, 
mode
);

1517 i‡(
	`ldlm_is_cb≥ndög
(
lock
) &&

1518 
lock
->
l_ªadîs
 =0 &&Üock->
l_wrôîs
 == 0)

1519 
	`GOTO
(
out
, 
mode
);

1521 i‡(
bôs
)

1522 *
bôs
 = 
lock
->
l_pﬁicy_d©a
.
l_öodebôs
.bits;

1523 
mode
 = 
lock
->
l_gø¡ed_mode
;

1524 
	`ldlm_lock_addªf_öã∫Æ_nﬁock
(
lock
, 
mode
);

1527 
EXIT
;

1529 
out
:

1530 i‡(
lock
 !
NULL
) {

1531 
	`u∆ock_ªs_™d_lock
(
lock
);

1532 
	`LDLM_LOCK_PUT
(
lock
);

1534  
mode
;

1535 
	}
}

1536 
EXPORT_SYMBOL
(
ldlm_ªvÆid©e_lock_h™dÀ
);

1539 
	$ldlm_fûl_lvb
(
ldlm_lock
 *
lock
, 
ªq_ˇpsuÀ
 *
pûl
,

1540 
ªq_loˇti⁄
 
loc
, *
d©a
, 
size
)

1542 *
lvb
;

1543 
ENTRY
;

1545 
	`LASSERT
(
d©a
 !
NULL
);

1546 
	`LASSERT
(
size
 >= 0);

1548 
lock
->
l_lvb_ty≥
) {

1549 
LVB_T_OST
:

1550 i‡(
size
 =(
o°_lvb
)) {

1551 i‡(
loc
 =
RCL_CLIENT
)

1552 
lvb
 = 
	`ªq_ˇpsuÀ_˛õ¡_swab_gë
(
pûl
,

1553 &
RMF_DLM_LVB
,

1554 
lu°ª_swab_o°_lvb
);

1556 
lvb
 = 
	`ªq_ˇpsuÀ_£rvî_swab_gë
(
pûl
,

1557 &
RMF_DLM_LVB
,

1558 
lu°ª_swab_o°_lvb
);

1559 i‡(
	`u∆ikñy
(
lvb
 =
NULL
)) {

1560 
	`LDLM_ERROR
(
lock
, "no LVB");

1561 
	`RETURN
(-
EPROTO
);

1564 
	`mem˝y
(
d©a
, 
lvb
, 
size
);

1565 } i‡(
size
 =(
o°_lvb_v1
)) {

1566 
o°_lvb
 *
ﬁvb
 = 
d©a
;

1568 i‡(
loc
 =
RCL_CLIENT
)

1569 
lvb
 = 
	`ªq_ˇpsuÀ_˛õ¡_swab_gë
(
pûl
,

1570 &
RMF_DLM_LVB
,

1571 
lu°ª_swab_o°_lvb_v1
);

1573 
lvb
 = 
	`ªq_ˇpsuÀ_£rvî_sized_swab_gë
(
pûl
,

1574 &
RMF_DLM_LVB
, 
size
,

1575 
lu°ª_swab_o°_lvb_v1
);

1576 i‡(
	`u∆ikñy
(
lvb
 =
NULL
)) {

1577 
	`LDLM_ERROR
(
lock
, "no LVB");

1578 
	`RETURN
(-
EPROTO
);

1581 
	`mem˝y
(
d©a
, 
lvb
, 
size
);

1582 
ﬁvb
->
lvb_mtime_ns
 = 0;

1583 
ﬁvb
->
lvb_©ime_ns
 = 0;

1584 
ﬁvb
->
lvb_˘ime_ns
 = 0;

1586 
	`LDLM_ERROR
(
lock
, "Replied unexpected ost LVB size %d",

1587 
size
);

1588 
	`RETURN
(-
EINVAL
);

1591 
LVB_T_LQUOTA
:

1592 i‡(
size
 =(
lquŸa_lvb
)) {

1593 i‡(
loc
 =
RCL_CLIENT
)

1594 
lvb
 = 
	`ªq_ˇpsuÀ_˛õ¡_swab_gë
(
pûl
,

1595 &
RMF_DLM_LVB
,

1596 
lu°ª_swab_lquŸa_lvb
);

1598 
lvb
 = 
	`ªq_ˇpsuÀ_£rvî_swab_gë
(
pûl
,

1599 &
RMF_DLM_LVB
,

1600 
lu°ª_swab_lquŸa_lvb
);

1601 i‡(
	`u∆ikñy
(
lvb
 =
NULL
)) {

1602 
	`LDLM_ERROR
(
lock
, "no LVB");

1603 
	`RETURN
(-
EPROTO
);

1606 
	`mem˝y
(
d©a
, 
lvb
, 
size
);

1608 
	`LDLM_ERROR
(
lock
, "Replied unexpectedÜquota LVB size %d",

1609 
size
);

1610 
	`RETURN
(-
EINVAL
);

1613 
LVB_T_LAYOUT
:

1614 i‡(
size
 == 0)

1617 i‡(
loc
 =
RCL_CLIENT
)

1618 
lvb
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(
pûl
, &
RMF_DLM_LVB
);

1620 
lvb
 = 
	`ªq_ˇpsuÀ_£rvî_gë
(
pûl
, &
RMF_DLM_LVB
);

1621 i‡(
	`u∆ikñy
(
lvb
 =
NULL
)) {

1622 
	`LDLM_ERROR
(
lock
, "no LVB");

1623 
	`RETURN
(-
EPROTO
);

1626 
	`mem˝y
(
d©a
, 
lvb
, 
size
);

1629 
	`LDLM_ERROR
(
lock
, "Unknow¿LVBÅy≥: %d\n",Üock->
l_lvb_ty≥
);

1630 
	`libcfs_debug_dump°ack
(
NULL
);

1631 
	`RETURN
(-
EINVAL
);

1634 
	`RETURN
(0);

1635 
	}
}

1641 
ldlm_lock
 *
	$ldlm_lock_¸óã
(
ldlm_«me•a˚
 *
ns
,

1642 c⁄° 
ldlm_ªs_id
 *
ªs_id
,

1643 
ldlm_ty≥
 
ty≥
,

1644 
ldlm_mode
 
mode
,

1645 c⁄° 
ldlm_ˇŒback_suôe
 *
cbs
,

1646 *
d©a
, 
__u32
 
lvb_Àn
,

1647 
lvb_ty≥
Üvb_type)

1649 
ldlm_lock
 *
lock
;

1650 
ldlm_ªsour˚
 *
ªs
;

1651 
rc
;

1652 
ENTRY
;

1654 
ªs
 = 
	`ldlm_ªsour˚_gë
(
ns
, 
NULL
, 
ªs_id
, 
ty≥
, 1);

1655 i‡(
	`IS_ERR
(
ªs
))

1656 
	`RETURN
(
	`ERR_CAST
(
ªs
));

1658 
lock
 = 
	`ldlm_lock_√w
(
ªs
);

1659 i‡(
lock
 =
NULL
)

1660 
	`RETURN
(
	`ERR_PTR
(-
ENOMEM
));

1662 
lock
->
l_ªq_mode
 = 
mode
;

1663 
lock
->
l_a°_d©a
 = 
d©a
;

1664 
lock
->
l_pid
 = 
	`cuºít_pid
();

1665 i‡(
	`ns_is_£rvî
(
ns
))

1666 
	`ldlm_£t_ns_§v
(
lock
);

1667 i‡(
cbs
) {

1668 
lock
->
l_blockög_a°
 = 
cbs
->
lcs_blockög
;

1669 
lock
->
l_com∂ëi⁄_a°
 = 
cbs
->
lcs_com∂ëi⁄
;

1670 
lock
->
l_glimp£_a°
 = 
cbs
->
lcs_glimp£
;

1673 
lock
->
l_åì_node
 = 
NULL
;

1675 i‡(
ty≥
 =
LDLM_EXTENT
)

1676 i‡(
	`ldlm_öãrvÆ_Æloc
(
lock
Ë=
NULL
)

1677 
	`GOTO
(
out
, 
rc
 = -
ENOMEM
);

1679 i‡(
lvb_Àn
) {

1680 
lock
->
l_lvb_Àn
 = 
lvb_Àn
;

1681 
	`OBD_ALLOC_LARGE
(
lock
->
l_lvb_d©a
, 
lvb_Àn
);

1682 i‡(
lock
->
l_lvb_d©a
 =
NULL
)

1683 
	`GOTO
(
out
, 
rc
 = -
ENOMEM
);

1686 
lock
->
l_lvb_ty≥
 = 
lvb_ty≥
;

1687 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_NEW_LOCK
))

1688 
	`GOTO
(
out
, 
rc
 = -
ENOENT
);

1690 
	`RETURN
(
lock
);

1692 
out
:

1693 
	`ldlm_lock_de°roy
(
lock
);

1694 
	`LDLM_LOCK_RELEASE
(
lock
);

1695 
	`RETURN
(
	`ERR_PTR
(
rc
));

1696 
	}
}

1708 
ldlm_îr‹
 
	$ldlm_lock_íqueue
(
ldlm_«me•a˚
 *
ns
,

1709 
ldlm_lock
 **
lockp
,

1710 *
cookõ
, 
__u64
 *
Êags
)

1712 
ldlm_lock
 *
lock
 = *
lockp
;

1713 
ldlm_ªsour˚
 *
ªs
 = 
lock
->
l_ªsour˚
;

1714 
loˇl
 = 
	`ns_is_˛õ¡
(
	`ldlm_ªs_to_ns
(
ªs
));

1715 #ifde‡
HAVE_SERVER_SUPPORT


1716 
ldlm_¥o˚ssög_pﬁicy
 
pﬁicy
;

1718 
ldlm_îr‹
 
rc
 = 
ELDLM_OK
;

1719 
ldlm_öãrvÆ
 *
node
 = 
NULL
;

1720 
ENTRY
;

1723 i‡((*
Êags
 & (
LDLM_FL_HAS_INTENT
|
LDLM_FL_REPLAY
)) == LDLM_FL_HAS_INTENT

1724 && !
loˇl
 && 
ns
->
ns_pﬁicy
) {

1725 
rc
 = 
ns
->
	`ns_pﬁicy
“s, 
lockp
, 
cookõ
, 
lock
->
l_ªq_mode
, *
Êags
,

1726 
NULL
);

1727 i‡(
rc
 =
ELDLM_LOCK_REPLACED
) {

1732 i‡(
lock
 !*
lockp
) {

1733 
	`ldlm_lock_de°roy
(
lock
);

1734 
	`LDLM_LOCK_RELEASE
(
lock
);

1736 *
Êags
 |
LDLM_FL_LOCK_CHANGED
;

1737 
	`RETURN
(0);

1738 } i‡(
rc
 !
ELDLM_OK
 &&

1739 
lock
->
l_ªq_mode
 =lock->
l_gø¡ed_mode
) {

1740 
	`LASSERT
(*
Êags
 & 
LDLM_FL_RESENT
);

1747 
	`RETURN
(
rc
);

1748 } i‡(
rc
 !
ELDLM_OK
 ||

1749 (
rc
 =
ELDLM_OK
 && (*
Êags
 & 
LDLM_FL_INTENT_ONLY
))) {

1750 
	`ldlm_lock_de°roy
(
lock
);

1751 
	`RETURN
(
rc
);

1755 i‡(*
Êags
 & 
LDLM_FL_RESENT
) {

1761 *
Êags
 |
LDLM_FL_LOCK_CHANGED
;

1762 i‡(
lock
->
l_ªq_mode
 !lock->
l_gø¡ed_mode
)

1763 *
Êags
 |
LDLM_FL_BLOCK_GRANTED
;

1764 *
Êags
 |
lock
->
l_Êags
 & 
LDLM_FL_NO_TIMEOUT
;

1765 
	`RETURN
(
ELDLM_OK
);

1772 i‡(!
loˇl
 && (*
Êags
 & 
LDLM_FL_REPLAY
Ë&& 
ªs
->
Ã_ty≥
 =
LDLM_EXTENT
)

1773 
	`OBD_SLAB_ALLOC_PTR_GFP
(
node
, 
ldlm_öãrvÆ_¶ab
, 
GFP_NOFS
);

1775 
	`lock_ªs_™d_lock
(
lock
);

1776 i‡(
loˇl
 && 
lock
->
l_ªq_mode
 =lock->
l_gø¡ed_mode
) {

1780 *
Êags
 &~
LDLM_FL_BLOCKED_MASK
;

1781 
	`GOTO
(
out
, 
rc
 = 
ELDLM_OK
);

1784 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

1785 i‡(
ªs
->
Ã_ty≥
 =
LDLM_EXTENT
 && 
lock
->
l_åì_node
 =
NULL
) {

1786 i‡(
node
 =
NULL
) {

1787 
	`ldlm_lock_de°roy_nﬁock
(
lock
);

1788 
	`GOTO
(
out
, 
rc
 = -
ENOMEM
);

1791 
	`INIT_LIST_HEAD
(&
node
->
li_group
);

1792 
	`ldlm_öãrvÆ_©èch
(
node
, 
lock
);

1793 
node
 = 
NULL
;

1798 i‡(*
Êags
 & 
LDLM_FL_AST_DISCARD_DATA
)

1799 
	`ldlm_£t_a°_disˇrd_d©a
(
lock
);

1800 i‡(*
Êags
 & 
LDLM_FL_TEST_LOCK
)

1801 
	`ldlm_£t_ã°_lock
(
lock
);

1802 i‡(*
Êags
 & 
LDLM_FL_COS_INCOMPAT
)

1803 
	`ldlm_£t_cos_öcom∑t
(
lock
);

1804 i‡(*
Êags
 & 
LDLM_FL_COS_ENABLED
)

1805 
	`ldlm_£t_cos_íabÀd
(
lock
);

1818 i‡(
loˇl
) {

1819 i‡(*
Êags
 & 
LDLM_FL_BLOCK_CONV
)

1820 
	`ldlm_ªsour˚_add_lock
(
ªs
, &ªs->
Ã_c⁄vîtög
, 
lock
);

1821 i‡(*
Êags
 & (
LDLM_FL_BLOCK_WAIT
 | 
LDLM_FL_BLOCK_GRANTED
))

1822 
	`ldlm_ªsour˚_add_lock
(
ªs
, &ªs->
Ã_waôög
, 
lock
);

1824 
	`ldlm_gø¡_lock
(
lock
, 
NULL
);

1825 
	`GOTO
(
out
, 
rc
 = 
ELDLM_OK
);

1826 #ifde‡
HAVE_SERVER_SUPPORT


1827 } i‡(*
Êags
 & 
LDLM_FL_REPLAY
) {

1828 i‡(*
Êags
 & 
LDLM_FL_BLOCK_CONV
) {

1829 
	`ldlm_ªsour˚_add_lock
(
ªs
, &ªs->
Ã_c⁄vîtög
, 
lock
);

1830 
	`GOTO
(
out
, 
rc
 = 
ELDLM_OK
);

1831 } i‡(*
Êags
 & 
LDLM_FL_BLOCK_WAIT
) {

1832 
	`ldlm_ªsour˚_add_lock
(
ªs
, &ªs->
Ã_waôög
, 
lock
);

1833 
	`GOTO
(
out
, 
rc
 = 
ELDLM_OK
);

1834 } i‡(*
Êags
 & 
LDLM_FL_BLOCK_GRANTED
) {

1835 
	`ldlm_gø¡_lock
(
lock
, 
NULL
);

1836 
	`GOTO
(
out
, 
rc
 = 
ELDLM_OK
);

1841 
pﬁicy
 = 
ldlm_¥o˚ssög_pﬁicy_èbÀ
[
ªs
->
Ã_ty≥
];

1842 
	`pﬁicy
(
lock
, 
Êags
, 1, &
rc
, 
NULL
);

1843 
	`GOTO
(
out
, 
rc
);

1846 
	`CERROR
("This is client-side-only module, cannot handle "

1848 
	`LBUG
();

1852 
out
:

1853 
	`u∆ock_ªs_™d_lock
(
lock
);

1854 i‡(
node
)

1855 
	`OBD_SLAB_FREE
(
node
, 
ldlm_öãrvÆ_¶ab
, (*node));

1856  
rc
;

1857 
	}
}

1859 #ifde‡
HAVE_SERVER_SUPPORT


1866 
	$ldlm_ª¥o˚ss_queue
(
ldlm_ªsour˚
 *
ªs
, 
li°_hód
 *
queue
,

1867 
li°_hód
 *
w‹k_li°
)

1869 
li°_hód
 *
tmp
, *
pos
;

1870 
ldlm_¥o˚ssög_pﬁicy
 
pﬁicy
;

1871 
__u64
 
Êags
;

1872 
rc
 = 
LDLM_ITER_CONTINUE
;

1873 
ldlm_îr‹
 
îr
;

1874 
ENTRY
;

1876 
	`check_ªs_locked
(
ªs
);

1878 
pﬁicy
 = 
ldlm_¥o˚ssög_pﬁicy_èbÀ
[
ªs
->
Ã_ty≥
];

1879 
	`LASSERT
(
pﬁicy
);

1881 
	`li°_f‹_óch_ß„
(
tmp
, 
pos
, 
queue
) {

1882 
ldlm_lock
 *
≥ndög
;

1884 
≥ndög
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
, 
l_ªs_lök
);

1886 
	`CDEBUG
(
D_INFO
, "Rïro˚ssögÜock %p\n", 
≥ndög
);

1888 
Êags
 = 0;

1889 
rc
 = 
	`pﬁicy
(
≥ndög
, &
Êags
, 0, &
îr
, 
w‹k_li°
);

1890 i‡(
rc
 !
LDLM_ITER_CONTINUE
)

1894 
	`RETURN
(
rc
);

1895 
	}
}

1902 
	$ldlm_w‹k_bl_a°_lock
(
±Ãpc_ªque°_£t
 *
rq£t
, *
›aq
)

1904 
ldlm_cb_£t_¨g
 *
¨g
 = 
›aq
;

1905 
ldlm_lock_desc
 
d
;

1906 
rc
;

1907 
ldlm_lock
 *
lock
;

1908 
ENTRY
;

1910 i‡(
	`li°_em±y
(
¨g
->
li°
))

1911 
	`RETURN
(-
ENOENT
);

1913 
lock
 = 
	`li°_íåy
(
¨g
->
li°
->
√xt
, 
ldlm_lock
, 
l_bl_a°
);

1916 
	`lock_ªs_™d_lock
(
lock
);

1917 
	`li°_dñ_öô
(&
lock
->
l_bl_a°
);

1919 
	`LASSERT
(
	`ldlm_is_a°_£¡
(
lock
));

1920 
	`LASSERT
(
lock
->
l_bl_a°_run
 == 0);

1921 
	`LASSERT
(
lock
->
l_blockög_lock
);

1922 
lock
->
l_bl_a°_run
++;

1923 
	`u∆ock_ªs_™d_lock
(
lock
);

1925 
	`ldlm_lock2desc
(
lock
->
l_blockög_lock
, &
d
);

1927 
rc
 = 
lock
->
	`l_blockög_a°
÷ock, &
d
, (*)
¨g
, 
LDLM_CB_BLOCKING
);

1928 
	`LDLM_LOCK_RELEASE
(
lock
->
l_blockög_lock
);

1929 
lock
->
l_blockög_lock
 = 
NULL
;

1930 
	`LDLM_LOCK_RELEASE
(
lock
);

1932 
	`RETURN
(
rc
);

1933 
	}
}

1939 
	$ldlm_w‹k_˝_a°_lock
(
±Ãpc_ªque°_£t
 *
rq£t
, *
›aq
)

1941 
ldlm_cb_£t_¨g
 *
¨g
 = 
›aq
;

1942 
rc
 = 0;

1943 
ldlm_lock
 *
lock
;

1944 
ldlm_com∂ëi⁄_ˇŒback
 
com∂ëi⁄_ˇŒback
;

1945 
ENTRY
;

1947 i‡(
	`li°_em±y
(
¨g
->
li°
))

1948 
	`RETURN
(-
ENOENT
);

1950 
lock
 = 
	`li°_íåy
(
¨g
->
li°
->
√xt
, 
ldlm_lock
, 
l_˝_a°
);

1964 
	`lock_ªs_™d_lock
(
lock
);

1965 
	`li°_dñ_öô
(&
lock
->
l_˝_a°
);

1966 
	`LASSERT
(
	`ldlm_is_˝_ªqd
(
lock
));

1969 
com∂ëi⁄_ˇŒback
 = 
lock
->
l_com∂ëi⁄_a°
;

1970 
	`ldlm_˛ór_˝_ªqd
(
lock
);

1971 
	`u∆ock_ªs_™d_lock
(
lock
);

1973 i‡(
com∂ëi⁄_ˇŒback
 !
NULL
)

1974 
rc
 = 
	`com∂ëi⁄_ˇŒback
(
lock
, 0, (*)
¨g
);

1975 
	`LDLM_LOCK_RELEASE
(
lock
);

1977 
	`RETURN
(
rc
);

1978 
	}
}

1984 
	$ldlm_w‹k_ªvoke_a°_lock
(
±Ãpc_ªque°_£t
 *
rq£t
, *
›aq
)

1986 
ldlm_cb_£t_¨g
 *
¨g
 = 
›aq
;

1987 
ldlm_lock_desc
 
desc
;

1988 
rc
;

1989 
ldlm_lock
 *
lock
;

1990 
ENTRY
;

1992 i‡(
	`li°_em±y
(
¨g
->
li°
))

1993 
	`RETURN
(-
ENOENT
);

1995 
lock
 = 
	`li°_íåy
(
¨g
->
li°
->
√xt
, 
ldlm_lock
, 
l_rk_a°
);

1996 
	`li°_dñ_öô
(&
lock
->
l_rk_a°
);

1999 
	`ldlm_lock2desc
(
lock
, &
desc
);

2000 
desc
.
l_ªq_mode
 = 
LCK_EX
;

2001 
desc
.
l_gø¡ed_mode
 = 0;

2003 
rc
 = 
lock
->
	`l_blockög_a°
÷ock, &
desc
, (*)
¨g
, 
LDLM_CB_BLOCKING
);

2004 
	`LDLM_LOCK_RELEASE
(
lock
);

2006 
	`RETURN
(
rc
);

2007 
	}
}

2012 
	$ldlm_w‹k_gl_a°_lock
(
±Ãpc_ªque°_£t
 *
rq£t
, *
›aq
)

2014 
ldlm_cb_£t_¨g
 *
¨g
 = 
›aq
;

2015 
ldlm_glimp£_w‹k
 *
gl_w‹k
;

2016 
ldlm_lock
 *
lock
;

2017 
rc
 = 0;

2018 
ENTRY
;

2020 i‡(
	`li°_em±y
(
¨g
->
li°
))

2021 
	`RETURN
(-
ENOENT
);

2023 
gl_w‹k
 = 
	`li°_íåy
(
¨g
->
li°
->
√xt
, 
ldlm_glimp£_w‹k
,

2024 
gl_li°
);

2025 
	`li°_dñ_öô
(&
gl_w‹k
->
gl_li°
);

2027 
lock
 = 
gl_w‹k
->
gl_lock
;

2030 
¨g
->
gl_desc
 = 
gl_w‹k
->gl_desc;

2033 i‡(
lock
->
	`l_glimp£_a°
÷ock, (*)
¨g
) == 0)

2034 
rc
 = 1;

2036 
	`LDLM_LOCK_RELEASE
(
lock
);

2038 i‡((
gl_w‹k
->
gl_Êags
 & 
LDLM_GL_WORK_NOFREE
) == 0)

2039 
	`OBD_FREE_PTR
(
gl_w‹k
);

2041 
	`RETURN
(
rc
);

2042 
	}
}

2050 
	$ldlm_run_a°_w‹k
(
ldlm_«me•a˚
 *
ns
, 
li°_hód
 *
Ωc_li°
,

2051 
ldlm_desc_a°_t
 
a°_ty≥
)

2053 
ldlm_cb_£t_¨g
 *
¨g
;

2054 
£t_¥odu˚r_func
 
w‹k_a°_lock
;

2055 
rc
;

2057 i‡(
	`li°_em±y
(
Ωc_li°
))

2058 
	`RETURN
(0);

2060 
	`OBD_ALLOC_PTR
(
¨g
);

2061 i‡(
¨g
 =
NULL
)

2062 
	`RETURN
(-
ENOMEM
);

2064 
	`©omic_£t
(&
¨g
->
ª°¨t
, 0);

2065 
¨g
->
li°
 = 
Ωc_li°
;

2067 
a°_ty≥
) {

2068 
LDLM_WORK_BL_AST
:

2069 
¨g
->
ty≥
 = 
LDLM_BL_CALLBACK
;

2070 
w‹k_a°_lock
 = 
ldlm_w‹k_bl_a°_lock
;

2072 
LDLM_WORK_CP_AST
:

2073 
¨g
->
ty≥
 = 
LDLM_CP_CALLBACK
;

2074 
w‹k_a°_lock
 = 
ldlm_w‹k_˝_a°_lock
;

2076 
LDLM_WORK_REVOKE_AST
:

2077 
¨g
->
ty≥
 = 
LDLM_BL_CALLBACK
;

2078 
w‹k_a°_lock
 = 
ldlm_w‹k_ªvoke_a°_lock
;

2080 
LDLM_WORK_GL_AST
:

2081 
¨g
->
ty≥
 = 
LDLM_GL_CALLBACK
;

2082 
w‹k_a°_lock
 = 
ldlm_w‹k_gl_a°_lock
;

2085 
	`LBUG
();

2092 
¨g
->
£t
 = 
	`±Ãpc_¥ï_fc£t
(
ns
->
ns_max_∑øŒñ_a°
 ? : 
UINT_MAX
,

2093 
w‹k_a°_lock
, 
¨g
);

2094 i‡(
¨g
->
£t
 =
NULL
)

2095 
	`GOTO
(
out
, 
rc
 = -
ENOMEM
);

2097 
	`±Ãpc_£t_waô
(
¨g
->
£t
);

2098 
	`±Ãpc_£t_de°roy
(
¨g
->
£t
);

2100 
rc
 = 
	`©omic_ªad
(&
¨g
->
ª°¨t
Ë? -
ERESTART
 : 0;

2101 
	`GOTO
(
out
, 
rc
);

2102 
out
:

2103 
	`OBD_FREE_PTR
(
¨g
);

2104  
rc
;

2105 
	}
}

2107 
	$ª¥o˚ss_⁄e_queue
(
ldlm_ªsour˚
 *
ªs
, *
˛osuª
)

2109 
	`ldlm_ª¥o˚ss_Æl
(
ªs
);

2110  
LDLM_ITER_CONTINUE
;

2111 
	}
}

2113 
	$ldlm_ª¥o˚ss_ªs
(
cfs_hash
 *
hs
, 
cfs_hash_bd
 *
bd
,

2114 
hli°_node
 *
hnode
, *
¨g
)

2116 
ldlm_ªsour˚
 *
ªs
 = 
	`cfs_hash_obje˘
(
hs
, 
hnode
);

2117 
rc
;

2119 
rc
 = 
	`ª¥o˚ss_⁄e_queue
(
ªs
, 
¨g
);

2121  
rc
 =
LDLM_ITER_STOP
;

2122 
	}
}

2128 
	$ldlm_ª¥o˚ss_Æl_ns
(
ldlm_«me•a˚
 *
ns
)

2130 
ENTRY
;

2132 i‡(
ns
 !
NULL
) {

2133 
	`cfs_hash_f‹_óch_nﬁock
(
ns
->
ns_rs_hash
,

2134 
ldlm_ª¥o˚ss_ªs
, 
NULL
, 0);

2136 
EXIT
;

2137 
	}
}

2147 
	$ldlm_ª¥o˚ss_Æl
(
ldlm_ªsour˚
 *
ªs
)

2149 
li°_hód
 
Ωc_li°
;

2150 #ifde‡
HAVE_SERVER_SUPPORT


2151 
rc
;

2152 
ENTRY
;

2154 
	`INIT_LIST_HEAD
(&
Ωc_li°
);

2156 i‡(
	`ns_is_˛õ¡
(
	`ldlm_ªs_to_ns
(
ªs
))) {

2157 
EXIT
;

2161 
ª°¨t
:

2162 
	`lock_ªs
(
ªs
);

2163 
rc
 = 
	`ldlm_ª¥o˚ss_queue
(
ªs
, &ªs->
Ã_c⁄vîtög
, &
Ωc_li°
);

2164 i‡(
rc
 =
LDLM_ITER_CONTINUE
)

2165 
	`ldlm_ª¥o˚ss_queue
(
ªs
, &ªs->
Ã_waôög
, &
Ωc_li°
);

2166 
	`u∆ock_ªs
(
ªs
);

2168 
rc
 = 
	`ldlm_run_a°_w‹k
(
	`ldlm_ªs_to_ns
(
ªs
), &
Ωc_li°
,

2169 
LDLM_WORK_CP_AST
);

2170 i‡(
rc
 =-
ERESTART
) {

2171 
	`LASSERT
(
	`li°_em±y
(&
Ωc_li°
));

2172 
ª°¨t
;

2175 
ENTRY
;

2177 
	`INIT_LIST_HEAD
(&
Ωc_li°
);

2178 i‡(!
	`ns_is_˛õ¡
(
	`ldlm_ªs_to_ns
(
ªs
))) {

2179 
	`CERROR
("This is client-side-only module, cannot handle "

2181 
	`LBUG
();

2184 
EXIT
;

2185 
	}
}

2186 
EXPORT_SYMBOL
(
ldlm_ª¥o˚ss_Æl
);

2188 
boﬁ
 
	$is_bl_d⁄e
(
ldlm_lock
 *
lock
)

2190 
boﬁ
 
bl_d⁄e
 = 
åue
;

2192 i‡(!
	`ldlm_is_bl_d⁄e
(
lock
)) {

2193 
	`lock_ªs_™d_lock
(
lock
);

2194 
bl_d⁄e
 = 
	`ldlm_is_bl_d⁄e
(
lock
);

2195 
	`u∆ock_ªs_™d_lock
(
lock
);

2198  
bl_d⁄e
;

2199 
	}
}

2205 
	$ldlm_ˇn˚l_ˇŒback
(
ldlm_lock
 *
lock
)

2207 
	`check_ªs_locked
(
lock
->
l_ªsour˚
);

2208 i‡(!
	`ldlm_is_ˇn˚l
(
lock
)) {

2209 
	`ldlm_£t_ˇn˚l
(
lock
);

2210 i‡(
lock
->
l_blockög_a°
) {

2211 
	`u∆ock_ªs_™d_lock
(
lock
);

2212 
lock
->
	`l_blockög_a°
÷ock, 
NULL
,Üock->
l_a°_d©a
,

2213 
LDLM_CB_CANCELING
);

2214 
	`lock_ªs_™d_lock
(
lock
);

2216 
	`LDLM_DEBUG
(
lock
, "no blockingást");

2220 
	`ldlm_£t_bl_d⁄e
(
lock
);

2221 
	`wake_up_Æl
(&
lock
->
l_waôq
);

2222 } i‡(!
	`ldlm_is_bl_d⁄e
(
lock
)) {

2223 
l_waô_öfo
 
lwi
 = { 0 };

2227 
	`u∆ock_ªs_™d_lock
(
lock
);

2228 
	`l_waô_evít
(
lock
->
l_waôq
, 
	`is_bl_d⁄e
÷ock), &
lwi
);

2229 
	`lock_ªs_™d_lock
(
lock
);

2231 
	}
}

2236 
	$ldlm_u∆ök_lock_skùli°
(
ldlm_lock
 *
ªq
)

2238 i‡(
ªq
->
l_ªsour˚
->
Ã_ty≥
 !
LDLM_PLAIN
 &&

2239 
ªq
->
l_ªsour˚
->
Ã_ty≥
 !
LDLM_IBITS
)

2242 
	`li°_dñ_öô
(&
ªq
->
l_¶_pﬁicy
);

2243 
	`li°_dñ_öô
(&
ªq
->
l_¶_mode
);

2244 
	}
}

2249 
	$ldlm_lock_ˇn˚l
(
ldlm_lock
 *
lock
)

2251 
ldlm_ªsour˚
 *
ªs
;

2252 
ldlm_«me•a˚
 *
ns
;

2253 
ENTRY
;

2255 
	`lock_ªs_™d_lock
(
lock
);

2257 
ªs
 = 
lock
->
l_ªsour˚
;

2258 
ns
 = 
	`ldlm_ªs_to_ns
(
ªs
);

2262 i‡(
lock
->
l_ªadîs
 ||Üock->
l_wrôîs
) {

2263 
	`LDLM_ERROR
(
lock
, "lock still hasÑeferences");

2264 
	`LBUG
();

2267 i‡(
	`ldlm_is_waôed
(
lock
))

2268 
	`ldlm_dñ_waôög_lock
(
lock
);

2271 
	`ldlm_ˇn˚l_ˇŒback
(
lock
);

2273 
	`LASSERT
(!
	`ldlm_is_waôed
(
lock
));

2275 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

2276 
	`ldlm_lock_de°roy_nﬁock
(
lock
);

2278 i‡(
lock
->
l_gø¡ed_mode
 =lock->
l_ªq_mode
)

2279 
	`ldlm_poﬁ_dñ
(&
ns
->
ns_poﬁ
, 
lock
);

2283 
lock
->
l_gø¡ed_mode
 = 
LCK_MINMODE
;

2284 
	`u∆ock_ªs_™d_lock
(
lock
);

2286 
EXIT
;

2287 
	}
}

2288 
EXPORT_SYMBOL
(
ldlm_lock_ˇn˚l
);

2293 
	$ldlm_lock_£t_d©a
(
lu°ª_h™dÀ
 *
lockh
, *
d©a
)

2295 
ldlm_lock
 *
lock
 = 
	`ldlm_h™dÀ2lock
(
lockh
);

2296 
rc
 = -
EINVAL
;

2297 
ENTRY
;

2299 i‡(
lock
) {

2300 i‡(
lock
->
l_a°_d©a
 =
NULL
)

2301 
lock
->
l_a°_d©a
 = 
d©a
;

2302 i‡(
lock
->
l_a°_d©a
 =
d©a
)

2303 
rc
 = 0;

2304 
	`LDLM_LOCK_PUT
(
lock
);

2306 
	`RETURN
(
rc
);

2307 
	}
}

2308 
EXPORT_SYMBOL
(
ldlm_lock_£t_d©a
);

2310 
	sexp‹t_˛_d©a
 {

2311 
obd_exp‹t
 *
	me˛_exp
;

2312 
	me˛_lo›
;

2315 
	$ldlm_ˇn˚l_lock_f‹_exp‹t
(
obd_exp‹t
 *
exp
,

2316 
ldlm_lock
 *
lock
,

2317 
exp‹t_˛_d©a
 *
e˛
)

2319 
ldlm_ªsour˚
 *
ªs
;

2321 
ªs
 = 
	`ldlm_ªsour˚_gëªf
(
lock
->
l_ªsour˚
);

2323 
	`ldlm_ªs_lvbo_upd©e
(
ªs
, 
NULL
, 1);

2324 
	`ldlm_lock_ˇn˚l
(
lock
);

2325 i‡(!
exp
->
exp_obd
->
obd_°›pög
)

2326 
	`ldlm_ª¥o˚ss_Æl
(
ªs
);

2327 
	`ldlm_ªsour˚_puåef
(
ªs
);

2329 
e˛
->
e˛_lo›
++;

2330 i‡((
e˛
->
e˛_lo›
 & -ecl->ecl_loop) ==Écl->ecl_loop) {

2331 
	`CDEBUG
(
D_INFO
, "Export %p, %dÜocks cancelled.\n",

2332 
exp
, 
e˛
->
e˛_lo›
);

2334 
	}
}

2341 
	$ldlm_ˇn˚l_locks_f‹_exp‹t_cb
(
cfs_hash
 *
hs
, 
cfs_hash_bd
 *
bd
,

2342 
hli°_node
 *
hnode
, *
d©a
)

2345 
exp‹t_˛_d©a
 *
e˛
 = (exp‹t_˛_d©®*)
d©a
;

2346 
obd_exp‹t
 *
exp
 = 
e˛
->
e˛_exp
;

2347 
ldlm_lock
 *
lock
 = 
	`cfs_hash_obje˘
(
hs
, 
hnode
);

2349 
	`LDLM_LOCK_GET
(
lock
);

2350 
	`ldlm_ˇn˚l_lock_f‹_exp‹t
(
exp
, 
lock
, 
e˛
);

2351 
	`LDLM_LOCK_RELEASE
(
lock
);

2354 
	}
}

2361 
	$ldlm_exp‹t_ˇn˚l_blocked_locks
(
obd_exp‹t
 *
exp
)

2363 
exp‹t_˛_d©a
 
e˛
 = {

2364 .
e˛_exp
 = 
exp
,

2365 .
e˛_lo›
 = 0,

2368 !
	`li°_em±y
(&
exp
->
exp_bl_li°
)) {

2369 
ldlm_lock
 *
lock
;

2371 
	`•ö_lock_bh
(&
exp
->
exp_bl_li°_lock
);

2372 i‡(!
	`li°_em±y
(&
exp
->
exp_bl_li°
)) {

2373 
lock
 = 
	`li°_íåy
(
exp
->
exp_bl_li°
.
√xt
,

2374 
ldlm_lock
, 
l_exp_li°
);

2375 
	`LDLM_LOCK_GET
(
lock
);

2376 
	`li°_dñ_öô
(&
lock
->
l_exp_li°
);

2378 
lock
 = 
NULL
;

2380 
	`•ö_u∆ock_bh
(&
exp
->
exp_bl_li°_lock
);

2382 i‡(
lock
 =
NULL
)

2385 
	`ldlm_ˇn˚l_lock_f‹_exp‹t
(
exp
, 
lock
, &
e˛
);

2386 
	`LDLM_LOCK_RELEASE
(
lock
);

2389 
	`CDEBUG
(
D_DLMTRACE
, "Export %p, canceled %dÜocks, "

2390 "À· o¿hashÅabÀ %d.\n", 
exp
, 
e˛
.
e˛_lo›
,

2391 
	`©omic_ªad
(&
exp
->
exp_lock_hash
->
hs_cou¡
));

2393  
e˛
.
e˛_lo›
;

2394 
	}
}

2401 
	$ldlm_exp‹t_ˇn˚l_locks
(
obd_exp‹t
 *
exp
)

2403 
exp‹t_˛_d©a
 
e˛
 = {

2404 .
e˛_exp
 = 
exp
,

2405 .
e˛_lo›
 = 0,

2408 
	`cfs_hash_f‹_óch_em±y
(
exp
->
exp_lock_hash
,

2409 
ldlm_ˇn˚l_locks_f‹_exp‹t_cb
, &
e˛
);

2411 
	`CDEBUG
(
D_DLMTRACE
, "Export %p, canceled %dÜocks, "

2412 "À· o¿hashÅabÀ %d.\n", 
exp
, 
e˛
.
e˛_lo›
,

2413 
	`©omic_ªad
(&
exp
->
exp_lock_hash
->
hs_cou¡
));

2415  
e˛
.
e˛_lo›
;

2416 
	}
}

2428 
	$ldlm_lock_downgøde
(
ldlm_lock
 *
lock
, 
ldlm_mode
 
√w_mode
)

2430 
ENTRY
;

2432 
	`LASSERT
(
lock
->
l_gø¡ed_mode
 & (
LCK_PW
 | 
LCK_EX
));

2433 
	`LASSERT
(
√w_mode
 =
LCK_COS
);

2435 
	`lock_ªs_™d_lock
(
lock
);

2436 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

2441 
	`ldlm_poﬁ_dñ
(&
	`ldlm_lock_to_ns
(
lock
)->
ns_poﬁ
,Üock);

2443 
lock
->
l_ªq_mode
 = 
√w_mode
;

2444 
	`ldlm_gø¡_lock
(
lock
, 
NULL
);

2445 
	`u∆ock_ªs_™d_lock
(
lock
);

2446 
	`ldlm_ª¥o˚ss_Æl
(
lock
->
l_ªsour˚
);

2448 
EXIT
;

2449 
	}
}

2450 
EXPORT_SYMBOL
(
ldlm_lock_downgøde
);

2459 
ldlm_ªsour˚
 *
	$ldlm_lock_c⁄vît
(
ldlm_lock
 *
lock
,

2460 
ldlm_mode
 
√w_mode
, 
__u32
 *
Êags
)

2462 
li°_hód
 
Ωc_li°
;

2463 
ldlm_ªsour˚
 *
ªs
;

2464 
ldlm_«me•a˚
 *
ns
;

2465 
gø¡ed
 = 0;

2466 #ifde‡
HAVE_SERVER_SUPPORT


2467 
ﬁd_mode
;

2468 
¶_ö£π_poöt
 
¥ev
;

2470 
ldlm_öãrvÆ
 *
node
;

2471 
ENTRY
;

2473 
	`INIT_LIST_HEAD
(&
Ωc_li°
);

2475 i‡(
√w_mode
 =
lock
->
l_gø¡ed_mode
) {

2476 *
Êags
 |
LDLM_FL_BLOCK_GRANTED
;

2477 
	`RETURN
(
lock
->
l_ªsour˚
);

2482 
	`OBD_SLAB_ALLOC_PTR_GFP
(
node
, 
ldlm_öãrvÆ_¶ab
, 
GFP_NOFS
);

2483 i‡(
node
 =
NULL
)

2484 
	`RETURN
(
NULL
);

2486 
	`LASSERTF
((
√w_mode
 =
LCK_PW
 && 
lock
->
l_gø¡ed_mode
 =
LCK_PR
),

2487 "√w_modê%u, gø¡ed %u\n", 
√w_mode
, 
lock
->
l_gø¡ed_mode
);

2489 
	`lock_ªs_™d_lock
(
lock
);

2491 
ªs
 = 
lock
->
l_ªsour˚
;

2492 
ns
 = 
	`ldlm_ªs_to_ns
(
ªs
);

2494 #ifde‡
HAVE_SERVER_SUPPORT


2495 
ﬁd_mode
 = 
lock
->
l_ªq_mode
;

2497 
lock
->
l_ªq_mode
 = 
√w_mode
;

2498 i‡(
ªs
->
Ã_ty≥
 =
LDLM_PLAIN
 ||Ñes->Ã_ty≥ =
LDLM_IBITS
) {

2499 #ifde‡
HAVE_SERVER_SUPPORT


2503 
¥ev
.
ªs_lök
 = 
lock
->
l_ªs_lök
.prev;

2504 
¥ev
.
mode_lök
 = 
lock
->
l_¶_mode
.prev;

2505 
¥ev
.
pﬁicy_lök
 = 
lock
->
l_¶_pﬁicy
.prev;

2507 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

2509 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

2510 i‡(
ªs
->
Ã_ty≥
 =
LDLM_EXTENT
) {

2514 
	`INIT_LIST_HEAD
(&
node
->
li_group
);

2515 
	`ldlm_öãrvÆ_©èch
(
node
, 
lock
);

2516 
node
 = 
NULL
;

2524 
	`ldlm_poﬁ_dñ
(&
ns
->
ns_poﬁ
, 
lock
);

2527 i‡(
	`ns_is_˛õ¡
(
	`ldlm_ªs_to_ns
(
ªs
))) {

2528 i‡(*
Êags
 & (
LDLM_FL_BLOCK_CONV
 | 
LDLM_FL_BLOCK_GRANTED
)) {

2529 
	`ldlm_ªsour˚_add_lock
(
ªs
, &ªs->
Ã_c⁄vîtög
, 
lock
);

2533 
	`LDLM_ERROR
(
lock
, "Erroneous flags %x onÜocalÜock\n",

2534 *
Êags
);

2535 
	`LBUG
();

2537 
	`ldlm_gø¡_lock
(
lock
, &
Ωc_li°
);

2538 
gø¡ed
 = 1;

2540 i‡(
lock
->
l_com∂ëi⁄_a°
)

2541 
lock
->
	`l_com∂ëi⁄_a°
÷ock, 0, 
NULL
);

2543 #ifde‡
HAVE_SERVER_SUPPORT


2545 
rc
;

2546 
ldlm_îr‹
 
îr
;

2547 
__u64
 
pÊags
 = 0;

2548 
ldlm_¥o˚ssög_pﬁicy
 
pﬁicy
;

2550 
pﬁicy
 = 
ldlm_¥o˚ssög_pﬁicy_èbÀ
[
ªs
->
Ã_ty≥
];

2551 
rc
 = 
	`pﬁicy
(
lock
, &
pÊags
, 0, &
îr
, &
Ωc_li°
);

2552 i‡(
rc
 =
LDLM_ITER_STOP
) {

2553 
lock
->
l_ªq_mode
 = 
ﬁd_mode
;

2554 i‡(
ªs
->
Ã_ty≥
 =
LDLM_EXTENT
)

2555 
	`ldlm_exã¡_add_lock
(
ªs
, 
lock
);

2557 
	`ldlm_gø¡ed_li°_add_lock
(
lock
, &
¥ev
);

2559 
ªs
 = 
NULL
;

2561 *
Êags
 |
LDLM_FL_BLOCK_GRANTED
;

2562 
gø¡ed
 = 1;

2567 
	`CERROR
("This is client-side-only module, cannot handle "

2569 
	`LBUG
();

2572 
	`u∆ock_ªs_™d_lock
(
lock
);

2574 i‡(
gø¡ed
)

2575 
	`ldlm_run_a°_w‹k
(
ns
, &
Ωc_li°
, 
LDLM_WORK_CP_AST
);

2576 i‡(
node
)

2577 
	`OBD_SLAB_FREE
(
node
, 
ldlm_öãrvÆ_¶ab
, (*node));

2578 
	`RETURN
(
ªs
);

2579 
	}
}

2586 
	$ldlm_lock_dump_h™dÀ
(
Àvñ
, 
lu°ª_h™dÀ
 *
lockh
)

2588 
ldlm_lock
 *
lock
;

2590 i‡(!((
libcfs_debug
 | 
D_ERROR
Ë& 
Àvñ
))

2593 
lock
 = 
	`ldlm_h™dÀ2lock
(
lockh
);

2594 i‡(
lock
 =
NULL
)

2597 
	`LDLM_DEBUG_LIMIT
(
Àvñ
, 
lock
, "###");

2599 
	`LDLM_LOCK_PUT
(
lock
);

2600 
	}
}

2601 
EXPORT_SYMBOL
(
ldlm_lock_dump_h™dÀ
);

2607 
	$_ldlm_lock_debug
(
ldlm_lock
 *
lock
,

2608 
libcfs_debug_msg_d©a
 *
msgd©a
,

2609 c⁄° *
fmt
, ...)

2611 
va_li°
 
¨gs
;

2612 
obd_exp‹t
 *
exp
 = 
lock
->
l_exp‹t
;

2613 
ldlm_ªsour˚
 *
ªsour˚
 = 
lock
->
l_ªsour˚
;

2614 *
nid
 = "local";

2616 
	`va_°¨t
(
¨gs
, 
fmt
);

2618 i‡(
exp
 &&Éxp->
exp_c⁄√˘i⁄
) {

2619 
nid
 = 
	`libcfs_nid2°r
(
exp
->
exp_c⁄√˘i⁄
->
c_≥î
.nid);

2620 } i‡(
exp
 &&Éxp->
exp_obd
 !
NULL
) {

2621 
obd_imp‹t
 *
imp
 = 
exp
->
exp_obd
->
u
.
˛i
.
˛_imp‹t
;

2622 
nid
 = 
	`libcfs_nid2°r
(
imp
->
imp_c⁄√˘i⁄
->
c_≥î
.nid);

2625 i‡(
ªsour˚
 =
NULL
) {

2626 
	`libcfs_debug_vmsg2
(
msgd©a
, 
fmt
, 
¨gs
,

2627 "Çs: \?\?Üock: %p/"
LPX64
"Ürc: %d/%d,%d mode: %s/%s "

2628 "ªs: \?\?Ñrc=\?\?Åy≥: \?\?\? fœgs: "
LPX64
"Çid: %s "

2629 "ªmŸe: "
LPX64
"Éxpref: %dÖid: %uÅimeout: %lu "

2631 
lock
,

2632 
lock
->
l_h™dÀ
.
h_cookõ
, 
	`©omic_ªad
(&lock->
l_ªfc
),

2633 
lock
->
l_ªadîs
,Üock->
l_wrôîs
,

2634 
ldlm_lock«me
[
lock
->
l_gø¡ed_mode
],

2635 
ldlm_lock«me
[
lock
->
l_ªq_mode
],

2636 
lock
->
l_Êags
, 
nid
,Üock->
l_ªmŸe_h™dÀ
.
cookõ
,

2637 
exp
 ? 
	`©omic_ªad
(&exp->
exp_ªfcou¡
) : -99,

2638 
lock
->
l_pid
,Üock->
l_ˇŒback_timeout
,Üock->
l_lvb_ty≥
);

2639 
	`va_íd
(
¨gs
);

2643 
ªsour˚
->
Ã_ty≥
) {

2644 
LDLM_EXTENT
:

2645 
	`libcfs_debug_vmsg2
(
msgd©a
, 
fmt
, 
¨gs
,

2646 "Çs: %†lock: %p/"
LPX64
"Ürc: %d/%d,%d mode: %s/%s "

2647 "ªs: "
DLDLMRES
"Ñrc: %dÅy≥: %†["
LPU64
"->"LPU64"] "

2648 "‘eq "
LPU64
"->"LPU64"ËÊags: "
LPX64
"Çid: %sÑemote: "

2649 
LPX64
"Éxpref: %dÖid: %uÅimeout: %luÜvb_type: %d\n",

2650 
	`ldlm_lock_to_ns_«me
(
lock
),Üock,

2651 
lock
->
l_h™dÀ
.
h_cookõ
, 
	`©omic_ªad
(&lock->
l_ªfc
),

2652 
lock
->
l_ªadîs
,Üock->
l_wrôîs
,

2653 
ldlm_lock«me
[
lock
->
l_gø¡ed_mode
],

2654 
ldlm_lock«me
[
lock
->
l_ªq_mode
],

2655 
	`PLDLMRES
(
ªsour˚
),

2656 
	`©omic_ªad
(&
ªsour˚
->
Ã_ªfcou¡
),

2657 
ldlm_ty≥«me
[
ªsour˚
->
Ã_ty≥
],

2658 
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
°¨t
,

2659 
lock
->
l_pﬁicy_d©a
.
l_exã¡
.
íd
,

2660 
lock
->
l_ªq_exã¡
.
°¨t
,Üock->l_ªq_exã¡.
íd
,

2661 
lock
->
l_Êags
, 
nid
,Üock->
l_ªmŸe_h™dÀ
.
cookõ
,

2662 
exp
 ? 
	`©omic_ªad
(&exp->
exp_ªfcou¡
) : -99,

2663 
lock
->
l_pid
,Üock->
l_ˇŒback_timeout
,

2664 
lock
->
l_lvb_ty≥
);

2667 
LDLM_FLOCK
:

2668 
	`libcfs_debug_vmsg2
(
msgd©a
, 
fmt
, 
¨gs
,

2669 "Çs: %†lock: %p/"
LPX64
"Ürc: %d/%d,%d mode: %s/%s "

2670 "ªs: "
DLDLMRES
"Ñrc: %dÅype: %sÖid: %d "

2671 "["
LPU64
"->"LPU64"] fœgs: "
LPX64
"Çid: %s "

2672 "ªmŸe: "
LPX64
"Éxpref: %dÖid: %uÅimeout: %lu\n",

2673 
	`ldlm_lock_to_ns_«me
(
lock
),Üock,

2674 
lock
->
l_h™dÀ
.
h_cookõ
, 
	`©omic_ªad
(&lock->
l_ªfc
),

2675 
lock
->
l_ªadîs
,Üock->
l_wrôîs
,

2676 
ldlm_lock«me
[
lock
->
l_gø¡ed_mode
],

2677 
ldlm_lock«me
[
lock
->
l_ªq_mode
],

2678 
	`PLDLMRES
(
ªsour˚
),

2679 
	`©omic_ªad
(&
ªsour˚
->
Ã_ªfcou¡
),

2680 
ldlm_ty≥«me
[
ªsour˚
->
Ã_ty≥
],

2681 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
pid
,

2682 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
°¨t
,

2683 
lock
->
l_pﬁicy_d©a
.
l_Êock
.
íd
,

2684 
lock
->
l_Êags
, 
nid
,Üock->
l_ªmŸe_h™dÀ
.
cookõ
,

2685 
exp
 ? 
	`©omic_ªad
(&exp->
exp_ªfcou¡
) : -99,

2686 
lock
->
l_pid
,Üock->
l_ˇŒback_timeout
);

2689 
LDLM_IBITS
:

2690 
	`libcfs_debug_vmsg2
(
msgd©a
, 
fmt
, 
¨gs
,

2691 "Çs: %†lock: %p/"
LPX64
"Ürc: %d/%d,%d mode: %s/%s "

2692 "ªs: "
DLDLMRES
" bô†"
LPX64
"Ñrc: %dÅype: %s "

2693 "Êags: "
LPX64
"Çid: %sÑemote: "LPX64"Éxpref: %d "

2695 
	`ldlm_lock_to_ns_«me
(
lock
),

2696 
lock
,Üock->
l_h™dÀ
.
h_cookõ
,

2697 
	`©omic_ªad
(&
lock
->
l_ªfc
),

2698 
lock
->
l_ªadîs
,Üock->
l_wrôîs
,

2699 
ldlm_lock«me
[
lock
->
l_gø¡ed_mode
],

2700 
ldlm_lock«me
[
lock
->
l_ªq_mode
],

2701 
	`PLDLMRES
(
ªsour˚
),

2702 
lock
->
l_pﬁicy_d©a
.
l_öodebôs
.
bôs
,

2703 
	`©omic_ªad
(&
ªsour˚
->
Ã_ªfcou¡
),

2704 
ldlm_ty≥«me
[
ªsour˚
->
Ã_ty≥
],

2705 
lock
->
l_Êags
, 
nid
,Üock->
l_ªmŸe_h™dÀ
.
cookõ
,

2706 
exp
 ? 
	`©omic_ªad
(&exp->
exp_ªfcou¡
) : -99,

2707 
lock
->
l_pid
,Üock->
l_ˇŒback_timeout
,

2708 
lock
->
l_lvb_ty≥
);

2712 
	`libcfs_debug_vmsg2
(
msgd©a
, 
fmt
, 
¨gs
,

2713 "Çs: %†lock: %p/"
LPX64
"Ürc: %d/%d,%d mode: %s/%s "

2714 "ªs: "
DLDLMRES
"Ñrc: %dÅy≥: %†Êags: "
LPX64
" "

2715 "nid: %†ªmŸe: "
LPX64
"Éxpref: %dÖid: %u "

2717 
	`ldlm_lock_to_ns_«me
(
lock
),

2718 
lock
,Üock->
l_h™dÀ
.
h_cookõ
,

2719 
	`©omic_ªad
(&
lock
->
l_ªfc
),

2720 
lock
->
l_ªadîs
,Üock->
l_wrôîs
,

2721 
ldlm_lock«me
[
lock
->
l_gø¡ed_mode
],

2722 
ldlm_lock«me
[
lock
->
l_ªq_mode
],

2723 
	`PLDLMRES
(
ªsour˚
),

2724 
	`©omic_ªad
(&
ªsour˚
->
Ã_ªfcou¡
),

2725 
ldlm_ty≥«me
[
ªsour˚
->
Ã_ty≥
],

2726 
lock
->
l_Êags
, 
nid
,Üock->
l_ªmŸe_h™dÀ
.
cookõ
,

2727 
exp
 ? 
	`©omic_ªad
(&exp->
exp_ªfcou¡
) : -99,

2728 
lock
->
l_pid
,Üock->
l_ˇŒback_timeout
,

2729 
lock
->
l_lvb_ty≥
);

2732 
	`va_íd
(
¨gs
);

2733 
	}
}

2734 
EXPORT_SYMBOL
(
_ldlm_lock_debug
);

	@ldlm_lockd.c

42 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

44 
	~<löux/kthªad.h
>

45 
	~<libcfs/libcfs.h
>

46 
	~<lu°ª_dlm.h
>

47 
	~<obd_˛ass.h
>

48 
	~<libcfs/li°.h
>

49 
	~"ldlm_öã∫Æ.h
"

51 
	gldlm_num_thªads
;

52 
CFS_MODULE_PARM
(
ldlm_num_thªads
, "i", , 0444,

55 *
	gldlm_˝ts
;

56 
CFS_MODULE_PARM
(
ldlm_˝ts
, "s", 
ch¨p
, 0444,

59 
muãx
 
	gldlm_ªf_muãx
;

60 
	gldlm_ªfcou¡
;

62 
	sldlm_cb_async_¨gs
 {

63 
ldlm_cb_£t_¨g
 *
	mˇ_£t_¨g
;

64 
ldlm_lock
 *
	mˇ_lock
;

69 
ldlm_°©e
 *
	gldlm_°©e
;

71 
ölöe
 
cfs_time_t
 
	$round_timeout
(
cfs_time_t
 
timeout
)

73  
	`cfs_time_£c⁄ds
(()
	`cfs_duøti⁄_£c
(
	`cfs_time_sub
(
timeout
, 0)) + 1);

74 
	}
}

77 
ölöe
 
	$ldlm_gë_rq_timeout
()

80 
timeout
 = 
	`mö
(
ldlm_timeout
, 
obd_timeout
 / 3);

82  
timeout
 < 1 ? 1 :Åimeout;

83 
	}
}

85 
	#ELT_STOPPED
 0

	)

86 
	#ELT_READY
 1

	)

87 
	#ELT_TERMINATE
 2

	)

89 
	sldlm_bl_poﬁ
 {

90 
•ölock_t
 
	mbÕ_lock
;

97 
li°_hód
 
	mbÕ_¥io_li°
;

103 
li°_hód
 
	mbÕ_li°
;

105 
waô_queue_hód_t
 
	mbÕ_waôq
;

106 
com∂ëi⁄
 
	mbÕ_comp
;

107 
©omic_t
 
	mbÕ_num_thªads
;

108 
©omic_t
 
	mbÕ_busy_thªads
;

109 
	mbÕ_mö_thªads
;

110 
	mbÕ_max_thªads
;

113 
	sldlm_bl_w‹k_ôem
 {

114 
li°_hód
 
	mblwi_íåy
;

115 
ldlm_«me•a˚
 *
	mblwi_ns
;

116 
ldlm_lock_desc
 
	mblwi_ld
;

117 
ldlm_lock
 *
	mblwi_lock
;

118 
li°_hód
 
	mblwi_hód
;

119 
	mblwi_cou¡
;

120 
com∂ëi⁄
 
	mblwi_comp
;

121 
ldlm_ˇn˚l_Êags
 
	mblwi_Êags
;

122 
	mblwi_mem_¥essuª
;

125 #ifde‡
HAVE_SERVER_SUPPORT


130 
•ölock_t
 
	gwaôög_locks_•ölock
;

143 
li°_hód
 
	gwaôög_locks_li°
;

144 
timî_li°
 
	gwaôög_locks_timî
;

146 
	sexpúed_lock_thªad
 {

147 
waô_queue_hód_t
 
	mñt_waôq
;

148 
	mñt_°©e
;

149 
	mñt_dump
;

150 
li°_hód
 
	mñt_expúed_locks
;

151 } 
	gexpúed_lock_thªad
;

153 
ölöe
 
	$have_expúed_locks
()

155 
√ed_to_run
;

157 
ENTRY
;

158 
	`•ö_lock_bh
(&
waôög_locks_•ölock
);

159 
√ed_to_run
 = !
	`li°_em±y
(&
expúed_lock_thªad
.
ñt_expúed_locks
);

160 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

162 
	`RETURN
(
√ed_to_run
);

163 
	}
}

168 
	$expúed_lock_maö
(*
¨g
)

170 
li°_hód
 *
expúed
 = &
expúed_lock_thªad
.
ñt_expúed_locks
;

171 
l_waô_öfo
 
lwi
 = { 0 };

172 
do_dump
;

174 
ENTRY
;

176 
expúed_lock_thªad
.
ñt_°©e
 = 
ELT_READY
;

177 
	`wake_up
(&
expúed_lock_thªad
.
ñt_waôq
);

180 
	`l_waô_evít
(
expúed_lock_thªad
.
ñt_waôq
,

181 
	`have_expúed_locks
() ||

182 
expúed_lock_thªad
.
ñt_°©e
 =
ELT_TERMINATE
,

183 &
lwi
);

185 
	`•ö_lock_bh
(&
waôög_locks_•ölock
);

186 i‡(
expúed_lock_thªad
.
ñt_dump
) {

187 
libcfs_debug_msg_d©a
 
msgd©a
 = {

188 .
msg_fûe
 = 
__FILE__
,

189 .
msg_‚
 = "waiting_locks_callback",

190 .
msg_löe
 = 
expúed_lock_thªad
.
ñt_dump
 };

191 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

194 
	`libcfs_debug_dum∂og
();

195 
	`libcfs_run_lbug_upˇŒ
(&
msgd©a
);

197 
	`•ö_lock_bh
(&
waôög_locks_•ölock
);

198 
expúed_lock_thªad
.
ñt_dump
 = 0;

201 
do_dump
 = 0;

203 !
	`li°_em±y
(
expúed
)) {

204 
obd_exp‹t
 *
exp‹t
;

205 
ldlm_lock
 *
lock
;

207 
lock
 = 
	`li°_íåy
(
expúed
->
√xt
, 
ldlm_lock
,

208 
l_≥ndög_chaö
);

209 i‡((*)
lock
 < 
LP_POISON
 + 
PAGE_CACHE_SIZE
 &&

210 (*)
lock
 >
LP_POISON
) {

211 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

212 
	`CERROR
("‰ìÜock o¿ñàli° %p\n", 
lock
);

213 
	`LBUG
();

215 
	`li°_dñ_öô
(&
lock
->
l_≥ndög_chaö
);

216 i‡((*)
lock
->
l_exp‹t
 <

217 
LP_POISON
 + 
PAGE_CACHE_SIZE
 &&

218 (*)
lock
->
l_exp‹t
 >
LP_POISON
) {

219 
	`CERROR
("lock with freeÉxport onÉltÜist %p\n",

220 
lock
->
l_exp‹t
);

221 
lock
->
l_exp‹t
 = 
NULL
;

222 
	`LDLM_ERROR
(
lock
, "freeÉxport");

226 
	`LDLM_LOCK_RELEASE
(
lock
);

230 i‡(
	`ldlm_is_de°royed
(
lock
)) {

233 
	`LDLM_LOCK_RELEASE
(
lock
);

236 
exp‹t
 = 
	`˛ass_exp‹t_lock_gë
(
lock
->
l_exp‹t
,Üock);

237 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

239 
	`•ö_lock_bh
(&
exp‹t
->
exp_bl_li°_lock
);

240 
	`li°_dñ_öô
(&
lock
->
l_exp_li°
);

241 
	`•ö_u∆ock_bh
(&
exp‹t
->
exp_bl_li°_lock
);

243 
do_dump
++;

244 
	`˛ass_Áû_exp‹t
(
exp‹t
);

245 
	`˛ass_exp‹t_lock_put
(
exp‹t
, 
lock
);

249 
	`LDLM_LOCK_RELEASE
(
lock
);

251 
	`•ö_lock_bh
(&
waôög_locks_•ölock
);

253 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

255 i‡(
do_dump
 && 
obd_dump_⁄_evi˘i⁄
) {

256 
	`CERROR
("dumpÅheÜog uponÉviction\n");

257 
	`libcfs_debug_dum∂og
();

260 i‡(
expúed_lock_thªad
.
ñt_°©e
 =
ELT_TERMINATE
)

264 
expúed_lock_thªad
.
ñt_°©e
 = 
ELT_STOPPED
;

265 
	`wake_up
(&
expúed_lock_thªad
.
ñt_waôq
);

266 
	`RETURN
(0);

267 
	}
}

269 
ldlm_add_waôög_lock
(
ldlm_lock
 *
lock
);

270 
__ldlm_add_waôög_lock
(
ldlm_lock
 *
lock
, 
£c⁄ds
);

276 
	$ldlm_lock_busy
(
ldlm_lock
 *
lock
)

278 
±Ãpc_ªque°
 *
ªq
;

279 
m©ch
 = 0;

280 
ENTRY
;

282 i‡(
lock
->
l_exp‹t
 =
NULL
)

285 
	`•ö_lock_bh
(&
lock
->
l_exp‹t
->
exp_Ωc_lock
);

286 
	`li°_f‹_óch_íåy
(
ªq
, &
lock
->
l_exp‹t
->
exp_hp_Ωcs
,

287 
rq_exp_li°
) {

288 i‡(
ªq
->
rq_›s
->
h¥eq_lock_m©ch
) {

289 
m©ch
 = 
ªq
->
rq_›s
->
	`h¥eq_lock_m©ch
‘eq, 
lock
);

290 i‡(
m©ch
)

294 
	`•ö_u∆ock_bh
(&
lock
->
l_exp‹t
->
exp_Ωc_lock
);

295 
	`RETURN
(
m©ch
);

296 
	}
}

299 
	$waôög_locks_ˇŒback
(
unu£d
)

301 
ldlm_lock
 *
lock
;

302 
√ed_dump
 = 0;

304 
	`•ö_lock_bh
(&
waôög_locks_•ölock
);

305 !
	`li°_em±y
(&
waôög_locks_li°
)) {

306 
lock
 = 
	`li°_íåy
(
waôög_locks_li°
.
√xt
, 
ldlm_lock
,

307 
l_≥ndög_chaö
);

308 i‡(
	`cfs_time_a·î
(
lock
->
l_ˇŒback_timeout
,

309 
	`cfs_time_cuºít
()) ||

310 (
lock
->
l_ªq_mode
 =
LCK_GROUP
))

314 i‡(!
	`OBD_FAIL_CHECK
(
OBD_FAIL_PTLRPC_HPREQ_TIMEOUT
) &&

315 
	`ldlm_lock_busy
(
lock
)) {

316 
c⁄t
 = 1;

318 i‡(
lock
->
l_≥ndög_chaö
.
√xt
 =&
waôög_locks_li°
)

319 
c⁄t
 = 0;

321 
	`LDLM_LOCK_GET
(
lock
);

323 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

324 
	`LDLM_DEBUG
(
lock
, "prolongÅhe busyÜock");

325 
	`ldlm_ª‰esh_waôög_lock
(
lock
,

326 
	`ldlm_bl_timeout
(
lock
) >> 1);

327 
	`•ö_lock_bh
(&
waôög_locks_•ölock
);

329 i‡(!
c⁄t
) {

330 
	`LDLM_LOCK_RELEASE
(
lock
);

334 
	`LDLM_LOCK_RELEASE
(
lock
);

337 
	`ldlm_lock_to_ns
(
lock
)->
ns_timeouts
++;

338 
	`LDLM_ERROR
(
lock
, "lock callbackÅimerÉxpiredáfter %lds: "

340 
	`cfs_time_cuºít_£c
(Ë- 
lock
->
l_œ°_a˘ivôy
,

341 
	`libcfs_nid2°r
(

342 
lock
->
l_exp‹t
->
exp_c⁄√˘i⁄
->
c_≥î
.
nid
));

347 
	`li°_dñ
(&
lock
->
l_≥ndög_chaö
);

348 
	`li°_add
(&
lock
->
l_≥ndög_chaö
,

349 &
expúed_lock_thªad
.
ñt_expúed_locks
);

350 
√ed_dump
 = 1;

353 i‡(!
	`li°_em±y
(&
expúed_lock_thªad
.
ñt_expúed_locks
)) {

354 i‡(
obd_dump_⁄_timeout
 && 
√ed_dump
)

355 
expúed_lock_thªad
.
ñt_dump
 = 
__LINE__
;

357 
	`wake_up
(&
expúed_lock_thªad
.
ñt_waôq
);

364 i‡(!
	`li°_em±y
(&
waôög_locks_li°
)) {

365 
cfs_time_t
 
timeout_rounded
;

366 
lock
 = 
	`li°_íåy
(
waôög_locks_li°
.
√xt
, 
ldlm_lock
,

367 
l_≥ndög_chaö
);

368 
timeout_rounded
 = (
cfs_time_t
)
	`round_timeout
(
lock
->
l_ˇŒback_timeout
);

369 
	`cfs_timî_¨m
(&
waôög_locks_timî
, 
timeout_rounded
);

371 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

372 
	}
}

386 
	$__ldlm_add_waôög_lock
(
ldlm_lock
 *
lock
, 
£c⁄ds
)

388 
cfs_time_t
 
timeout
;

389 
cfs_time_t
 
timeout_rounded
;

391 i‡(!
	`li°_em±y
(&
lock
->
l_≥ndög_chaö
))

394 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_PTLRPC_HPREQ_NOTIMEOUT
) ||

395 
	`OBD_FAIL_CHECK
(
OBD_FAIL_PTLRPC_HPREQ_TIMEOUT
))

396 
£c⁄ds
 = 1;

398 
timeout
 = 
	`cfs_time_shi·
(
£c⁄ds
);

399 i‡(
	`likñy
(
	`cfs_time_a·î
(
timeout
, 
lock
->
l_ˇŒback_timeout
)))

400 
lock
->
l_ˇŒback_timeout
 = 
timeout
;

402 
timeout_rounded
 = 
	`round_timeout
(
lock
->
l_ˇŒback_timeout
);

404 i‡(
	`cfs_time_bef‹e
(
timeout_rounded
,

405 
	`cfs_timî_dódlöe
(&
waôög_locks_timî
)) ||

406 !
	`cfs_timî_is_¨med
(&
waôög_locks_timî
)) {

407 
	`cfs_timî_¨m
(&
waôög_locks_timî
, 
timeout_rounded
);

412 
	`li°_add_èû
(&
lock
->
l_≥ndög_chaö
, &
waôög_locks_li°
);

414 
	}
}

416 
	$ldlm_add_blocked_lock
(
ldlm_lock
 *
lock
)

418 
	`•ö_lock_bh
(&
lock
->
l_exp‹t
->
exp_bl_li°_lock
);

419 i‡(
	`li°_em±y
(&
lock
->
l_exp_li°
)) {

420 i‡(
lock
->
l_gø¡ed_mode
 !lock->
l_ªq_mode
)

421 
	`li°_add_èû
(&
lock
->
l_exp_li°
,

422 &
lock
->
l_exp‹t
->
exp_bl_li°
);

424 
	`li°_add
(&
lock
->
l_exp_li°
,

425 &
lock
->
l_exp‹t
->
exp_bl_li°
);

427 
	`•ö_u∆ock_bh
(&
lock
->
l_exp‹t
->
exp_bl_li°_lock
);

434 i‡(!
	`li°_em±y
(&
lock
->
l_exp‹t
->
exp_°Æe_li°
))

435 
	`obd_°Æe_exp‹t_adju°
(
lock
->
l_exp‹t
);

436 
	}
}

438 
	$ldlm_add_waôög_lock
(
ldlm_lock
 *
lock
)

440 
ªt
;

441 
timeout
 = 
	`ldlm_bl_timeout
(
lock
);

444 
	`LASSERT
(
	`ldlm_is_ªs_locked
(
lock
));

445 
	`LASSERT
(!
	`ldlm_is_ˇn˚l_⁄_block
(
lock
));

449 i‡(
lock
->
l_exp‹t
 !
NULL
 &&

450 (
	`exp_c⁄√˘_Êags
(
lock
->
l_exp‹t
Ë& 
OBD_CONNECT_MDS_MDS
))

453 
	`•ö_lock_bh
(&
waôög_locks_•ölock
);

454 i‡(
	`ldlm_is_ˇn˚l
(
lock
)) {

455 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

459 i‡(
	`ldlm_is_de°royed
(
lock
)) {

460 
cfs_time_t
 
√xt
;

462 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

463 
	`LDLM_ERROR
(
lock
, "not waiting on destroyedÜock (bug 5653)");

464 i‡(
	`cfs_time_a·î
(
	`cfs_time_cuºít
(), 
√xt
)) {

465 
√xt
 = 
	`cfs_time_shi·
(14400);

466 
	`libcfs_debug_dump°ack
(
NULL
);

471 
	`ldlm_£t_waôed
(
lock
);

472 
lock
->
l_œ°_a˘ivôy
 = 
	`cfs_time_cuºít_£c
();

473 
ªt
 = 
	`__ldlm_add_waôög_lock
(
lock
, 
timeout
);

474 i‡(
ªt
) {

477 
	`LDLM_LOCK_GET
(
lock
);

479 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

481 i‡(
ªt
)

482 
	`ldlm_add_blocked_lock
(
lock
);

484 
	`LDLM_DEBUG
(
lock
, "%saddingÅo waitÜist(timeout: %d, AT: %s)",

485 
ªt
 =0 ? "nŸÑe-" : "", 
timeout
,

486 
AT_OFF
 ? "off" : "on");

487  
ªt
;

488 
	}
}

499 
	$__ldlm_dñ_waôög_lock
(
ldlm_lock
 *
lock
)

501 
li°_hód
 *
li°_√xt
;

503 i‡(
	`li°_em±y
(&
lock
->
l_≥ndög_chaö
))

506 
li°_√xt
 = 
lock
->
l_≥ndög_chaö
.
√xt
;

507 i‡(
lock
->
l_≥ndög_chaö
.
¥ev
 =&
waôög_locks_li°
) {

509 i‡(
li°_√xt
 =&
waôög_locks_li°
) {

511 
	`cfs_timî_dißrm
(&
waôög_locks_timî
);

513 
ldlm_lock
 *
√xt
;

514 
√xt
 = 
	`li°_íåy
(
li°_√xt
, 
ldlm_lock
,

515 
l_≥ndög_chaö
);

516 
	`cfs_timî_¨m
(&
waôög_locks_timî
,

517 
	`round_timeout
(
√xt
->
l_ˇŒback_timeout
));

520 
	`li°_dñ_öô
(&
lock
->
l_≥ndög_chaö
);

523 
	}
}

525 
	$ldlm_dñ_waôög_lock
(
ldlm_lock
 *
lock
)

527 
ªt
;

529 i‡(
lock
->
l_exp‹t
 =
NULL
) {

531 
	`CDEBUG
(
D_DLMTRACE
, "Clõ¡Üock %∞:Ço-›\n", 
lock
);

535 
	`•ö_lock_bh
(&
waôög_locks_•ölock
);

536 
ªt
 = 
	`__ldlm_dñ_waôög_lock
(
lock
);

537 
	`ldlm_˛ór_waôed
(
lock
);

538 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

541 
	`•ö_lock_bh
(&
lock
->
l_exp‹t
->
exp_bl_li°_lock
);

542 
	`li°_dñ_öô
(&
lock
->
l_exp_li°
);

543 
	`•ö_u∆ock_bh
(&
lock
->
l_exp‹t
->
exp_bl_li°_lock
);

545 i‡(
ªt
) {

548 
	`LDLM_LOCK_RELEASE
(
lock
);

551 
	`LDLM_DEBUG
(
lock
, "%s", 
ªt
 == 0 ? "wasn't waiting" : "removed");

552  
ªt
;

553 
	}
}

560 
	$ldlm_ª‰esh_waôög_lock
(
ldlm_lock
 *
lock
, 
timeout
)

562 i‡(
lock
->
l_exp‹t
 =
NULL
) {

564 
	`LDLM_DEBUG
(
lock
, "clientÜock:Ço-op");

568 i‡(
	`exp_c⁄√˘_Êags
(
lock
->
l_exp‹t
Ë& 
OBD_CONNECT_MDS_MDS
) {

570 
	`LDLM_DEBUG
(
lock
, "MDS-MDSÜock:Ço-op");

574 
	`•ö_lock_bh
(&
waôög_locks_•ölock
);

576 i‡(
	`li°_em±y
(&
lock
->
l_≥ndög_chaö
)) {

577 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

578 
	`LDLM_DEBUG
(
lock
, "wasn't waiting");

584 
	`__ldlm_dñ_waôög_lock
(
lock
);

585 
	`__ldlm_add_waôög_lock
(
lock
, 
timeout
);

586 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

588 
	`LDLM_DEBUG
(
lock
, "refreshed");

590 
	}
}

591 
EXPORT_SYMBOL
(
ldlm_ª‰esh_waôög_lock
);

595 
	$ldlm_dñ_waôög_lock
(
ldlm_lock
 *
lock
)

597 
	`RETURN
(0);

598 
	}
}

600 
	$ldlm_ª‰esh_waôög_lock
(
ldlm_lock
 *
lock
, 
timeout
)

602 
	`RETURN
(0);

603 
	}
}

607 #ifde‡
HAVE_SERVER_SUPPORT


618 
	$ldlm_bl_timeout
(
ldlm_lock
 *
lock
)

620 
timeout
;

622 i‡(
AT_OFF
)

623  
obd_timeout
 / 2;

629 
timeout
 = 
	`©_gë
(&
lock
->
l_exp‹t
->
exp_bl_lock_©
);

630  
	`max
(
timeout
 + (timeouà>> 1), 
ldlm_íqueue_mö
);

631 
	}
}

632 
EXPORT_SYMBOL
(
ldlm_bl_timeout
);

637 
	$ldlm_Áûed_a°
(
ldlm_lock
 *
lock
, 
rc
,

638 c⁄° *
a°_ty≥
)

640 
	`LCONSOLE_ERROR_MSG
(0x138, "%s: A client onÇid %s wasÉvicted due "

642 
lock
->
l_exp‹t
->
exp_obd
->
obd_«me
,

643 
	`obd_exp‹t_nid2°r
(
lock
->
l_exp‹t
), 
a°_ty≥
, 
rc
);

645 i‡(
obd_dump_⁄_timeout
)

646 
	`libcfs_debug_dum∂og
();

647 
	`•ö_lock_bh
(&
waôög_locks_•ölock
);

648 i‡(
	`__ldlm_dñ_waôög_lock
(
lock
) == 0)

651 
	`LDLM_LOCK_GET
(
lock
);

652 
	`li°_add
(&
lock
->
l_≥ndög_chaö
,

653 &
expúed_lock_thªad
.
ñt_expúed_locks
);

654 
	`wake_up
(&
expúed_lock_thªad
.
ñt_waôq
);

655 
	`•ö_u∆ock_bh
(&
waôög_locks_•ölock
);

656 
	}
}

661 
	$ldlm_h™dÀ_a°_îr‹
(
ldlm_lock
 *
lock
,

662 
±Ãpc_ªque°
 *
ªq
, 
rc
,

663 c⁄° *
a°_ty≥
)

665 
 ë_¥o˚ss_id_t
 
≥î
 = 
ªq
->
rq_imp‹t
->
imp_c⁄√˘i⁄
->
c_≥î
;

667 i‡(!
ªq
->
rq_ª∂õd
 || (
rc
 &&Ñ¯!-
EINVAL
)) {

668 i‡(
lock
->
l_exp‹t
 &&Üock->l_exp‹t->
exp_lib˛õ¡
) {

669 
	`LDLM_DEBUG
(
lock
, "%s ASTÅoÜiblustre client (nid %s)"

670 "Åimeout, ju° c™˚ŒögÜock", 
a°_ty≥
,

671 
	`libcfs_nid2°r
(
≥î
.
nid
));

672 
	`ldlm_lock_ˇn˚l
(
lock
);

673 
rc
 = -
ERESTART
;

674 } i‡(
	`ldlm_is_ˇn˚l
(
lock
)) {

675 
	`LDLM_DEBUG
(
lock
, "%s ASTÅimeout fromÇid %s, but "

677 
a°_ty≥
, 
	`libcfs_nid2°r
(
≥î
.
nid
));

678 
	`ldlm_lock_ˇn˚l
(
lock
);

679 
rc
 = -
ERESTART
;

681 
	`LDLM_ERROR
(
lock
, "client (nid %s) %s %s AST "

683 
	`libcfs_nid2°r
(
≥î
.
nid
),

684 
ªq
->
rq_ª∂õd
 ? "returnedÉrror from" :

686 
a°_ty≥
,

687 (
ªq
->
rq_ªpmsg
 !
NULL
) ?

688 
	`lu°ª_msg_gë_°©us
(
ªq
->
rq_ªpmsg
) : 0,

689 
rc
);

690 
	`ldlm_Áûed_a°
(
lock
, 
rc
, 
a°_ty≥
);

692  
rc
;

695 i‡(
rc
 =-
EINVAL
) {

696 
ldlm_ªsour˚
 *
ªs
 = 
lock
->
l_ªsour˚
;

698 
	`LDLM_DEBUG
(
lock
, "client (nid %s)Ñeturned %d"

700 
	`libcfs_nid2°r
(
≥î
.
nid
),

701 
ªq
->
rq_ªpmsg
 ?

702 
	`lu°ª_msg_gë_°©us
(
ªq
->
rq_ªpmsg
) : -1,

703 
a°_ty≥
);

704 i‡(
ªs
) {

707 
	`ldlm_ªsour˚_gëªf
(
ªs
);

708 
	`ldlm_ªs_lvbo_upd©e
(
ªs
, 
NULL
, 1);

709 
	`ldlm_ªsour˚_puåef
(
ªs
);

711 
	`ldlm_lock_ˇn˚l
(
lock
);

712 
rc
 = -
ERESTART
;

715  
rc
;

716 
	}
}

718 
	$ldlm_cb_öãΩªt
(c⁄° 
lu_ív
 *
ív
,

719 
±Ãpc_ªque°
 *
ªq
, *
d©a
, 
rc
)

721 
ldlm_cb_async_¨gs
 *
ˇ
 = 
d©a
;

722 
ldlm_lock
 *
lock
 = 
ˇ
->
ˇ_lock
;

723 
ldlm_cb_£t_¨g
 *
¨g
 = 
ˇ
->
ˇ_£t_¨g
;

724 
ENTRY
;

726 
	`LASSERT
(
lock
 !
NULL
);

728 
¨g
->
ty≥
) {

729 
LDLM_GL_CALLBACK
:

738 i‡(
rc
 =-
ELDLM_NO_LOCK_DATA
) {

739 
	`LDLM_DEBUG
(
lock
, "lostÑace - client hasáÜock butÇo "

741 
	`ldlm_ªs_lvbo_upd©e
(
lock
->
l_ªsour˚
, 
NULL
, 1);

742 } i‡(
rc
 != 0) {

743 
rc
 = 
	`ldlm_h™dÀ_a°_îr‹
(
lock
, 
ªq
,Ñc, "glimpse");

745 
rc
 = 
	`ldlm_ªs_lvbo_upd©e
(
lock
->
l_ªsour˚
, 
ªq
, 1);

748 
LDLM_BL_CALLBACK
:

749 i‡(
rc
 != 0)

750 
rc
 = 
	`ldlm_h™dÀ_a°_îr‹
(
lock
, 
ªq
,Ñc, "blocking");

752 
LDLM_CP_CALLBACK
:

753 i‡(
rc
 != 0)

754 
rc
 = 
	`ldlm_h™dÀ_a°_îr‹
(
lock
, 
ªq
,Ñc, "completion");

757 
	`LDLM_ERROR
(
lock
, "invalid opcode forÜock callback %d",

758 
¨g
->
ty≥
);

759 
	`LBUG
();

763 
	`LDLM_LOCK_RELEASE
(
lock
);

765 i‡(
rc
 =-
ERESTART
)

766 
	`©omic_öc
(&
¨g
->
ª°¨t
);

768 
	`RETURN
(0);

769 
	}
}

771 
	$ldlm_upd©e_ª£nd
(
±Ãpc_ªque°
 *
ªq
, *
d©a
)

773 
ldlm_cb_async_¨gs
 *
ˇ
 = 
d©a
;

774 
ldlm_lock
 *
lock
 = 
ˇ
->
ˇ_lock
;

776 
	`ldlm_ª‰esh_waôög_lock
(
lock
, 
	`ldlm_bl_timeout
(lock));

777 
	}
}

779 
ölöe
 
	$ldlm_a°_föi
(
±Ãpc_ªque°
 *
ªq
,

780 
ldlm_cb_£t_¨g
 *
¨g
,

781 
ldlm_lock
 *
lock
,

782 
ö°™t_ˇn˚l
)

784 
rc
 = 0;

785 
ENTRY
;

787 i‡(
	`u∆ikñy
(
ö°™t_ˇn˚l
)) {

788 
rc
 = 
	`±l_£nd_Ωc
(
ªq
, 1);

789 
	`±Ãpc_ªq_föished
(
ªq
);

790 i‡(
rc
 == 0)

791 
	`©omic_öc
(&
¨g
->
ª°¨t
);

793 
	`LDLM_LOCK_GET
(
lock
);

794 
	`±Ãpc_£t_add_ªq
(
¨g
->
£t
, 
ªq
);

797 
	`RETURN
(
rc
);

798 
	}
}

804 
	$ldlm_lock_ª‹dî_ªq
(
ldlm_lock
 *
lock
)

806 
±Ãpc_ªque°
 *
ªq
;

807 
ENTRY
;

809 i‡(
lock
->
l_exp‹t
 =
NULL
) {

810 
	`LDLM_DEBUG
(
lock
, "clientÜock:Ço-op");

811 
RETURN_EXIT
;

814 
	`•ö_lock_bh
(&
lock
->
l_exp‹t
->
exp_Ωc_lock
);

815 
	`li°_f‹_óch_íåy
(
ªq
, &
lock
->
l_exp‹t
->
exp_hp_Ωcs
,

816 
rq_exp_li°
) {

823 i‡(
	`±Ãpc_ƒs_ªq_ˇn_move
(
ªq
) &&

824 
ªq
->
rq_›s
->
h¥eq_lock_m©ch
 &&

825 
ªq
->
rq_›s
->
	`h¥eq_lock_m©ch
‘eq, 
lock
))

826 
	`±Ãpc_ƒs_ªq_hp_move
(
ªq
);

828 
	`•ö_u∆ock_bh
(&
lock
->
l_exp‹t
->
exp_Ωc_lock
);

829 
EXIT
;

830 
	}
}

839 
	$ldlm_£rvî_blockög_a°
(
ldlm_lock
 *
lock
,

840 
ldlm_lock_desc
 *
desc
,

841 *
d©a
, 
Êag
)

843 
ldlm_cb_async_¨gs
 *
ˇ
;

844 
ldlm_cb_£t_¨g
 *
¨g
 = 
d©a
;

845 
ldlm_ªque°
 *
body
;

846 
±Ãpc_ªque°
 *
ªq
;

847 
ö°™t_ˇn˚l
 = 0;

848 
rc
 = 0;

849 
ENTRY
;

851 i‡(
Êag
 =
LDLM_CB_CANCELING
)

853 
	`RETURN
(0);

855 
	`LASSERT
(
lock
);

856 
	`LASSERT
(
d©a
 !
NULL
);

857 i‡(
lock
->
l_exp‹t
->
exp_obd
->
obd_ªcovîög
 != 0)

858 
	`LDLM_ERROR
(
lock
, "BUG 6063:Üock collide duringÑecovery");

860 
	`ldlm_lock_ª‹dî_ªq
(
lock
);

862 
ªq
 = 
	`±Ãpc_ªque°_Æloc_∑ck
(
lock
->
l_exp‹t
->
exp_imp_ªvî£
,

863 &
RQF_LDLM_BL_CALLBACK
,

864 
LUSTRE_DLM_VERSION
, 
LDLM_BL_CALLBACK
);

865 i‡(
ªq
 =
NULL
)

866 
	`RETURN
(-
ENOMEM
);

868 
	`CLASSERT
((*
ˇ
Ë<(
ªq
->
rq_async_¨gs
));

869 
ˇ
 = 
	`±Ãpc_ªq_async_¨gs
(
ªq
);

870 
ˇ
->
ˇ_£t_¨g
 = 
¨g
;

871 
ˇ
->
ˇ_lock
 = 
lock
;

873 
ªq
->
rq_öãΩªt_ª∂y
 = 
ldlm_cb_öãΩªt
;

875 
	`lock_ªs_™d_lock
(
lock
);

876 i‡(
	`ldlm_is_de°royed
(
lock
)) {

878 
	`u∆ock_ªs_™d_lock
(
lock
);

879 
	`±Ãpc_ªq_föished
(
ªq
);

880 
	`RETURN
(0);

883 i‡(
lock
->
l_gø¡ed_mode
 !lock->
l_ªq_mode
) {

886 
	`ldlm_add_blocked_lock
(
lock
);

887 
	`ldlm_£t_waôed
(
lock
);

888 
	`u∆ock_ªs_™d_lock
(
lock
);

890 
	`±Ãpc_ªq_föished
(
ªq
);

891 
	`LDLM_DEBUG
(
lock
, "lockÇot granted,Çot sending blocking AST");

892 
	`RETURN
(0);

895 i‡(
	`ldlm_is_ˇn˚l_⁄_block
(
lock
))

896 
ö°™t_ˇn˚l
 = 1;

898 
body
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

899 
body
->
lock_h™dÀ
[0] = 
lock
->
l_ªmŸe_h™dÀ
;

900 
body
->
lock_desc
 = *
desc
;

901 
body
->
lock_Êags
 |
	`ldlm_Êags_to_wúe
(
lock
->
l_Êags
 & 
LDLM_FL_AST_MASK
);

903 
	`LDLM_DEBUG
(
lock
, "serverÖreparing blocking AST");

905 
	`±Ãpc_ªque°_£t_ª∂í
(
ªq
);

906 
	`ldlm_£t_cb≥ndög
(
lock
);

907 i‡(
ö°™t_ˇn˚l
) {

908 
	`u∆ock_ªs_™d_lock
(
lock
);

909 
	`ldlm_lock_ˇn˚l
(
lock
);

911 
ªq
->
rq_no_ª£nd
 = 1;

913 
	`LASSERT
(
lock
->
l_gø¡ed_mode
 =lock->
l_ªq_mode
);

914 
	`ldlm_add_waôög_lock
(
lock
);

915 
	`u∆ock_ªs_™d_lock
(
lock
);

918 
ªq
->
rq_dñay_limô
 = 
	`ldlm_bl_timeout
(
lock
);

919 
ªq
->
rq_ª£nd_cb
 = 
ldlm_upd©e_ª£nd
;

922 
ªq
->
rq_£nd_°©e
 = 
LUSTRE_IMP_FULL
;

924 i‡(
AT_OFF
)

925 
ªq
->
rq_timeout
 = 
	`ldlm_gë_rq_timeout
();

927 
lock
->
l_œ°_a˘ivôy
 = 
	`cfs_time_cuºít_£c
();

929 i‡(
lock
->
l_exp‹t
 &&Üock->l_exp‹t->
exp_nid_°©s
 &&

930 
lock
->
l_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
)

931 
	`Õrocfs_cou¡î_ö¸
(
lock
->
l_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
,

932 
LDLM_BL_CALLBACK
 - 
LDLM_FIRST_OPC
);

934 
rc
 = 
	`ldlm_a°_föi
(
ªq
, 
¨g
, 
lock
, 
ö°™t_ˇn˚l
);

936 
	`RETURN
(
rc
);

937 
	}
}

946 
	$ldlm_£rvî_com∂ëi⁄_a°
(
ldlm_lock
 *
lock
, 
__u64
 
Êags
, *
d©a
)

948 
ldlm_cb_£t_¨g
 *
¨g
 = 
d©a
;

949 
ldlm_ªque°
 *
body
;

950 
±Ãpc_ªque°
 *
ªq
;

951 
ldlm_cb_async_¨gs
 *
ˇ
;

952 
ö°™t_ˇn˚l
 = 0;

953 
rc
 = 0;

954 
lvb_Àn
;

955 
ENTRY
;

957 
	`LASSERT
(
lock
 !
NULL
);

958 
	`LASSERT
(
d©a
 !
NULL
);

960 i‡(
	`OBD_FAIL_PRECHECK
(
OBD_FAIL_LDLM_SRV_CP_AST
)) {

961 
	`LDLM_DEBUG
(
lock
, "dropping CP AST");

962 
	`RETURN
(0);

965 
ªq
 = 
	`±Ãpc_ªque°_Æloc
(
lock
->
l_exp‹t
->
exp_imp_ªvî£
,

966 &
RQF_LDLM_CP_CALLBACK
);

967 i‡(
ªq
 =
NULL
)

968 
	`RETURN
(-
ENOMEM
);

971 
lvb_Àn
 = 
	`ldlm_lvbo_size
(
lock
);

976 i‡(
	`ldlm_has_œyout
(
lock
))

977 
lvb_Àn
 = 0;

979 
	`ªq_ˇpsuÀ_£t_size
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
, 
RCL_CLIENT
, 
lvb_Àn
);

980 
rc
 = 
	`±Ãpc_ªque°_∑ck
(
ªq
, 
LUSTRE_DLM_VERSION
, 
LDLM_CP_CALLBACK
);

981 i‡(
rc
) {

982 
	`±Ãpc_ªque°_‰ì
(
ªq
);

983 
	`RETURN
(
rc
);

986 
	`CLASSERT
((*
ˇ
Ë<(
ªq
->
rq_async_¨gs
));

987 
ˇ
 = 
	`±Ãpc_ªq_async_¨gs
(
ªq
);

988 
ˇ
->
ˇ_£t_¨g
 = 
¨g
;

989 
ˇ
->
ˇ_lock
 = 
lock
;

991 
ªq
->
rq_öãΩªt_ª∂y
 = 
ldlm_cb_öãΩªt
;

992 
body
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

994 
body
->
lock_h™dÀ
[0] = 
lock
->
l_ªmŸe_h™dÀ
;

995 
body
->
lock_Êags
 = 
	`ldlm_Êags_to_wúe
(
Êags
);

996 
	`ldlm_lock2desc
(
lock
, &
body
->
lock_desc
);

997 i‡(
lvb_Àn
 > 0) {

998 *
lvb
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
);

1000 
lvb_Àn
 = 
	`ldlm_lvbo_fûl
(
lock
, 
lvb
,Üvb_len);

1001 i‡(
lvb_Àn
 < 0) {

1008 
	`ªq_ˇpsuÀ_shrök
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
, 0,

1009 
RCL_CLIENT
);

1010 
ö°™t_ˇn˚l
 = 1;

1012 
	`ªq_ˇpsuÀ_shrök
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
, 
lvb_Àn
,

1013 
RCL_CLIENT
);

1017 
lock
->
l_œ°_a˘ivôy
 = 
	`cfs_time_cuºít_£c
();

1019 
	`LDLM_DEBUG
(
lock
, "serverÖreparing completion AST");

1021 
	`±Ãpc_ªque°_£t_ª∂í
(
ªq
);

1023 
ªq
->
rq_£nd_°©e
 = 
LUSTRE_IMP_FULL
;

1025 i‡(
AT_OFF
)

1026 
ªq
->
rq_timeout
 = 
	`ldlm_gë_rq_timeout
();

1029 
	`lock_ªs_™d_lock
(
lock
);

1030 i‡(
	`ldlm_is_a°_£¡
(
lock
)) {

1031 
body
->
lock_Êags
 |
	`ldlm_Êags_to_wúe
(
LDLM_FL_AST_SENT
);

1033 
body
->
lock_Êags
 |
	`ldlm_Êags_to_wúe
(
lock
->
l_Êags
 &

1034 
LDLM_FL_AST_MASK
);

1042 i‡(
	`ldlm_is_ˇn˚l_⁄_block
(
lock
)) {

1043 
	`u∆ock_ªs_™d_lock
(
lock
);

1044 
	`ldlm_lock_ˇn˚l
(
lock
);

1046 
ö°™t_ˇn˚l
 = 1;

1047 
ªq
->
rq_no_ª£nd
 = 1;

1049 
	`lock_ªs_™d_lock
(
lock
);

1052 
	`ldlm_add_waôög_lock
(
lock
);

1054 
ªq
->
rq_dñay_limô
 = 
	`ldlm_bl_timeout
(
lock
);

1055 
ªq
->
rq_ª£nd_cb
 = 
ldlm_upd©e_ª£nd
;

1058 
	`u∆ock_ªs_™d_lock
(
lock
);

1060 i‡(
lock
->
l_exp‹t
 &&Üock->l_exp‹t->
exp_nid_°©s
 &&

1061 
lock
->
l_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
)

1062 
	`Õrocfs_cou¡î_ö¸
(
lock
->
l_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
,

1063 
LDLM_CP_CALLBACK
 - 
LDLM_FIRST_OPC
);

1065 
rc
 = 
	`ldlm_a°_föi
(
ªq
, 
¨g
, 
lock
, 
ö°™t_ˇn˚l
);

1067 
	`RETURN
(
lvb_Àn
 < 0 ?Üvb_À¿: 
rc
);

1068 
	}
}

1076 
	$ldlm_£rvî_glimp£_a°
(
ldlm_lock
 *
lock
, *
d©a
)

1078 
ldlm_cb_£t_¨g
 *
¨g
 = 
d©a
;

1079 
ldlm_ªque°
 *
body
;

1080 
±Ãpc_ªque°
 *
ªq
;

1081 
ldlm_cb_async_¨gs
 *
ˇ
;

1082 
rc
;

1083 
ªq_f‹m©
 *
ªq_fmt
;

1084 
ENTRY
;

1086 
	`LASSERT
(
lock
 !
NULL
);

1088 i‡(
¨g
->
gl_desc
 !
NULL
)

1090 
ªq_fmt
 = &
RQF_LDLM_GL_DESC_CALLBACK
;

1092 
ªq_fmt
 = &
RQF_LDLM_GL_CALLBACK
;

1094 
ªq
 = 
	`±Ãpc_ªque°_Æloc_∑ck
(
lock
->
l_exp‹t
->
exp_imp_ªvî£
,

1095 
ªq_fmt
, 
LUSTRE_DLM_VERSION
,

1096 
LDLM_GL_CALLBACK
);

1098 i‡(
ªq
 =
NULL
)

1099 
	`RETURN
(-
ENOMEM
);

1101 i‡(
¨g
->
gl_desc
 !
NULL
) {

1103 
ldlm_gl_desc
 *
desc
;

1104 
desc
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_GL_DESC
);

1105 *
desc
 = *
¨g
->
gl_desc
;

1108 
body
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

1109 
body
->
lock_h™dÀ
[0] = 
lock
->
l_ªmŸe_h™dÀ
;

1110 
	`ldlm_lock2desc
(
lock
, &
body
->
lock_desc
);

1112 
	`CLASSERT
((*
ˇ
Ë<(
ªq
->
rq_async_¨gs
));

1113 
ˇ
 = 
	`±Ãpc_ªq_async_¨gs
(
ªq
);

1114 
ˇ
->
ˇ_£t_¨g
 = 
¨g
;

1115 
ˇ
->
ˇ_lock
 = 
lock
;

1118 
	`ªq_ˇpsuÀ_£t_size
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
, 
RCL_SERVER
,

1119 
	`ldlm_lvbo_size
(
lock
));

1120 
	`±Ãpc_ªque°_£t_ª∂í
(
ªq
);

1122 
ªq
->
rq_£nd_°©e
 = 
LUSTRE_IMP_FULL
;

1124 i‡(
AT_OFF
)

1125 
ªq
->
rq_timeout
 = 
	`ldlm_gë_rq_timeout
();

1127 
lock
->
l_œ°_a˘ivôy
 = 
	`cfs_time_cuºít_£c
();

1129 
ªq
->
rq_öãΩªt_ª∂y
 = 
ldlm_cb_öãΩªt
;

1131 i‡(
lock
->
l_exp‹t
 &&Üock->l_exp‹t->
exp_nid_°©s
 &&

1132 
lock
->
l_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
)

1133 
	`Õrocfs_cou¡î_ö¸
(
lock
->
l_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
,

1134 
LDLM_GL_CALLBACK
 - 
LDLM_FIRST_OPC
);

1136 
rc
 = 
	`ldlm_a°_föi
(
ªq
, 
¨g
, 
lock
, 0);

1138 
	`RETURN
(
rc
);

1139 
	}
}

1141 
	$ldlm_glimp£_locks
(
ldlm_ªsour˚
 *
ªs
,

1142 
li°_hód
 *
gl_w‹k_li°
)

1144 
rc
;

1145 
ENTRY
;

1147 
rc
 = 
	`ldlm_run_a°_w‹k
(
	`ldlm_ªs_to_ns
(
ªs
), 
gl_w‹k_li°
,

1148 
LDLM_WORK_GL_AST
);

1149 i‡(
rc
 =-
ERESTART
)

1150 
	`ldlm_ª¥o˚ss_Æl
(
ªs
);

1152 
	`RETURN
(
rc
);

1153 
	}
}

1154 
EXPORT_SYMBOL
(
ldlm_glimp£_locks
);

1157 
ldlm_lock
 *
	$ldlm_ªque°_lock
(
±Ãpc_ªque°
 *
ªq
)

1159 
ldlm_cb_async_¨gs
 *
ˇ
;

1160 
ldlm_lock
 *
lock
;

1161 
ENTRY
;

1163 
ˇ
 = 
	`±Ãpc_ªq_async_¨gs
(
ªq
);

1164 
lock
 = 
ˇ
->
ˇ_lock
;

1165 i‡(
lock
 =
NULL
)

1166 
	`RETURN
(
	`ERR_PTR
(-
EFAULT
));

1168 
	`RETURN
(
lock
);

1169 
	}
}

1170 
EXPORT_SYMBOL
(
ldlm_ªque°_lock
);

1172 
	$ldlm_svc_gë_e›c
(c⁄° 
ldlm_ªque°
 *
dlm_ªq
,

1173 
Õrocfs_°©s
 *
§v_°©s
)

1175 
lock_ty≥
 = 0, 
›
 = 0;

1177 
lock_ty≥
 = 
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
;

1179 
lock_ty≥
) {

1180 
LDLM_PLAIN
:

1181 
›
 = 
PTLRPC_LAST_CNTR
 + 
LDLM_PLAIN_ENQUEUE
;

1183 
LDLM_EXTENT
:

1184 i‡(
dlm_ªq
->
lock_Êags
 & 
LDLM_FL_HAS_INTENT
)

1185 
›
 = 
PTLRPC_LAST_CNTR
 + 
LDLM_GLIMPSE_ENQUEUE
;

1187 
›
 = 
PTLRPC_LAST_CNTR
 + 
LDLM_EXTENT_ENQUEUE
;

1189 
LDLM_FLOCK
:

1190 
›
 = 
PTLRPC_LAST_CNTR
 + 
LDLM_FLOCK_ENQUEUE
;

1192 
LDLM_IBITS
:

1193 
›
 = 
PTLRPC_LAST_CNTR
 + 
LDLM_IBITS_ENQUEUE
;

1196 
›
 = 0;

1200 i‡(
›
)

1201 
	`Õrocfs_cou¡î_ö¸
(
§v_°©s
, 
›
);

1204 
	}
}

1210 
	$ldlm_h™dÀ_íqueue0
(
ldlm_«me•a˚
 *
ns
,

1211 
±Ãpc_ªque°
 *
ªq
,

1212 c⁄° 
ldlm_ªque°
 *
dlm_ªq
,

1213 c⁄° 
ldlm_ˇŒback_suôe
 *
cbs
)

1215 
ldlm_ª∂y
 *
dlm_ªp
;

1216 
__u64
 
Êags
;

1217 
ldlm_îr‹
 
îr
 = 
ELDLM_OK
;

1218 
ldlm_lock
 *
lock
 = 
NULL
;

1219 *
cookõ
 = 
NULL
;

1220 
rc
 = 0;

1221 
ldlm_ªsour˚
 *
ªs
 = 
NULL
;

1222 
ENTRY
;

1224 
	`LDLM_DEBUG_NOLOCK
("server-sideÉnqueue handler START");

1226 
	`ldlm_ªque°_ˇn˚l
(
ªq
, 
dlm_ªq
, 
LDLM_ENQUEUE_CANCEL_OFF
, 
LATF_SKIP
);

1227 
Êags
 = 
	`ldlm_Êags_‰om_wúe
(
dlm_ªq
->
lock_Êags
);

1229 
	`LASSERT
(
ªq
->
rq_exp‹t
);

1231 i‡(
	`±Ãpc_ªq2svc
(
ªq
)->
§v_°©s
 !
NULL
)

1232 
	`ldlm_svc_gë_e›c
(
dlm_ªq
, 
	`±Ãpc_ªq2svc
(
ªq
)->
§v_°©s
);

1234 i‡(
ªq
->
rq_exp‹t
 &&Ñeq->rq_exp‹t->
exp_nid_°©s
 &&

1235 
ªq
->
rq_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
)

1236 
	`Õrocfs_cou¡î_ö¸
(
ªq
->
rq_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
,

1237 
LDLM_ENQUEUE
 - 
LDLM_FIRST_OPC
);

1239 i‡(
	`u∆ikñy
(
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
 < 
LDLM_MIN_TYPE
 ||

1240 
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
 >
LDLM_MAX_TYPE
)) {

1241 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "invalidÜockÑequestÅype %d",

1242 
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
);

1243 
	`GOTO
(
out
, 
rc
 = -
EFAULT
);

1246 i‡(
	`u∆ikñy
(
dlm_ªq
->
lock_desc
.
l_ªq_mode
 <
LCK_MINMODE
 ||

1247 
dlm_ªq
->
lock_desc
.
l_ªq_mode
 >
LCK_MAXMODE
 ||

1248 
dlm_ªq
->
lock_desc
.
l_ªq_mode
 &

1249 (
dlm_ªq
->
lock_desc
.
l_ªq_mode
-1))) {

1250 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
, "invalidÜockÑequest mode %d",

1251 
dlm_ªq
->
lock_desc
.
l_ªq_mode
);

1252 
	`GOTO
(
out
, 
rc
 = -
EFAULT
);

1255 i‡(
	`exp_c⁄√˘_Êags
(
ªq
->
rq_exp‹t
Ë& 
OBD_CONNECT_IBITS
) {

1256 i‡(
	`u∆ikñy
(
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
 ==

1257 
LDLM_PLAIN
)) {

1258 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
,

1260 
	`GOTO
(
out
, 
rc
 = -
EPROTO
);

1262 } i‡(
	`u∆ikñy
(
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
 ==

1263 
LDLM_IBITS
)) {

1264 
	`DEBUG_REQ
(
D_ERROR
, 
ªq
,

1266 
	`GOTO
(
out
, 
rc
 = -
EPROTO
);

1276 i‡(!(
	`exp_c⁄√˘_Êags
(
ªq
->
rq_exp‹t
Ë& 
OBD_CONNECT_IBITS
) &&

1277 (
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
 =
LDLM_PLAIN
)) {

1278 
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
 = 
LDLM_IBITS
;

1279 
dlm_ªq
->
lock_desc
.
l_pﬁicy_d©a
.
l_öodebôs
.
bôs
 =

1280 
MDS_INODELOCK_LOOKUP
 | 
MDS_INODELOCK_UPDATE
;

1281 i‡(
dlm_ªq
->
lock_desc
.
l_ªq_mode
 =
LCK_PR
)

1282 
dlm_ªq
->
lock_desc
.
l_ªq_mode
 = 
LCK_CR
;

1286 i‡(
	`u∆ikñy
((
Êags
 & 
LDLM_FL_REPLAY
) ||

1287 (
	`lu°ª_msg_gë_Êags
(
ªq
->
rq_ªqmsg
Ë& 
MSG_RESENT
))) {

1292 
lock
 = 
	`cfs_hash_lookup
(
ªq
->
rq_exp‹t
->
exp_lock_hash
,

1293 (*)&
dlm_ªq
->
lock_h™dÀ
[0]);

1294 i‡(
lock
 !
NULL
) {

1295 
	`DEBUG_REQ
(
D_DLMTRACE
, 
ªq
, "foundÉxistingÜock cookie "

1296 
LPX64
, 
lock
->
l_h™dÀ
.
h_cookõ
);

1297 
Êags
 |
LDLM_FL_RESENT
;

1298 
	`GOTO
(
exi°ög_lock
, 
rc
 = 0);

1301 i‡(
	`ldlm_ª˛aim_fuŒ
()) {

1302 
	`DEBUG_REQ
(
D_DLMTRACE
, 
ªq
, "Too many grantedÜocks, "

1305 
	`GOTO
(
out
, 
rc
 = -
EINPROGRESS
);

1310 
lock
 = 
	`ldlm_lock_¸óã
(
ns
, &
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_«me
,

1311 
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
,

1312 
dlm_ªq
->
lock_desc
.
l_ªq_mode
,

1313 
cbs
, 
NULL
, 0, 
LVB_T_NONE
);

1314 i‡(
	`IS_ERR
(
lock
)) {

1315 
rc
 = 
	`PTR_ERR
(
lock
);

1316 
lock
 = 
NULL
;

1317 
	`GOTO
(
out
, 
rc
);

1320 
lock
->
l_ªmŸe_h™dÀ
 = 
dlm_ªq
->
lock_h™dÀ
[0];

1321 
	`LDLM_DEBUG
(
lock
, "server-sideÉnqueue handler,ÇewÜock created");

1328 
ªs
 = 
lock
->
l_ªsour˚
;

1329 i‡(!(
Êags
 & 
LDLM_FL_REPLAY
)) {

1331 
rc
 = 
	`ldlm_lvbo_öô
(
ªs
);

1332 i‡(
rc
 < 0) {

1333 
	`LDLM_DEBUG
(
lock
, "dñayedÜvb inô faûed (r¯%d)", 
rc
);

1334 
	`GOTO
(
out
, 
rc
);

1338 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_LDLM_ENQUEUE_BLOCKED
, 
obd_timeout
 * 2);

1342 i‡(
ªq
->
rq_exp‹t
->
exp_disc⁄√˘ed
) {

1343 
	`LDLM_ERROR
(
lock
, "lock on disconnectedÉxport %p",

1344 
ªq
->
rq_exp‹t
);

1345 
	`GOTO
(
out
, 
rc
 = -
ENOTCONN
);

1348 
lock
->
l_exp‹t
 = 
	`˛ass_exp‹t_lock_gë
(
ªq
->
rq_exp‹t
,Üock);

1349 i‡(
lock
->
l_exp‹t
->
exp_lock_hash
)

1350 
	`cfs_hash_add
(
lock
->
l_exp‹t
->
exp_lock_hash
,

1351 &
lock
->
l_ªmŸe_h™dÀ
,

1352 &
lock
->
l_exp_hash
);

1357 
lock
->
l_Êags
 |
	`ldlm_Êags_‰om_wúe
(
dlm_ªq
->
lock_Êags
 &

1358 
LDLM_FL_INHERIT_MASK
);

1359 
exi°ög_lock
:

1361 i‡(
Êags
 & 
LDLM_FL_HAS_INTENT
) {

1364 
cookõ
 = 
ªq
;

1369 
	`ªq_ˇpsuÀ_£t_size
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
,

1370 
RCL_SERVER
, 
	`ldlm_lvbo_size
(
lock
));

1372 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_ENQUEUE_EXTENT_ERR
))

1373 
	`GOTO
(
out
, 
rc
 = -
ENOMEM
);

1375 
rc
 = 
	`ªq_ˇpsuÀ_£rvî_∑ck
(&
ªq
->
rq_pûl
);

1376 i‡(
rc
)

1377 
	`GOTO
(
out
, 
rc
);

1380 i‡(
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
 !
LDLM_PLAIN
)

1381 
	`ldlm_c⁄vît_pﬁicy_to_loˇl
(
ªq
->
rq_exp‹t
,

1382 
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
,

1383 &
dlm_ªq
->
lock_desc
.
l_pﬁicy_d©a
,

1384 &
lock
->
l_pﬁicy_d©a
);

1385 i‡(
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
 =
LDLM_EXTENT
)

1386 
lock
->
l_ªq_exã¡
 =Üock->
l_pﬁicy_d©a
.
l_exã¡
;

1388 
îr
 = 
	`ldlm_lock_íqueue
(
ns
, &
lock
, 
cookõ
, &
Êags
);

1389 i‡(
îr
) {

1390 i‡(()
îr
 < 0)

1391 
rc
 = ()
îr
;

1392 
	`GOTO
(
out
, 
îr
);

1395 
dlm_ªp
 = 
	`ªq_ˇpsuÀ_£rvî_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REP
);

1397 
	`ldlm_lock2desc
(
lock
, &
dlm_ªp
->
lock_desc
);

1398 
	`ldlm_lock2h™dÀ
(
lock
, &
dlm_ªp
->
lock_h™dÀ
);

1400 i‡(
lock
 &&Üock->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_EXTENT
)

1401 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_LDLM_BL_EVICT
, 6);

1405 
	`lock_ªs_™d_lock
(
lock
);

1409 
dlm_ªp
->
lock_Êags
 = 
	`ldlm_Êags_to_wúe
(
Êags
);

1410 
lock
->
l_Êags
 |
Êags
 & 
LDLM_FL_INHERIT_MASK
;

1415 i‡(
	`u∆ikñy
(
ªq
->
rq_exp‹t
->
exp_disc⁄√˘ed
 ||

1416 
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_ENQUEUE_OLD_EXPORT
))) {

1417 
	`LDLM_ERROR
(
lock
, "lock o¿de°royedÉxp‹à%p", 
ªq
->
rq_exp‹t
);

1418 
rc
 = -
ENOTCONN
;

1419 } i‡(
	`ldlm_is_a°_£¡
(
lock
)) {

1420 
dlm_ªp
->
lock_Êags
 |
	`ldlm_Êags_to_wúe
(
LDLM_FL_AST_SENT
);

1421 i‡(
lock
->
l_gø¡ed_mode
 =lock->
l_ªq_mode
) {

1429 i‡(
dlm_ªp
->
lock_Êags
 & 
LDLM_FL_CANCEL_ON_BLOCK
) {

1430 
	`u∆ock_ªs_™d_lock
(
lock
);

1431 
	`ldlm_lock_ˇn˚l
(
lock
);

1432 
	`lock_ªs_™d_lock
(
lock
);

1434 
	`ldlm_add_waôög_lock
(
lock
);

1439 i‡((
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
 =
LDLM_PLAIN
 ||

1440 
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
 =
LDLM_IBITS
) &&

1441 
ªq
->
rq_exp‹t
->
exp_lib˛õ¡
) {

1442 i‡(
	`u∆ikñy
(!
	`ldlm_is_ˇn˚l_⁄_block
(
lock
) ||

1443 !(
dlm_ªp
->
lock_Êags
 & 
LDLM_FL_CANCEL_ON_BLOCK
))){

1444 
	`CERROR
("Granting syncÜockÅoÜibclient. "

1445 "ªq f»%d,Ñï f»%d,Üock f»"
LPX64
"\n",

1446 
dlm_ªq
->
lock_Êags
, 
dlm_ªp
->lock_flags,

1447 
lock
->
l_Êags
);

1448 
	`LDLM_ERROR
(
lock
, "syncÜock");

1449 i‡(
dlm_ªq
->
lock_Êags
 & 
LDLM_FL_HAS_INTENT
) {

1450 
ldlm_öã¡
 *
ô
;

1452 
ô
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
,

1453 &
RMF_LDLM_INTENT
);

1454 i‡(
ô
 !
NULL
) {

1455 
	`CERROR
("Thi†i†öã¡ %†("
LPU64
")\n",

1456 
	`ldlm_ô2°r
(
ô
->
›c
), it->opc);

1462 
	`u∆ock_ªs_™d_lock
(
lock
);

1464 
EXIT
;

1465 
out
:

1466 
ªq
->
rq_°©us
 = 
rc
 ?: 
îr
;

1467 i‡(!
ªq
->
rq_∑cked_föÆ
) {

1468 
îr
 = 
	`lu°ª_∑ck_ª∂y
(
ªq
, 1, 
NULL
, NULL);

1469 i‡(
rc
 == 0)

1470 
rc
 = 
îr
;

1475 i‡(
lock
 !
NULL
) {

1476 
	`LDLM_DEBUG
(
lock
, "server-sideÉnqueue handler, sendingÑeply"

1477 "”º=%d,Ñc=%d)", 
îr
, 
rc
);

1479 i‡(
rc
 == 0) {

1480 i‡(
	`ªq_ˇpsuÀ_has_fõld
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
,

1481 
RCL_SERVER
) &&

1482 
	`ldlm_lvbo_size
(
lock
) > 0) {

1483 *
buf
;

1484 
buÊí
;

1486 
buf
 = 
	`ªq_ˇpsuÀ_£rvî_gë
(&
ªq
->
rq_pûl
,

1487 &
RMF_DLM_LVB
);

1488 
	`LASSERTF
(
buf
 !
NULL
, "req %p,Üock %p\n",

1489 
ªq
, 
lock
);

1490 
buÊí
 = 
	`ªq_ˇpsuÀ_gë_size
(&
ªq
->
rq_pûl
,

1491 &
RMF_DLM_LVB
, 
RCL_SERVER
);

1494 i‡((
buÊí
 > 0Ë&& !(
Êags
 & 
LDLM_FL_REPLAY
)) {

1495 
buÊí
 = 
	`ldlm_lvbo_fûl
(
lock
, 
buf
,

1496 
buÊí
);

1497 i‡(
buÊí
 >= 0)

1498 
	`ªq_ˇpsuÀ_shrök
(

1499 &
ªq
->
rq_pûl
,

1500 &
RMF_DLM_LVB
,

1501 
buÊí
, 
RCL_SERVER
);

1503 
rc
 = 
buÊí
;

1504 } i‡(
Êags
 & 
LDLM_FL_REPLAY
) {

1506 i‡(
buÊí
 > 0)

1507 
	`ªq_ˇpsuÀ_shrök
(

1508 &
ªq
->
rq_pûl
,

1509 &
RMF_DLM_LVB
,

1510 0, 
RCL_SERVER
);

1512 
rc
 = 
buÊí
;

1514 
rc
 = 
buÊí
;

1519 i‡(
rc
 !0 && !(
Êags
 & 
LDLM_FL_RESENT
)) {

1520 i‡(
lock
->
l_exp‹t
) {

1521 
	`ldlm_lock_ˇn˚l
(
lock
);

1523 
	`lock_ªs_™d_lock
(
lock
);

1524 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

1525 
	`ldlm_lock_de°roy_nﬁock
(
lock
);

1526 
	`u∆ock_ªs_™d_lock
(
lock
);

1531 i‡(!
îr
 && 
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
 !
LDLM_FLOCK
)

1532 
	`ldlm_ª¥o˚ss_Æl
(
lock
->
l_ªsour˚
);

1534 
	`LDLM_LOCK_RELEASE
(
lock
);

1537 
	`LDLM_DEBUG_NOLOCK
("server-sideÉnqueue handler END (lock %p,Ñc %d)",

1538 
lock
, 
rc
);

1540  
rc
;

1541 
	}
}

1546 
	$ldlm_h™dÀ_íqueue
(
±Ãpc_ªque°
 *
ªq
,

1547 
ldlm_com∂ëi⁄_ˇŒback
 
com∂ëi⁄_ˇŒback
,

1548 
ldlm_blockög_ˇŒback
 
blockög_ˇŒback
,

1549 
ldlm_glimp£_ˇŒback
 
glimp£_ˇŒback
)

1551 
ldlm_ªque°
 *
dlm_ªq
;

1552 
ldlm_ˇŒback_suôe
 
cbs
 = {

1553 .
lcs_com∂ëi⁄
 = 
com∂ëi⁄_ˇŒback
,

1554 .
lcs_blockög
 = 
blockög_ˇŒback
,

1555 .
lcs_glimp£
 = 
glimp£_ˇŒback


1557 
rc
;

1559 
dlm_ªq
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

1560 i‡(
dlm_ªq
 !
NULL
) {

1561 
rc
 = 
	`ldlm_h™dÀ_íqueue0
(
ªq
->
rq_exp‹t
->
exp_obd
->
obd_«me•a˚
,

1562 
ªq
, 
dlm_ªq
, &
cbs
);

1564 
rc
 = -
EFAULT
;

1566  
rc
;

1567 
	}
}

1572 
	$ldlm_h™dÀ_c⁄vît0
(
±Ãpc_ªque°
 *
ªq
,

1573 c⁄° 
ldlm_ªque°
 *
dlm_ªq
)

1575 
ldlm_ª∂y
 *
dlm_ªp
;

1576 
ldlm_lock
 *
lock
;

1577 
rc
;

1578 
ENTRY
;

1580 i‡(
ªq
->
rq_exp‹t
 &&Ñeq->rq_exp‹t->
exp_nid_°©s
 &&

1581 
ªq
->
rq_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
)

1582 
	`Õrocfs_cou¡î_ö¸
(
ªq
->
rq_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
,

1583 
LDLM_CONVERT
 - 
LDLM_FIRST_OPC
);

1585 
rc
 = 
	`ªq_ˇpsuÀ_£rvî_∑ck
(&
ªq
->
rq_pûl
);

1586 i‡(
rc
)

1587 
	`RETURN
(
rc
);

1589 
dlm_ªp
 = 
	`ªq_ˇpsuÀ_£rvî_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REP
);

1590 
dlm_ªp
->
lock_Êags
 = 
dlm_ªq
->lock_flags;

1592 
lock
 = 
	`ldlm_h™dÀ2lock
(&
dlm_ªq
->
lock_h™dÀ
[0]);

1593 i‡(!
lock
) {

1594 
ªq
->
rq_°©us
 = 
LUSTRE_EINVAL
;

1596 *
ªs
 = 
NULL
;

1598 
	`LDLM_DEBUG
(
lock
, "server-side convert handler START");

1600 
ªs
 = 
	`ldlm_lock_c⁄vît
(
lock
, 
dlm_ªq
->
lock_desc
.
l_ªq_mode
,

1601 &
dlm_ªp
->
lock_Êags
);

1602 i‡(
ªs
) {

1603 i‡(
	`ldlm_dñ_waôög_lock
(
lock
))

1604 
	`LDLM_DEBUG
(
lock
, "converted waitingÜock");

1605 
ªq
->
rq_°©us
 = 0;

1607 
ªq
->
rq_°©us
 = 
LUSTRE_EDEADLK
;

1611 i‡(
lock
) {

1612 i‡(!
ªq
->
rq_°©us
)

1613 
	`ldlm_ª¥o˚ss_Æl
(
lock
->
l_ªsour˚
);

1614 
	`LDLM_DEBUG
(
lock
, "server-side convert handler END");

1615 
	`LDLM_LOCK_PUT
(
lock
);

1617 
	`LDLM_DEBUG_NOLOCK
("server-side convert handler END");

1619 
	`RETURN
(0);

1620 
	}
}

1626 
	$ldlm_h™dÀ_c⁄vît
(
±Ãpc_ªque°
 *
ªq
)

1628 
rc
;

1629 
ldlm_ªque°
 *
dlm_ªq
;

1631 
dlm_ªq
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

1632 i‡(
dlm_ªq
 !
NULL
) {

1633 
rc
 = 
	`ldlm_h™dÀ_c⁄vît0
(
ªq
, 
dlm_ªq
);

1635 
	`CERROR
 ("Can't unpack dlm_req\n");

1636 
rc
 = -
EFAULT
;

1638  
rc
;

1639 
	}
}

1647 
	$ldlm_ªque°_ˇn˚l
(
±Ãpc_ªque°
 *
ªq
,

1648 c⁄° 
ldlm_ªque°
 *
dlm_ªq
,

1649 
fú°
, 
lu°ª_©_Êags
 
Êags
)

1651 
ldlm_ªsour˚
 *
ªs
, *
¥es
 = 
NULL
;

1652 
ldlm_lock
 *
lock
;

1653 
i
, 
cou¡
, 
d⁄e
 = 0;

1654 
ENTRY
;

1656 
cou¡
 = 
dlm_ªq
->
lock_cou¡
 ? dlm_req->lock_count : 1;

1657 i‡(
fú°
 >
cou¡
)

1658 
	`RETURN
(0);

1660 i‡(
cou¡
 =1 && 
dlm_ªq
->
lock_h™dÀ
[0].
cookõ
 == 0)

1661 
	`RETURN
(0);

1665 i‡(
	`lu°ª_msg_gë_Êags
(
ªq
->
rq_ªqmsg
Ë& 
MSG_REPLAY
)

1666 
	`RETURN
(0);

1668 
	`LDLM_DEBUG_NOLOCK
("server-side cancel handler START: %dÜocks, "

1669 "°¨tögáà%d", 
cou¡
, 
fú°
);

1671 
i
 = 
fú°
; i < 
cou¡
; i++) {

1672 
lock
 = 
	`ldlm_h™dÀ2lock
(&
dlm_ªq
->
lock_h™dÀ
[
i
]);

1673 i‡(!
lock
) {

1674 
	`LDLM_DEBUG_NOLOCK
("server-side cancel handler stale "

1675 "lock (cookõ "
LPU64
")",

1676 
dlm_ªq
->
lock_h™dÀ
[
i
].
cookõ
);

1680 
ªs
 = 
lock
->
l_ªsour˚
;

1681 
d⁄e
++;

1686 i‡(
ªs
 !
¥es
) {

1687 i‡(
¥es
 !
NULL
) {

1688 
	`ldlm_ª¥o˚ss_Æl
(
¥es
);

1689 
	`LDLM_RESOURCE_DELREF
(
¥es
);

1690 
	`ldlm_ªsour˚_puåef
(
¥es
);

1692 i‡(
ªs
 !
NULL
) {

1693 
	`ldlm_ªsour˚_gëªf
(
ªs
);

1694 
	`LDLM_RESOURCE_ADDREF
(
ªs
);

1695 
	`ldlm_ªs_lvbo_upd©e
(
ªs
, 
NULL
, 1);

1697 
¥es
 = 
ªs
;

1700 i‡((
Êags
 & 
LATF_STATS
Ë&& 
	`ldlm_is_a°_£¡
(
lock
)) {

1701 
dñay
 = 
	`cfs_time_sub
(
	`cfs_time_cuºít_£c
(),

1702 
lock
->
l_œ°_a˘ivôy
);

1703 
	`LDLM_DEBUG
(
lock
, "server cancels blockedÜockáfter "

1704 
CFS_DURATION_T
"s", 
dñay
);

1705 
	`©_mósuªd
(&
lock
->
l_exp‹t
->
exp_bl_lock_©
, 
dñay
);

1707 
	`ldlm_lock_ˇn˚l
(
lock
);

1708 
	`LDLM_LOCK_PUT
(
lock
);

1710 i‡(
¥es
 !
NULL
) {

1711 
	`ldlm_ª¥o˚ss_Æl
(
¥es
);

1712 
	`LDLM_RESOURCE_DELREF
(
¥es
);

1713 
	`ldlm_ªsour˚_puåef
(
¥es
);

1715 
	`LDLM_DEBUG_NOLOCK
("server-side cancel handler END");

1716 
	`RETURN
(
d⁄e
);

1717 
	}
}

1718 
EXPORT_SYMBOL
(
ldlm_ªque°_ˇn˚l
);

1725 
	$ldlm_h™dÀ_ˇn˚l
(
±Ãpc_ªque°
 *
ªq
)

1727 
ldlm_ªque°
 *
dlm_ªq
;

1728 
rc
;

1729 
ENTRY
;

1731 
dlm_ªq
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

1732 i‡(
dlm_ªq
 =
NULL
) {

1733 
	`CDEBUG
(
D_INFO
, "badÑequest buffer for cancel\n");

1734 
	`RETURN
(-
EFAULT
);

1737 i‡(
ªq
->
rq_exp‹t
 &&Ñeq->rq_exp‹t->
exp_nid_°©s
 &&

1738 
ªq
->
rq_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
)

1739 
	`Õrocfs_cou¡î_ö¸
(
ªq
->
rq_exp‹t
->
exp_nid_°©s
->
nid_ldlm_°©s
,

1740 
LDLM_CANCEL
 - 
LDLM_FIRST_OPC
);

1742 
rc
 = 
	`ªq_ˇpsuÀ_£rvî_∑ck
(&
ªq
->
rq_pûl
);

1743 i‡(
rc
)

1744 
	`RETURN
(
rc
);

1746 i‡(!
	`ldlm_ªque°_ˇn˚l
(
ªq
, 
dlm_ªq
, 0, 
LATF_STATS
))

1747 
ªq
->
rq_°©us
 = 
LUSTRE_ESTALE
;

1749 
	`RETURN
(
	`±Ãpc_ª∂y
(
ªq
));

1750 
	}
}

1758 
	$ldlm_h™dÀ_bl_ˇŒback
(
ldlm_«me•a˚
 *
ns
,

1759 
ldlm_lock_desc
 *
ld
, 
ldlm_lock
 *
lock
)

1761 
do_a°
;

1762 
ENTRY
;

1764 
	`LDLM_DEBUG
(
lock
, "client blocking AST callback handler");

1766 
	`lock_ªs_™d_lock
(
lock
);

1767 
	`ldlm_£t_cb≥ndög
(
lock
);

1769 i‡(
	`ldlm_is_ˇn˚l_⁄_block
(
lock
))

1770 
	`ldlm_£t_ˇn˚l
(
lock
);

1772 
do_a°
 = (!
lock
->
l_ªadîs
 && !lock->
l_wrôîs
);

1773 
	`u∆ock_ªs_™d_lock
(
lock
);

1775 i‡(
do_a°
) {

1776 
	`CDEBUG
(
D_DLMTRACE
, "Lock %pálready unused, calling callback (%p)\n",

1777 
lock
,Üock->
l_blockög_a°
);

1778 i‡(
lock
->
l_blockög_a°
 !
NULL
)

1779 
lock
->
	`l_blockög_a°
÷ock, 
ld
,Üock->
l_a°_d©a
,

1780 
LDLM_CB_BLOCKING
);

1782 
	`CDEBUG
(
D_DLMTRACE
, "Lock %p isÑeferenced, will be cancelledÜater\n",

1783 
lock
);

1786 
	`LDLM_DEBUG
(
lock
, "client blocking callback handler END");

1787 
	`LDLM_LOCK_RELEASE
(
lock
);

1788 
EXIT
;

1789 
	}
}

1796 
	$ldlm_h™dÀ_˝_ˇŒback
(
±Ãpc_ªque°
 *
ªq
,

1797 
ldlm_«me•a˚
 *
ns
,

1798 
ldlm_ªque°
 *
dlm_ªq
,

1799 
ldlm_lock
 *
lock
)

1801 
li°_hód
 
a°_li°
;

1802 
lvb_Àn
;

1803 
rc
 = 0;

1804 
ENTRY
;

1806 
	`LDLM_DEBUG
(
lock
, "client completion callback handler START");

1808 
	`INIT_LIST_HEAD
(&
a°_li°
);

1809 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_CANCEL_BL_CB_RACE
)) {

1810 
to
 = 
	`cfs_time_£c⁄ds
(1);

1811 
to
 > 0) {

1812 
	`£t_cuºít_°©e
(
TASK_INTERRUPTIBLE
);

1813 
	`scheduÀ_timeout
(
to
);

1814 i‡(
lock
->
l_gø¡ed_mode
 =lock->
l_ªq_mode
 ||

1815 
	`ldlm_is_de°royed
(
lock
))

1820 
lvb_Àn
 = 
	`ªq_ˇpsuÀ_gë_size
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
, 
RCL_CLIENT
);

1821 i‡(
lvb_Àn
 < 0) {

1822 
	`LDLM_ERROR
(
lock
, "FaûÅÿgëÜvb_Àn,Ñ¯%d", 
lvb_Àn
);

1823 
	`GOTO
(
out
, 
rc
 = 
lvb_Àn
);

1824 } i‡(
lvb_Àn
 > 0) {

1825 i‡(
lock
->
l_lvb_Àn
 > 0) {

1827 
	`LASSERT
(
lock
->
l_lvb_d©a
 !
NULL
);

1829 i‡(
	`u∆ikñy
(
lock
->
l_lvb_Àn
 < 
lvb_Àn
)) {

1830 
	`LDLM_ERROR
(
lock
, "Replied LVB isÜargerÅhan "

1833 
lock
->
l_lvb_Àn
, 
lvb_Àn
);

1834 
	`GOTO
(
out
, 
rc
 = -
EINVAL
);

1839 
	`lock_ªs_™d_lock
(
lock
);

1840 i‡(
	`ldlm_is_de°royed
(
lock
) ||

1841 
lock
->
l_gø¡ed_mode
 =lock->
l_ªq_mode
) {

1843 
	`u∆ock_ªs_™d_lock
(
lock
);

1844 
	`LDLM_DEBUG
(
lock
, "Double grantÑace happened");

1845 
	`GOTO
(
out
, 
rc
 = 0);

1850 i‡(
dlm_ªq
->
lock_desc
.
l_gø¡ed_mode
 !
lock
->
l_ªq_mode
) {

1851 
lock
->
l_ªq_mode
 = 
dlm_ªq
->
lock_desc
.
l_gø¡ed_mode
;

1852 
	`LDLM_DEBUG
(
lock
, "completion AST,ÇewÜock mode");

1855 i‡(
lock
->
l_ªsour˚
->
Ã_ty≥
 !
LDLM_PLAIN
) {

1856 
	`ldlm_c⁄vît_pﬁicy_to_loˇl
(
ªq
->
rq_exp‹t
,

1857 
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_ty≥
,

1858 &
dlm_ªq
->
lock_desc
.
l_pﬁicy_d©a
,

1859 &
lock
->
l_pﬁicy_d©a
);

1860 
	`LDLM_DEBUG
(
lock
, "completion AST,ÇewÖolicy data");

1863 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

1864 i‡(
	`memcmp
(&
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_«me
,

1865 &
lock
->
l_ªsour˚
->
Ã_«me
,

1866 (
lock
->
l_ªsour˚
->
Ã_«me
)) != 0) {

1867 
	`u∆ock_ªs_™d_lock
(
lock
);

1868 
rc
 = 
	`ldlm_lock_ch™ge_ªsour˚
(
ns
, 
lock
,

1869 &
dlm_ªq
->
lock_desc
.
l_ªsour˚
.
Ã_«me
);

1870 i‡(
rc
 < 0) {

1871 
	`LDLM_ERROR
(
lock
, "FailedÅoállocateÑesource");

1872 
	`GOTO
(
out
, 
rc
);

1874 
	`LDLM_DEBUG
(
lock
, "completion AST,ÇewÑesource");

1875 
	`CERROR
("changeÑesource!\n");

1876 
	`lock_ªs_™d_lock
(
lock
);

1879 i‡(
dlm_ªq
->
lock_Êags
 & 
LDLM_FL_AST_SENT
) {

1882 
	`ldlm_lock_ªmove_‰om_Ãu
(
lock
);

1883 
lock
->
l_Êags
 |
LDLM_FL_CBPENDING
 | 
LDLM_FL_BL_AST
;

1884 
	`LDLM_DEBUG
(
lock
, "completion AST includes blocking AST");

1887 i‡(
lock
->
l_lvb_Àn
 > 0) {

1888 
rc
 = 
	`ldlm_fûl_lvb
(
lock
, &
ªq
->
rq_pûl
, 
RCL_CLIENT
,

1889 
lock
->
l_lvb_d©a
, 
lvb_Àn
);

1890 i‡(
rc
 < 0) {

1891 
	`u∆ock_ªs_™d_lock
(
lock
);

1892 
	`GOTO
(
out
, 
rc
);

1896 
	`ldlm_gø¡_lock
(
lock
, &
a°_li°
);

1897 
	`u∆ock_ªs_™d_lock
(
lock
);

1899 
	`LDLM_DEBUG
(
lock
, "callback handler finished,áboutÅoÑun_ast_work");

1903 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_OSC_CP_ENQ_RACE
, 2);

1905 
	`ldlm_run_a°_w‹k
(
ns
, &
a°_li°
, 
LDLM_WORK_CP_AST
);

1907 
	`LDLM_DEBUG_NOLOCK
("client completion callback handler END (lock %p)",

1908 
lock
);

1909 
	`GOTO
(
out
, 
rc
);

1911 
out
:

1912 i‡(
rc
 < 0) {

1913 
	`lock_ªs_™d_lock
(
lock
);

1914 
	`ldlm_£t_Áûed
(
lock
);

1915 
	`u∆ock_ªs_™d_lock
(
lock
);

1916 
	`wake_up
(&
lock
->
l_waôq
);

1918 
	`LDLM_LOCK_RELEASE
(
lock
);

1919 
	}
}

1928 
	$ldlm_h™dÀ_gl_ˇŒback
(
±Ãpc_ªque°
 *
ªq
,

1929 
ldlm_«me•a˚
 *
ns
,

1930 
ldlm_ªque°
 *
dlm_ªq
,

1931 
ldlm_lock
 *
lock
)

1933 
rc
 = -
ENOSYS
;

1934 
ENTRY
;

1936 
	`LDLM_DEBUG
(
lock
, "client glimpse AST callback handler");

1938 i‡(
lock
->
l_glimp£_a°
 !
NULL
)

1939 
rc
 = 
lock
->
	`l_glimp£_a°
÷ock, 
ªq
);

1941 i‡(
ªq
->
rq_ªpmsg
 !
NULL
) {

1942 
	`±Ãpc_ª∂y
(
ªq
);

1944 
ªq
->
rq_°©us
 = 
rc
;

1945 
	`±Ãpc_îr‹
(
ªq
);

1948 
	`lock_ªs_™d_lock
(
lock
);

1949 i‡(
lock
->
l_gø¡ed_mode
 =
LCK_PW
 &&

1950 !
lock
->
l_ªadîs
 && !lock->
l_wrôîs
 &&

1951 
	`cfs_time_a·î
(
	`cfs_time_cuºít
(),

1952 
	`cfs_time_add
(
lock
->
l_œ°_u£d
,

1953 
	`cfs_time_£c⁄ds
(10)))) {

1954 
	`u∆ock_ªs_™d_lock
(
lock
);

1955 i‡(
	`ldlm_bl_to_thªad_lock
(
ns
, 
NULL
, 
lock
))

1956 
	`ldlm_h™dÀ_bl_ˇŒback
(
ns
, 
NULL
, 
lock
);

1958 
EXIT
;

1961 
	`u∆ock_ªs_™d_lock
(
lock
);

1962 
	`LDLM_LOCK_RELEASE
(
lock
);

1963 
EXIT
;

1964 
	}
}

1966 
	$ldlm_ˇŒback_ª∂y
(
±Ãpc_ªque°
 *
ªq
, 
rc
)

1968 i‡(
ªq
->
rq_no_ª∂y
)

1971 
ªq
->
rq_°©us
 = 
rc
;

1972 i‡(!
ªq
->
rq_∑cked_föÆ
) {

1973 
rc
 = 
	`lu°ª_∑ck_ª∂y
(
ªq
, 1, 
NULL
, NULL);

1974 i‡(
rc
)

1975  
rc
;

1977  
	`±Ãpc_ª∂y
(
ªq
);

1978 
	}
}

1980 
	$__ldlm_bl_to_thªad
(
ldlm_bl_w‹k_ôem
 *
blwi
,

1981 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
)

1983 
ldlm_bl_poﬁ
 *
bÕ
 = 
ldlm_°©e
->ldlm_bl_pool;

1984 
ENTRY
;

1986 
	`•ö_lock
(&
bÕ
->
bÕ_lock
);

1987 i‡(
blwi
->
blwi_lock
 &&

1988 
	`ldlm_is_disˇrd_d©a
(
blwi
->
blwi_lock
)) {

1990 
	`li°_add_èû
(&
blwi
->
blwi_íåy
, &
bÕ
->
bÕ_¥io_li°
);

1993 
	`li°_add_èû
(&
blwi
->
blwi_íåy
, &
bÕ
->
bÕ_li°
);

1995 
	`•ö_u∆ock
(&
bÕ
->
bÕ_lock
);

1997 
	`wake_up
(&
bÕ
->
bÕ_waôq
);

2001 i‡(!(
ˇn˚l_Êags
 & 
LCF_ASYNC
))

2002 
	`waô_f‹_com∂ëi⁄
(&
blwi
->
blwi_comp
);

2004 
	`RETURN
(0);

2005 
	}
}

2007 
ölöe
 
	$öô_blwi
(
ldlm_bl_w‹k_ôem
 *
blwi
,

2008 
ldlm_«me•a˚
 *
ns
,

2009 
ldlm_lock_desc
 *
ld
,

2010 
li°_hód
 *
ˇn˚ls
, 
cou¡
,

2011 
ldlm_lock
 *
lock
,

2012 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
)

2014 
	`öô_com∂ëi⁄
(&
blwi
->
blwi_comp
);

2015 
	`INIT_LIST_HEAD
(&
blwi
->
blwi_hód
);

2017 i‡(
	`mem‹y_¥essuª_gë
())

2018 
blwi
->
blwi_mem_¥essuª
 = 1;

2020 
blwi
->
blwi_ns
 = 
ns
;

2021 
blwi
->
blwi_Êags
 = 
ˇn˚l_Êags
;

2022 i‡(
ld
 !
NULL
)

2023 
blwi
->
blwi_ld
 = *
ld
;

2024 i‡(
cou¡
) {

2025 
	`li°_add
(&
blwi
->
blwi_hód
, 
ˇn˚ls
);

2026 
	`li°_dñ_öô
(
ˇn˚ls
);

2027 
blwi
->
blwi_cou¡
 = 
cou¡
;

2029 
blwi
->
blwi_lock
 = 
lock
;

2031 
	}
}

2042 
	$ldlm_bl_to_thªad
(
ldlm_«me•a˚
 *
ns
,

2043 
ldlm_lock_desc
 *
ld
,

2044 
ldlm_lock
 *
lock
,

2045 
li°_hód
 *
ˇn˚ls
, 
cou¡
,

2046 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
)

2048 
ENTRY
;

2050 i‡(
ˇn˚ls
 && 
cou¡
 == 0)

2051 
	`RETURN
(0);

2053 i‡(
ˇn˚l_Êags
 & 
LCF_ASYNC
) {

2054 
ldlm_bl_w‹k_ôem
 *
blwi
;

2056 
	`OBD_ALLOC
(
blwi
, (*blwi));

2057 i‡(
blwi
 =
NULL
)

2058 
	`RETURN
(-
ENOMEM
);

2059 
	`öô_blwi
(
blwi
, 
ns
, 
ld
, 
ˇn˚ls
, 
cou¡
, 
lock
, 
ˇn˚l_Êags
);

2061 
	`RETURN
(
	`__ldlm_bl_to_thªad
(
blwi
, 
ˇn˚l_Êags
));

2066 
ldlm_bl_w‹k_ôem
 
blwi
;

2068 
	`mem£t
(&
blwi
, 0, (blwi));

2069 
	`öô_blwi
(&
blwi
, 
ns
, 
ld
, 
ˇn˚ls
, 
cou¡
, 
lock
, 
ˇn˚l_Êags
);

2070 
	`RETURN
(
	`__ldlm_bl_to_thªad
(&
blwi
, 
ˇn˚l_Êags
));

2072 
	}
}

2075 
	$ldlm_bl_to_thªad_lock
(
ldlm_«me•a˚
 *
ns
, 
ldlm_lock_desc
 *
ld
,

2076 
ldlm_lock
 *
lock
)

2078  
	`ldlm_bl_to_thªad
(
ns
, 
ld
, 
lock
, 
NULL
, 0, 
LCF_ASYNC
);

2079 
	}
}

2081 
	$ldlm_bl_to_thªad_li°
(
ldlm_«me•a˚
 *
ns
, 
ldlm_lock_desc
 *
ld
,

2082 
li°_hód
 *
ˇn˚ls
, 
cou¡
,

2083 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
)

2085  
	`ldlm_bl_to_thªad
(
ns
, 
ld
, 
NULL
, 
ˇn˚ls
, 
cou¡
, 
ˇn˚l_Êags
);

2086 
	}
}

2088 
	$ldlm_bl_thªad_wakeup
()

2090 
	`wake_up
(&
ldlm_°©e
->
ldlm_bl_poﬁ
->
bÕ_waôq
);

2092 
	}
}

2095 
	$ldlm_h™dÀ_£töfo
(
±Ãpc_ªque°
 *
ªq
)

2097 
obd_devi˚
 *
obd
 = 
ªq
->
rq_exp‹t
->
exp_obd
;

2098 *
key
;

2099 *
vÆ
;

2100 
keyÀn
, 
vÆÀn
;

2101 
rc
 = -
ENOSYS
;

2102 
ENTRY
;

2104 
	`DEBUG_REQ
(
D_HSM
, 
ªq
, "%s: h™dÀ sëöfo\n", 
obd
->
obd_«me
);

2106 
	`ªq_ˇpsuÀ_£t
(&
ªq
->
rq_pûl
, &
RQF_OBD_SET_INFO
);

2108 
key
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_SETINFO_KEY
);

2109 i‡(
key
 =
NULL
) {

2110 
	`DEBUG_REQ
(
D_IOCTL
, 
ªq
, "no set_info key");

2111 
	`RETURN
(-
EFAULT
);

2113 
keyÀn
 = 
	`ªq_ˇpsuÀ_gë_size
(&
ªq
->
rq_pûl
, &
RMF_SETINFO_KEY
,

2114 
RCL_CLIENT
);

2115 
vÆ
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_SETINFO_VAL
);

2116 i‡(
vÆ
 =
NULL
) {

2117 
	`DEBUG_REQ
(
D_IOCTL
, 
ªq
, "no set_info val");

2118 
	`RETURN
(-
EFAULT
);

2120 
vÆÀn
 = 
	`ªq_ˇpsuÀ_gë_size
(&
ªq
->
rq_pûl
, &
RMF_SETINFO_VAL
,

2121 
RCL_CLIENT
);

2125 i‡(
	`KEY_IS
(
KEY_HSM_COPYTOOL_SEND
))

2127 
rc
 = 
	`obd_£t_öfo_async
(
ªq
->
rq_svc_thªad
->
t_ív
,

2128 
ªq
->
rq_exp‹t
,

2129 (
KEY_HSM_COPYTOOL_SEND
),

2130 
KEY_HSM_COPYTOOL_SEND
,

2131 
vÆÀn
, 
vÆ
, 
NULL
);

2133 
	`DEBUG_REQ
(
D_WARNING
, 
ªq
, "ign‹ög unknow¿key %s", 
key
);

2135  
rc
;

2136 
	}
}

2138 
ölöe
 
	$ldlm_ˇŒback_îrmsg
(
±Ãpc_ªque°
 *
ªq
,

2139 c⁄° *
msg
, 
rc
,

2140 
lu°ª_h™dÀ
 *
h™dÀ
)

2142 
	`DEBUG_REQ
((
ªq
->
rq_no_ª∂y
 || 
rc
Ë? 
D_WARNING
 : 
D_DLMTRACE
,Ñeq,

2143 "%s: [nid %s] [r¯%d] [lock "
LPX64
"]",

2144 
msg
, 
	`libcfs_id2°r
(
ªq
->
rq_≥î
), 
rc
,

2145 
h™dÀ
 ? h™dÀ->
cookõ
 : 0);

2146 i‡(
ªq
->
rq_no_ª∂y
)

2147 
	`CWARN
("NoÑeply was sent, maybe cause bug 21636.\n");

2148 i‡(
rc
)

2149 
	`CWARN
("SendÑeply failed, maybe cause bug 21636.\n");

2150 
	}
}

2153 
	$ldlm_ˇŒback_h™dÀr
(
±Ãpc_ªque°
 *
ªq
)

2155 
ldlm_«me•a˚
 *
ns
;

2156 
ldlm_ªque°
 *
dlm_ªq
;

2157 
ldlm_lock
 *
lock
;

2158 
rc
;

2159 
ENTRY
;

2167 i‡(
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
Ë=
SEC_CTX_FINI
)

2168 
	`RETURN
(0);

2170 
	`ªq_ˇpsuÀ_öô
(&
ªq
->
rq_pûl
,Ñeq, 
RCL_SERVER
);

2172 i‡(
ªq
->
rq_exp‹t
 =
NULL
) {

2173 
rc
 = 
	`ldlm_ˇŒback_ª∂y
(
ªq
, -
ENOTCONN
);

2174 
	`ldlm_ˇŒback_îrmsg
(
ªq
, "Operate on unconnected server",

2175 
rc
, 
NULL
);

2176 
	`RETURN
(0);

2179 
	`LASSERT
(
ªq
->
rq_exp‹t
 !
NULL
);

2180 
	`LASSERT
(
ªq
->
rq_exp‹t
->
exp_obd
 !
NULL
);

2182 
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
)) {

2183 
LDLM_BL_CALLBACK
:

2184 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_BL_CALLBACK_NET
)) {

2185 i‡(
cfs_Áû_îr
)

2186 
	`ldlm_ˇŒback_ª∂y
(
ªq
, -()
cfs_Áû_îr
);

2187 
	`RETURN
(0);

2190 
LDLM_CP_CALLBACK
:

2191 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_CP_CALLBACK_NET
))

2192 
	`RETURN
(0);

2194 
LDLM_GL_CALLBACK
:

2195 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_GL_CALLBACK_NET
))

2196 
	`RETURN
(0);

2198 
LDLM_SET_INFO
:

2199 
rc
 = 
	`ldlm_h™dÀ_£töfo
(
ªq
);

2200 
	`ldlm_ˇŒback_ª∂y
(
ªq
, 
rc
);

2201 
	`RETURN
(0);

2202 
LLOG_ORIGIN_HANDLE_CREATE
:

2203 
	`ªq_ˇpsuÀ_£t
(&
ªq
->
rq_pûl
, &
RQF_LLOG_ORIGIN_HANDLE_CREATE
);

2204 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_OBD_LOGD_NET
))

2205 
	`RETURN
(0);

2206 
rc
 = 
	`Œog_‹igö_h™dÀ_›í
(
ªq
);

2207 
	`ldlm_ˇŒback_ª∂y
(
ªq
, 
rc
);

2208 
	`RETURN
(0);

2209 
LLOG_ORIGIN_HANDLE_NEXT_BLOCK
:

2210 
	`ªq_ˇpsuÀ_£t
(&
ªq
->
rq_pûl
,

2211 &
RQF_LLOG_ORIGIN_HANDLE_NEXT_BLOCK
);

2212 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_OBD_LOGD_NET
))

2213 
	`RETURN
(0);

2214 
rc
 = 
	`Œog_‹igö_h™dÀ_√xt_block
(
ªq
);

2215 
	`ldlm_ˇŒback_ª∂y
(
ªq
, 
rc
);

2216 
	`RETURN
(0);

2217 
LLOG_ORIGIN_HANDLE_READ_HEADER
:

2218 
	`ªq_ˇpsuÀ_£t
(&
ªq
->
rq_pûl
,

2219 &
RQF_LLOG_ORIGIN_HANDLE_READ_HEADER
);

2220 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_OBD_LOGD_NET
))

2221 
	`RETURN
(0);

2222 
rc
 = 
	`Œog_‹igö_h™dÀ_ªad_hódî
(
ªq
);

2223 
	`ldlm_ˇŒback_ª∂y
(
ªq
, 
rc
);

2224 
	`RETURN
(0);

2225 
LLOG_ORIGIN_HANDLE_CLOSE
:

2226 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_OBD_LOGD_NET
))

2227 
	`RETURN
(0);

2228 
rc
 = 
	`Œog_‹igö_h™dÀ_˛o£
(
ªq
);

2229 
	`ldlm_ˇŒback_ª∂y
(
ªq
, 
rc
);

2230 
	`RETURN
(0);

2232 
	`CERROR
("unknown opcode %u\n",

2233 
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
));

2234 
	`ldlm_ˇŒback_ª∂y
(
ªq
, -
EPROTO
);

2235 
	`RETURN
(0);

2238 
ns
 = 
ªq
->
rq_exp‹t
->
exp_obd
->
obd_«me•a˚
;

2239 
	`LASSERT
(
ns
 !
NULL
);

2241 
	`ªq_ˇpsuÀ_£t
(&
ªq
->
rq_pûl
, &
RQF_LDLM_CALLBACK
);

2243 
dlm_ªq
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

2244 i‡(
dlm_ªq
 =
NULL
) {

2245 
rc
 = 
	`ldlm_ˇŒback_ª∂y
(
ªq
, -
EPROTO
);

2246 
	`ldlm_ˇŒback_îrmsg
(
ªq
, "O≥øã wôhouà∑ømëî", 
rc
,

2247 
NULL
);

2248 
	`RETURN
(0);

2253 i‡(
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_CANCEL_BL_CB_RACE
) &&

2254 
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
Ë=
LDLM_BL_CALLBACK
) {

2255 
rc
 = 
	`ldlm_˛i_ˇn˚l
(&
dlm_ªq
->
lock_h™dÀ
[0], 0);

2256 i‡(
rc
 < 0)

2257 
	`CERROR
("ldlm_˛i_ˇn˚l: %d\n", 
rc
);

2260 
lock
 = 
	`ldlm_h™dÀ2lock_l⁄g
(&
dlm_ªq
->
lock_h™dÀ
[0], 0);

2261 i‡(!
lock
) {

2262 
	`CDEBUG
(
D_DLMTRACE
, "ˇŒback o¿lock "
LPX64
" -Üock "

2263 "dißµóªd\n", 
dlm_ªq
->
lock_h™dÀ
[0].
cookõ
);

2264 
rc
 = 
	`ldlm_ˇŒback_ª∂y
(
ªq
, -
EINVAL
);

2265 
	`ldlm_ˇŒback_îrmsg
(
ªq
, "O≥øã wôh invÆidÖ¨amëî", 
rc
,

2266 &
dlm_ªq
->
lock_h™dÀ
[0]);

2267 
	`RETURN
(0);

2270 i‡(
	`ldlm_is_Áû_loc
(
lock
) &&

2271 
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
Ë=
LDLM_BL_CALLBACK
)

2272 
	`OBD_RACE
(
OBD_FAIL_LDLM_CP_BL_RACE
);

2275 
	`lock_ªs_™d_lock
(
lock
);

2276 
lock
->
l_Êags
 |
	`ldlm_Êags_‰om_wúe
(
dlm_ªq
->
lock_Êags
 &

2277 
LDLM_FL_AST_MASK
);

2278 i‡(
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
Ë=
LDLM_BL_CALLBACK
) {

2283 i‡((
	`ldlm_is_ˇn˚lög
(
lock
Ë&& 
	`ldlm_is_bl_d⁄e
(lock)) ||

2284 
	`ldlm_is_Áûed
(
lock
)) {

2285 
	`LDLM_DEBUG
(
lock
, "callback onÜock "

2286 
LPX64
" -Üock disappeared\n",

2287 
dlm_ªq
->
lock_h™dÀ
[0].
cookõ
);

2288 
	`u∆ock_ªs_™d_lock
(
lock
);

2289 
	`LDLM_LOCK_RELEASE
(
lock
);

2290 
rc
 = 
	`ldlm_ˇŒback_ª∂y
(
ªq
, -
EINVAL
);

2291 
	`ldlm_ˇŒback_îrmsg
(
ªq
, "O≥øã o¿°Æêlock", 
rc
,

2292 &
dlm_ªq
->
lock_h™dÀ
[0]);

2293 
	`RETURN
(0);

2297 
	`ldlm_lock_ªmove_‰om_Ãu
(
lock
);

2298 
	`ldlm_£t_bl_a°
(
lock
);

2300 
	`u∆ock_ªs_™d_lock
(
lock
);

2311 
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
)) {

2312 
LDLM_BL_CALLBACK
:

2313 
	`CDEBUG
(
D_INODE
, "blockingást\n");

2314 
	`ªq_ˇpsuÀ_exãnd
(&
ªq
->
rq_pûl
, &
RQF_LDLM_BL_CALLBACK
);

2315 i‡(!
	`ldlm_is_ˇn˚l_⁄_block
(
lock
)) {

2316 
rc
 = 
	`ldlm_ˇŒback_ª∂y
(
ªq
, 0);

2317 i‡(
ªq
->
rq_no_ª∂y
 || 
rc
)

2318 
	`ldlm_ˇŒback_îrmsg
(
ªq
, "N‹mÆÖro˚ss", 
rc
,

2319 &
dlm_ªq
->
lock_h™dÀ
[0]);

2321 i‡(
	`ldlm_bl_to_thªad_lock
(
ns
, &
dlm_ªq
->
lock_desc
, 
lock
))

2322 
	`ldlm_h™dÀ_bl_ˇŒback
(
ns
, &
dlm_ªq
->
lock_desc
, 
lock
);

2324 
LDLM_CP_CALLBACK
:

2325 
	`CDEBUG
(
D_INODE
, "completionást\n");

2326 
	`ªq_ˇpsuÀ_exãnd
(&
ªq
->
rq_pûl
, &
RQF_LDLM_CP_CALLBACK
);

2327 
	`ldlm_ˇŒback_ª∂y
(
ªq
, 0);

2328 
	`ldlm_h™dÀ_˝_ˇŒback
(
ªq
, 
ns
, 
dlm_ªq
, 
lock
);

2330 
LDLM_GL_CALLBACK
:

2331 
	`CDEBUG
(
D_INODE
, "glimpseást\n");

2332 
	`ªq_ˇpsuÀ_exãnd
(&
ªq
->
rq_pûl
, &
RQF_LDLM_GL_CALLBACK
);

2333 
	`ldlm_h™dÀ_gl_ˇŒback
(
ªq
, 
ns
, 
dlm_ªq
, 
lock
);

2336 
	`LBUG
();

2339 
	`RETURN
(0);

2340 
	}
}

2342 #ifde‡
HAVE_SERVER_SUPPORT


2348 
	$ldlm_ˇn˚l_h™dÀr
(
±Ãpc_ªque°
 *
ªq
)

2350 
rc
;

2351 
ENTRY
;

2358 
	`ªq_ˇpsuÀ_öô
(&
ªq
->
rq_pûl
,Ñeq, 
RCL_SERVER
);

2360 i‡(
ªq
->
rq_exp‹t
 =
NULL
) {

2361 
ldlm_ªque°
 *
dlm_ªq
;

2363 
	`CERROR
("%s from %sárrivedát %lu with badÉxport cookie "

2364 
LPU64
"\n",

2365 
	`Œ_›code2°r
(
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
)),

2366 
	`libcfs_nid2°r
(
ªq
->
rq_≥î
.
nid
),

2367 
ªq
->
rq_¨rivÆ_time
.
tv_£c
,

2368 
	`lu°ª_msg_gë_h™dÀ
(
ªq
->
rq_ªqmsg
)->
cookõ
);

2370 i‡(
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
Ë=
LDLM_CANCEL
) {

2371 
	`ªq_ˇpsuÀ_£t
(&
ªq
->
rq_pûl
, &
RQF_LDLM_CALLBACK
);

2372 
dlm_ªq
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
,

2373 &
RMF_DLM_REQ
);

2374 i‡(
dlm_ªq
 !
NULL
)

2375 
	`ldlm_lock_dump_h™dÀ
(
D_ERROR
,

2376 &
dlm_ªq
->
lock_h™dÀ
[0]);

2378 
	`ldlm_ˇŒback_ª∂y
(
ªq
, -
ENOTCONN
);

2379 
	`RETURN
(0);

2382 
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
)) {

2385 
LDLM_CANCEL
:

2386 
	`ªq_ˇpsuÀ_£t
(&
ªq
->
rq_pûl
, &
RQF_LDLM_CANCEL
);

2387 
	`CDEBUG
(
D_INODE
, "cancel\n");

2388 i‡(
	`CFS_FAIL_CHECK
(
OBD_FAIL_LDLM_CANCEL_NET
) ||

2389 
	`CFS_FAIL_CHECK
(
OBD_FAIL_PTLRPC_CANCEL_RESEND
) ||

2390 
	`CFS_FAIL_CHECK
(
OBD_FAIL_LDLM_BL_EVICT
))

2391 
	`RETURN
(0);

2392 
rc
 = 
	`ldlm_h™dÀ_ˇn˚l
(
ªq
);

2393 i‡(
rc
)

2395 
	`RETURN
(0);

2397 
	`CERROR
("invalid opcode %d\n",

2398 
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
));

2399 
	`ªq_ˇpsuÀ_£t
(&
ªq
->
rq_pûl
, &
RQF_LDLM_CALLBACK
);

2400 
	`ldlm_ˇŒback_ª∂y
(
ªq
, -
EINVAL
);

2403 
	`RETURN
(0);

2404 
	}
}

2406 
	$ldlm_ˇn˚l_h¥eq_lock_m©ch
(
±Ãpc_ªque°
 *
ªq
,

2407 
ldlm_lock
 *
lock
)

2409 
ldlm_ªque°
 *
dlm_ªq
;

2410 
lu°ª_h™dÀ
 
lockh
;

2411 
rc
 = 0;

2412 
i
;

2413 
ENTRY
;

2415 
dlm_ªq
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

2416 i‡(
dlm_ªq
 =
NULL
)

2417 
	`RETURN
(0);

2419 
	`ldlm_lock2h™dÀ
(
lock
, &
lockh
);

2420 
i
 = 0; i < 
dlm_ªq
->
lock_cou¡
; i++) {

2421 i‡(
	`lu°ª_h™dÀ_equÆ
(&
dlm_ªq
->
lock_h™dÀ
[
i
],

2422 &
lockh
)) {

2423 
	`DEBUG_REQ
(
D_RPCTRACE
, 
ªq
,

2424 "Priÿøi£d byÜock "
LPX64
".", 
lockh
.
cookõ
);

2426 
rc
 = 1;

2431 
	`RETURN
(
rc
);

2433 
	}
}

2435 
	$ldlm_ˇn˚l_h¥eq_check
(
±Ãpc_ªque°
 *
ªq
)

2437 
ldlm_ªque°
 *
dlm_ªq
;

2438 
rc
 = 0;

2439 
i
;

2440 
ENTRY
;

2443 i‡(
	`lu°ª_msg_gë_Êags
(
ªq
->
rq_ªqmsg
Ë& 
MSG_REPLAY
)

2444 
	`RETURN
(0);

2446 
dlm_ªq
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

2447 i‡(
dlm_ªq
 =
NULL
)

2448 
	`RETURN
(-
EFAULT
);

2450 
i
 = 0; i < 
dlm_ªq
->
lock_cou¡
; i++) {

2451 
ldlm_lock
 *
lock
;

2453 
lock
 = 
	`ldlm_h™dÀ2lock
(&
dlm_ªq
->
lock_h™dÀ
[
i
]);

2454 i‡(
lock
 =
NULL
)

2457 
rc
 = 
	`ldlm_is_a°_£¡
(
lock
) ? 1 : 0;

2458 i‡(
rc
)

2459 
	`LDLM_DEBUG
(
lock
, "hpreq cancelÜock");

2460 
	`LDLM_LOCK_PUT
(
lock
);

2462 i‡(
rc
)

2466 
	`RETURN
(
rc
);

2467 
	}
}

2469 
±Ãpc_h¥eq_›s
 
	gldlm_ˇn˚l_h¥eq_›s
 = {

2470 .
h¥eq_lock_m©ch
 = 
ldlm_ˇn˚l_h¥eq_lock_m©ch
,

2471 .
	gh¥eq_check
 = 
ldlm_ˇn˚l_h¥eq_check
,

2472 .
	gh¥eq_föi
 = 
NULL
,

2475 
	$ldlm_h¥eq_h™dÀr
(
±Ãpc_ªque°
 *
ªq
)

2477 
ENTRY
;

2479 
	`ªq_ˇpsuÀ_öô
(&
ªq
->
rq_pûl
,Ñeq, 
RCL_SERVER
);

2481 i‡(
ªq
->
rq_exp‹t
 =
NULL
)

2482 
	`RETURN
(0);

2484 i‡(
LDLM_CANCEL
 =
	`lu°ª_msg_gë_›c
(
ªq
->
rq_ªqmsg
)) {

2485 
	`ªq_ˇpsuÀ_£t
(&
ªq
->
rq_pûl
, &
RQF_LDLM_CANCEL
);

2486 
ªq
->
rq_›s
 = &
ldlm_ˇn˚l_h¥eq_›s
;

2488 
	`RETURN
(0);

2489 
	}
}

2491 
	$ldlm_ªvoke_lock_cb
(
cfs_hash
 *
hs
, 
cfs_hash_bd
 *
bd
,

2492 
hli°_node
 *
hnode
, *
d©a
)

2495 
li°_hód
 *
Ωc_li°
 = 
d©a
;

2496 
ldlm_lock
 *
lock
 = 
	`cfs_hash_obje˘
(
hs
, 
hnode
);

2498 
	`lock_ªs_™d_lock
(
lock
);

2500 i‡(
lock
->
l_ªq_mode
 !lock->
l_gø¡ed_mode
) {

2501 
	`u∆ock_ªs_™d_lock
(
lock
);

2505 
	`LASSERT
(
lock
->
l_ªsour˚
);

2506 i‡(
lock
->
l_ªsour˚
->
Ã_ty≥
 !
LDLM_IBITS
 &&

2507 
lock
->
l_ªsour˚
->
Ã_ty≥
 !
LDLM_PLAIN
) {

2508 
	`u∆ock_ªs_™d_lock
(
lock
);

2512 i‡(
	`ldlm_is_a°_£¡
(
lock
)) {

2513 
	`u∆ock_ªs_™d_lock
(
lock
);

2517 
	`LASSERT
(
lock
->
l_blockög_a°
);

2518 
	`LASSERT
(!
lock
->
l_blockög_lock
);

2520 
	`ldlm_£t_a°_£¡
(
lock
);

2521 i‡(
lock
->
l_exp‹t
 &&Üock->l_exp‹t->
exp_lock_hash
) {

2527 
	`cfs_hash_dñ
(
lock
->
l_exp‹t
->
exp_lock_hash
,

2528 &
lock
->
l_ªmŸe_h™dÀ
, &lock->
l_exp_hash
);

2531 
	`li°_add_èû
(&
lock
->
l_rk_a°
, 
Ωc_li°
);

2532 
	`LDLM_LOCK_GET
(
lock
);

2534 
	`u∆ock_ªs_™d_lock
(
lock
);

2536 
	}
}

2538 
	$ldlm_ªvoke_exp‹t_locks
(
obd_exp‹t
 *
exp
)

2540 
li°_hód
 
Ωc_li°
;

2541 
ENTRY
;

2543 
	`INIT_LIST_HEAD
(&
Ωc_li°
);

2544 
	`cfs_hash_f‹_óch_em±y
(
exp
->
exp_lock_hash
,

2545 
ldlm_ªvoke_lock_cb
, &
Ωc_li°
);

2546 
	`ldlm_run_a°_w‹k
(
exp
->
exp_obd
->
obd_«me•a˚
, &
Ωc_li°
,

2547 
LDLM_WORK_REVOKE_AST
);

2549 
EXIT
;

2550 
	}
}

2551 
EXPORT_SYMBOL
(
ldlm_ªvoke_exp‹t_locks
);

2554 
	$ldlm_bl_gë_w‹k
(
ldlm_bl_poﬁ
 *
bÕ
,

2555 
ldlm_bl_w‹k_ôem
 **
p_blwi
,

2556 
obd_exp‹t
 **
p_exp
)

2558 
ldlm_bl_w‹k_ôem
 *
blwi
 = 
NULL
;

2559 
num_bl
 = 0;

2560 
num_°Æe
;

2561 
num_th
 = 
	`©omic_ªad
(&
bÕ
->
bÕ_num_thªads
);

2563 *
p_exp
 = 
	`obd_°Æe_exp‹t_gë
();

2565 
	`•ö_lock
(&
bÕ
->
bÕ_lock
);

2566 i‡(*
p_exp
 !
NULL
) {

2567 i‡(
num_th
 =1 || ++
num_°Æe
 <Çum_th) {

2568 
	`•ö_u∆ock
(&
bÕ
->
bÕ_lock
);

2571 
num_°Æe
 = 0;

2576 i‡(!
	`li°_em±y
(&
bÕ
->
bÕ_li°
) &&

2577 (
	`li°_em±y
(&
bÕ
->
bÕ_¥io_li°
Ë|| 
num_bl
 == 0))

2578 
blwi
 = 
	`li°_íåy
(
bÕ
->
bÕ_li°
.
√xt
,

2579 
ldlm_bl_w‹k_ôem
, 
blwi_íåy
);

2581 i‡(!
	`li°_em±y
(&
bÕ
->
bÕ_¥io_li°
))

2582 
blwi
 = 
	`li°_íåy
(
bÕ
->
bÕ_¥io_li°
.
√xt
,

2583 
ldlm_bl_w‹k_ôem
,

2584 
blwi_íåy
);

2586 i‡(
blwi
) {

2587 i‡(++
num_bl
 >
num_th
)

2588 
num_bl
 = 0;

2589 
	`li°_dñ
(&
blwi
->
blwi_íåy
);

2591 
	`•ö_u∆ock
(&
bÕ
->
bÕ_lock
);

2592 *
p_blwi
 = 
blwi
;

2594 i‡(*
p_exp
 !
NULL
 && *
p_blwi
 != NULL) {

2595 
	`obd_°Æe_exp‹t_put
(*
p_exp
);

2596 *
p_exp
 = 
NULL
;

2599  (*
p_blwi
 !
NULL
 || *
p_exp
 != NULL) ? 1 : 0;

2600 
	}
}

2603 
	sldlm_bl_thªad_d©a
 {

2604 
ldlm_bl_poﬁ
 *
	mb…d_bÕ
;

2605 
com∂ëi⁄
 
	mb…d_comp
;

2606 
	mb…d_num
;

2609 
ldlm_bl_thªad_maö
(*
¨g
);

2611 
	$ldlm_bl_thªad_°¨t
(
ldlm_bl_poﬁ
 *
bÕ
, 
boﬁ
 
check_busy
)

2613 
ldlm_bl_thªad_d©a
 
b…d
 = { .
b…d_bÕ
 = 
bÕ
 };

2614 
èsk_°ru˘
 *
èsk
;

2616 
	`öô_com∂ëi⁄
(&
b…d
.
b…d_comp
);

2618 
b…d
.
b…d_num
 = 
	`©omic_öc_ªtu∫
(&
bÕ
->
bÕ_num_thªads
);

2619 i‡(
b…d
.
b…d_num
 >
bÕ
->
bÕ_max_thªads
) {

2620 
	`©omic_dec
(&
bÕ
->
bÕ_num_thªads
);

2624 
	`LASSERTF
(
b…d
.
b…d_num
 > 0, "threadÇum:%d\n", bltd.bltd_num);

2625 i‡(
check_busy
 &&

2626 
	`©omic_ªad
(&
bÕ
->
bÕ_busy_thªads
Ë< (
b…d
.
b…d_num
 - 1)) {

2627 
	`©omic_dec
(&
bÕ
->
bÕ_num_thªads
);

2631 
èsk
 = 
	`kthªad_run
(
ldlm_bl_thªad_maö
, &
b…d
, "ldlm_bl_%02d",

2632 
b…d
.
b…d_num
);

2633 i‡(
	`IS_ERR
(
èsk
)) {

2634 
	`CERROR
("cannot start LDLMÅhreadÜdlm_bl_%02d:Ñc %ld\n",

2635 
b…d
.
b…d_num
, 
	`PTR_ERR
(
èsk
));

2636 
	`©omic_dec
(&
bÕ
->
bÕ_num_thªads
);

2637  
	`PTR_ERR
(
èsk
);

2639 
	`waô_f‹_com∂ëi⁄
(&
b…d
.
b…d_comp
);

2642 
	}
}

2645 
	$ldlm_bl_thªad_√ed_¸óã
(
ldlm_bl_poﬁ
 *
bÕ
,

2646 
ldlm_bl_w‹k_ôem
 *
blwi
)

2648 i‡(
	`©omic_ªad
(&
bÕ
->
bÕ_num_thªads
Ë>bÕ->
bÕ_max_thªads
)

2651 i‡(
	`©omic_ªad
(&
bÕ
->
bÕ_busy_thªads
) <

2652 
	`©omic_ªad
(&
bÕ
->
bÕ_num_thªads
))

2655 i‡(
blwi
 !
NULL
 && (blwi->
blwi_ns
 == NULL ||

2656 
blwi
->
blwi_mem_¥essuª
))

2660 
	}
}

2662 
	$ldlm_bl_thªad_blwi
(
ldlm_bl_poﬁ
 *
bÕ
,

2663 
ldlm_bl_w‹k_ôem
 *
blwi
)

2665 
ENTRY
;

2667 i‡(
blwi
->
blwi_ns
 =
NULL
)

2669 
	`RETURN
(
LDLM_ITER_STOP
);

2671 i‡(
blwi
->
blwi_mem_¥essuª
)

2672 
	`mem‹y_¥essuª_£t
();

2674 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_LDLM_PAUSE_CANCEL2
, 4);

2676 i‡(
blwi
->
blwi_cou¡
) {

2677 
cou¡
;

2682 
cou¡
 = 
	`ldlm_˛i_ˇn˚l_li°_loˇl
(&
blwi
->
blwi_hód
,

2683 
blwi
->
blwi_cou¡
,

2684 
LCF_BL_AST
);

2685 
	`ldlm_˛i_ˇn˚l_li°
(&
blwi
->
blwi_hód
, 
cou¡
, 
NULL
,

2686 
blwi
->
blwi_Êags
);

2688 
	`ldlm_h™dÀ_bl_ˇŒback
(
blwi
->
blwi_ns
, &blwi->
blwi_ld
,

2689 
blwi
->
blwi_lock
);

2691 i‡(
blwi
->
blwi_mem_¥essuª
)

2692 
	`mem‹y_¥essuª_˛r
();

2694 i‡(
blwi
->
blwi_Êags
 & 
LCF_ASYNC
)

2695 
	`OBD_FREE
(
blwi
, (*blwi));

2697 
	`com∂ëe
(&
blwi
->
blwi_comp
);

2699 
	`RETURN
(0);

2700 
	}
}

2708 
	$ldlm_bl_thªad_exp‹ts
(
ldlm_bl_poﬁ
 *
bÕ
,

2709 
obd_exp‹t
 *
exp
)

2711 
num
;

2712 
ENTRY
;

2714 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_LDLM_BL_EVICT
, 4);

2716 
num
 = 
	`ldlm_exp‹t_ˇn˚l_blocked_locks
(
exp
);

2717 i‡(
num
 == 0)

2718 
	`ldlm_exp‹t_ˇn˚l_locks
(
exp
);

2720 
	`obd_°Æe_exp‹t_put
(
exp
);

2722 
	`RETURN
(0);

2723 
	}
}

2733 
	$ldlm_bl_thªad_maö
(*
¨g
)

2735 
ldlm_bl_poﬁ
 *
bÕ
;

2736 
ldlm_bl_thªad_d©a
 *
b…d
 = 
¨g
;

2737 
ENTRY
;

2739 
bÕ
 = 
b…d
->
b…d_bÕ
;

2741 
	`com∂ëe
(&
b…d
->
b…d_comp
);

2745 
l_waô_öfo
 
lwi
 = { 0 };

2746 
ldlm_bl_w‹k_ôem
 *
blwi
 = 
NULL
;

2747 
obd_exp‹t
 *
exp
 = 
NULL
;

2748 
rc
;

2750 
rc
 = 
	`ldlm_bl_gë_w‹k
(
bÕ
, &
blwi
, &
exp
);

2752 i‡(
rc
 == 0)

2753 
	`l_waô_evít_ex˛usive
(
bÕ
->
bÕ_waôq
,

2754 
	`ldlm_bl_gë_w‹k
(
bÕ
, &
blwi
,

2755 &
exp
),

2756 &
lwi
);

2757 
	`©omic_öc
(&
bÕ
->
bÕ_busy_thªads
);

2759 i‡(
	`ldlm_bl_thªad_√ed_¸óã
(
bÕ
, 
blwi
))

2761 
	`ldlm_bl_thªad_°¨t
(
bÕ
, 
åue
);

2763 i‡(
exp
)

2764 
rc
 = 
	`ldlm_bl_thªad_exp‹ts
(
bÕ
, 
exp
);

2765 i‡(
blwi
)

2766 
rc
 = 
	`ldlm_bl_thªad_blwi
(
bÕ
, 
blwi
);

2768 
	`©omic_dec
(&
bÕ
->
bÕ_busy_thªads
);

2770 i‡(
rc
 =
LDLM_ITER_STOP
)

2774 
	`©omic_dec
(&
bÕ
->
bÕ_num_thªads
);

2775 
	`com∂ëe
(&
bÕ
->
bÕ_comp
);

2776 
	`RETURN
(0);

2777 
	}
}

2780 
ldlm_£tup
();

2781 
ldlm_˛ónup
();

2783 
	$ldlm_gë_ªf
()

2785 
rc
 = 0;

2786 
ENTRY
;

2787 
	`muãx_lock
(&
ldlm_ªf_muãx
);

2788 i‡(++
ldlm_ªfcou¡
 == 1) {

2789 
rc
 = 
	`ldlm_£tup
();

2790 i‡(
rc
)

2791 
ldlm_ªfcou¡
--;

2793 
	`muãx_u∆ock
(&
ldlm_ªf_muãx
);

2795 
	`RETURN
(
rc
);

2796 
	}
}

2798 
	$ldlm_put_ªf
()

2800 
ENTRY
;

2801 
	`muãx_lock
(&
ldlm_ªf_muãx
);

2802 i‡(
ldlm_ªfcou¡
 == 1) {

2803 
rc
 = 
	`ldlm_˛ónup
();

2804 i‡(
rc
)

2805 
	`CERROR
("ldlm_˛ónu∞Áûed: %d\n", 
rc
);

2807 
ldlm_ªfcou¡
--;

2809 
ldlm_ªfcou¡
--;

2811 
	`muãx_u∆ock
(&
ldlm_ªf_muãx
);

2813 
EXIT
;

2814 
	}
}

2820 
	$ldlm_exp‹t_lock_hash
(
cfs_hash
 *
hs
, c⁄° *
key
, 
mask
)

2822  
	`cfs_hash_u64_hash
(((
lu°ª_h™dÀ
 *)
key
)->
cookõ
, 
mask
);

2823 
	}
}

2826 
	$ldlm_exp‹t_lock_key
(
hli°_node
 *
hnode
)

2828 
ldlm_lock
 *
lock
;

2830 
lock
 = 
	`hli°_íåy
(
hnode
, 
ldlm_lock
, 
l_exp_hash
);

2831  &
lock
->
l_ªmŸe_h™dÀ
;

2832 
	}
}

2835 
	$ldlm_exp‹t_lock_key˝y
(
hli°_node
 *
hnode
, *
key
)

2837 
ldlm_lock
 *
lock
;

2839 
lock
 = 
	`hli°_íåy
(
hnode
, 
ldlm_lock
, 
l_exp_hash
);

2840 
lock
->
l_ªmŸe_h™dÀ
 = *(
lu°ª_h™dÀ
 *)
key
;

2841 
	}
}

2844 
	$ldlm_exp‹t_lock_keycmp
(c⁄° *
key
, 
hli°_node
 *
hnode
)

2846  
	`lu°ª_h™dÀ_equÆ
(
	`ldlm_exp‹t_lock_key
(
hnode
), 
key
);

2847 
	}
}

2850 
	$ldlm_exp‹t_lock_obje˘
(
hli°_node
 *
hnode
)

2852  
	`hli°_íåy
(
hnode
, 
ldlm_lock
, 
l_exp_hash
);

2853 
	}
}

2856 
	$ldlm_exp‹t_lock_gë
(
cfs_hash
 *
hs
, 
hli°_node
 *
hnode
)

2858 
ldlm_lock
 *
lock
;

2860 
lock
 = 
	`hli°_íåy
(
hnode
, 
ldlm_lock
, 
l_exp_hash
);

2861 
	`LDLM_LOCK_GET
(
lock
);

2862 
	}
}

2865 
	$ldlm_exp‹t_lock_put
(
cfs_hash
 *
hs
, 
hli°_node
 *
hnode
)

2867 
ldlm_lock
 *
lock
;

2869 
lock
 = 
	`hli°_íåy
(
hnode
, 
ldlm_lock
, 
l_exp_hash
);

2870 
	`LDLM_LOCK_RELEASE
(
lock
);

2871 
	}
}

2873 
cfs_hash_›s
 
	gldlm_exp‹t_lock_›s
 = {

2874 .
hs_hash
 = 
ldlm_exp‹t_lock_hash
,

2875 .
	ghs_key
 = 
ldlm_exp‹t_lock_key
,

2876 .
	ghs_keycmp
 = 
ldlm_exp‹t_lock_keycmp
,

2877 .
	ghs_key˝y
 = 
ldlm_exp‹t_lock_key˝y
,

2878 .
	ghs_obje˘
 = 
ldlm_exp‹t_lock_obje˘
,

2879 .
	ghs_gë
 = 
ldlm_exp‹t_lock_gë
,

2880 .
	ghs_put
 = 
ldlm_exp‹t_lock_put
,

2881 .
	ghs_put_locked
 = 
ldlm_exp‹t_lock_put
,

2884 
	$ldlm_öô_exp‹t
(
obd_exp‹t
 *
exp
)

2886 
rc
;

2887 
ENTRY
;

2889 
exp
->
exp_lock_hash
 =

2890 
	`cfs_hash_¸óã
(
	`obd_uuid2°r
(&
exp
->
exp_˛õ¡_uuid
),

2891 
HASH_EXP_LOCK_CUR_BITS
,

2892 
HASH_EXP_LOCK_MAX_BITS
,

2893 
HASH_EXP_LOCK_BKT_BITS
, 0,

2894 
CFS_HASH_MIN_THETA
, 
CFS_HASH_MAX_THETA
,

2895 &
ldlm_exp‹t_lock_›s
,

2896 
CFS_HASH_DEFAULT
 | 
CFS_HASH_REHASH_KEY
 |

2897 
CFS_HASH_NBLK_CHANGE
);

2899 i‡(!
exp
->
exp_lock_hash
)

2900 
	`RETURN
(-
ENOMEM
);

2902 
rc
 = 
	`ldlm_öô_Êock_exp‹t
(
exp
);

2903 i‡(
rc
)

2904 
	`GOTO
(
îr
, 
rc
);

2906 
	`RETURN
(0);

2907 
îr
:

2908 
	`ldlm_de°roy_exp‹t
(
exp
);

2909 
	`RETURN
(
rc
);

2910 
	}
}

2911 
EXPORT_SYMBOL
(
ldlm_öô_exp‹t
);

2913 
	$ldlm_de°roy_exp‹t
(
obd_exp‹t
 *
exp
)

2915 
ENTRY
;

2916 
	`cfs_hash_puåef
(
exp
->
exp_lock_hash
);

2917 
exp
->
exp_lock_hash
 = 
NULL
;

2919 
	`ldlm_de°roy_Êock_exp‹t
(
exp
);

2920 
EXIT
;

2921 
	}
}

2922 
EXPORT_SYMBOL
(
ldlm_de°roy_exp‹t
);

2924 
	$ldlm_£tup
()

2926 
±Ãpc_£rvi˚_c⁄f
 
c⁄f
;

2927 
ldlm_bl_poﬁ
 *
bÕ
 = 
NULL
;

2928 #ifde‡
HAVE_SERVER_SUPPORT


2929 
èsk_°ru˘
 *
èsk
;

2931 
i
;

2932 
rc
 = 0;

2934 
ENTRY
;

2936 i‡(
ldlm_°©e
 !
NULL
)

2937 
	`RETURN
(-
EALREADY
);

2939 
	`OBD_ALLOC
(
ldlm_°©e
, (*ldlm_state));

2940 i‡(
ldlm_°©e
 =
NULL
)

2941 
	`RETURN
(-
ENOMEM
);

2943 #ifde‡
CONFIG_PROC_FS


2944 
rc
 = 
	`ldlm_¥oc_£tup
();

2945 i‡(
rc
 != 0)

2946 
	`GOTO
(
out
, 
rc
);

2949 
	`mem£t
(&
c⁄f
, 0, (conf));

2950 
c⁄f
 = (
	`ty≥of
(conf)) {

2951 .
psc_«me
 = "ldlm_cbd",

2952 .
psc_w©chdog_Á˘‹
 = 2,

2953 .
psc_buf
 = {

2954 .
bc_nbufs
 = 
LDLM_CLIENT_NBUFS
,

2955 .
bc_buf_size
 = 
LDLM_BUFSIZE
,

2956 .
bc_ªq_max_size
 = 
LDLM_MAXREQSIZE
,

2957 .
bc_ªp_max_size
 = 
LDLM_MAXREPSIZE
,

2958 .
bc_ªq_p‹èl
 = 
LDLM_CB_REQUEST_PORTAL
,

2959 .
bc_ªp_p‹èl
 = 
LDLM_CB_REPLY_PORTAL
,

2961 .
psc_thr
 = {

2962 .
tc_thr_«me
 = "ldlm_cb",

2963 .
tc_thr_Á˘‹
 = 
LDLM_THR_FACTOR
,

2964 .
tc_¡hrs_öô
 = 
LDLM_NTHRS_INIT
,

2965 .
tc_¡hrs_ba£
 = 
LDLM_NTHRS_BASE
,

2966 .
tc_¡hrs_max
 = 
LDLM_NTHRS_MAX
,

2967 .
tc_¡hrs_u£r
 = 
ldlm_num_thªads
,

2968 .
tc_˝u_afföôy
 = 1,

2969 .
tc_˘x_ègs
 = 
LCT_MD_THREAD
 | 
LCT_DT_THREAD
,

2971 .
psc_˝t
 = {

2972 .
cc_∑âîn
 = 
ldlm_˝ts
,

2974 .
psc_›s
 = {

2975 .
so_ªq_h™dÀr
 = 
ldlm_ˇŒback_h™dÀr
,

2978 
ldlm_°©e
->
ldlm_cb_£rvi˚
 = \

2979 
	`±Ãpc_ªgi°î_£rvi˚
(&
c⁄f
, 
ldlm_svc_¥oc_dú
);

2980 i‡(
	`IS_ERR
(
ldlm_°©e
->
ldlm_cb_£rvi˚
)) {

2981 
	`CERROR
("failedÅo start service\n");

2982 
rc
 = 
	`PTR_ERR
(
ldlm_°©e
->
ldlm_cb_£rvi˚
);

2983 
ldlm_°©e
->
ldlm_cb_£rvi˚
 = 
NULL
;

2984 
	`GOTO
(
out
, 
rc
);

2987 #ifde‡
HAVE_SERVER_SUPPORT


2988 
	`mem£t
(&
c⁄f
, 0, (conf));

2989 
c⁄f
 = (
	`ty≥of
(conf)) {

2990 .
psc_«me
 = "ldlm_canceld",

2991 .
psc_w©chdog_Á˘‹
 = 6,

2992 .
psc_buf
 = {

2993 .
bc_nbufs
 = 
LDLM_SERVER_NBUFS
,

2994 .
bc_buf_size
 = 
LDLM_BUFSIZE
,

2995 .
bc_ªq_max_size
 = 
LDLM_MAXREQSIZE
,

2996 .
bc_ªp_max_size
 = 
LDLM_MAXREPSIZE
,

2997 .
bc_ªq_p‹èl
 = 
LDLM_CANCEL_REQUEST_PORTAL
,

2998 .
bc_ªp_p‹èl
 = 
LDLM_CANCEL_REPLY_PORTAL
,

3001 .
psc_thr
 = {

3002 .
tc_thr_«me
 = "ldlm_cn",

3003 .
tc_thr_Á˘‹
 = 
LDLM_THR_FACTOR
,

3004 .
tc_¡hrs_öô
 = 
LDLM_NTHRS_INIT
,

3005 .
tc_¡hrs_ba£
 = 
LDLM_NTHRS_BASE
,

3006 .
tc_¡hrs_max
 = 
LDLM_NTHRS_MAX
,

3007 .
tc_¡hrs_u£r
 = 
ldlm_num_thªads
,

3008 .
tc_˝u_afföôy
 = 1,

3009 .
tc_˘x_ègs
 = 
LCT_MD_THREAD
 | \

3010 
LCT_DT_THREAD
 | \

3011 
LCT_CL_THREAD
,

3013 .
psc_˝t
 = {

3014 .
cc_∑âîn
 = 
ldlm_˝ts
,

3016 .
psc_›s
 = {

3017 .
so_ªq_h™dÀr
 = 
ldlm_ˇn˚l_h™dÀr
,

3018 .
so_h¥eq_h™dÀr
 = 
ldlm_h¥eq_h™dÀr
,

3021 
ldlm_°©e
->
ldlm_ˇn˚l_£rvi˚
 = \

3022 
	`±Ãpc_ªgi°î_£rvi˚
(&
c⁄f
, 
ldlm_svc_¥oc_dú
);

3023 i‡(
	`IS_ERR
(
ldlm_°©e
->
ldlm_ˇn˚l_£rvi˚
)) {

3024 
	`CERROR
("failedÅo start service\n");

3025 
rc
 = 
	`PTR_ERR
(
ldlm_°©e
->
ldlm_ˇn˚l_£rvi˚
);

3026 
ldlm_°©e
->
ldlm_ˇn˚l_£rvi˚
 = 
NULL
;

3027 
	`GOTO
(
out
, 
rc
);

3031 
	`OBD_ALLOC
(
bÕ
, (*blp));

3032 i‡(
bÕ
 =
NULL
)

3033 
	`GOTO
(
out
, 
rc
 = -
ENOMEM
);

3034 
ldlm_°©e
->
ldlm_bl_poﬁ
 = 
bÕ
;

3036 
	`•ö_lock_öô
(&
bÕ
->
bÕ_lock
);

3037 
	`INIT_LIST_HEAD
(&
bÕ
->
bÕ_li°
);

3038 
	`INIT_LIST_HEAD
(&
bÕ
->
bÕ_¥io_li°
);

3039 
	`öô_waôqueue_hód
(&
bÕ
->
bÕ_waôq
);

3040 
	`©omic_£t
(&
bÕ
->
bÕ_num_thªads
, 0);

3041 
	`©omic_£t
(&
bÕ
->
bÕ_busy_thªads
, 0);

3043 i‡(
ldlm_num_thªads
 == 0) {

3044 
bÕ
->
bÕ_mö_thªads
 = 
LDLM_NTHRS_INIT
;

3045 
bÕ
->
bÕ_max_thªads
 = 
LDLM_NTHRS_MAX
;

3047 
bÕ
->
bÕ_mö_thªads
 = bÕ->
bÕ_max_thªads
 = \

3048 
	`mö_t
(, 
LDLM_NTHRS_MAX
, 
	`max_t
(, 
LDLM_NTHRS_INIT
,

3049 
ldlm_num_thªads
));

3052 
i
 = 0; i < 
bÕ
->
bÕ_mö_thªads
; i++) {

3053 
rc
 = 
	`ldlm_bl_thªad_°¨t
(
bÕ
, 
Ál£
);

3054 i‡(
rc
 < 0)

3055 
	`GOTO
(
out
, 
rc
);

3058 #ifde‡
HAVE_SERVER_SUPPORT


3059 
	`INIT_LIST_HEAD
(&
expúed_lock_thªad
.
ñt_expúed_locks
);

3060 
expúed_lock_thªad
.
ñt_°©e
 = 
ELT_STOPPED
;

3061 
	`öô_waôqueue_hód
(&
expúed_lock_thªad
.
ñt_waôq
);

3063 
	`INIT_LIST_HEAD
(&
waôög_locks_li°
);

3064 
	`•ö_lock_öô
(&
waôög_locks_•ölock
);

3065 
	`cfs_timî_öô
(&
waôög_locks_timî
, 
waôög_locks_ˇŒback
, 
NULL
);

3067 
èsk
 = 
	`kthªad_run
(
expúed_lock_maö
, 
NULL
, "ldlm_elt");

3068 i‡(
	`IS_ERR
(
èsk
)) {

3069 
rc
 = 
	`PTR_ERR
(
èsk
);

3070 
	`CERROR
("C™nŸ sèπÜdlmÉxpúed-lockÅhªad: %d\n", 
rc
);

3071 
	`GOTO
(
out
, 
rc
);

3074 
	`waô_evít
(
expúed_lock_thªad
.
ñt_waôq
,

3075 
expúed_lock_thªad
.
ñt_°©e
 =
ELT_READY
);

3078 
rc
 = 
	`ldlm_poﬁs_öô
();

3079 i‡(
rc
) {

3080 
	`CERROR
("FaûedÅÿöôülizêLDLMÖoﬁs: %d\n", 
rc
);

3081 
	`GOTO
(
out
, 
rc
);

3084 
rc
 = 
	`ldlm_ª˛aim_£tup
();

3085 i‡(
rc
) {

3086 
	`CERROR
("FaûedÅÿ£tu∞ª˛aimÅhªad:Ñ¯%d\n", 
rc
);

3087 
	`GOTO
(
out
, 
rc
);

3089 
	`RETURN
(0);

3091 
out
:

3092 
	`ldlm_˛ónup
();

3093 
	`RETURN
(
rc
);

3094 
	}
}

3096 
	$ldlm_˛ónup
()

3098 
ENTRY
;

3100 i‡(!
	`li°_em±y
(
	`ldlm_«me•a˚_li°
(
LDLM_NAMESPACE_SERVER
)) ||

3101 !
	`li°_em±y
(
	`ldlm_«me•a˚_li°
(
LDLM_NAMESPACE_CLIENT
))) {

3102 
	`CERROR
("ldlm still hasÇamespaces; cleanÅhese up first.\n");

3103 
	`ldlm_dump_Æl_«me•a˚s
(
LDLM_NAMESPACE_SERVER
, 
D_DLMTRACE
);

3104 
	`ldlm_dump_Æl_«me•a˚s
(
LDLM_NAMESPACE_CLIENT
, 
D_DLMTRACE
);

3105 
	`RETURN
(-
EBUSY
);

3108 
	`ldlm_ª˛aim_˛ónup
();

3109 
	`ldlm_poﬁs_föi
();

3111 i‡(
ldlm_°©e
->
ldlm_bl_poﬁ
 !
NULL
) {

3112 
ldlm_bl_poﬁ
 *
bÕ
 = 
ldlm_°©e
->ldlm_bl_pool;

3114 
	`©omic_ªad
(&
bÕ
->
bÕ_num_thªads
) > 0) {

3115 
ldlm_bl_w‹k_ôem
 
blwi
 = { .
blwi_ns
 = 
NULL
 };

3117 
	`öô_com∂ëi⁄
(&
bÕ
->
bÕ_comp
);

3119 
	`•ö_lock
(&
bÕ
->
bÕ_lock
);

3120 
	`li°_add_èû
(&
blwi
.
blwi_íåy
, &
bÕ
->
bÕ_li°
);

3121 
	`wake_up
(&
bÕ
->
bÕ_waôq
);

3122 
	`•ö_u∆ock
(&
bÕ
->
bÕ_lock
);

3124 
	`waô_f‹_com∂ëi⁄
(&
bÕ
->
bÕ_comp
);

3127 
	`OBD_FREE
(
bÕ
, (*blp));

3130 i‡(
ldlm_°©e
->
ldlm_cb_£rvi˚
 !
NULL
)

3131 
	`±Ãpc_uƒegi°î_£rvi˚
(
ldlm_°©e
->
ldlm_cb_£rvi˚
);

3132 #ifde‡
HAVE_SERVER_SUPPORT


3133 i‡(
ldlm_°©e
->
ldlm_ˇn˚l_£rvi˚
 !
NULL
)

3134 
	`±Ãpc_uƒegi°î_£rvi˚
(
ldlm_°©e
->
ldlm_ˇn˚l_£rvi˚
);

3137 
	`ldlm_¥oc_˛ónup
();

3139 #ifde‡
HAVE_SERVER_SUPPORT


3140 i‡(
expúed_lock_thªad
.
ñt_°©e
 !
ELT_STOPPED
) {

3141 
expúed_lock_thªad
.
ñt_°©e
 = 
ELT_TERMINATE
;

3142 
	`wake_up
(&
expúed_lock_thªad
.
ñt_waôq
);

3143 
	`waô_evít
(
expúed_lock_thªad
.
ñt_waôq
,

3144 
expúed_lock_thªad
.
ñt_°©e
 =
ELT_STOPPED
);

3148 
	`OBD_FREE
(
ldlm_°©e
, (*ldlm_state));

3149 
ldlm_°©e
 = 
NULL
;

3151 
	`RETURN
(0);

3152 
	}
}

3154 
	$ldlm_öô
()

3156 
	`muãx_öô
(&
ldlm_ªf_muãx
);

3157 
	`muãx_öô
(
	`ldlm_«me•a˚_lock
(
LDLM_NAMESPACE_SERVER
));

3158 
	`muãx_öô
(
	`ldlm_«me•a˚_lock
(
LDLM_NAMESPACE_CLIENT
));

3160 
	`INIT_LIST_HEAD
(&
ldlm_§v_«me•a˚_li°
);

3161 
	`INIT_LIST_HEAD
(&
ldlm_˛i_a˘ive_«me•a˚_li°
);

3162 
	`INIT_LIST_HEAD
(&
ldlm_˛i_öa˘ive_«me•a˚_li°
);

3164 
ldlm_ªsour˚_¶ab
 = 
	`kmem_ˇche_¸óã
("ldlm_resources",

3165 (
ldlm_ªsour˚
), 0,

3166 
SLAB_HWCACHE_ALIGN
, 
NULL
);

3167 i‡(
ldlm_ªsour˚_¶ab
 =
NULL
)

3168  -
ENOMEM
;

3170 
ldlm_lock_¶ab
 = 
	`kmem_ˇche_¸óã
("ldlm_locks",

3171 (
ldlm_lock
), 0,

3172 
SLAB_HWCACHE_ALIGN
 | 
SLAB_DESTROY_BY_RCU
, 
NULL
);

3173 i‡(
ldlm_lock_¶ab
 =
NULL
)

3174 
out_ªsour˚
;

3176 
ldlm_öãrvÆ_¶ab
 = 
	`kmem_ˇche_¸óã
("interval_node",

3177 (
ldlm_öãrvÆ
),

3178 0, 
SLAB_HWCACHE_ALIGN
, 
NULL
);

3179 i‡(
ldlm_öãrvÆ_¶ab
 =
NULL
)

3180 
out_lock
;

3182 
ldlm_öãrvÆ_åì_¶ab
 = 
	`kmem_ˇche_¸óã
("interval_tree",

3183 (
ldlm_öãrvÆ_åì
Ë* 
LCK_MODE_NUM
,

3184 0, 
SLAB_HWCACHE_ALIGN
, 
NULL
);

3185 i‡(
ldlm_öãrvÆ_åì_¶ab
 =
NULL
)

3186 
out_öãrvÆ
;

3188 #i‡
LUSTRE_TRACKS_LOCK_EXP_REFS


3189 
˛ass_exp‹t_dump_hook
 = 
ldlm_dump_exp‹t_locks
;

3193 
out_öãrvÆ
:

3194 
	`kmem_ˇche_de°roy
(
ldlm_öãrvÆ_¶ab
);

3195 
out_lock
:

3196 
	`kmem_ˇche_de°roy
(
ldlm_lock_¶ab
);

3197 
out_ªsour˚
:

3198 
	`kmem_ˇche_de°roy
(
ldlm_ªsour˚_¶ab
);

3200  -
ENOMEM
;

3201 
	}
}

3203 
	$ldlm_exô
()

3205 i‡(
ldlm_ªfcou¡
)

3206 
	`CERROR
("ldlm_ªfcou¡ i†%d i¿ldlm_exô!\n", 
ldlm_ªfcou¡
);

3207 
	`kmem_ˇche_de°roy
(
ldlm_ªsour˚_¶ab
);

3211 
	`synchr⁄ize_rcu
();

3212 
	`kmem_ˇche_de°roy
(
ldlm_lock_¶ab
);

3213 
	`kmem_ˇche_de°roy
(
ldlm_öãrvÆ_¶ab
);

3214 
	`kmem_ˇche_de°roy
(
ldlm_öãrvÆ_åì_¶ab
);

3215 
	}
}

	@ldlm_plain.c

53 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

55 
	~<lu°ª_dlm.h
>

56 
	~<obd_suµ‹t.h
>

57 
	~<lu°ª_lib.h
>

59 
	~"ldlm_öã∫Æ.h
"

61 #ifde‡
HAVE_SERVER_SUPPORT


71 
ölöe
 

72 
	$ldlm_∂aö_com∑t_queue
(
li°_hód
 *
queue
, 
ldlm_lock
 *
ªq
,

73 
li°_hód
 *
w‹k_li°
)

75 
ldlm_mode
 
ªq_mode
 = 
ªq
->
l_ªq_mode
;

76 
ldlm_lock
 *
lock
;

77 
li°_hód
 *
tmp
;

78 
com∑t
 = 1;

79 
ENTRY
;

81 
	`lockmode_vîify
(
ªq_mode
);

83 
	`li°_f‹_óch_íåy
(
lock
, 
queue
, 
l_ªs_lök
) {

87 i‡(
ªq
 =
lock
)

88 
	`RETURN
(
com∑t
);

91 
tmp
 = &
	`li°_íåy
(
lock
->
l_¶_mode
.
¥ev
, 
ldlm_lock
,

92 
l_¶_mode
)->
l_ªs_lök
;

94 i‡(
	`lockmode_com∑t
(
lock
->
l_ªq_mode
, 
ªq_mode
))

97 i‡(!
w‹k_li°
)

98 
	`RETURN
(0);

100 
com∑t
 = 0;

104 i‡(
lock
->
l_blockög_a°
)

105 
	`ldlm_add_a°_w‹k_ôem
(
lock
, 
ªq
, 
w‹k_li°
);

108 
li°_hód
 *
hód
;

110 
hód
 = &
lock
->
l_¶_mode
;

111 
	`li°_f‹_óch_íåy
(
lock
, 
hód
, 
l_¶_mode
)

112 i‡(
lock
->
l_blockög_a°
)

113 
	`ldlm_add_a°_w‹k_ôem
(
lock
, 
ªq
,

114 
w‹k_li°
);

118 
	`RETURN
(
com∑t
);

119 
	}
}

136 
	$ldlm_¥o˚ss_∂aö_lock
(
ldlm_lock
 *
lock
, 
__u64
 *
Êags
,

137 
fú°_íq
, 
ldlm_îr‹
 *
îr
,

138 
li°_hód
 *
w‹k_li°
)

140 
ldlm_ªsour˚
 *
ªs
 = 
lock
->
l_ªsour˚
;

141 
li°_hód
 
Ωc_li°
;

142 
rc
;

143 
ENTRY
;

145 
	`LASSERT
(
lock
->
l_gø¡ed_mode
 !lock->
l_ªq_mode
);

146 
	`check_ªs_locked
(
ªs
);

147 
	`LASSERT
(
	`li°_em±y
(&
ªs
->
Ã_c⁄vîtög
));

148 
	`INIT_LIST_HEAD
(&
Ωc_li°
);

150 i‡(!
fú°_íq
) {

151 
	`LASSERT
(
w‹k_li°
 !
NULL
);

152 
rc
 = 
	`ldlm_∂aö_com∑t_queue
(&
ªs
->
Ã_gø¡ed
, 
lock
, 
NULL
);

153 i‡(!
rc
)

154 
	`RETURN
(
LDLM_ITER_STOP
);

155 
rc
 = 
	`ldlm_∂aö_com∑t_queue
(&
ªs
->
Ã_waôög
, 
lock
, 
NULL
);

156 i‡(!
rc
)

157 
	`RETURN
(
LDLM_ITER_STOP
);

159 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

160 
	`ldlm_gø¡_lock
(
lock
, 
w‹k_li°
);

161 
	`RETURN
(
LDLM_ITER_CONTINUE
);

164 
ª°¨t
:

165 
rc
 = 
	`ldlm_∂aö_com∑t_queue
(&
ªs
->
Ã_gø¡ed
, 
lock
, &
Ωc_li°
);

166 
rc
 +
	`ldlm_∂aö_com∑t_queue
(&
ªs
->
Ã_waôög
, 
lock
, &
Ωc_li°
);

168 i‡(
rc
 != 2) {

175 i‡(
	`li°_em±y
(&
lock
->
l_ªs_lök
))

176 
	`ldlm_ªsour˚_add_lock
(
ªs
, &ªs->
Ã_waôög
, 
lock
);

177 
	`u∆ock_ªs
(
ªs
);

178 
rc
 = 
	`ldlm_run_a°_w‹k
(
	`ldlm_ªs_to_ns
(
ªs
), &
Ωc_li°
,

179 
LDLM_WORK_BL_AST
);

180 
	`lock_ªs
(
ªs
);

181 i‡(
rc
 =-
ERESTART
)

182 
	`GOTO
(
ª°¨t
, 
rc
);

183 *
Êags
 |
LDLM_FL_BLOCK_GRANTED
;

185 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

186 
	`ldlm_gø¡_lock
(
lock
, 
NULL
);

188 
	`RETURN
(0);

189 
	}
}

192 
	$ldlm_∂aö_pﬁicy_wúe_to_loˇl
(c⁄° 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
,

193 
ldlm_pﬁicy_d©a
 *
Õﬁicy
)

196 
	}
}

198 
	$ldlm_∂aö_pﬁicy_loˇl_to_wúe
(c⁄° 
ldlm_pﬁicy_d©a
 *
Õﬁicy
,

199 
ldlm_wúe_pﬁicy_d©a
 *
wpﬁicy
)

202 
	}
}

	@ldlm_pool.c

98 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

100 
	~<löux/kthªad.h
>

101 
	~<lu°ª_dlm.h
>

102 
	~<˛_obje˘.h
>

103 
	~<obd_˛ass.h
>

104 
	~<obd_suµ‹t.h
>

105 
	~"ldlm_öã∫Æ.h
"

107 #ifde‡
HAVE_LRU_RESIZE_SUPPORT


112 
	#LDLM_POOL_HOST_L
 ((
NUM_CACHEPAGES
 >> (20 - 
PAGE_CACHE_SHIFT
)Ë* 50)

	)

117 
	#LDLM_POOL_MAX_GSP
 (30)

	)

122 
	#LDLM_POOL_MIN_GSP
 (1)

	)

128 
	#LDLM_POOL_GSP_STEP_SHIFT
 (2)

	)

133 
	#LDLM_POOL_GP
(
L
Ë(((LË* 
LDLM_POOL_MAX_GSP
Ë/ 100)

	)

138 
	#LDLM_POOL_MAX_AGE
 (36000)

	)

143 
	#LDLM_POOL_SLV_SHIFT
 (10)

	)

145 
¥oc_dú_íåy
 *
ldlm_ns_¥oc_dú
;

147 
ölöe
 
__u64
 
	$dru
(
__u64
 
vÆ
, 
__u32
 
shi·
, 
round_up
)

149  (
vÆ
 + (
round_up
 ? (1 << 
shi·
) - 1 : 0)) >> shift;

150 
	}
}

152 
ölöe
 
__u64
 
	$ldlm_poﬁ_¶v_max
(
__u32
 
L
)

158 
__u64
 
lim
 = (__u64)
L
 * 
LDLM_POOL_MAX_AGE
 / 1;

159  
lim
;

160 
	}
}

162 
ölöe
 
__u64
 
	$ldlm_poﬁ_¶v_mö
(
__u32
 
L
)

165 
	}
}

168 
	mLDLM_POOL_FIRST_STAT
 = 0,

169 
	mLDLM_POOL_GRANTED_STAT
 = 
LDLM_POOL_FIRST_STAT
,

170 
	mLDLM_POOL_GRANT_STAT
,

171 
	mLDLM_POOL_CANCEL_STAT
,

172 
	mLDLM_POOL_GRANT_RATE_STAT
,

173 
	mLDLM_POOL_CANCEL_RATE_STAT
,

174 
	mLDLM_POOL_GRANT_PLAN_STAT
,

175 
	mLDLM_POOL_SLV_STAT
,

176 
	mLDLM_POOL_SHRINK_REQTD_STAT
,

177 
	mLDLM_POOL_SHRINK_FREED_STAT
,

178 
	mLDLM_POOL_RECALC_STAT
,

179 
	mLDLM_POOL_TIMING_STAT
,

180 
	mLDLM_POOL_LAST_STAT


183 
ölöe
 
ldlm_«me•a˚
 *
	$ldlm_∂2ns
(
ldlm_poﬁ
 *
∂
)

185  
	`c⁄èöî_of
(
∂
, 
ldlm_«me•a˚
, 
ns_poﬁ
);

186 
	}
}

192 
ölöe
 
	$ldlm_poﬁ_t2g•
(
t
)

214  
LDLM_POOL_MAX_GSP
 -

215 ((
LDLM_POOL_MAX_GSP
 - 
LDLM_POOL_MIN_GSP
) >>

216 (
t
 >> 
LDLM_POOL_GSP_STEP_SHIFT
));

217 
	}
}

219 
ölöe
 
	$ldlm_poﬁ_gø¡ed
(
ldlm_poﬁ
 *
∂
)

221  
	`©omic_ªad
(&
∂
->
∂_gø¡ed
);

222 
	}
}

229 
	$ldlm_poﬁ_ªˇlc_gø¡_∂™
(
ldlm_poﬁ
 *
∂
)

231 
gø¡ed
, 
gø¡_°ï
, 
limô
;

233 
limô
 = 
	`ldlm_poﬁ_gë_limô
(
∂
);

234 
gø¡ed
 = 
	`ldlm_poﬁ_gø¡ed
(
∂
);

236 
gø¡_°ï
 = 
	`ldlm_poﬁ_t2g•
(
∂
->
∂_ªˇlc_≥riod
);

237 
gø¡_°ï
 = ((
limô
 - 
gø¡ed
) * grant_step) / 100;

238 
∂
->
∂_gø¡_∂™
 = 
gø¡ed
 + 
gø¡_°ï
;

239 
limô
 = (limit * 5) >> 2;

240 i‡(
∂
->
∂_gø¡_∂™
 > 
limô
)

241 
∂
->
∂_gø¡_∂™
 = 
limô
;

242 
	}
}

249 
	$ldlm_poﬁ_ªˇlc_¶v
(
ldlm_poﬁ
 *
∂
)

251 
gø¡ed
;

252 
gø¡_∂™
;

253 
round_up
;

254 
__u64
 
¶v
;

255 
__u64
 
¶v_Á˘‹
;

256 
__u64
 
gø¡_ußge
;

257 
__u32
 
limô
;

259 
¶v
 = 
∂
->
∂_£rvî_lock_vﬁume
;

260 
gø¡_∂™
 = 
∂
->
∂_gø¡_∂™
;

261 
limô
 = 
	`ldlm_poﬁ_gë_limô
(
∂
);

262 
gø¡ed
 = 
	`ldlm_poﬁ_gø¡ed
(
∂
);

263 
round_up
 = 
gø¡ed
 < 
limô
;

265 
gø¡_ußge
 = 
	`max_t
(, 
limô
 - (
gø¡ed
 - 
gø¡_∂™
), 1);

275 
¶v_Á˘‹
 = (
gø¡_ußge
 << 
LDLM_POOL_SLV_SHIFT
);

276 
	`do_div
(
¶v_Á˘‹
, 
limô
);

277 
¶v
 = slv * 
¶v_Á˘‹
;

278 
¶v
 = 
	`dru
(¶v, 
LDLM_POOL_SLV_SHIFT
, 
round_up
);

280 i‡(
¶v
 > 
	`ldlm_poﬁ_¶v_max
(
limô
)) {

281 
¶v
 = 
	`ldlm_poﬁ_¶v_max
(
limô
);

282 } i‡(
¶v
 < 
	`ldlm_poﬁ_¶v_mö
(
limô
)) {

283 
¶v
 = 
	`ldlm_poﬁ_¶v_mö
(
limô
);

286 
∂
->
∂_£rvî_lock_vﬁume
 = 
¶v
;

287 
	}
}

294 
	$ldlm_poﬁ_ªˇlc_°©s
(
ldlm_poﬁ
 *
∂
)

296 
gø¡_∂™
 = 
∂
->
∂_gø¡_∂™
;

297 
__u64
 
¶v
 = 
∂
->
∂_£rvî_lock_vﬁume
;

298 
gø¡ed
 = 
	`ldlm_poﬁ_gø¡ed
(
∂
);

299 
gø¡_øã
 = 
	`©omic_ªad
(&
∂
->
∂_gø¡_øã
);

300 
ˇn˚l_øã
 = 
	`©omic_ªad
(&
∂
->
∂_ˇn˚l_øã
);

302 
	`Õrocfs_cou¡î_add
(
∂
->
∂_°©s
, 
LDLM_POOL_SLV_STAT
,

303 
¶v
);

304 
	`Õrocfs_cou¡î_add
(
∂
->
∂_°©s
, 
LDLM_POOL_GRANTED_STAT
,

305 
gø¡ed
);

306 
	`Õrocfs_cou¡î_add
(
∂
->
∂_°©s
, 
LDLM_POOL_GRANT_RATE_STAT
,

307 
gø¡_øã
);

308 
	`Õrocfs_cou¡î_add
(
∂
->
∂_°©s
, 
LDLM_POOL_GRANT_PLAN_STAT
,

309 
gø¡_∂™
);

310 
	`Õrocfs_cou¡î_add
(
∂
->
∂_°©s
, 
LDLM_POOL_CANCEL_RATE_STAT
,

311 
ˇn˚l_øã
);

312 
	}
}

317 
	$ldlm_§v_poﬁ_push_¶v
(
ldlm_poﬁ
 *
∂
)

319 
obd_devi˚
 *
obd
;

328 
obd
 = 
	`ldlm_∂2ns
(
∂
)->
ns_obd
;

329 
	`LASSERT
(
obd
 !
NULL
);

330 
	`wrôe_lock
(&
obd
->
obd_poﬁ_lock
);

331 
obd
->
obd_poﬁ_¶v
 = 
∂
->
∂_£rvî_lock_vﬁume
;

332 
	`wrôe_u∆ock
(&
obd
->
obd_poﬁ_lock
);

333 
	}
}

340 
	$ldlm_§v_poﬁ_ªˇlc
(
ldlm_poﬁ
 *
∂
)

342 
time_t
 
ªˇlc_öãrvÆ_£c
;

343 
ENTRY
;

345 
ªˇlc_öãrvÆ_£c
 = 
	`cfs_time_cuºít_£c
(Ë- 
∂
->
∂_ªˇlc_time
;

346 i‡(
ªˇlc_öãrvÆ_£c
 < 
∂
->
∂_ªˇlc_≥riod
)

347 
	`RETURN
(0);

349 
	`•ö_lock
(&
∂
->
∂_lock
);

350 
ªˇlc_öãrvÆ_£c
 = 
	`cfs_time_cuºít_£c
(Ë- 
∂
->
∂_ªˇlc_time
;

351 i‡(
ªˇlc_öãrvÆ_£c
 < 
∂
->
∂_ªˇlc_≥riod
) {

352 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

353 
	`RETURN
(0);

359 
	`ldlm_poﬁ_ªˇlc_¶v
(
∂
);

364 
	`ldlm_§v_poﬁ_push_¶v
(
∂
);

369 
	`ldlm_poﬁ_ªˇlc_gø¡_∂™
(
∂
);

371 
∂
->
∂_ªˇlc_time
 = 
	`cfs_time_cuºít_£c
();

372 
	`Õrocfs_cou¡î_add
(
∂
->
∂_°©s
, 
LDLM_POOL_TIMING_STAT
,

373 
ªˇlc_öãrvÆ_£c
);

374 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

375 
	`RETURN
(0);

376 
	}
}

386 
	$ldlm_§v_poﬁ_shrök
(
ldlm_poﬁ
 *
∂
,

387 
ƒ
, 
gÂ_t
 
gÂ_mask
)

389 
__u32
 
limô
;

394 i‡(
ƒ
 == 0)

395  
	`ldlm_poﬁ_gø¡ed
(
∂
);

401 i‡(
	`ldlm_poﬁ_gø¡ed
(
∂
) == 0)

402 
	`RETURN
(0);

404 
	`•ö_lock
(&
∂
->
∂_lock
);

418 i‡(
ƒ
 < 
∂
->
∂_£rvî_lock_vﬁume
) {

419 
∂
->
∂_£rvî_lock_vﬁume
 =Öl->∂_£rvî_lock_vﬁumê- 
ƒ
;

421 
limô
 = 
	`ldlm_poﬁ_gë_limô
(
∂
);

422 
∂
->
∂_£rvî_lock_vﬁume
 = 
	`ldlm_poﬁ_¶v_mö
(
limô
);

428 
	`ldlm_§v_poﬁ_push_¶v
(
∂
);

429 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

436 
	}
}

441 
	$ldlm_§v_poﬁ_£tup
(
ldlm_poﬁ
 *
∂
, 
limô
)

443 
obd_devi˚
 *
obd
;

445 
obd
 = 
	`ldlm_∂2ns
(
∂
)->
ns_obd
;

446 
	`LASSERT
(
obd
 !
NULL
 && obd !
LP_POISON
);

447 
	`LASSERT
(
obd
->
obd_ty≥
 !
LP_POISON
);

448 
	`wrôe_lock
(&
obd
->
obd_poﬁ_lock
);

449 
obd
->
obd_poﬁ_limô
 = 
limô
;

450 
	`wrôe_u∆ock
(&
obd
->
obd_poﬁ_lock
);

452 
	`ldlm_poﬁ_£t_limô
(
∂
, 
limô
);

454 
	}
}

459 
	$ldlm_˛i_poﬁ_p›_¶v
(
ldlm_poﬁ
 *
∂
)

461 
obd_devi˚
 *
obd
;

467 
obd
 = 
	`ldlm_∂2ns
(
∂
)->
ns_obd
;

468 
	`LASSERT
(
obd
 !
NULL
);

469 
	`ªad_lock
(&
obd
->
obd_poﬁ_lock
);

470 
∂
->
∂_£rvî_lock_vﬁume
 = 
obd
->
obd_poﬁ_¶v
;

471 
	`ldlm_poﬁ_£t_limô
(
∂
, 
obd
->
obd_poﬁ_limô
);

472 
	`ªad_u∆ock
(&
obd
->
obd_poﬁ_lock
);

473 
	}
}

478 
	$ldlm_˛i_poﬁ_ªˇlc
(
ldlm_poﬁ
 *
∂
)

480 
time_t
 
ªˇlc_öãrvÆ_£c
;

481 
ªt
;

482 
ENTRY
;

484 
ªˇlc_öãrvÆ_£c
 = 
	`cfs_time_cuºít_£c
(Ë- 
∂
->
∂_ªˇlc_time
;

485 i‡(
ªˇlc_öãrvÆ_£c
 < 
∂
->
∂_ªˇlc_≥riod
)

486 
	`RETURN
(0);

488 
	`•ö_lock
(&
∂
->
∂_lock
);

492 
ªˇlc_öãrvÆ_£c
 = 
	`cfs_time_cuºít_£c
(Ë- 
∂
->
∂_ªˇlc_time
;

493 i‡(
ªˇlc_öãrvÆ_£c
 < 
∂
->
∂_ªˇlc_≥riod
) {

494 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

495 
	`RETURN
(0);

501 
	`ldlm_˛i_poﬁ_p›_¶v
(
∂
);

502 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

507 i‡(!
	`ns_c⁄√˘_Ãu_ªsize
(
	`ldlm_∂2ns
(
∂
)))

508 
	`GOTO
(
out
, 
ªt
 = 0);

516 
ªt
 = 
	`ldlm_ˇn˚l_Ãu
(
	`ldlm_∂2ns
(
∂
), 0, 
LCF_ASYNC
,

517 
LDLM_LRU_FLAG_LRUR
);

519 
out
:

520 
	`•ö_lock
(&
∂
->
∂_lock
);

525 
∂
->
∂_ªˇlc_time
 = 
	`cfs_time_cuºít_£c
();

526 
	`Õrocfs_cou¡î_add
(
∂
->
∂_°©s
, 
LDLM_POOL_TIMING_STAT
,

527 
ªˇlc_öãrvÆ_£c
);

528 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

529 
	`RETURN
(
ªt
);

530 
	}
}

537 
	$ldlm_˛i_poﬁ_shrök
(
ldlm_poﬁ
 *
∂
,

538 
ƒ
, 
gÂ_t
 
gÂ_mask
)

540 
ldlm_«me•a˚
 *
ns
;

541 
unu£d
;

543 
ns
 = 
	`ldlm_∂2ns
(
∂
);

548 i‡(!
	`ns_c⁄√˘_Ãu_ªsize
(
ns
))

549 
	`RETURN
(0);

554 
	`ldlm_˛i_poﬁ_p›_¶v
(
∂
);

556 
	`•ö_lock
(&
ns
->
ns_lock
);

557 
unu£d
 = 
ns
->
ns_ƒ_unu£d
;

558 
	`•ö_u∆ock
(&
ns
->
ns_lock
);

560 i‡(
ƒ
 == 0)

561  (
unu£d
 / 100Ë* 
sys˘l_vfs_ˇche_¥essuª
;

563  
	`ldlm_ˇn˚l_Ãu
(
ns
, 
ƒ
, 
LCF_ASYNC
, 
LDLM_LRU_FLAG_SHRINK
);

564 
	}
}

566 
ldlm_poﬁ_›s
 
	gldlm_§v_poﬁ_›s
 = {

567 .
po_ªˇlc
 = 
ldlm_§v_poﬁ_ªˇlc
,

568 .
	gpo_shrök
 = 
ldlm_§v_poﬁ_shrök
,

569 .
	gpo_£tup
 = 
ldlm_§v_poﬁ_£tup


572 
ldlm_poﬁ_›s
 
	gldlm_˛i_poﬁ_›s
 = {

573 .
po_ªˇlc
 = 
ldlm_˛i_poﬁ_ªˇlc
,

574 .
	gpo_shrök
 = 
ldlm_˛i_poﬁ_shrök


581 
	$ldlm_poﬁ_ªˇlc
(
ldlm_poﬁ
 *
∂
)

583 
time_t
 
ªˇlc_öãrvÆ_£c
;

584 
cou¡
;

586 
ªˇlc_öãrvÆ_£c
 = 
	`cfs_time_cuºít_£c
(Ë- 
∂
->
∂_ªˇlc_time
;

587 i‡(
ªˇlc_öãrvÆ_£c
 > 0) {

588 
	`•ö_lock
(&
∂
->
∂_lock
);

589 
ªˇlc_öãrvÆ_£c
 = 
	`cfs_time_cuºít_£c
() -

590 
∂
->
∂_ªˇlc_time
;

592 i‡(
ªˇlc_öãrvÆ_£c
 > 0) {

596 
	`ldlm_poﬁ_ªˇlc_°©s
(
∂
);

601 
	`©omic_£t
(&
∂
->
∂_gø¡_øã
, 0);

602 
	`©omic_£t
(&
∂
->
∂_ˇn˚l_øã
, 0);

604 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

607 i‡(
∂
->
∂_›s
->
po_ªˇlc
 !
NULL
) {

608 
cou¡
 = 
∂
->
∂_›s
->
	`po_ªˇlc
(pl);

609 
	`Õrocfs_cou¡î_add
(
∂
->
∂_°©s
, 
LDLM_POOL_RECALC_STAT
,

610 
cou¡
);

613 
ªˇlc_öãrvÆ_£c
 = 
∂
->
∂_ªˇlc_time
 - 
	`cfs_time_cuºít_£c
() +

614 
∂
->
∂_ªˇlc_≥riod
;

615 i‡(
ªˇlc_öãrvÆ_£c
 <= 0) {

617 
	`CDEBUG
(
D_DLMTRACE
, "%s: Negative interval(%ld), "

619 
∂
->
∂_«me
, 
ªˇlc_öãrvÆ_£c
,

620 
∂
->
∂_ªˇlc_≥riod
);

623 
ªˇlc_öãrvÆ_£c
 = 1;

626  
ªˇlc_öãrvÆ_£c
;

627 
	}
}

633 
	$ldlm_poﬁ_shrök
(
ldlm_poﬁ
 *
∂
, 
ƒ
, 
gÂ_t
 
gÂ_mask
)

635 
ˇn˚l
 = 0;

637 i‡(
∂
->
∂_›s
->
po_shrök
 !
NULL
) {

638 
ˇn˚l
 = 
∂
->
∂_›s
->
	`po_shrök
’l, 
ƒ
, 
gÂ_mask
);

639 i‡(
ƒ
 > 0) {

640 
	`Õrocfs_cou¡î_add
(
∂
->
∂_°©s
,

641 
LDLM_POOL_SHRINK_REQTD_STAT
,

642 
ƒ
);

643 
	`Õrocfs_cou¡î_add
(
∂
->
∂_°©s
,

644 
LDLM_POOL_SHRINK_FREED_STAT
,

645 
ˇn˚l
);

646 
	`CDEBUG
(
D_DLMTRACE
, "%s:ÑequestÅo shrink %dÜocks, "

647 "shrunk %d\n", 
∂
->
∂_«me
, 
ƒ
, 
ˇn˚l
);

650  
ˇn˚l
;

651 
	}
}

659 
	$ldlm_poﬁ_£tup
(
ldlm_poﬁ
 *
∂
, 
limô
)

661 i‡(
∂
->
∂_›s
->
po_£tup
 !
NULL
)

662 (
∂
->
∂_›s
->
	`po_£tup
’l, 
limô
));

664 
	}
}

666 
	$Õrocfs_poﬁ_°©e_£q_show
(
£q_fûe
 *
m
, *
unu£d
)

668 
gø¡ed
, 
gø¡_øã
, 
ˇn˚l_øã
, 
gø¡_°ï
;

669 
gø¡_•ìd
, 
gø¡_∂™
, 
lvf
;

670 
ldlm_poﬁ
 *
∂
 = 
m
->
¥iv©e
;

671 
__u64
 
¶v
, 
˛v
;

672 
__u32
 
limô
;

674 
	`•ö_lock
(&
∂
->
∂_lock
);

675 
¶v
 = 
∂
->
∂_£rvî_lock_vﬁume
;

676 
˛v
 = 
∂
->
∂_˛õ¡_lock_vﬁume
;

677 
limô
 = 
	`ldlm_poﬁ_gë_limô
(
∂
);

678 
gø¡_∂™
 = 
∂
->
∂_gø¡_∂™
;

679 
gø¡ed
 = 
	`ldlm_poﬁ_gø¡ed
(
∂
);

680 
gø¡_øã
 = 
	`©omic_ªad
(&
∂
->
∂_gø¡_øã
);

681 
ˇn˚l_øã
 = 
	`©omic_ªad
(&
∂
->
∂_ˇn˚l_øã
);

682 
gø¡_•ìd
 = 
gø¡_øã
 - 
ˇn˚l_øã
;

683 
lvf
 = 
	`©omic_ªad
(&
∂
->
∂_lock_vﬁume_Á˘‹
);

684 
gø¡_°ï
 = 
	`ldlm_poﬁ_t2g•
(
∂
->
∂_ªˇlc_≥riod
);

685 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

687 
	`£q_¥ötf
(
m
, "LDLMÖool state (%s):\n"

688 " SLV: "
LPU64
"\n"

689 " CLV: "
LPU64
"\n"

691 
∂
->
∂_«me
, 
¶v
, 
˛v
, 
lvf
);

693 i‡(
	`ns_is_£rvî
(
	`ldlm_∂2ns
(
∂
))) {

694 
	`£q_¥ötf
(
m
, " GSP: %d%%\n"

696 
gø¡_°ï
, 
gø¡_∂™
);

698 
	`£q_¥ötf
(
m
, " GR: %d\n" " CR: %d\n" " GS: %d\n"

700 
gø¡_øã
, 
ˇn˚l_øã
, 
gø¡_•ìd
,

701 
gø¡ed
, 
limô
);

703 
	}
}

704 
LPROC_SEQ_FOPS_RO
(
Õrocfs_poﬁ_°©e
);

706 
	$Õrocfs_gø¡_•ìd_£q_show
(
£q_fûe
 *
m
, *
unu£d
)

708 
ldlm_poﬁ
 *
∂
 = 
m
->
¥iv©e
;

709 
gø¡_•ìd
;

711 
	`•ö_lock
(&
∂
->
∂_lock
);

713 
gø¡_•ìd
 = 
	`©omic_ªad
(&
∂
->
∂_gø¡_øã
) -

714 
	`©omic_ªad
(&
∂
->
∂_ˇn˚l_øã
);

715 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

716  
	`Õrocfs_uöt_£q_show
(
m
, &
gø¡_•ìd
);

717 
	}
}

719 
LDLM_POOL_PROC_READER_SEQ_SHOW
(
gø¡_∂™
, );

720 
LPROC_SEQ_FOPS_RO
(
Õrocfs_gø¡_∂™
);

722 
LDLM_POOL_PROC_READER_SEQ_SHOW
(
ªˇlc_≥riod
, );

723 
LDLM_POOL_PROC_WRITER
(
ªˇlc_≥riod
, );

724 
ssize_t
 
	$Õrocfs_ªˇlc_≥riod_£q_wrôe
(
fûe
 *file,

725 c⁄° 
__u£r
 *
buf
,

726 
size_t
 
Àn
, 
loff_t
 *
off
)

728 
£q_fûe
 *
£q
 = 
fûe
->
¥iv©e_d©a
;

730  
	`Õrocfs_wr_ªˇlc_≥riod
(
fûe
, 
buf
, 
Àn
, 
£q
->
¥iv©e
);

731 
	}
}

732 
LPROC_SEQ_FOPS
(
Õrocfs_ªˇlc_≥riod
);

734 
LPROC_SEQ_FOPS_RO_TYPE
(
ldlm_poﬁ
, 
u64
);

735 
LPROC_SEQ_FOPS_RO_TYPE
(
ldlm_poﬁ
, 
©omic
);

736 
LPROC_SEQ_FOPS_RW_TYPE
(
ldlm_poﬁ_rw
, 
©omic
);

738 
LPROC_SEQ_FOPS_RO
(
Õrocfs_gø¡_•ìd
);

740 
	$ldlm_poﬁ_¥oc_öô
(
ldlm_poﬁ
 *
∂
)

742 
ldlm_«me•a˚
 *
ns
 = 
	`ldlm_∂2ns
(
∂
);

743 
¥oc_dú_íåy
 *
∑ª¡_ns_¥oc
;

744 
Õrocfs_v¨s
 
poﬁ_v¨s
[2];

745 *
v¨_«me
 = 
NULL
;

746 
rc
 = 0;

747 
ENTRY
;

749 
	`OBD_ALLOC
(
v¨_«me
, 
MAX_STRING_SIZE
 + 1);

750 i‡(!
v¨_«me
)

751 
	`RETURN
(-
ENOMEM
);

753 
∑ª¡_ns_¥oc
 = 
ns
->
ns_¥oc_dú_íåy
;

754 i‡(
∑ª¡_ns_¥oc
 =
NULL
) {

755 
	`CERROR
("%s:ÖrocÉntry isÇot initialized\n",

756 
	`ldlm_ns_«me
(
ns
));

757 
	`GOTO
(
out_‰ì_«me
, 
rc
 = -
EINVAL
);

759 
∂
->
∂_¥oc_dú
 = 
	`Õrocfs_ªgi°î
("poﬁ", 
∑ª¡_ns_¥oc
,

760 
NULL
, NULL);

761 i‡(
	`IS_ERR
(
∂
->
∂_¥oc_dú
)) {

762 
rc
 = 
	`PTR_ERR
(
∂
->
∂_¥oc_dú
);

763 
∂
->
∂_¥oc_dú
 = 
NULL
;

764 
	`CERROR
("%s: cannot create 'pool'ÖrocÉntry:Ñc = %d\n",

765 
	`ldlm_ns_«me
(
ns
), 
rc
);

766 
	`GOTO
(
out_‰ì_«me
, 
rc
);

769 
v¨_«me
[
MAX_STRING_SIZE
] = '\0';

770 
	`mem£t
(
poﬁ_v¨s
, 0, (pool_vars));

771 
poﬁ_v¨s
[0].
«me
 = 
v¨_«me
;

773 
	`ldlm_add_v¨
(&
poﬁ_v¨s
[0], 
∂
->
∂_¥oc_dú
, "server_lock_volume",

774 &
∂
->
∂_£rvî_lock_vﬁume
, &
ldlm_poﬁ_u64_f›s
);

775 
	`ldlm_add_v¨
(&
poﬁ_v¨s
[0], 
∂
->
∂_¥oc_dú
, "limô", &∂->
∂_limô
,

776 &
ldlm_poﬁ_rw_©omic_f›s
);

777 
	`ldlm_add_v¨
(&
poﬁ_v¨s
[0], 
∂
->
∂_¥oc_dú
, "granted",

778 &
∂
->
∂_gø¡ed
, &
ldlm_poﬁ_©omic_f›s
);

779 
	`ldlm_add_v¨
(&
poﬁ_v¨s
[0], 
∂
->
∂_¥oc_dú
, "grant_speed",Öl,

780 &
Õrocfs_gø¡_•ìd_f›s
);

781 
	`ldlm_add_v¨
(&
poﬁ_v¨s
[0], 
∂
->
∂_¥oc_dú
, "cancel_rate",

782 &
∂
->
∂_ˇn˚l_øã
, &
ldlm_poﬁ_©omic_f›s
);

783 
	`ldlm_add_v¨
(&
poﬁ_v¨s
[0], 
∂
->
∂_¥oc_dú
, "grant_rate",

784 &
∂
->
∂_gø¡_øã
, &
ldlm_poﬁ_©omic_f›s
);

785 
	`ldlm_add_v¨
(&
poﬁ_v¨s
[0], 
∂
->
∂_¥oc_dú
, "grant_plan",Öl,

786 &
Õrocfs_gø¡_∂™_f›s
);

787 
	`ldlm_add_v¨
(&
poﬁ_v¨s
[0], 
∂
->
∂_¥oc_dú
, "recalc_period",

788 
∂
, &
Õrocfs_ªˇlc_≥riod_f›s
);

789 
	`ldlm_add_v¨
(&
poﬁ_v¨s
[0], 
∂
->
∂_¥oc_dú
, "lock_volume_factor",

790 &
∂
->
∂_lock_vﬁume_Á˘‹
, &
ldlm_poﬁ_rw_©omic_f›s
);

791 
	`ldlm_add_v¨
(&
poﬁ_v¨s
[0], 
∂
->
∂_¥oc_dú
, "state",Öl,

792 &
Õrocfs_poﬁ_°©e_f›s
);

794 
∂
->
∂_°©s
 = 
	`Õrocfs_Æloc_°©s
(
LDLM_POOL_LAST_STAT
 -

795 
LDLM_POOL_FIRST_STAT
, 0);

796 i‡(!
∂
->
∂_°©s
)

797 
	`GOTO
(
out_‰ì_«me
, 
rc
 = -
ENOMEM
);

799 
	`Õrocfs_cou¡î_öô
(
∂
->
∂_°©s
, 
LDLM_POOL_GRANTED_STAT
,

800 
LPROCFS_CNTR_AVGMINMAX
 | 
LPROCFS_CNTR_STDDEV
,

802 
	`Õrocfs_cou¡î_öô
(
∂
->
∂_°©s
, 
LDLM_POOL_GRANT_STAT
,

803 
LPROCFS_CNTR_AVGMINMAX
 | 
LPROCFS_CNTR_STDDEV
,

805 
	`Õrocfs_cou¡î_öô
(
∂
->
∂_°©s
, 
LDLM_POOL_CANCEL_STAT
,

806 
LPROCFS_CNTR_AVGMINMAX
 | 
LPROCFS_CNTR_STDDEV
,

808 
	`Õrocfs_cou¡î_öô
(
∂
->
∂_°©s
, 
LDLM_POOL_GRANT_RATE_STAT
,

809 
LPROCFS_CNTR_AVGMINMAX
 | 
LPROCFS_CNTR_STDDEV
,

811 
	`Õrocfs_cou¡î_öô
(
∂
->
∂_°©s
, 
LDLM_POOL_CANCEL_RATE_STAT
,

812 
LPROCFS_CNTR_AVGMINMAX
 | 
LPROCFS_CNTR_STDDEV
,

814 
	`Õrocfs_cou¡î_öô
(
∂
->
∂_°©s
, 
LDLM_POOL_GRANT_PLAN_STAT
,

815 
LPROCFS_CNTR_AVGMINMAX
 | 
LPROCFS_CNTR_STDDEV
,

817 
	`Õrocfs_cou¡î_öô
(
∂
->
∂_°©s
, 
LDLM_POOL_SLV_STAT
,

818 
LPROCFS_CNTR_AVGMINMAX
 | 
LPROCFS_CNTR_STDDEV
,

820 
	`Õrocfs_cou¡î_öô
(
∂
->
∂_°©s
, 
LDLM_POOL_SHRINK_REQTD_STAT
,

821 
LPROCFS_CNTR_AVGMINMAX
 | 
LPROCFS_CNTR_STDDEV
,

823 
	`Õrocfs_cou¡î_öô
(
∂
->
∂_°©s
, 
LDLM_POOL_SHRINK_FREED_STAT
,

824 
LPROCFS_CNTR_AVGMINMAX
 | 
LPROCFS_CNTR_STDDEV
,

826 
	`Õrocfs_cou¡î_öô
(
∂
->
∂_°©s
, 
LDLM_POOL_RECALC_STAT
,

827 
LPROCFS_CNTR_AVGMINMAX
 | 
LPROCFS_CNTR_STDDEV
,

829 
	`Õrocfs_cou¡î_öô
(
∂
->
∂_°©s
, 
LDLM_POOL_TIMING_STAT
,

830 
LPROCFS_CNTR_AVGMINMAX
 | 
LPROCFS_CNTR_STDDEV
,

832 
rc
 = 
	`Õrocfs_ªgi°î_°©s
(
∂
->
∂_¥oc_dú
, "°©s",Öl->
∂_°©s
);

834 
EXIT
;

835 
out_‰ì_«me
:

836 
	`OBD_FREE
(
v¨_«me
, 
MAX_STRING_SIZE
 + 1);

837  
rc
;

838 
	}
}

840 
	$ldlm_poﬁ_¥oc_föi
(
ldlm_poﬁ
 *
∂
)

842 i‡(
∂
->
∂_°©s
 !
NULL
) {

843 
	`Õrocfs_‰ì_°©s
(&
∂
->
∂_°©s
);

844 
∂
->
∂_°©s
 = 
NULL
;

846 i‡(
∂
->
∂_¥oc_dú
 !
NULL
) {

847 
	`Õrocfs_ªmove
(&
∂
->
∂_¥oc_dú
);

848 
∂
->
∂_¥oc_dú
 = 
NULL
;

850 
	}
}

852 
	$ldlm_poﬁ_öô
(
ldlm_poﬁ
 *
∂
, 
ldlm_«me•a˚
 *
ns
,

853 
idx
, 
ldlm_side
 
˛õ¡
)

855 
rc
;

856 
ENTRY
;

858 
	`•ö_lock_öô
(&
∂
->
∂_lock
);

859 
	`©omic_£t
(&
∂
->
∂_gø¡ed
, 0);

860 
∂
->
∂_ªˇlc_time
 = 
	`cfs_time_cuºít_£c
();

861 
	`©omic_£t
(&
∂
->
∂_lock_vﬁume_Á˘‹
, 1);

863 
	`©omic_£t
(&
∂
->
∂_gø¡_øã
, 0);

864 
	`©omic_£t
(&
∂
->
∂_ˇn˚l_øã
, 0);

865 
∂
->
∂_gø¡_∂™
 = 
	`LDLM_POOL_GP
(
LDLM_POOL_HOST_L
);

867 
	`¢¥ötf
(
∂
->
∂_«me
, (pl->pl_name), "ldlm-pool-%s-%d",

868 
	`ldlm_ns_«me
(
ns
), 
idx
);

870 i‡(
˛õ¡
 =
LDLM_NAMESPACE_SERVER
) {

871 
∂
->
∂_›s
 = &
ldlm_§v_poﬁ_›s
;

872 
	`ldlm_poﬁ_£t_limô
(
∂
, 
LDLM_POOL_HOST_L
);

873 
∂
->
∂_ªˇlc_≥riod
 = 
LDLM_POOL_SRV_DEF_RECALC_PERIOD
;

874 
∂
->
∂_£rvî_lock_vﬁume
 = 
	`ldlm_poﬁ_¶v_max
(
LDLM_POOL_HOST_L
);

876 
	`ldlm_poﬁ_£t_limô
(
∂
, 1);

877 
∂
->
∂_£rvî_lock_vﬁume
 = 0;

878 
∂
->
∂_›s
 = &
ldlm_˛i_poﬁ_›s
;

879 
∂
->
∂_ªˇlc_≥riod
 = 
LDLM_POOL_CLI_DEF_RECALC_PERIOD
;

881 
∂
->
∂_˛õ¡_lock_vﬁume
 = 0;

882 
rc
 = 
	`ldlm_poﬁ_¥oc_öô
(
∂
);

883 i‡(
rc
)

884 
	`RETURN
(
rc
);

886 
	`CDEBUG
(
D_DLMTRACE
, "LockÖoﬁ %†i†öôülized\n", 
∂
->
∂_«me
);

888 
	`RETURN
(
rc
);

889 
	}
}

891 
	$ldlm_poﬁ_föi
(
ldlm_poﬁ
 *
∂
)

893 
ENTRY
;

894 
	`ldlm_poﬁ_¥oc_föi
(
∂
);

901 
	`POISON
(
∂
, 0x5a, (*pl));

902 
EXIT
;

903 
	}
}

908 
	$ldlm_poﬁ_add
(
ldlm_poﬁ
 *
∂
, 
ldlm_lock
 *
lock
)

919 i‡(
lock
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_FLOCK
 ||

920 
lock
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_PLAIN
)

923 
	`ldlm_ª˛aim_add
(
lock
);

925 
	`©omic_öc
(&
∂
->
∂_gø¡ed
);

926 
	`©omic_öc
(&
∂
->
∂_gø¡_øã
);

927 
	`Õrocfs_cou¡î_ö¸
(
∂
->
∂_°©s
, 
LDLM_POOL_GRANT_STAT
);

934 i‡(
	`ns_is_£rvî
(
	`ldlm_∂2ns
(
∂
)))

935 
	`ldlm_poﬁ_ªˇlc
(
∂
);

936 
	}
}

941 
	$ldlm_poﬁ_dñ
(
ldlm_poﬁ
 *
∂
, 
ldlm_lock
 *
lock
)

947 i‡(
lock
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_FLOCK
 ||

948 
lock
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_PLAIN
)

951 
	`ldlm_ª˛aim_dñ
(
lock
);

953 
	`LASSERT
(
	`©omic_ªad
(&
∂
->
∂_gø¡ed
) > 0);

954 
	`©omic_dec
(&
∂
->
∂_gø¡ed
);

955 
	`©omic_öc
(&
∂
->
∂_ˇn˚l_øã
);

957 
	`Õrocfs_cou¡î_ö¸
(
∂
->
∂_°©s
, 
LDLM_POOL_CANCEL_STAT
);

959 i‡(
	`ns_is_£rvî
(
	`ldlm_∂2ns
(
∂
)))

960 
	`ldlm_poﬁ_ªˇlc
(
∂
);

961 
	}
}

968 
__u64
 
	$ldlm_poﬁ_gë_¶v
(
ldlm_poﬁ
 *
∂
)

970 
__u64
 
¶v
;

971 
	`•ö_lock
(&
∂
->
∂_lock
);

972 
¶v
 = 
∂
->
∂_£rvî_lock_vﬁume
;

973 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

974  
¶v
;

975 
	}
}

982 
	$ldlm_poﬁ_£t_¶v
(
ldlm_poﬁ
 *
∂
, 
__u64
 
¶v
)

984 
	`•ö_lock
(&
∂
->
∂_lock
);

985 
∂
->
∂_£rvî_lock_vﬁume
 = 
¶v
;

986 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

987 
	}
}

994 
__u64
 
	$ldlm_poﬁ_gë_˛v
(
ldlm_poﬁ
 *
∂
)

996 
__u64
 
¶v
;

997 
	`•ö_lock
(&
∂
->
∂_lock
);

998 
¶v
 = 
∂
->
∂_˛õ¡_lock_vﬁume
;

999 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

1000  
¶v
;

1001 
	}
}

1008 
	$ldlm_poﬁ_£t_˛v
(
ldlm_poﬁ
 *
∂
, 
__u64
 
˛v
)

1010 
	`•ö_lock
(&
∂
->
∂_lock
);

1011 
∂
->
∂_˛õ¡_lock_vﬁume
 = 
˛v
;

1012 
	`•ö_u∆ock
(&
∂
->
∂_lock
);

1013 
	}
}

1018 
__u32
 
	$ldlm_poﬁ_gë_limô
(
ldlm_poﬁ
 *
∂
)

1020  
	`©omic_ªad
(&
∂
->
∂_limô
);

1021 
	}
}

1026 
	$ldlm_poﬁ_£t_limô
(
ldlm_poﬁ
 *
∂
, 
__u32
 
limô
)

1028 
	`©omic_£t
(&
∂
->
∂_limô
, 
limô
);

1029 
	}
}

1034 
__u32
 
	$ldlm_poﬁ_gë_lvf
(
ldlm_poﬁ
 *
∂
)

1036  
	`©omic_ªad
(&
∂
->
∂_lock_vﬁume_Á˘‹
);

1037 
	}
}

1039 
±Ãpc_thªad
 *
	gldlm_poﬁs_thªad
;

1040 
shrökî
 *
	gldlm_poﬁs_§v_shrökî
;

1041 
shrökî
 *
	gldlm_poﬁs_˛i_shrökî
;

1042 
com∂ëi⁄
 
	gldlm_poﬁs_comp
;

1048 
	$ldlm_poﬁs_cou¡
(
ldlm_side
 
˛õ¡
, 
gÂ_t
 
gÂ_mask
)

1050 
tŸÆ
 = 0;

1051 
ƒ_ns
;

1052 
ldlm_«me•a˚
 *
ns
;

1053 
ldlm_«me•a˚
 *
ns_ﬁd
 = 
NULL
;

1054 *
cookõ
;

1056 i‡(
˛õ¡
 =
LDLM_NAMESPACE_CLIENT
 && !(
gÂ_mask
 & 
__GFP_FS
))

1059 
	`CDEBUG
(
D_DLMTRACE
, "RequestÅo count %sÜocks fromállÖools\n",

1060 
˛õ¡
 =
LDLM_NAMESPACE_CLIENT
 ? "client" : "server");

1062 
cookõ
 = 
	`˛_ív_ªíãr
();

1067 
ƒ_ns
 = 
	`ldlm_«me•a˚_ƒ_ªad
(
˛õ¡
);

1068 
ƒ_ns
 > 0;Çr_ns--) {

1069 
	`muãx_lock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1070 i‡(
	`li°_em±y
(
	`ldlm_«me•a˚_li°
(
˛õ¡
))) {

1071 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1072 
	`˛_ív_ªexô
(
cookõ
);

1075 
ns
 = 
	`ldlm_«me•a˚_fú°_locked
(
˛õ¡
);

1077 i‡(
ns
 =
ns_ﬁd
) {

1078 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1082 i‡(
	`ldlm_ns_em±y
(
ns
)) {

1083 
	`ldlm_«me•a˚_move_to_öa˘ive_locked
(
ns
, 
˛õ¡
);

1084 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1088 i‡(
ns_ﬁd
 =
NULL
)

1089 
ns_ﬁd
 = 
ns
;

1091 
	`ldlm_«me•a˚_gë
(
ns
);

1092 
	`ldlm_«me•a˚_move_to_a˘ive_locked
(
ns
, 
˛õ¡
);

1093 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1094 
tŸÆ
 +
	`ldlm_poﬁ_shrök
(&
ns
->
ns_poﬁ
, 0, 
gÂ_mask
);

1095 
	`ldlm_«me•a˚_put
(
ns
);

1098 
	`˛_ív_ªexô
(
cookõ
);

1099  
tŸÆ
;

1100 
	}
}

1102 
	$ldlm_poﬁs_sˇn
(
ldlm_side
 
˛õ¡
, 
ƒ
,

1103 
gÂ_t
 
gÂ_mask
)

1105 
‰ìd
 = 0;

1106 
tmp
, 
ƒ_ns
;

1107 
ldlm_«me•a˚
 *
ns
;

1108 *
cookõ
;

1110 i‡(
˛õ¡
 =
LDLM_NAMESPACE_CLIENT
 && !(
gÂ_mask
 & 
__GFP_FS
))

1113 
cookõ
 = 
	`˛_ív_ªíãr
();

1118 
tmp
 = 
ƒ_ns
 = 
	`ldlm_«me•a˚_ƒ_ªad
(
˛õ¡
);

1119 
tmp
 > 0;Åmp--) {

1120 
ˇn˚l
, 
ƒ_locks
;

1125 
	`muãx_lock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1126 i‡(
	`li°_em±y
(
	`ldlm_«me•a˚_li°
(
˛õ¡
))) {

1127 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1130 
ns
 = 
	`ldlm_«me•a˚_fú°_locked
(
˛õ¡
);

1131 
	`ldlm_«me•a˚_gë
(
ns
);

1132 
	`ldlm_«me•a˚_move_to_a˘ive_locked
(
ns
, 
˛õ¡
);

1133 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1135 
ƒ_locks
 = 
	`ldlm_poﬁ_gø¡ed
(&
ns
->
ns_poﬁ
);

1140 
ˇn˚l
 = 1 + 
	`mö_t
(, 
ƒ_locks
, 
ƒ
 / 
ƒ_ns
);

1141 
‰ìd
 +
	`ldlm_poﬁ_shrök
(&
ns
->
ns_poﬁ
, 
ˇn˚l
, 
gÂ_mask
);

1142 
	`ldlm_«me•a˚_put
(
ns
);

1144 
	`˛_ív_ªexô
(
cookõ
);

1149  (
˛õ¡
 =
LDLM_NAMESPACE_SERVER
Ë? 
SHRINK_STOP
 : 
‰ìd
;

1150 
	}
}

1152 #ifde‡
HAVE_SHRINKER_COUNT


1153 
	$ldlm_poﬁs_§v_cou¡
(
shrökî
 *
s
,

1154 
shrök_c⁄åﬁ
 *
sc
)

1156  
	`ldlm_poﬁs_cou¡
(
LDLM_NAMESPACE_SERVER
, 
sc
->
gÂ_mask
);

1157 
	}
}

1159 
	$ldlm_poﬁs_§v_sˇn
(
shrökî
 *
s
,

1160 
shrök_c⁄åﬁ
 *
sc
)

1162  
	`ldlm_poﬁs_sˇn
(
LDLM_NAMESPACE_SERVER
, 
sc
->
ƒ_to_sˇn
,

1163 
sc
->
gÂ_mask
);

1164 
	}
}

1166 
	$ldlm_poﬁs_˛i_cou¡
(
shrökî
 *
s
, 
shrök_c⁄åﬁ
 *
sc
)

1168  
	`ldlm_poﬁs_cou¡
(
LDLM_NAMESPACE_CLIENT
, 
sc
->
gÂ_mask
);

1169 
	}
}

1171 
	$ldlm_poﬁs_˛i_sˇn
(
shrökî
 *
s
,

1172 
shrök_c⁄åﬁ
 *
sc
)

1174  
	`ldlm_poﬁs_sˇn
(
LDLM_NAMESPACE_CLIENT
, 
sc
->
ƒ_to_sˇn
,

1175 
sc
->
gÂ_mask
);

1176 
	}
}

1184 
	$ldlm_poﬁs_shrök
(
ldlm_side
 
˛õ¡
, 
ƒ
, 
gÂ_t
 
gÂ_mask
)

1186 
tŸÆ
 = 0;

1188 i‡(
˛õ¡
 =
LDLM_NAMESPACE_CLIENT
 && 
ƒ
 != 0 &&

1189 !(
gÂ_mask
 & 
__GFP_FS
))

1192 
	`CDEBUG
(
D_DLMTRACE
, "RequestÅo shrink %d %sÜocks fromállÖools\n",

1193 
ƒ
, 
˛õ¡
 =
LDLM_NAMESPACE_CLIENT
 ? "client" : "server");

1195 
tŸÆ
 = 
	`ldlm_poﬁs_cou¡
(
˛õ¡
, 
gÂ_mask
);

1197 i‡(
ƒ
 =0 || 
tŸÆ
 == 0)

1198  
tŸÆ
;

1200  
	`ldlm_poﬁs_sˇn
(
˛õ¡
, 
ƒ
, 
gÂ_mask
);

1201 
	}
}

1203 
ldlm_poﬁs_§v_shrök
(
	$SHRINKER_ARGS
(
sc
, 
ƒ_to_sˇn
, 
gÂ_mask
))

1205  
	`ldlm_poﬁs_shrök
(
LDLM_NAMESPACE_SERVER
,

1206 
	`shrök_∑øm
(
sc
, 
ƒ_to_sˇn
),

1207 
	`shrök_∑øm
(
sc
, 
gÂ_mask
));

1208 
	}
}

1210 
ldlm_poﬁs_˛i_shrök
(
	$SHRINKER_ARGS
(
sc
, 
ƒ_to_sˇn
, 
gÂ_mask
))

1212  
	`ldlm_poﬁs_shrök
(
LDLM_NAMESPACE_CLIENT
,

1213 
	`shrök_∑øm
(
sc
, 
ƒ_to_sˇn
),

1214 
	`shrök_∑øm
(
sc
, 
gÂ_mask
));

1215 
	}
}

1219 
	$ldlm_poﬁs_ªˇlc
(
ldlm_side
 
˛õ¡
)

1221 
ƒ_l
 = 0, 
ƒ_p
 = 0, 
l
;

1222 
ldlm_«me•a˚
 *
ns
;

1223 
ldlm_«me•a˚
 *
ns_ﬁd
 = 
NULL
;

1224 
ƒ
, 
equÆ
 = 0;

1226 
time
 = 
˛õ¡
 ? 
LDLM_POOL_CLI_DEF_RECALC_PERIOD
 :

1227 
LDLM_POOL_SRV_DEF_RECALC_PERIOD
;

1232 i‡(
˛õ¡
 =
LDLM_NAMESPACE_SERVER
) {

1236 
	`muãx_lock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1237 
	`li°_f‹_óch_íåy
(
ns
, 
	`ldlm_«me•a˚_li°
(
˛õ¡
),

1238 
ns_li°_chaö
)

1240 i‡(
ns
->
ns_≠≥tôe
 !
LDLM_NAMESPACE_MODEST
)

1243 
l
 = 
	`ldlm_poﬁ_gø¡ed
(&
ns
->
ns_poﬁ
);

1244 i‡(
l
 == 0)

1245 
l
 = 1;

1251 
l
 +
	`dru
÷, 
LDLM_POOLS_MODEST_MARGIN_SHIFT
, 0);

1252 
	`ldlm_poﬁ_£tup
(&
ns
->
ns_poﬁ
, 
l
);

1253 
ƒ_l
 +
l
;

1254 
ƒ_p
++;

1261 i‡(
ƒ_l
 >2 * (
LDLM_POOL_HOST_L
 / 3)) {

1262 
	`CWARN
("\"Modest\"ÖoolsÉat out 2/3 of serverÜocks "

1265 "Upgødê£rvî!\n", 
ƒ_l
, 
LDLM_POOL_HOST_L
);

1266 
equÆ
 = 1;

1272 
	`li°_f‹_óch_íåy
(
ns
, 
	`ldlm_«me•a˚_li°
(
˛õ¡
),

1273 
ns_li°_chaö
)

1275 i‡(!
equÆ
 && 
ns
->
ns_≠≥tôe
 !
LDLM_NAMESPACE_GREEDY
)

1278 i‡(
equÆ
) {

1284 
l
 = 
LDLM_POOL_HOST_L
 /

1285 
	`ldlm_«me•a˚_ƒ_ªad
(
˛õ¡
);

1291 
l
 = (
LDLM_POOL_HOST_L
 - 
ƒ_l
) /

1292 (
	`ldlm_«me•a˚_ƒ_ªad
(
˛õ¡
) -

1293 
ƒ_p
);

1295 
	`ldlm_poﬁ_£tup
(&
ns
->
ns_poﬁ
, 
l
);

1297 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1303 
ƒ
 = 
	`ldlm_«me•a˚_ƒ_ªad
(
˛õ¡
);Çr > 0;Çr--) {

1304 
skù
;

1312 
	`muãx_lock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1313 i‡(
	`li°_em±y
(
	`ldlm_«me•a˚_li°
(
˛õ¡
))) {

1314 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1317 
ns
 = 
	`ldlm_«me•a˚_fú°_locked
(
˛õ¡
);

1319 i‡(
ns_ﬁd
 =
ns
) {

1320 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1334 i‡(
	`ldlm_ns_em±y
(
ns
)) {

1335 
	`ldlm_«me•a˚_move_to_öa˘ive_locked
(
ns
, 
˛õ¡
);

1336 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1340 i‡(
ns_ﬁd
 =
NULL
)

1341 
ns_ﬁd
 = 
ns
;

1343 
	`•ö_lock
(&
ns
->
ns_lock
);

1348 i‡(
ns
->
ns_°›pög
) {

1349 
skù
 = 1;

1351 
skù
 = 0;

1352 
	`ldlm_«me•a˚_gë
(
ns
);

1354 
	`•ö_u∆ock
(&
ns
->
ns_lock
);

1356 
	`ldlm_«me•a˚_move_to_a˘ive_locked
(
ns
, 
˛õ¡
);

1357 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1362 i‡(!
skù
) {

1363 
âime
 = 
	`ldlm_poﬁ_ªˇlc
(&
ns
->
ns_poﬁ
);

1365 i‡(
âime
 < 
time
)

1366 
time
 = 
âime
;

1368 
	`ldlm_«me•a˚_put
(
ns
);

1373 
	`ldlm_bl_thªad_wakeup
();

1375  
time
;

1376 
	}
}

1378 
	$ldlm_poﬁs_thªad_maö
(*
¨g
)

1380 
±Ãpc_thªad
 *
thªad
 = (±Ãpc_thªad *)
¨g
;

1381 
s_time
, 
c_time
;

1382 
ENTRY
;

1384 
	`thªad_£t_Êags
(
thªad
, 
SVC_RUNNING
);

1385 
	`wake_up
(&
thªad
->
t_˘l_waôq
);

1387 
	`CDEBUG
(
D_DLMTRACE
, "%s:ÖoolÅhread starting,Örocess %d\n",

1388 "ldlm_poﬁd", 
	`cuºít_pid
());

1391 
l_waô_öfo
 
lwi
;

1396 
s_time
 = 
	`ldlm_poﬁs_ªˇlc
(
LDLM_NAMESPACE_SERVER
);

1397 
c_time
 = 
	`ldlm_poﬁs_ªˇlc
(
LDLM_NAMESPACE_CLIENT
);

1403 
lwi
 = 
	`LWI_TIMEOUT
(
	`cfs_time_£c⁄ds
(
	`mö
(
s_time
, 
c_time
)),

1404 
NULL
, NULL);

1405 
	`l_waô_evít
(
thªad
->
t_˘l_waôq
,

1406 
	`thªad_is_°›pög
(
thªad
) ||

1407 
	`thªad_is_evít
(
thªad
),

1408 &
lwi
);

1410 i‡(
	`thªad_ã°_™d_˛ór_Êags
(
thªad
, 
SVC_STOPPING
))

1413 
	`thªad_ã°_™d_˛ór_Êags
(
thªad
, 
SVC_EVENT
);

1416 
	`thªad_£t_Êags
(
thªad
, 
SVC_STOPPED
);

1417 
	`wake_up
(&
thªad
->
t_˘l_waôq
);

1419 
	`CDEBUG
(
D_DLMTRACE
, "%s:ÖoolÅhreadÉxiting,Örocess %d\n",

1420 "ldlm_poﬁd", 
	`cuºít_pid
());

1422 
	`com∂ëe_™d_exô
(&
ldlm_poﬁs_comp
, 0);

1423 
	}
}

1425 
	$ldlm_poﬁs_thªad_°¨t
()

1427 
l_waô_öfo
 
lwi
 = { 0 };

1428 
èsk_°ru˘
 *
èsk
;

1429 
ENTRY
;

1431 i‡(
ldlm_poﬁs_thªad
 !
NULL
)

1432 
	`RETURN
(-
EALREADY
);

1434 
	`OBD_ALLOC_PTR
(
ldlm_poﬁs_thªad
);

1435 i‡(
ldlm_poﬁs_thªad
 =
NULL
)

1436 
	`RETURN
(-
ENOMEM
);

1438 
	`öô_com∂ëi⁄
(&
ldlm_poﬁs_comp
);

1439 
	`öô_waôqueue_hód
(&
ldlm_poﬁs_thªad
->
t_˘l_waôq
);

1441 
èsk
 = 
	`kthªad_run
(
ldlm_poﬁs_thªad_maö
, 
ldlm_poﬁs_thªad
,

1443 i‡(
	`IS_ERR
(
èsk
)) {

1444 
	`CERROR
("C™'à°¨àpoﬁÅhªad,Éº‹ %ld\n", 
	`PTR_ERR
(
èsk
));

1445 
	`OBD_FREE
(
ldlm_poﬁs_thªad
, (*ldlm_pools_thread));

1446 
ldlm_poﬁs_thªad
 = 
NULL
;

1447 
	`RETURN
(
	`PTR_ERR
(
èsk
));

1449 
	`l_waô_evít
(
ldlm_poﬁs_thªad
->
t_˘l_waôq
,

1450 
	`thªad_is_ru¬ög
(
ldlm_poﬁs_thªad
), &
lwi
);

1451 
	`RETURN
(0);

1452 
	}
}

1454 
	$ldlm_poﬁs_thªad_°›
()

1456 
ENTRY
;

1458 i‡(
ldlm_poﬁs_thªad
 =
NULL
) {

1459 
EXIT
;

1463 
	`thªad_£t_Êags
(
ldlm_poﬁs_thªad
, 
SVC_STOPPING
);

1464 
	`wake_up
(&
ldlm_poﬁs_thªad
->
t_˘l_waôq
);

1471 
	`waô_f‹_com∂ëi⁄
(&
ldlm_poﬁs_comp
);

1472 
	`OBD_FREE_PTR
(
ldlm_poﬁs_thªad
);

1473 
ldlm_poﬁs_thªad
 = 
NULL
;

1474 
EXIT
;

1475 
	}
}

1477 
	$ldlm_poﬁs_öô
()

1479 
rc
;

1480 
	`DEF_SHRINKER_VAR
(
shsv¨
, 
ldlm_poﬁs_§v_shrök
,

1481 
ldlm_poﬁs_§v_cou¡
, 
ldlm_poﬁs_§v_sˇn
);

1482 
	`DEF_SHRINKER_VAR
(
shcv¨
, 
ldlm_poﬁs_˛i_shrök
,

1483 
ldlm_poﬁs_˛i_cou¡
, 
ldlm_poﬁs_˛i_sˇn
);

1484 
ENTRY
;

1486 
rc
 = 
	`ldlm_poﬁs_thªad_°¨t
();

1487 i‡(
rc
 == 0) {

1488 
ldlm_poﬁs_§v_shrökî
 =

1489 
	`£t_shrökî
(
DEFAULT_SEEKS
, &
shsv¨
);

1490 
ldlm_poﬁs_˛i_shrökî
 =

1491 
	`£t_shrökî
(
DEFAULT_SEEKS
, &
shcv¨
);

1493 
	`RETURN
(
rc
);

1494 
	}
}

1496 
	$ldlm_poﬁs_föi
()

1498 i‡(
ldlm_poﬁs_§v_shrökî
 !
NULL
) {

1499 
	`ªmove_shrökî
(
ldlm_poﬁs_§v_shrökî
);

1500 
ldlm_poﬁs_§v_shrökî
 = 
NULL
;

1502 i‡(
ldlm_poﬁs_˛i_shrökî
 !
NULL
) {

1503 
	`ªmove_shrökî
(
ldlm_poﬁs_˛i_shrökî
);

1504 
ldlm_poﬁs_˛i_shrökî
 = 
NULL
;

1506 
	`ldlm_poﬁs_thªad_°›
();

1507 
	}
}

1510 
	$ldlm_poﬁ_£tup
(
ldlm_poﬁ
 *
∂
, 
limô
)

1513 
	}
}

1515 
	$ldlm_poﬁ_ªˇlc
(
ldlm_poﬁ
 *
∂
)

1518 
	}
}

1520 
	$ldlm_poﬁ_shrök
(
ldlm_poﬁ
 *
∂
,

1521 
ƒ
, 
gÂ_t
 
gÂ_mask
)

1524 
	}
}

1526 
	$ldlm_poﬁ_öô
(
ldlm_poﬁ
 *
∂
, 
ldlm_«me•a˚
 *
ns
,

1527 
idx
, 
ldlm_side
 
˛õ¡
)

1530 
	}
}

1532 
	$ldlm_poﬁ_föi
(
ldlm_poﬁ
 *
∂
)

1535 
	}
}

1537 
	$ldlm_poﬁ_add
(
ldlm_poﬁ
 *
∂
, 
ldlm_lock
 *
lock
)

1540 
	}
}

1542 
	$ldlm_poﬁ_dñ
(
ldlm_poﬁ
 *
∂
, 
ldlm_lock
 *
lock
)

1545 
	}
}

1547 
__u64
 
	$ldlm_poﬁ_gë_¶v
(
ldlm_poﬁ
 *
∂
)

1550 
	}
}

1552 
	$ldlm_poﬁ_£t_¶v
(
ldlm_poﬁ
 *
∂
, 
__u64
 
¶v
)

1555 
	}
}

1557 
__u64
 
	$ldlm_poﬁ_gë_˛v
(
ldlm_poﬁ
 *
∂
)

1560 
	}
}

1562 
	$ldlm_poﬁ_£t_˛v
(
ldlm_poﬁ
 *
∂
, 
__u64
 
˛v
)

1565 
	}
}

1567 
__u32
 
	$ldlm_poﬁ_gë_limô
(
ldlm_poﬁ
 *
∂
)

1570 
	}
}

1572 
	$ldlm_poﬁ_£t_limô
(
ldlm_poﬁ
 *
∂
, 
__u32
 
limô
)

1575 
	}
}

1577 
__u32
 
	$ldlm_poﬁ_gë_lvf
(
ldlm_poﬁ
 *
∂
)

1580 
	}
}

1582 
	$ldlm_poﬁs_öô
()

1585 
	}
}

1587 
	$ldlm_poﬁs_föi
()

1590 
	}
}

1592 
	$ldlm_poﬁs_ªˇlc
(
ldlm_side
 
˛õ¡
)

1595 
	}
}

	@ldlm_reclaim.c

29 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

31 
	~<löux/kthªad.h
>

32 
	~<lu°ª_dlm.h
>

33 
	~<obd_˛ass.h
>

34 
	~"ldlm_öã∫Æ.h
"

53 #ifde‡
HAVE_SERVER_SUPPORT


56 
__u64
 
	gldlm_ª˛aim_thªshﬁd
;

57 
__u64
 
	gldlm_lock_limô
;

61 
__u64
 
	gldlm_ª˛aim_thªshﬁd_mb
;

62 
__u64
 
	gldlm_lock_limô_mb
;

64 
≥r˝u_cou¡î
 
	gldlm_gø¡ed_tŸÆ
;

65 
©omic_t
 
	gldlm_ƒ_ª˛aimî
;

66 
cfs_duøti⁄_t
 
	gldlm_œ°_ª˛aim_age
;

67 
cfs_time_t
 
	gldlm_œ°_ª˛aim_time
;

69 
	sldlm_ª˛aim_cb_d©a
 {

70 
li°_hód
 
	mrcd_Ωc_li°
;

71 
	mrcd_added
;

72 
	mrcd_tŸÆ
;

73 
	mrcd_curs‹
;

74 
	mrcd_°¨t
;

75 
boﬁ
 
	mrcd_skù
;

76 
cfs_duøti⁄_t
 
	mrcd_age
;

77 
cfs_hash_bd
 *
	mrcd_¥ev_bd
;

80 
ölöe
 
boﬁ
 
	$ldlm_lock_ª˛aimabÀ
(
ldlm_lock
 *
lock
)

82 
ldlm_«me•a˚
 *
ns
 = 
	`ldlm_lock_to_ns
(
lock
);

88 i‡(
ns
->
ns_˛õ¡
 =
LDLM_NAMESPACE_SERVER
 &&

89 (
lock
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_IBITS
 ||

90 
lock
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_EXTENT
))

91  
åue
;

92  
Ál£
;

93 
	}
}

106 
	$ldlm_ª˛aim_lock_cb
(
cfs_hash
 *
hs
, 
cfs_hash_bd
 *
bd
,

107 
hli°_node
 *
hnode
, *
¨g
)

110 
ldlm_ªsour˚
 *
ªs
;

111 
ldlm_ª˛aim_cb_d©a
 *
d©a
;

112 
ldlm_lock
 *
lock
;

113 
ldlm_ns_buckë
 *
nsb
;

114 
rc
 = 0;

116 
d©a
 = (
ldlm_ª˛aim_cb_d©a
 *)
¨g
;

118 
	`LASSERTF
(
d©a
->
rcd_added
 < d©a->
rcd_tŸÆ
, "added:%d >=Åotal:%d\n",

119 
d©a
->
rcd_added
, d©a->
rcd_tŸÆ
);

121 
nsb
 = 
	`cfs_hash_bd_exåa_gë
(
hs
, 
bd
);

122 
ªs
 = 
	`cfs_hash_obje˘
(
hs
, 
hnode
);

124 i‡(
d©a
->
rcd_¥ev_bd
 !
bd
) {

125 i‡(
d©a
->
rcd_¥ev_bd
 !
NULL
)

126 
	`ldlm_ªs_to_ns
(
ªs
)->
ns_ª˛aim_°¨t
++;

127 
d©a
->
rcd_¥ev_bd
 = 
bd
;

128 
d©a
->
rcd_curs‹
 = 0;

129 
d©a
->
rcd_°¨t
 = 
nsb
->
nsb_ª˛aim_°¨t
 %

130 
	`cfs_hash_bd_cou¡_gë
(
bd
);

133 i‡(
d©a
->
rcd_skù
 && d©a->
rcd_curs‹
 < d©a->
rcd_°¨t
) {

134 
d©a
->
rcd_curs‹
++;

138 
nsb
->
nsb_ª˛aim_°¨t
++;

140 
	`lock_ªs
(
ªs
);

141 
	`li°_f‹_óch_íåy
(
lock
, &
ªs
->
Ã_gø¡ed
, 
l_ªs_lök
) {

142 i‡(!
	`ldlm_lock_ª˛aimabÀ
(
lock
))

145 i‡(!
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_WATERMARK_LOW
) &&

146 
	`cfs_time_bef‹e
(
	`cfs_time_cuºít
(),

147 
	`cfs_time_add
(
lock
->
l_œ°_u£d
,

148 
d©a
->
rcd_age
)))

151 i‡(!
	`ldlm_is_a°_£¡
(
lock
)) {

152 
	`ldlm_£t_a°_£¡
(
lock
);

153 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_rk_a°
));

154 
	`li°_add
(&
lock
->
l_rk_a°
, &
d©a
->
rcd_Ωc_li°
);

155 
	`LDLM_LOCK_GET
(
lock
);

156 i‡(++
d©a
->
rcd_added
 =d©a->
rcd_tŸÆ
) {

157 
rc
 = 1;

162 
	`u∆ock_ªs
(
ªs
);

164  
rc
;

165 
	}
}

179 
	$ldlm_ª˛aim_ªs
(
ldlm_«me•a˚
 *
ns
, *
cou¡
,

180 
cfs_duøti⁄_t
 
age
, 
boﬁ
 
skù
)

182 
ldlm_ª˛aim_cb_d©a
 
d©a
;

183 
idx
, 
ty≥
, 
°¨t
;

184 
ENTRY
;

186 
	`LASSERT
(*
cou¡
 != 0);

188 i‡(
ns
->
ns_obd
) {

189 
ty≥
 = 
	`£rvî_«me2ödex
(
ns
->
ns_obd
->
obd_«me
, &
idx
, 
NULL
);

190 i‡(
ty≥
 !
LDD_F_SV_TYPE_MDT
 &&Åy≥ !
LDD_F_SV_TYPE_OST
) {

191 
EXIT
;

196 i‡(
	`©omic_ªad
(&
ns
->
ns_bªf
) == 0) {

197 
EXIT
;

201 
	`INIT_LIST_HEAD
(&
d©a
.
rcd_Ωc_li°
);

202 
d©a
.
rcd_added
 = 0;

203 
d©a
.
rcd_tŸÆ
 = *
cou¡
;

204 
d©a
.
rcd_age
 = 
age
;

205 
d©a
.
rcd_skù
 = 
skù
;

206 
d©a
.
rcd_¥ev_bd
 = 
NULL
;

207 
°¨t
 = 
ns
->
ns_ª˛aim_°¨t
 % 
	`CFS_HASH_NBKT
“s->
ns_rs_hash
);

209 
	`cfs_hash_f‹_óch_nﬁock
(
ns
->
ns_rs_hash
, 
ldlm_ª˛aim_lock_cb
, &
d©a
,

210 
°¨t
);

212 
	`CDEBUG
(
D_DLMTRACE
, "NS(%s): %dÜocksÅo beÑeclaimed, found %d/%d "

213 "locks.\n", 
	`ldlm_ns_«me
(
ns
), *
cou¡
, 
d©a
.
rcd_added
,

214 
d©a
.
rcd_tŸÆ
);

216 
	`LASSERTF
(*
cou¡
 >
d©a
.
rcd_added
, "count:%d,ádded:%d\n", *count,

217 
d©a
.
rcd_added
);

219 
	`ldlm_run_a°_w‹k
(
ns
, &
d©a
.
rcd_Ωc_li°
, 
LDLM_WORK_REVOKE_AST
);

220 *
cou¡
 -
d©a
.
rcd_added
;

221 
EXIT
;

222 
	}
}

224 
	#LDLM_RECLAIM_BATCH
 512

	)

225 
	#LDLM_RECLAIM_AGE_MIN
 
	`cfs_time_£c⁄ds
(300)

	)

226 
	#LDLM_RECLAIM_AGE_MAX
 (
LDLM_DEFAULT_MAX_ALIVE
 * 3 / 4)

	)

228 
ölöe
 
cfs_duøti⁄_t
 
	$ldlm_ª˛aim_age
()

230 
cfs_duøti⁄_t
 
age
;

232 
age
 = 
ldlm_œ°_ª˛aim_age
 +

233 
	`cfs_time_sub
(
	`cfs_time_cuºít
(), 
ldlm_œ°_ª˛aim_time
);

234 i‡(
age
 > 
LDLM_RECLAIM_AGE_MAX
)

235 
age
 = 
LDLM_RECLAIM_AGE_MAX
;

236 i‡(
age
 < (
LDLM_RECLAIM_AGE_MIN
 * 2))

237 
age
 = 
LDLM_RECLAIM_AGE_MIN
;

238  
age
;

239 
	}
}

246 
	$ldlm_ª˛aim_ns
()

248 
ldlm_«me•a˚
 *
ns
;

249 
cou¡
 = 
LDLM_RECLAIM_BATCH
;

250 
ns_ƒ
, 
ƒ_¥o˚s£d
;

251 
ldlm_side
 
ns_˛i
 = 
LDLM_NAMESPACE_SERVER
;

252 
cfs_duøti⁄_t
 
age
;

253 
boﬁ
 
skù
 = 
åue
;

254 
ENTRY
;

256 i‡(!
	`©omic_add_u∆ess
(&
ldlm_ƒ_ª˛aimî
, 1, 1)) {

257 
EXIT
;

261 
age
 = 
	`ldlm_ª˛aim_age
();

262 
agaö
:

263 
ƒ_¥o˚s£d
 = 0;

264 
ns_ƒ
 = 
	`ldlm_«me•a˚_ƒ_ªad
(
ns_˛i
);

265 
cou¡
 > 0 && 
ƒ_¥o˚s£d
 < 
ns_ƒ
) {

266 
	`muãx_lock
(
	`ldlm_«me•a˚_lock
(
ns_˛i
));

268 i‡(
	`li°_em±y
(
	`ldlm_«me•a˚_li°
(
ns_˛i
))) {

269 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
ns_˛i
));

270 
out
;

273 
ns
 = 
	`ldlm_«me•a˚_fú°_locked
(
ns_˛i
);

274 
	`ldlm_«me•a˚_move_to_a˘ive_locked
(
ns
, 
ns_˛i
);

275 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
ns_˛i
));

277 
	`ldlm_ª˛aim_ªs
(
ns
, &
cou¡
, 
age
, 
skù
);

278 
	`ldlm_«me•a˚_put
(
ns
);

279 
ƒ_¥o˚s£d
++;

282 i‡(
cou¡
 > 0 && 
age
 > 
LDLM_RECLAIM_AGE_MIN
) {

283 
age
 >>= 1;

284 i‡(
age
 < (
LDLM_RECLAIM_AGE_MIN
 * 2))

285 
age
 = 
LDLM_RECLAIM_AGE_MIN
;

286 
skù
 = 
Ál£
;

287 
agaö
;

290 
ldlm_œ°_ª˛aim_age
 = 
age
;

291 
ldlm_œ°_ª˛aim_time
 = 
	`cfs_time_cuºít
();

292 
out
:

293 
	`©omic_add_u∆ess
(&
ldlm_ƒ_ª˛aimî
, -1, 0);

294 
EXIT
;

295 
	}
}

297 
	$ldlm_ª˛aim_add
(
ldlm_lock
 *
lock
)

299 i‡(!
	`ldlm_lock_ª˛aimabÀ
(
lock
))

301 
	`≥r˝u_cou¡î_add
(&
ldlm_gø¡ed_tŸÆ
, 1);

302 
lock
->
l_œ°_u£d
 = 
	`cfs_time_cuºít
();

303 
	}
}

305 
	$ldlm_ª˛aim_dñ
(
ldlm_lock
 *
lock
)

307 i‡(!
	`ldlm_lock_ª˛aimabÀ
(
lock
))

309 
	`≥r˝u_cou¡î_sub
(&
ldlm_gø¡ed_tŸÆ
, 1);

310 
	}
}

321 
boﬁ
 
	$ldlm_ª˛aim_fuŒ
()

323 
__u64
 
high
 = 
ldlm_lock_limô
;

324 
__u64
 
low
 = 
ldlm_ª˛aim_thªshﬁd
;

326 i‡(
low
 !0 && 
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_WATERMARK_LOW
))

327 
low
 = 
cfs_Áû_vÆ
;

329 i‡(
low
 != 0 &&

330 
	`≥r˝u_cou¡î_sum_posôive
(&
ldlm_gø¡ed_tŸÆ
Ë> 
low
)

331 
	`ldlm_ª˛aim_ns
();

333 i‡(
high
 !0 && 
	`OBD_FAIL_CHECK
(
OBD_FAIL_LDLM_WATERMARK_HIGH
))

334 
high
 = 
cfs_Áû_vÆ
;

336 i‡(
high
 != 0 &&

337 
	`≥r˝u_cou¡î_sum_posôive
(&
ldlm_gø¡ed_tŸÆ
Ë> 
high
)

338  
åue
;

340  
Ál£
;

341 
	}
}

343 
ölöe
 
__u64
 
	$ldlm_øtio2lockƒ
(
øtio
)

345 
__u64
 
lockƒ
;

347 
lockƒ
 = ((
__u64
)
NUM_CACHEPAGES
 << 
PAGE_CACHE_SHIFT
Ë* 
øtio
;

348 
	`do_div
(
lockƒ
, 100 * (
ldlm_lock
));

350  
lockƒ
;

351 
	}
}

353 
ölöe
 
__u64
 
	$ldlm_lockƒ2mb
(
__u64
 
lockƒ
)

355  (
lockƒ
 * (
ldlm_lock
) + 512 * 1024) >> 20;

356 
	}
}

358 
	#LDLM_WM_RATIO_LOW_DEFAULT
 20

	)

359 
	#LDLM_WM_RATIO_HIGH_DEFAULT
 30

	)

361 
	$ldlm_ª˛aim_£tup
()

363 
	`©omic_£t
(&
ldlm_ƒ_ª˛aimî
, 0);

365 
ldlm_ª˛aim_thªshﬁd
 = 
	`ldlm_øtio2lockƒ
(
LDLM_WM_RATIO_LOW_DEFAULT
);

366 
ldlm_ª˛aim_thªshﬁd_mb
 = 
	`ldlm_lockƒ2mb
(
ldlm_ª˛aim_thªshﬁd
);

367 
ldlm_lock_limô
 = 
	`ldlm_øtio2lockƒ
(
LDLM_WM_RATIO_HIGH_DEFAULT
);

368 
ldlm_lock_limô_mb
 = 
	`ldlm_lockƒ2mb
(
ldlm_lock_limô
);

370 
ldlm_œ°_ª˛aim_age
 = 
LDLM_RECLAIM_AGE_MAX
;

371 
ldlm_œ°_ª˛aim_time
 = 
	`cfs_time_cuºít
();

373 #ifde‡
HAVE_PERCPU_COUNTER_INIT_GFP_FLAG


374  
	`≥r˝u_cou¡î_öô
(&
ldlm_gø¡ed_tŸÆ
, 0, 
GFP_KERNEL
);

376  
	`≥r˝u_cou¡î_öô
(&
ldlm_gø¡ed_tŸÆ
, 0);

378 
	}
}

380 
	$ldlm_ª˛aim_˛ónup
()

382 
	`≥r˝u_cou¡î_de°roy
(&
ldlm_gø¡ed_tŸÆ
);

383 
	}
}

387 
boﬁ
 
	$ldlm_ª˛aim_fuŒ
()

389  
Ál£
;

390 
	}
}

392 
	$ldlm_ª˛aim_add
(
ldlm_lock
 *
lock
)

394 
	}
}

396 
	$ldlm_ª˛aim_dñ
(
ldlm_lock
 *
lock
)

398 
	}
}

400 
	$ldlm_ª˛aim_£tup
()

403 
	}
}

405 
	$ldlm_ª˛aim_˛ónup
()

407 
	}
}

	@ldlm_request.c

62 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

64 
	~<lu°ª_dlm.h
>

65 
	~<obd_˛ass.h
>

66 
	~<obd.h
>

68 
	~"ldlm_öã∫Æ.h
"

70 
	gldlm_íqueue_mö
 = 
OBD_TIMEOUT_DEFAULT
;

71 
CFS_MODULE_PARM
(
ldlm_íqueue_mö
, "i", 
uöt
, 0644,

75 
	gldlm_ˇn˚l_unu£d_locks_bef‹e_ª∂ay
 = 1;

77 
	$öãºu±ed_com∂ëi⁄_waô
(*
d©a
)

79 
	}
}

81 
	slock_waô_d©a
 {

82 
ldlm_lock
 *
	mlwd_lock
;

83 
__u32
 
	mlwd_c⁄n_˙t
;

86 
	sldlm_async_¨gs
 {

87 
lu°ª_h™dÀ
 
	mlock_h™dÀ
;

90 
	$ldlm_expúed_com∂ëi⁄_waô
(*
d©a
)

92 
lock_waô_d©a
 *
lwd
 = 
d©a
;

93 
ldlm_lock
 *
lock
 = 
lwd
->
lwd_lock
;

94 
obd_imp‹t
 *
imp
;

95 
obd_devi˚
 *
obd
;

97 
ENTRY
;

98 i‡(
lock
->
l_c⁄n_exp‹t
 =
NULL
) {

99 
cfs_time_t
 
√xt_dump
 = 0, 
œ°_dump
 = 0;

101 
	`LDLM_ERROR
(
lock
, "lockÅimed ouà”nqueuedáà"
CFS_TIME_T
", "

102 
CFS_DURATION_T
"ságo);ÇotÉnteringÑecovery in "

104 
lock
->
l_œ°_a˘ivôy
,

105 
	`cfs_time_sub
(
	`cfs_time_cuºít_£c
(),

106 
lock
->
l_œ°_a˘ivôy
));

107 i‡(
	`cfs_time_a·î
(
	`cfs_time_cuºít
(), 
√xt_dump
)) {

108 
œ°_dump
 = 
√xt_dump
;

109 
√xt_dump
 = 
	`cfs_time_shi·
(300);

110 
	`ldlm_«me•a˚_dump
(
D_DLMTRACE
,

111 
	`ldlm_lock_to_ns
(
lock
));

112 i‡(
œ°_dump
 == 0)

113 
	`libcfs_debug_dum∂og
();

115 
	`RETURN
(0);

118 
obd
 = 
lock
->
l_c⁄n_exp‹t
->
exp_obd
;

119 
imp
 = 
obd
->
u
.
˛i
.
˛_imp‹t
;

120 
	`±Ãpc_Áû_imp‹t
(
imp
, 
lwd
->
lwd_c⁄n_˙t
);

121 
	`LDLM_ERROR
(
lock
, "lockÅimed ouà”nqueuedáà"
CFS_TIME_T
", "

122 
CFS_DURATION_T
"ságo),ÉnteringÑecovery for %s@%s",

123 
lock
->
l_œ°_a˘ivôy
,

124 
	`cfs_time_sub
(
	`cfs_time_cuºít_£c
(), 
lock
->
l_œ°_a˘ivôy
),

125 
	`obd2˛i_tgt
(
obd
), 
imp
->
imp_c⁄√˘i⁄
->
c_ªmŸe_uuid
.
uuid
);

127 
	`RETURN
(0);

128 
	}
}

142 
	$ldlm_˝_timeout
(
ldlm_lock
 *
lock
)

144 
timeout
;

146 i‡(
AT_OFF
)

147  
obd_timeout
;

152 
timeout
 = 
	`©_gë
(
	`ldlm_lock_to_ns_©
(
lock
));

153  
	`max
(3 * 
timeout
, 
ldlm_íqueue_mö
);

154 
	}
}

160 
	$ldlm_com∂ëi⁄_èû
(
ldlm_lock
 *
lock
, *
d©a
)

162 
dñay
;

163 
ªsu…
 = 0;

165 i‡(
	`ldlm_is_de°royed
(
lock
Ë|| 
	`ldlm_is_Áûed
(lock)) {

166 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue: destroyed");

167 
ªsu…
 = -
EIO
;

168 } i‡(
d©a
 =
NULL
) {

169 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue: granted");

172 
dñay
 = 
	`cfs_time_sub
(
	`cfs_time_cuºít_£c
(),

173 
lock
->
l_œ°_a˘ivôy
);

174 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue: grantedáfter "

175 
CFS_DURATION_T
"s", 
dñay
);

178 
	`©_mósuªd
(
	`ldlm_lock_to_ns_©
(
lock
), 
dñay
);

180  
ªsu…
;

181 
	}
}

188 
	$ldlm_com∂ëi⁄_a°_async
(
ldlm_lock
 *
lock
, 
__u64
 
Êags
, *
d©a
)

190 
ENTRY
;

192 i‡(
Êags
 =
LDLM_FL_WAIT_NOREPROC
) {

193 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue waiting onÖendingÜock");

194 
	`RETURN
(0);

197 i‡(!(
Êags
 & 
LDLM_FL_BLOCKED_MASK
)) {

198 
	`wake_up
(&
lock
->
l_waôq
);

199 
	`RETURN
(
	`ldlm_com∂ëi⁄_èû
(
lock
, 
d©a
));

202 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueueÑeturnedá blockedÜock, "

204 
	`ldlm_ª¥o˚ss_Æl
(
lock
->
l_ªsour˚
);

205 
	`RETURN
(0);

206 
	}
}

207 
EXPORT_SYMBOL
(
ldlm_com∂ëi⁄_a°_async
);

230 
	$ldlm_com∂ëi⁄_a°
(
ldlm_lock
 *
lock
, 
__u64
 
Êags
, *
d©a
)

233 
lock_waô_d©a
 
lwd
;

234 
obd_devi˚
 *
obd
;

235 
obd_imp‹t
 *
imp
 = 
NULL
;

236 
l_waô_öfo
 
lwi
;

237 
__u32
 
timeout
;

238 
rc
 = 0;

239 
ENTRY
;

241 i‡(
Êags
 =
LDLM_FL_WAIT_NOREPROC
) {

242 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue waiting onÖendingÜock");

243 
n‹ïroc
;

246 i‡(!(
Êags
 & 
LDLM_FL_BLOCKED_MASK
)) {

247 
	`wake_up
(&
lock
->
l_waôq
);

248 
	`RETURN
(0);

251 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueueÑeturnedá blockedÜock, "

254 
n‹ïroc
:

256 
obd
 = 
	`˛ass_exp2obd
(
lock
->
l_c⁄n_exp‹t
);

259 i‡(
obd
 !
NULL
) {

260 
imp
 = 
obd
->
u
.
˛i
.
˛_imp‹t
;

263 
timeout
 = 
	`ldlm_˝_timeout
(
lock
);

265 
lwd
.
lwd_lock
 = 
lock
;

266 
lock
->
l_œ°_a˘ivôy
 = 
	`cfs_time_cuºít_£c
();

268 i‡(
	`ldlm_is_no_timeout
(
lock
)) {

269 
	`LDLM_DEBUG
(
lock
, "waiting indefinitely because of NO_TIMEOUT");

270 
lwi
 = 
	`LWI_INTR
(
öãºu±ed_com∂ëi⁄_waô
, &
lwd
);

272 
lwi
 = 
	`LWI_TIMEOUT_INTR
(
	`cfs_time_£c⁄ds
(
timeout
),

273 
ldlm_expúed_com∂ëi⁄_waô
,

274 
öãºu±ed_com∂ëi⁄_waô
, &
lwd
);

277 i‡(
imp
 !
NULL
) {

278 
	`•ö_lock
(&
imp
->
imp_lock
);

279 
lwd
.
lwd_c⁄n_˙t
 = 
imp
->
imp_c⁄n_˙t
;

280 
	`•ö_u∆ock
(&
imp
->
imp_lock
);

283 i‡(
	`ns_is_˛õ¡
(
	`ldlm_lock_to_ns
(
lock
)) &&

284 
	`OBD_FAIL_CHECK_RESET
(
OBD_FAIL_LDLM_INTR_CP_AST
,

285 
OBD_FAIL_LDLM_CP_BL_RACE
 | 
OBD_FAIL_ONCE
)) {

286 
	`ldlm_£t_Áû_loc
(
lock
);

287 
rc
 = -
EINTR
;

290 
rc
 = 
	`l_waô_evít
(
lock
->
l_waôq
,

291 
	`is_gø¡ed_‹_ˇn˚Œed
(
lock
), &
lwi
);

294 i‡(
rc
) {

295 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue waking up: failed (%d)",

296 
rc
);

297 
	`RETURN
(
rc
);

300 
	`RETURN
(
	`ldlm_com∂ëi⁄_èû
(
lock
, 
d©a
));

301 
	}
}

302 
EXPORT_SYMBOL
(
ldlm_com∂ëi⁄_a°
);

315 
	$ldlm_blockög_a°_nocheck
(
ldlm_lock
 *
lock
)

317 
do_a°
;

318 
ENTRY
;

320 
	`ldlm_£t_cb≥ndög
(
lock
);

321 
do_a°
 = (!
lock
->
l_ªadîs
 && !lock->
l_wrôîs
);

322 
	`u∆ock_ªs_™d_lock
(
lock
);

324 i‡(
do_a°
) {

325 
lu°ª_h™dÀ
 
lockh
;

326 
rc
;

328 
	`LDLM_DEBUG
(
lock
, "already unused, callingÜdlm_cli_cancel");

329 
	`ldlm_lock2h™dÀ
(
lock
, &
lockh
);

330 
rc
 = 
	`ldlm_˛i_ˇn˚l
(&
lockh
, 
LCF_ASYNC
);

331 i‡(
rc
 < 0)

332 
	`CERROR
("ldlm_˛i_ˇn˚l: %d\n", 
rc
);

334 
	`LDLM_DEBUG
(
lock
, "Lock still hasÑeferences, will be "

337 
	`RETURN
(0);

338 
	}
}

339 
EXPORT_SYMBOL
(
ldlm_blockög_a°_nocheck
);

354 
	$ldlm_blockög_a°
(
ldlm_lock
 *
lock
, 
ldlm_lock_desc
 *
desc
,

355 *
d©a
, 
Êag
)

357 
ENTRY
;

359 i‡(
Êag
 =
LDLM_CB_CANCELING
) {

361 
	`RETURN
(0);

364 
	`lock_ªs_™d_lock
(
lock
);

370 i‡(
lock
->
l_blockög_a°
 !
ldlm_blockög_a°
) {

371 
	`u∆ock_ªs_™d_lock
(
lock
);

372 
	`RETURN
(0);

374 
	`RETURN
(
	`ldlm_blockög_a°_nocheck
(
lock
));

375 
	}
}

376 
EXPORT_SYMBOL
(
ldlm_blockög_a°
);

407 
	$ldlm_glimp£_a°
(
ldlm_lock
 *
lock
, *
ªqp
)

409  -
ELDLM_NO_LOCK_DATA
;

410 
	}
}

415 
	$ldlm_˛i_íqueue_loˇl
(
ldlm_«me•a˚
 *
ns
,

416 c⁄° 
ldlm_ªs_id
 *
ªs_id
,

417 
ldlm_ty≥
 
ty≥
, 
ldlm_pﬁicy_d©a
 *
pﬁicy
,

418 
ldlm_mode
 
mode
, 
__u64
 *
Êags
,

419 
ldlm_blockög_ˇŒback
 
blockög
,

420 
ldlm_com∂ëi⁄_ˇŒback
 
com∂ëi⁄
,

421 
ldlm_glimp£_ˇŒback
 
glimp£
,

422 *
d©a
, 
__u32
 
lvb_Àn
, 
lvb_ty≥
Üvb_type,

423 c⁄° 
__u64
 *
˛õ¡_cookõ
,

424 
lu°ª_h™dÀ
 *
lockh
)

426 
ldlm_lock
 *
lock
;

427 
îr
;

428 c⁄° 
ldlm_ˇŒback_suôe
 
cbs
 = { .
lcs_com∂ëi⁄
 = 
com∂ëi⁄
,

429 .
lcs_blockög
 = 
blockög
,

430 .
lcs_glimp£
 = 
glimp£
,

432 
ENTRY
;

434 
	`LASSERT
(!(*
Êags
 & 
LDLM_FL_REPLAY
));

435 i‡(
	`u∆ikñy
(
	`ns_is_˛õ¡
(
ns
))) {

436 
	`CERROR
("TryingÅoÉnqueueÜocalÜock iná shadowÇamespace\n");

437 
	`LBUG
();

440 
lock
 = 
	`ldlm_lock_¸óã
(
ns
, 
ªs_id
, 
ty≥
, 
mode
, &
cbs
, 
d©a
, 
lvb_Àn
,

441 
lvb_ty≥
);

442 i‡(
	`IS_ERR
(
lock
))

443 
	`GOTO
(
out_nﬁock
, 
îr
 = 
	`PTR_ERR
(
lock
));

445 
îr
 = 
	`ldlm_lvbo_öô
(
lock
->
l_ªsour˚
);

446 i‡(
îr
 < 0) {

447 
	`LDLM_ERROR
(
lock
, "dñayedÜvb inô faûed (r¯%d)", 
îr
);

448 
	`GOTO
(
out
, 
îr
);

451 
	`ldlm_lock2h™dÀ
(
lock
, 
lockh
);

455 
	`ldlm_lock_addªf_öã∫Æ_nﬁock
(
lock
, 
mode
);

456 
	`ldlm_£t_loˇl
(
lock
);

457 i‡(*
Êags
 & 
LDLM_FL_ATOMIC_CB
)

458 
	`ldlm_£t_©omic_cb
(
lock
);

460 i‡(
pﬁicy
 !
NULL
)

461 
lock
->
l_pﬁicy_d©a
 = *
pﬁicy
;

462 i‡(
˛õ¡_cookõ
 !
NULL
)

463 
lock
->
l_˛õ¡_cookõ
 = *
˛õ¡_cookõ
;

464 i‡(
ty≥
 =
LDLM_EXTENT
) {

466 i‡(
pﬁicy
 =
NULL
)

467 
	`LBUG
();

469 
lock
->
l_ªq_exã¡
 = 
pﬁicy
->
l_exã¡
;

472 
îr
 = 
	`ldlm_lock_íqueue
(
ns
, &
lock
, 
pﬁicy
, 
Êags
);

473 i‡(
	`u∆ikñy
(
îr
 !
ELDLM_OK
))

474 
	`GOTO
(
out
, 
îr
);

476 i‡(
pﬁicy
 !
NULL
)

477 *
pﬁicy
 = 
lock
->
l_pﬁicy_d©a
;

479 i‡(
lock
->
l_com∂ëi⁄_a°
)

480 
lock
->
	`l_com∂ëi⁄_a°
÷ock, *
Êags
, 
NULL
);

482 
	`LDLM_DEBUG
(
lock
, "client-sideÜocalÉnqueue handler,ÇewÜock created");

483 
EXIT
;

484 
out
:

485 
	`LDLM_LOCK_RELEASE
(
lock
);

486 
out_nﬁock
:

487  
îr
;

488 
	}
}

489 
EXPORT_SYMBOL
(
ldlm_˛i_íqueue_loˇl
);

491 
	$Áûed_lock_˛ónup
(
ldlm_«me•a˚
 *
ns
,

492 
ldlm_lock
 *
lock
, 
mode
)

494 
√ed_ˇn˚l
 = 0;

497 
	`lock_ªs_™d_lock
(
lock
);

499 i‡((
lock
->
l_ªq_mode
 !lock->
l_gø¡ed_mode
) &&

500 !
	`ldlm_is_Áûed
(
lock
)) {

504 
lock
->
l_Êags
 |
LDLM_FL_LOCAL_ONLY
 | 
LDLM_FL_FAILED
 |

505 
LDLM_FL_ATOMIC_CB
 | 
LDLM_FL_CBPENDING
;

506 
√ed_ˇn˚l
 = 1;

508 
	`u∆ock_ªs_™d_lock
(
lock
);

510 i‡(
√ed_ˇn˚l
)

511 
	`LDLM_DEBUG
(
lock
,

515 
	`LDLM_DEBUG
(
lock
, "lock was granted or failed inÑace");

523 i‡(
lock
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_FLOCK
) {

524 
	`lock_ªs_™d_lock
(
lock
);

525 i‡(!
	`ldlm_is_de°royed
(
lock
)) {

526 
	`ldlm_ªsour˚_u∆ök_lock
(
lock
);

527 
	`ldlm_lock_de¸ef_öã∫Æ_nﬁock
(
lock
, 
mode
);

528 
	`ldlm_lock_de°roy_nﬁock
(
lock
);

530 
	`u∆ock_ªs_™d_lock
(
lock
);

532 
	`ldlm_lock_de¸ef_öã∫Æ
(
lock
, 
mode
);

534 
	}
}

541 
	$ldlm_˛i_íqueue_föi
(
obd_exp‹t
 *
exp
, 
±Ãpc_ªque°
 *
ªq
,

542 
ldlm_ty≥
 
ty≥
, 
__u8
 
wôh_pﬁicy
,

543 
ldlm_mode
 
mode
, 
__u64
 *
Êags
, *
lvb
,

544 
__u32
 
lvb_Àn
, 
lu°ª_h™dÀ
 *
lockh
, 
rc
)

546 
ldlm_«me•a˚
 *
ns
 = 
exp
->
exp_obd
->
obd_«me•a˚
;

547 
is_ª∂ay
 = *
Êags
 & 
LDLM_FL_REPLAY
;

548 
ldlm_lock
 *
lock
;

549 
ldlm_ª∂y
 *
ª∂y
;

550 
˛ónup_pha£
 = 1;

551 
ENTRY
;

553 
lock
 = 
	`ldlm_h™dÀ2lock
(
lockh
);

555 i‡(!
lock
) {

556 
	`LASSERT
(
ty≥
 =
LDLM_FLOCK
);

557 
	`RETURN
(-
ENOLCK
);

560 
	`LASSERTF
(
	`îgo
(
lvb_Àn
 !0,Üvb_À¿=
lock
->
l_lvb_Àn
),

561 "lvb_À¿%d,Ü_lvb_À¿%d\n", 
lvb_Àn
, 
lock
->
l_lvb_Àn
);

563 i‡(
rc
 !
ELDLM_OK
) {

564 
	`LASSERT
(!
is_ª∂ay
);

565 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue END (%s)",

566 
rc
 =
ELDLM_LOCK_ABORTED
 ? "ABORTED" : "FAILED");

568 i‡(
rc
 !
ELDLM_LOCK_ABORTED
)

569 
	`GOTO
(
˛ónup
, 
rc
);

573 
ª∂y
 = 
	`ªq_ˇpsuÀ_£rvî_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REP
);

574 i‡(
ª∂y
 =
NULL
)

575 
	`GOTO
(
˛ónup
, 
rc
 = -
EPROTO
);

577 i‡(
lvb_Àn
 > 0) {

578 
size
 = 0;

580 
size
 = 
	`ªq_ˇpsuÀ_gë_size
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
,

581 
RCL_SERVER
);

582 i‡(
size
 < 0) {

583 
	`LDLM_ERROR
(
lock
, "FaûÅÿgëÜvb_Àn,Ñ¯%d", 
size
);

584 
	`GOTO
(
˛ónup
, 
rc
 = 
size
);

585 } i‡(
	`u∆ikñy
(
size
 > 
lvb_Àn
)) {

586 
	`LDLM_ERROR
(
lock
, "Replied LVB isÜargerÅhan "

588 
lvb_Àn
, 
size
);

589 
	`GOTO
(
˛ónup
, 
rc
 = -
EINVAL
);

591 
lvb_Àn
 = 
size
;

594 i‡(
rc
 =
ELDLM_LOCK_ABORTED
) {

595 i‡(
lvb_Àn
 > 0 && 
lvb
 !
NULL
)

596 
rc
 = 
	`ldlm_fûl_lvb
(
lock
, &
ªq
->
rq_pûl
, 
RCL_SERVER
,

597 
lvb
, 
lvb_Àn
);

598 
	`GOTO
(
˛ónup
, 
rc
 =Ñ¯? : 
ELDLM_LOCK_ABORTED
);

602 
˛ónup_pha£
 = 0;

604 
	`lock_ªs_™d_lock
(
lock
);

606 i‡(
exp
->
exp_lock_hash
) {

610 
	`cfs_hash_ªhash_key
(
exp
->
exp_lock_hash
,

611 &
lock
->
l_ªmŸe_h™dÀ
,

612 &
ª∂y
->
lock_h™dÀ
,

613 &
lock
->
l_exp_hash
);

615 
lock
->
l_ªmŸe_h™dÀ
 = 
ª∂y
->
lock_h™dÀ
;

618 *
Êags
 = 
	`ldlm_Êags_‰om_wúe
(
ª∂y
->
lock_Êags
);

619 
lock
->
l_Êags
 |
	`ldlm_Êags_‰om_wúe
(
ª∂y
->
lock_Êags
 &

620 
LDLM_FL_INHERIT_MASK
);

621 
	`u∆ock_ªs_™d_lock
(
lock
);

623 
	`CDEBUG
(
D_INFO
, "loˇl: %p,ÑemŸêcookõ: "
LPX64
", flags: "LPX64"\n",

624 
lock
, 
ª∂y
->
lock_h™dÀ
.
cookõ
, *
Êags
);

629 i‡((*
Êags
Ë& 
LDLM_FL_LOCK_CHANGED
) {

630 
√wmode
 = 
ª∂y
->
lock_desc
.
l_ªq_mode
;

631 
	`LASSERT
(!
is_ª∂ay
);

632 i‡(
√wmode
 &&Çewmodê!
lock
->
l_ªq_mode
) {

633 
	`LDLM_DEBUG
(
lock
, "serverÑeturned different mode %s",

634 
ldlm_lock«me
[
√wmode
]);

635 
lock
->
l_ªq_mode
 = 
√wmode
;

638 i‡(!
	`ldlm_ªs_eq
(&
ª∂y
->
lock_desc
.
l_ªsour˚
.
Ã_«me
,

639 &
lock
->
l_ªsour˚
->
Ã_«me
)) {

640 
	`CDEBUG
(
D_INFO
, "ªmŸêöã¡ suc˚ss,Üockög "
DLDLMRES


641 " in°ód o‡"
DLDLMRES
"\n",

642 
	`PLDLMRES
(&
ª∂y
->
lock_desc
.
l_ªsour˚
),

643 
	`PLDLMRES
(
lock
->
l_ªsour˚
));

645 
rc
 = 
	`ldlm_lock_ch™ge_ªsour˚
(
ns
, 
lock
,

646 &
ª∂y
->
lock_desc
.
l_ªsour˚
.
Ã_«me
);

647 i‡(
rc
 || 
lock
->
l_ªsour˚
 =
NULL
)

648 
	`GOTO
(
˛ónup
, 
rc
 = -
ENOMEM
);

649 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue,ÇewÑesource");

651 i‡(
wôh_pﬁicy
)

652 i‡(!(
ty≥
 =
LDLM_IBITS
 &&

653 !(
	`exp_c⁄√˘_Êags
(
exp
Ë& 
OBD_CONNECT_IBITS
)))

655 
	`ldlm_c⁄vît_pﬁicy_to_loˇl
(
exp
,

656 
lock
->
l_ªsour˚
->
Ã_ty≥
,

657 &
ª∂y
->
lock_desc
.
l_pﬁicy_d©a
,

658 &
lock
->
l_pﬁicy_d©a
);

659 i‡(
ty≥
 !
LDLM_PLAIN
)

660 
	`LDLM_DEBUG
(
lock
,"client-sideÉnqueue,ÇewÖolicy data");

663 i‡((*
Êags
Ë& 
LDLM_FL_AST_SENT
) {

664 
	`lock_ªs_™d_lock
(
lock
);

665 
lock
->
l_Êags
 |
LDLM_FL_CBPENDING
 | 
LDLM_FL_BL_AST
;

666 
	`u∆ock_ªs_™d_lock
(
lock
);

667 
	`LDLM_DEBUG
(
lock
, "enqueueÑeply includes blocking AST");

672 i‡(
lvb_Àn
 > 0) {

677 
	`lock_ªs_™d_lock
(
lock
);

678 i‡(
lock
->
l_ªq_mode
 !lock->
l_gø¡ed_mode
)

679 
rc
 = 
	`ldlm_fûl_lvb
(
lock
, &
ªq
->
rq_pûl
, 
RCL_SERVER
,

680 
lock
->
l_lvb_d©a
, 
lvb_Àn
);

681 
	`u∆ock_ªs_™d_lock
(
lock
);

682 i‡(
rc
 < 0) {

683 
˛ónup_pha£
 = 1;

684 
	`GOTO
(
˛ónup
, 
rc
);

688 i‡(!
is_ª∂ay
) {

689 
rc
 = 
	`ldlm_lock_íqueue
(
ns
, &
lock
, 
NULL
, 
Êags
);

690 i‡(
lock
->
l_com∂ëi⁄_a°
 !
NULL
) {

691 
îr
 = 
lock
->
	`l_com∂ëi⁄_a°
÷ock, *
Êags
, 
NULL
);

692 i‡(!
rc
)

693 
rc
 = 
îr
;

694 i‡(
rc
)

695 
˛ónup_pha£
 = 1;

699 i‡(
lvb_Àn
 > 0 && 
lvb
 !
NULL
) {

702 
	`mem˝y
(
lvb
, 
lock
->
l_lvb_d©a
, 
lvb_Àn
);

705 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue END");

706 
EXIT
;

707 
˛ónup
:

708 i‡(
˛ónup_pha£
 =1 && 
rc
)

709 
	`Áûed_lock_˛ónup
(
ns
, 
lock
, 
mode
);

711 
	`LDLM_LOCK_PUT
(
lock
);

712 
	`LDLM_LOCK_RELEASE
(
lock
);

713  
rc
;

714 
	}
}

715 
EXPORT_SYMBOL
(
ldlm_˛i_íqueue_föi
);

723 
ölöe
 
	$ldlm_ªq_h™dÀs_avaû
(
ªq_size
, 
off
)

725 
avaû
;

727 
avaû
 = 
	`mö_t
(, 
LDLM_MAXREQSIZE
, 
PAGE_CACHE_SIZE
 - 512Ë- 
ªq_size
;

728 i‡(
	`likñy
(
avaû
 >= 0))

729 
avaû
 /()(
lu°ª_h™dÀ
);

731 
avaû
 = 0;

732 
avaû
 +
LDLM_LOCKREQ_HANDLES
 - 
off
;

734  
avaû
;

735 
	}
}

737 
ölöe
 
	$ldlm_ˇpsuÀ_h™dÀs_avaû
(
ªq_ˇpsuÀ
 *
pûl
,

738 
ªq_loˇti⁄
 
loc
,

739 
off
)

741 
__u32
 
size
 = 
	`ªq_ˇpsuÀ_msg_size
(
pûl
, 
loc
);

742  
	`ldlm_ªq_h™dÀs_avaû
(
size
, 
off
);

743 
	}
}

745 
ölöe
 
	$ldlm_f‹m©_h™dÀs_avaû
(
obd_imp‹t
 *
imp
,

746 c⁄° 
ªq_f‹m©
 *
fmt
,

747 
ªq_loˇti⁄
 
loc
, 
off
)

749 
__u32
 
size
 = 
	`ªq_ˇpsuÀ_fmt_size
(
imp
->
imp_msg_magic
, 
fmt
, 
loc
);

750  
	`ldlm_ªq_h™dÀs_avaû
(
size
, 
off
);

751 
	}
}

761 
	$ldlm_¥ï_ñc_ªq
(
obd_exp‹t
 *
exp
, 
±Ãpc_ªque°
 *
ªq
,

762 
vîsi⁄
, 
›c
, 
ˇn˚loff
,

763 
li°_hód
 *
ˇn˚ls
, 
cou¡
)

765 
ldlm_«me•a˚
 *
ns
 = 
exp
->
exp_obd
->
obd_«me•a˚
;

766 
ªq_ˇpsuÀ
 *
pûl
 = &
ªq
->
rq_pûl
;

767 
ldlm_ªque°
 *
dlm
 = 
NULL
;

768 
li°_hód
 
hód
 = 
	`LIST_HEAD_INIT
(head);

769 
ldlm_Ãu_Êags
 
Ãu_Êags
;

770 
avaû
, 
to_‰ì
, 
∑ck
 = 0;

771 
rc
;

772 
ENTRY
;

774 i‡(
ˇn˚ls
 =
NULL
)

775 
ˇn˚ls
 = &
hód
;

776 i‡(
	`ns_c⁄√˘_ˇn˚l£t
(
ns
)) {

778 
	`ªq_ˇpsuÀ_fûÀd_sizes
(
pûl
, 
RCL_CLIENT
);

779 
avaû
 = 
	`ldlm_ˇpsuÀ_h™dÀs_avaû
(
pûl
, 
RCL_CLIENT
, 
ˇn˚loff
);

781 
Ãu_Êags
 = 
	`ns_c⁄√˘_Ãu_ªsize
(
ns
) ?

782 
LDLM_LRU_FLAG_LRUR_NO_WAIT
 : 
LDLM_LRU_FLAG_AGED
;

783 
to_‰ì
 = !
	`ns_c⁄√˘_Ãu_ªsize
(
ns
) &&

784 
›c
 =
LDLM_ENQUEUE
 ? 1 : 0;

789 i‡(
avaû
 > 
cou¡
)

790 
cou¡
 +
	`ldlm_ˇn˚l_Ãu_loˇl
(
ns
, 
ˇn˚ls
, 
to_‰ì
,

791 
avaû
 - 
cou¡
, 0,

792 
Ãu_Êags
);

793 i‡(
avaû
 > 
cou¡
)

794 
∑ck
 = 
cou¡
;

796 
∑ck
 = 
avaû
;

797 
	`ªq_ˇpsuÀ_£t_size
(
pûl
, &
RMF_DLM_REQ
, 
RCL_CLIENT
,

798 
	`ldlm_ªque°_bufsize
(
∑ck
, 
›c
));

801 
rc
 = 
	`±Ãpc_ªque°_∑ck
(
ªq
, 
vîsi⁄
, 
›c
);

802 i‡(
rc
) {

803 
	`ldlm_lock_li°_put
(
ˇn˚ls
, 
l_bl_a°
, 
cou¡
);

804 
	`RETURN
(
rc
);

807 i‡(
	`ns_c⁄√˘_ˇn˚l£t
(
ns
)) {

808 i‡(
ˇn˚loff
) {

809 
dlm
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(
pûl
, &
RMF_DLM_REQ
);

810 
	`LASSERT
(
dlm
);

815 
dlm
->
lock_cou¡
 = 
ˇn˚loff
;

818 
	`ldlm_˛i_ˇn˚l_li°
(
ˇn˚ls
, 
∑ck
, 
ªq
, 0);

820 
	`ldlm_˛i_ˇn˚l_li°
(
ˇn˚ls
, 
cou¡
 - 
∑ck
, 
NULL
, 0);

822 
	`ldlm_lock_li°_put
(
ˇn˚ls
, 
l_bl_a°
, 
cou¡
);

824 
	`RETURN
(0);

825 
	}
}

826 
EXPORT_SYMBOL
(
ldlm_¥ï_ñc_ªq
);

828 
	$ldlm_¥ï_íqueue_ªq
(
obd_exp‹t
 *
exp
, 
±Ãpc_ªque°
 *
ªq
,

829 
li°_hód
 *
ˇn˚ls
, 
cou¡
)

831  
	`ldlm_¥ï_ñc_ªq
(
exp
, 
ªq
, 
LUSTRE_DLM_VERSION
, 
LDLM_ENQUEUE
,

832 
LDLM_ENQUEUE_CANCEL_OFF
, 
ˇn˚ls
, 
cou¡
);

833 
	}
}

834 
EXPORT_SYMBOL
(
ldlm_¥ï_íqueue_ªq
);

836 
±Ãpc_ªque°
 *
	$ldlm_íqueue_∑ck
(
obd_exp‹t
 *
exp
, 
lvb_Àn
)

838 
±Ãpc_ªque°
 *
ªq
;

839 
rc
;

840 
ENTRY
;

842 
ªq
 = 
	`±Ãpc_ªque°_Æloc
(
	`˛ass_exp2˛iimp
(
exp
), &
RQF_LDLM_ENQUEUE
);

843 i‡(
ªq
 =
NULL
)

844 
	`RETURN
(
	`ERR_PTR
(-
ENOMEM
));

846 
rc
 = 
	`ldlm_¥ï_íqueue_ªq
(
exp
, 
ªq
, 
NULL
, 0);

847 i‡(
rc
) {

848 
	`±Ãpc_ªque°_‰ì
(
ªq
);

849 
	`RETURN
(
	`ERR_PTR
(
rc
));

852 
	`ªq_ˇpsuÀ_£t_size
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
, 
RCL_SERVER
, 
lvb_Àn
);

853 
	`±Ãpc_ªque°_£t_ª∂í
(
ªq
);

854 
	`RETURN
(
ªq
);

855 
	}
}

856 
EXPORT_SYMBOL
(
ldlm_íqueue_∑ck
);

868 
	$ldlm_˛i_íqueue
(
obd_exp‹t
 *
exp
, 
±Ãpc_ªque°
 **
ªqp
,

869 
ldlm_íqueue_öfo
 *
eöfo
,

870 c⁄° 
ldlm_ªs_id
 *
ªs_id
,

871 
ldlm_pﬁicy_d©a
 c⁄° *
pﬁicy
, 
__u64
 *
Êags
,

872 *
lvb
, 
__u32
 
lvb_Àn
, 
lvb_ty≥
Üvb_type,

873 
lu°ª_h™dÀ
 *
lockh
, 
async
)

875 
ldlm_«me•a˚
 *
ns
;

876 
ldlm_lock
 *
lock
;

877 
ldlm_ªque°
 *
body
;

878 
is_ª∂ay
 = *
Êags
 & 
LDLM_FL_REPLAY
;

879 
ªq_∑s£d_ö
 = 1;

880 
rc
, 
îr
;

881 
±Ãpc_ªque°
 *
ªq
;

882 
ENTRY
;

884 
	`LASSERT
(
exp
 !
NULL
);

886 
ns
 = 
exp
->
exp_obd
->
obd_«me•a˚
;

890 i‡(
is_ª∂ay
) {

891 
lock
 = 
	`ldlm_h™dÀ2lock_l⁄g
(
lockh
, 0);

892 
	`LASSERT
(
lock
 !
NULL
);

893 
	`LDLM_DEBUG
(
lock
, "client-sideÉnqueue START");

894 
	`LASSERT
(
exp
 =
lock
->
l_c⁄n_exp‹t
);

896 c⁄° 
ldlm_ˇŒback_suôe
 
cbs
 = {

897 .
lcs_com∂ëi⁄
 = 
eöfo
->
ei_cb_˝
,

898 .
lcs_blockög
 = 
eöfo
->
ei_cb_bl
,

899 .
lcs_glimp£
 = 
eöfo
->
ei_cb_gl


901 
lock
 = 
	`ldlm_lock_¸óã
(
ns
, 
ªs_id
, 
eöfo
->
ei_ty≥
,

902 
eöfo
->
ei_mode
, &
cbs
,Éöfo->
ei_cbd©a
,

903 
lvb_Àn
, 
lvb_ty≥
);

904 i‡(
	`IS_ERR
(
lock
))

905 
	`RETURN
(
	`PTR_ERR
(
lock
));

907 
	`ldlm_lock_addªf_öã∫Æ
(
lock
, 
eöfo
->
ei_mode
);

908 
	`ldlm_lock2h™dÀ
(
lock
, 
lockh
);

909 i‡(
pﬁicy
 !
NULL
)

910 
lock
->
l_pﬁicy_d©a
 = *
pﬁicy
;

912 i‡(
eöfo
->
ei_ty≥
 =
LDLM_EXTENT
) {

914 i‡(
pﬁicy
 =
NULL
)

915 
	`LBUG
();

917 
lock
->
l_ªq_exã¡
 = 
pﬁicy
->
l_exã¡
;

919 
	`LDLM_DEBUG
(
lock
, "˛õ¡-sidêíqueuêSTART, fœg†"
LPX64
"\n",

920 *
Êags
);

923 
lock
->
l_c⁄n_exp‹t
 = 
exp
;

924 
lock
->
l_exp‹t
 = 
NULL
;

925 
lock
->
l_blockög_a°
 = 
eöfo
->
ei_cb_bl
;

926 
lock
->
l_Êags
 |(*
Êags
 & (
LDLM_FL_NO_LRU
 | 
LDLM_FL_EXCL
));

927 
lock
->
l_œ°_a˘ivôy
 = 
	`cfs_time_cuºít_£c
();

931 i‡(
ªqp
 =
NULL
 || *reqp == NULL) {

932 
ªq
 = 
	`±Ãpc_ªque°_Æloc_∑ck
(
	`˛ass_exp2˛iimp
(
exp
),

933 &
RQF_LDLM_ENQUEUE
,

934 
LUSTRE_DLM_VERSION
,

935 
LDLM_ENQUEUE
);

936 i‡(
ªq
 =
NULL
) {

937 
	`Áûed_lock_˛ónup
(
ns
, 
lock
, 
eöfo
->
ei_mode
);

938 
	`LDLM_LOCK_RELEASE
(
lock
);

939 
	`RETURN
(-
ENOMEM
);

941 
ªq_∑s£d_ö
 = 0;

942 i‡(
ªqp
)

943 *
ªqp
 = 
ªq
;

945 
Àn
;

947 
ªq
 = *
ªqp
;

948 
Àn
 = 
	`ªq_ˇpsuÀ_gë_size
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
,

949 
RCL_CLIENT
);

950 
	`LASSERTF
(
Àn
 >(*
body
), "buflen[%d] = %d,Çot %d\n",

951 
DLM_LOCKREQ_OFF
, 
Àn
, ()(*
body
));

955 
body
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

956 
	`ldlm_lock2desc
(
lock
, &
body
->
lock_desc
);

957 
body
->
lock_Êags
 = 
	`ldlm_Êags_to_wúe
(*
Êags
);

958 
body
->
lock_h™dÀ
[0] = *
lockh
;

961 i‡(!
ªq_∑s£d_ö
) {

962 i‡(
lvb_Àn
 > 0)

963 
	`ªq_ˇpsuÀ_exãnd
(&
ªq
->
rq_pûl
,

964 &
RQF_LDLM_ENQUEUE_LVB
);

965 
	`ªq_ˇpsuÀ_£t_size
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
, 
RCL_SERVER
,

966 
lvb_Àn
);

967 
	`±Ãpc_ªque°_£t_ª∂í
(
ªq
);

970 i‡(
async
) {

971 
	`LASSERT
(
ªqp
 !
NULL
);

972 
	`RETURN
(0);

975 
	`LDLM_DEBUG
(
lock
, "sendingÑequest");

977 
rc
 = 
	`±Ãpc_queue_waô
(
ªq
);

979 
îr
 = 
	`ldlm_˛i_íqueue_föi
(
exp
, 
ªq
, 
eöfo
->
ei_ty≥
, 
pﬁicy
 ? 1 : 0,

980 
eöfo
->
ei_mode
, 
Êags
, 
lvb
, 
lvb_Àn
,

981 
lockh
, 
rc
);

985 i‡(
îr
 =-
ENOLCK
)

986 
	`LDLM_LOCK_RELEASE
(
lock
);

988 
rc
 = 
îr
;

990 i‡(!
ªq_∑s£d_ö
 && 
ªq
 !
NULL
) {

991 
	`±Ãpc_ªq_föished
(
ªq
);

992 i‡(
ªqp
)

993 *
ªqp
 = 
NULL
;

996 
	`RETURN
(
rc
);

997 
	}
}

998 
EXPORT_SYMBOL
(
ldlm_˛i_íqueue
);

1000 
	$ldlm_˛i_c⁄vît_loˇl
(
ldlm_lock
 *
lock
, 
√w_mode
,

1001 
__u32
 *
Êags
)

1003 
ldlm_ªsour˚
 *
ªs
;

1004 
rc
;

1005 
ENTRY
;

1006 i‡(
	`ns_is_˛õ¡
(
	`ldlm_lock_to_ns
(
lock
))) {

1007 
	`CERROR
("TryingÅo cancelÜocalÜock\n");

1008 
	`LBUG
();

1010 
	`LDLM_DEBUG
(
lock
, "client-sideÜocal convert");

1012 
ªs
 = 
	`ldlm_lock_c⁄vît
(
lock
, 
√w_mode
, 
Êags
);

1013 i‡(
ªs
) {

1014 
	`ldlm_ª¥o˚ss_Æl
(
ªs
);

1015 
rc
 = 0;

1017 
rc
 = 
LUSTRE_EDEADLK
;

1019 
	`LDLM_DEBUG
(
lock
, "client-sideÜocal convert handler END");

1020 
	`LDLM_LOCK_PUT
(
lock
);

1021 
	`RETURN
(
rc
);

1022 
	}
}

1028 
	$ldlm_˛i_c⁄vît
(
lu°ª_h™dÀ
 *
lockh
, 
√w_mode
, 
__u32
 *
Êags
)

1030 
ldlm_ªque°
 *
body
;

1031 
ldlm_ª∂y
 *
ª∂y
;

1032 
ldlm_lock
 *
lock
;

1033 
ldlm_ªsour˚
 *
ªs
;

1034 
±Ãpc_ªque°
 *
ªq
;

1035 
rc
;

1036 
ENTRY
;

1038 
lock
 = 
	`ldlm_h™dÀ2lock
(
lockh
);

1039 i‡(!
lock
) {

1040 
	`LBUG
();

1041 
	`RETURN
(-
EINVAL
);

1043 *
Êags
 = 0;

1045 i‡(
lock
->
l_c⁄n_exp‹t
 =
NULL
)

1046 
	`RETURN
(
	`ldlm_˛i_c⁄vît_loˇl
(
lock
, 
√w_mode
, 
Êags
));

1048 
	`LDLM_DEBUG
(
lock
, "client-side convert");

1050 
ªq
 = 
	`±Ãpc_ªque°_Æloc_∑ck
(
	`˛ass_exp2˛iimp
(
lock
->
l_c⁄n_exp‹t
),

1051 &
RQF_LDLM_CONVERT
, 
LUSTRE_DLM_VERSION
,

1052 
LDLM_CONVERT
);

1053 i‡(
ªq
 =
NULL
) {

1054 
	`LDLM_LOCK_PUT
(
lock
);

1055 
	`RETURN
(-
ENOMEM
);

1058 
body
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

1059 
body
->
lock_h™dÀ
[0] = 
lock
->
l_ªmŸe_h™dÀ
;

1061 
body
->
lock_desc
.
l_ªq_mode
 = 
√w_mode
;

1062 
body
->
lock_Êags
 = 
	`ldlm_Êags_to_wúe
(*
Êags
);

1065 
	`±Ãpc_ªque°_£t_ª∂í
(
ªq
);

1066 
rc
 = 
	`±Ãpc_queue_waô
(
ªq
);

1067 i‡(
rc
 !
ELDLM_OK
)

1068 
	`GOTO
(
out
, 
rc
);

1070 
ª∂y
 = 
	`ªq_ˇpsuÀ_£rvî_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REP
);

1071 i‡(
ª∂y
 =
NULL
)

1072 
	`GOTO
(
out
, 
rc
 = -
EPROTO
);

1074 i‡(
ªq
->
rq_°©us
)

1075 
	`GOTO
(
out
, 
rc
 = 
ªq
->
rq_°©us
);

1077 
ªs
 = 
	`ldlm_lock_c⁄vît
(
lock
, 
√w_mode
, &
ª∂y
->
lock_Êags
);

1078 i‡(
ªs
 !
NULL
) {

1079 
	`ldlm_ª¥o˚ss_Æl
(
ªs
);

1082 i‡(
lock
->
l_com∂ëi⁄_a°
) {

1083 
rc
 = 
lock
->
	`l_com∂ëi⁄_a°
÷ock, 
LDLM_FL_WAIT_NOREPROC
,

1084 
NULL
);

1085 i‡(
rc
)

1086 
	`GOTO
(
out
, 
rc
);

1089 
rc
 = 
LUSTRE_EDEADLK
;

1091 
EXIT
;

1092 
out
:

1093 
	`LDLM_LOCK_PUT
(
lock
);

1094 
	`±Ãpc_ªq_föished
(
ªq
);

1095  
rc
;

1096 
	}
}

1105 
__u64
 
	$ldlm_˛i_ˇn˚l_loˇl
(
ldlm_lock
 *
lock
)

1107 
__u64
 
rc
 = 
LDLM_FL_LOCAL_ONLY
;

1108 
ENTRY
;

1110 i‡(
lock
->
l_c⁄n_exp‹t
) {

1111 
boﬁ
 
loˇl_⁄ly
;

1113 
	`LDLM_DEBUG
(
lock
, "client-side cancel");

1115 
	`lock_ªs_™d_lock
(
lock
);

1116 
	`ldlm_£t_cb≥ndög
(
lock
);

1117 
loˇl_⁄ly
 = !!(
lock
->
l_Êags
 &

1118 (
LDLM_FL_LOCAL_ONLY
|
LDLM_FL_CANCEL_ON_BLOCK
));

1119 
	`ldlm_ˇn˚l_ˇŒback
(
lock
);

1120 
rc
 = (
	`ldlm_is_bl_a°
(
lock
)) ?

1121 
LDLM_FL_BL_AST
 : 
LDLM_FL_CANCELING
;

1122 
	`u∆ock_ªs_™d_lock
(
lock
);

1124 i‡(
loˇl_⁄ly
) {

1125 
	`CDEBUG
(
D_DLMTRACE
, "not sendingÑequest (at caller's "

1127 
rc
 = 
LDLM_FL_LOCAL_ONLY
;

1129 
	`ldlm_lock_ˇn˚l
(
lock
);

1131 i‡(
	`ns_is_˛õ¡
(
	`ldlm_lock_to_ns
(
lock
))) {

1132 
	`LDLM_ERROR
(
lock
, "TryingÅo cancelÜocalÜock");

1133 
	`LBUG
();

1135 
	`LDLM_DEBUG
(
lock
, "server-sideÜocal cancel");

1136 
	`ldlm_lock_ˇn˚l
(
lock
);

1137 
	`ldlm_ª¥o˚ss_Æl
(
lock
->
l_ªsour˚
);

1140 
	`RETURN
(
rc
);

1141 
	}
}

1146 
	$ldlm_ˇn˚l_∑ck
(
±Ãpc_ªque°
 *
ªq
,

1147 
li°_hód
 *
hód
, 
cou¡
)

1149 
ldlm_ªque°
 *
dlm
;

1150 
ldlm_lock
 *
lock
;

1151 
max
, 
∑cked
 = 0;

1152 
ENTRY
;

1154 
dlm
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

1155 
	`LASSERT
(
dlm
 !
NULL
);

1158 
max
 = 
	`ªq_ˇpsuÀ_gë_size
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
, 
RCL_CLIENT
) -

1159 (
ldlm_ªque°
);

1160 
max
 /(
lu°ª_h™dÀ
);

1161 
max
 +
LDLM_LOCKREQ_HANDLES
;

1162 
	`LASSERT
(
max
 >
dlm
->
lock_cou¡
 + 
cou¡
);

1167 
	`li°_f‹_óch_íåy
(
lock
, 
hód
, 
l_bl_a°
) {

1168 i‡(!
cou¡
--)

1170 
	`LASSERT
(
lock
->
l_c⁄n_exp‹t
);

1172 
	`LDLM_DEBUG
(
lock
, "packing");

1173 
dlm
->
lock_h™dÀ
[dlm->
lock_cou¡
++] = 
lock
->
l_ªmŸe_h™dÀ
;

1174 
∑cked
++;

1176 
	`CDEBUG
(
D_DLMTRACE
, "%dÜock†∑cked\n", 
∑cked
);

1177 
EXIT
;

1178 
	}
}

1183 
	$ldlm_˛i_ˇn˚l_ªq
(
obd_exp‹t
 *
exp
, 
li°_hód
 *
ˇn˚ls
,

1184 
cou¡
, 
ldlm_ˇn˚l_Êags
 
Êags
)

1186 
±Ãpc_ªque°
 *
ªq
 = 
NULL
;

1187 
obd_imp‹t
 *
imp
;

1188 
‰ì
, 
£¡
 = 0;

1189 
rc
 = 0;

1190 
ENTRY
;

1192 
	`LASSERT
(
exp
 !
NULL
);

1193 
	`LASSERT
(
cou¡
 > 0);

1195 
	`CFS_FAIL_TIMEOUT
(
OBD_FAIL_LDLM_PAUSE_CANCEL
, 
cfs_Áû_vÆ
);

1197 i‡(
	`CFS_FAIL_CHECK
(
OBD_FAIL_LDLM_CANCEL_RACE
))

1198 
	`RETURN
(
cou¡
);

1200 
‰ì
 = 
	`ldlm_f‹m©_h™dÀs_avaû
(
	`˛ass_exp2˛iimp
(
exp
),

1201 &
RQF_LDLM_CANCEL
, 
RCL_CLIENT
, 0);

1202 i‡(
cou¡
 > 
‰ì
)

1203 
cou¡
 = 
‰ì
;

1206 
imp
 = 
	`˛ass_exp2˛iimp
(
exp
);

1207 i‡(
imp
 =
NULL
 || imp->
imp_övÆid
) {

1208 
	`CDEBUG
(
D_DLMTRACE
,

1209 "skùpög c™˚»⁄ invÆid imp‹à%p\n", 
imp
);

1210 
	`RETURN
(
cou¡
);

1213 
ªq
 = 
	`±Ãpc_ªque°_Æloc
(
imp
, &
RQF_LDLM_CANCEL
);

1214 i‡(
ªq
 =
NULL
)

1215 
	`GOTO
(
out
, 
rc
 = -
ENOMEM
);

1217 
	`ªq_ˇpsuÀ_fûÀd_sizes
(&
ªq
->
rq_pûl
, 
RCL_CLIENT
);

1218 
	`ªq_ˇpsuÀ_£t_size
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
, 
RCL_CLIENT
,

1219 
	`ldlm_ªque°_bufsize
(
cou¡
, 
LDLM_CANCEL
));

1221 
rc
 = 
	`±Ãpc_ªque°_∑ck
(
ªq
, 
LUSTRE_DLM_VERSION
, 
LDLM_CANCEL
);

1222 i‡(
rc
) {

1223 
	`±Ãpc_ªque°_‰ì
(
ªq
);

1224 
	`GOTO
(
out
, 
rc
);

1231 i‡(
	`exp_c⁄√˘_Êags
(
exp
Ë& 
OBD_CONNECT_MDS_MDS
 &&

1232 
exp
->
exp_obd
->
obd_lu_dev
 !
NULL
 &&

1233 
exp
->
exp_obd
->
obd_lu_dev
->
ld_sôe
 !
NULL
) {

1234 
lu_devi˚
 *
t›_dev
;

1236 
t›_dev
 = 
exp
->
exp_obd
->
obd_lu_dev
->
ld_sôe
->
ls_t›_dev
;

1237 i‡(
t›_dev
 !
NULL
 &&

1238 
t›_dev
->
ld_obd
->
obd_ªcovîög
)

1239 
ªq
->
rq_Ælow_ª∂ay
 = 1;

1242 
ªq
->
rq_ªque°_p‹èl
 = 
LDLM_CANCEL_REQUEST_PORTAL
;

1243 
ªq
->
rq_ª∂y_p‹èl
 = 
LDLM_CANCEL_REPLY_PORTAL
;

1244 
	`±Ãpc_©_£t_ªq_timeout
(
ªq
);

1246 
	`ldlm_ˇn˚l_∑ck
(
ªq
, 
ˇn˚ls
, 
cou¡
);

1248 
	`±Ãpc_ªque°_£t_ª∂í
(
ªq
);

1249 i‡(
Êags
 & 
LCF_ASYNC
) {

1250 
	`±Ãpcd_add_ªq
(
ªq
);

1251 
£¡
 = 
cou¡
;

1252 
	`GOTO
(
out
, 0);

1255 
rc
 = 
	`±Ãpc_queue_waô
(
ªq
);

1256 i‡(
rc
 =
LUSTRE_ESTALE
) {

1257 
	`CDEBUG
(
D_DLMTRACE
, "client/server (nid %s) "

1259 
	`libcfs_nid2°r
(
ªq
->
rq_imp‹t
->

1260 
imp_c⁄√˘i⁄
->
c_≥î
.
nid
));

1261 
rc
 = 0;

1262 } i‡(
rc
 =-
ETIMEDOUT
 &&

1263 
ªq
->
rq_imp‹t_gíî©i⁄
 =
imp
->
imp_gíî©i⁄
) {

1264 
	`±Ãpc_ªq_föished
(
ªq
);

1266 } i‡(
rc
 !
ELDLM_OK
) {

1268 
	`CDEBUG_LIMIT
(
rc
 =-
ESHUTDOWN
 ? 
D_DLMTRACE
 : 
D_ERROR
,

1270 "ˇn˚lögányway\n", 
rc
);

1273 
£¡
 = 
cou¡
;

1277 
	`±Ãpc_ªq_föished
(
ªq
);

1278 
EXIT
;

1279 
out
:

1280  
£¡
 ? síà: 
rc
;

1281 
	}
}

1283 
ölöe
 
ldlm_poﬁ
 *
	$ldlm_imp2∂
(
obd_imp‹t
 *
imp
)

1285 
	`LASSERT
(
imp
 !
NULL
);

1286  &
imp
->
imp_obd
->
obd_«me•a˚
->
ns_poﬁ
;

1287 
	}
}

1292 
	$ldlm_˛i_upd©e_poﬁ
(
±Ãpc_ªque°
 *
ªq
)

1294 
obd_devi˚
 *
obd
;

1295 
__u64
 
√w_¶v
;

1296 
__u32
 
√w_limô
;

1297 
ENTRY
;

1298 i‡(
	`u∆ikñy
(!
ªq
->
rq_imp‹t
 || !ªq->rq_imp‹t->
imp_obd
 ||

1299 !
	`imp_c⁄√˘_Ãu_ªsize
(
ªq
->
rq_imp‹t
)))

1304 
	`RETURN
(0);

1312 i‡(
	`lu°ª_msg_gë_¶v
(
ªq
->
rq_ªpmsg
) == 0 ||

1313 
	`lu°ª_msg_gë_limô
(
ªq
->
rq_ªpmsg
) == 0) {

1314 
	`DEBUG_REQ
(
D_HA
, 
ªq
, "Zero SLV or Limit found "

1315 "(SLV: "
LPU64
", Limit: %u)",

1316 
	`lu°ª_msg_gë_¶v
(
ªq
->
rq_ªpmsg
),

1317 
	`lu°ª_msg_gë_limô
(
ªq
->
rq_ªpmsg
));

1318 
	`RETURN
(0);

1321 
√w_limô
 = 
	`lu°ª_msg_gë_limô
(
ªq
->
rq_ªpmsg
);

1322 
√w_¶v
 = 
	`lu°ª_msg_gë_¶v
(
ªq
->
rq_ªpmsg
);

1323 
obd
 = 
ªq
->
rq_imp‹t
->
imp_obd
;

1330 
	`wrôe_lock
(&
obd
->
obd_poﬁ_lock
);

1331 
obd
->
obd_poﬁ_¶v
 = 
√w_¶v
;

1332 
obd
->
obd_poﬁ_limô
 = 
√w_limô
;

1333 
	`wrôe_u∆ock
(&
obd
->
obd_poﬁ_lock
);

1335 
	`RETURN
(0);

1336 
	}
}

1343 
	$ldlm_˛i_ˇn˚l
(
lu°ª_h™dÀ
 *
lockh
,

1344 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
)

1346 
obd_exp‹t
 *
exp
;

1347 
ldlm_Ãu_Êags
 
Ãu_Êags
;

1348 
avaû
, 
cou¡
 = 1;

1349 
__u64
 
rc
 = 0;

1350 
ldlm_«me•a˚
 *
ns
;

1351 
ldlm_lock
 *
lock
;

1352 
li°_hód
 
ˇn˚ls
 = 
	`LIST_HEAD_INIT
(cancels);

1353 
ENTRY
;

1355 
lock
 = 
	`ldlm_h™dÀ2lock_l⁄g
(
lockh
, 0);

1356 i‡(
lock
 =
NULL
) {

1357 
	`LDLM_DEBUG_NOLOCK
("lock isálready being destroyed");

1358 
	`RETURN
(0);

1361 
	`lock_ªs_™d_lock
(
lock
);

1363 i‡(
	`ldlm_is_ˇn˚lög
(
lock
Ë&& (
ˇn˚l_Êags
 & 
LCF_ASYNC
)) {

1364 
	`u∆ock_ªs_™d_lock
(
lock
);

1365 
	`LDLM_LOCK_RELEASE
(
lock
);

1366 
	`RETURN
(0);

1369 
	`ldlm_£t_ˇn˚lög
(
lock
);

1370 
	`u∆ock_ªs_™d_lock
(
lock
);

1372 
rc
 = 
	`ldlm_˛i_ˇn˚l_loˇl
(
lock
);

1373 i‡(
rc
 =
LDLM_FL_LOCAL_ONLY
 || 
ˇn˚l_Êags
 & 
LCF_LOCAL
) {

1374 
	`LDLM_LOCK_RELEASE
(
lock
);

1375 
	`RETURN
(0);

1380 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_bl_a°
));

1381 
	`li°_add
(&
lock
->
l_bl_a°
, &
ˇn˚ls
);

1383 
exp
 = 
lock
->
l_c⁄n_exp‹t
;

1384 i‡(
	`exp_c⁄√˘_ˇn˚l£t
(
exp
)) {

1385 
avaû
 = 
	`ldlm_f‹m©_h™dÀs_avaû
(
	`˛ass_exp2˛iimp
(
exp
),

1386 &
RQF_LDLM_CANCEL
,

1387 
RCL_CLIENT
, 0);

1388 
	`LASSERT
(
avaû
 > 0);

1390 
ns
 = 
	`ldlm_lock_to_ns
(
lock
);

1391 
Ãu_Êags
 = 
	`ns_c⁄√˘_Ãu_ªsize
(
ns
) ?

1392 
LDLM_LRU_FLAG_LRUR
 : 
LDLM_LRU_FLAG_AGED
;

1393 
cou¡
 +
	`ldlm_ˇn˚l_Ãu_loˇl
(
ns
, &
ˇn˚ls
, 0, 
avaû
 - 1,

1394 
LCF_BL_AST
, 
Ãu_Êags
);

1396 
	`ldlm_˛i_ˇn˚l_li°
(&
ˇn˚ls
, 
cou¡
, 
NULL
, 
ˇn˚l_Êags
);

1397 
	`RETURN
(0);

1398 
	}
}

1399 
EXPORT_SYMBOL
(
ldlm_˛i_ˇn˚l
);

1405 
	$ldlm_˛i_ˇn˚l_li°_loˇl
(
li°_hód
 *
ˇn˚ls
, 
cou¡
,

1406 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
)

1408 
li°_hód
 
hód
 = 
	`LIST_HEAD_INIT
(head);

1409 
ldlm_lock
 *
lock
, *
√xt
;

1410 
À·
 = 0, 
bl_a°
 = 0;

1411 
__u64
 
rc
;

1413 
À·
 = 
cou¡
;

1414 
	`li°_f‹_óch_íåy_ß„
(
lock
, 
√xt
, 
ˇn˚ls
, 
l_bl_a°
) {

1415 i‡(
À·
-- == 0)

1418 i‡(
ˇn˚l_Êags
 & 
LCF_LOCAL
) {

1419 
rc
 = 
LDLM_FL_LOCAL_ONLY
;

1420 
	`ldlm_lock_ˇn˚l
(
lock
);

1422 
rc
 = 
	`ldlm_˛i_ˇn˚l_loˇl
(
lock
);

1428 i‡(!(
ˇn˚l_Êags
 & 
LCF_BL_AST
Ë&& (
rc
 =
LDLM_FL_BL_AST
)) {

1429 
	`LDLM_DEBUG
(
lock
, "CancelÜock separately");

1430 
	`li°_dñ_öô
(&
lock
->
l_bl_a°
);

1431 
	`li°_add
(&
lock
->
l_bl_a°
, &
hód
);

1432 
bl_a°
++;

1435 i‡(
rc
 =
LDLM_FL_LOCAL_ONLY
) {

1437 
	`li°_dñ_öô
(&
lock
->
l_bl_a°
);

1438 
	`LDLM_LOCK_RELEASE
(
lock
);

1439 
cou¡
--;

1442 i‡(
bl_a°
 > 0) {

1443 
cou¡
 -
bl_a°
;

1444 
	`ldlm_˛i_ˇn˚l_li°
(&
hód
, 
bl_a°
, 
NULL
, 0);

1447 
	`RETURN
(
cou¡
);

1448 
	}
}

1455 
ldlm_pﬁicy_ªs


1456 
	$ldlm_ˇn˚l_no_waô_pﬁicy
(
ldlm_«me•a˚
 *
ns
, 
ldlm_lock
 *
lock
,

1457 
unu£d
, 
added
, 
cou¡
)

1459 
ldlm_pﬁicy_ªs
 
ªsu…
 = 
LDLM_POLICY_CANCEL_LOCK
;

1465 
lock
->
l_ªsour˚
->
Ã_ty≥
) {

1466 
LDLM_EXTENT
:

1467 
LDLM_IBITS
:

1468 i‡(
ns
->
ns_ˇn˚l
 !
NULL
 &&Çs->
	`ns_ˇn˚l
(
lock
) != 0)

1471 
ªsu…
 = 
LDLM_POLICY_SKIP_LOCK
;

1472 
	`lock_ªs_™d_lock
(
lock
);

1473 
	`ldlm_£t_skù≥d
(
lock
);

1474 
	`u∆ock_ªs_™d_lock
(
lock
);

1478 
	`RETURN
(
ªsu…
);

1479 
	}
}

1490 
ldlm_pﬁicy_ªs
 
	$ldlm_ˇn˚l_Ãur_pﬁicy
(
ldlm_«me•a˚
 *
ns
,

1491 
ldlm_lock
 *
lock
,

1492 
unu£d
, 
added
,

1493 
cou¡
)

1495 
cfs_time_t
 
cur
 = 
	`cfs_time_cuºít
();

1496 
ldlm_poﬁ
 *
∂
 = &
ns
->
ns_poﬁ
;

1497 
__u64
 
¶v
, 
lvf
, 
lv
;

1498 
cfs_time_t
 
œ
;

1502 i‡(
cou¡
 && 
added
 >= count)

1503  
LDLM_POLICY_KEEP_LOCK
;

1507 i‡(
	`cfs_time_a·î
(
	`cfs_time_cuºít
(),

1508 
	`cfs_time_add
(
lock
->
l_œ°_u£d
, 
ns
->
ns_max_age
)))

1509  
LDLM_POLICY_CANCEL_LOCK
;

1511 
¶v
 = 
	`ldlm_poﬁ_gë_¶v
(
∂
);

1512 
lvf
 = 
	`ldlm_poﬁ_gë_lvf
(
∂
);

1513 
œ
 = 
	`cfs_duøti⁄_£c
(
	`cfs_time_sub
(
cur
,

1514 
lock
->
l_œ°_u£d
));

1515 
lv
 = 
lvf
 * 
œ
 * 
unu£d
;

1518 
	`ldlm_poﬁ_£t_˛v
(
∂
, 
lv
);

1522 i‡(
¶v
 =0 || 
lv
 < slv)

1523  
LDLM_POLICY_KEEP_LOCK
;

1525  
LDLM_POLICY_CANCEL_LOCK
;

1526 
	}
}

1528 
ldlm_pﬁicy_ªs


1529 
	$ldlm_ˇn˚l_Ãur_no_waô_pﬁicy
(
ldlm_«me•a˚
 *
ns
,

1530 
ldlm_lock
 *
lock
,

1531 
unu£d
, 
added
,

1532 
cou¡
)

1534 
ldlm_pﬁicy_ªs
 
ªsu…
;

1536 
ªsu…
 = 
	`ldlm_ˇn˚l_Ãur_pﬁicy
(
ns
, 
lock
, 
unu£d
, 
added
, 
cou¡
);

1537 i‡(
ªsu…
 =
LDLM_POLICY_KEEP_LOCK
)

1538  
ªsu…
;

1540  
	`ldlm_ˇn˚l_no_waô_pﬁicy
(
ns
, 
lock
, 
unu£d
, 
added
, 
cou¡
);

1541 
	}
}

1552 
ldlm_pﬁicy_ªs
 
	$ldlm_ˇn˚l_∑s£d_pﬁicy
(
ldlm_«me•a˚
 *
ns
,

1553 
ldlm_lock
 *
lock
,

1554 
unu£d
, 
added
,

1555 
cou¡
)

1559  (
added
 >
cou¡
) ?

1560 
LDLM_POLICY_KEEP_LOCK
 : 
LDLM_POLICY_CANCEL_LOCK
;

1561 
	}
}

1572 
ldlm_pﬁicy_ªs
 
	$ldlm_ˇn˚l_aged_pﬁicy
(
ldlm_«me•a˚
 *
ns
,

1573 
ldlm_lock
 *
lock
,

1574 
unu£d
, 
added
,

1575 
cou¡
)

1577 i‡((
added
 >
cou¡
) &&

1578 
	`cfs_time_bef‹e
(
	`cfs_time_cuºít
(),

1579 
	`cfs_time_add
(
lock
->
l_œ°_u£d
, 
ns
->
ns_max_age
)))

1580  
LDLM_POLICY_KEEP_LOCK
;

1582  
LDLM_POLICY_CANCEL_LOCK
;

1583 
	}
}

1595 
ldlm_pﬁicy_ªs
 
	$ldlm_ˇn˚l_deÁu…_pﬁicy
(
ldlm_«me•a˚
 *
ns
,

1596 
ldlm_lock
 *
lock
,

1597 
unu£d
, 
added
,

1598 
cou¡
)

1602  (
added
 >
cou¡
) ?

1603 
LDLM_POLICY_KEEP_LOCK
 : 
LDLM_POLICY_CANCEL_LOCK
;

1604 
	}
}

1606 
	gldlm_pﬁicy_ªs


1607 (*
	tldlm_ˇn˚l_Ãu_pﬁicy_t
)(
	tldlm_«me•a˚
 *
	tns
, 
	tldlm_lock
 *
	tlock
,

1608 
	tunu£d
, 
	tadded
, 
	tcou¡
);

1610 
ldlm_ˇn˚l_Ãu_pﬁicy_t


1611 
	$ldlm_ˇn˚l_Ãu_pﬁicy
(
ldlm_«me•a˚
 *
ns
, 
ldlm_Ãu_Êags
 
Ãu_Êags
)

1613 i‡(
Ãu_Êags
 & 
LDLM_LRU_FLAG_NO_WAIT
)

1614  
ldlm_ˇn˚l_no_waô_pﬁicy
;

1616 i‡(
	`ns_c⁄√˘_Ãu_ªsize
(
ns
)) {

1617 i‡(
Ãu_Êags
 & 
LDLM_LRU_FLAG_SHRINK
)

1619  
ldlm_ˇn˚l_∑s£d_pﬁicy
;

1620 i‡(
Ãu_Êags
 & 
LDLM_LRU_FLAG_LRUR
)

1621  
ldlm_ˇn˚l_Ãur_pﬁicy
;

1622 i‡(
Ãu_Êags
 & 
LDLM_LRU_FLAG_PASSED
)

1623  
ldlm_ˇn˚l_∑s£d_pﬁicy
;

1624 i‡(
Ãu_Êags
 & 
LDLM_LRU_FLAG_LRUR_NO_WAIT
)

1625  
ldlm_ˇn˚l_Ãur_no_waô_pﬁicy
;

1627 i‡(
Ãu_Êags
 & 
LDLM_LRU_FLAG_AGED
)

1628  
ldlm_ˇn˚l_aged_pﬁicy
;

1631  
ldlm_ˇn˚l_deÁu…_pﬁicy
;

1632 
	}
}

1667 
	$ldlm_¥ï¨e_Ãu_li°
(
ldlm_«me•a˚
 *
ns
,

1668 
li°_hód
 *
ˇn˚ls
, 
cou¡
, 
max
,

1669 
ldlm_Ãu_Êags
 
Ãu_Êags
)

1671 
ldlm_ˇn˚l_Ãu_pﬁicy_t
 
pf
;

1672 
ldlm_lock
 *
lock
, *
√xt
;

1673 
added
 = 0, 
unu£d
, 
ªmaöed
;

1674 
no_waô
 = 
Ãu_Êags
 & (
LDLM_LRU_FLAG_NO_WAIT
 |

1675 
LDLM_LRU_FLAG_LRUR_NO_WAIT
);

1676 
ENTRY
;

1678 
	`•ö_lock
(&
ns
->
ns_lock
);

1679 
unu£d
 = 
ns
->
ns_ƒ_unu£d
;

1680 
ªmaöed
 = 
unu£d
;

1682 i‡(!
	`ns_c⁄√˘_Ãu_ªsize
(
ns
))

1683 
cou¡
 +
unu£d
 - 
ns
->
ns_max_unu£d
;

1685 
pf
 = 
	`ldlm_ˇn˚l_Ãu_pﬁicy
(
ns
, 
Ãu_Êags
);

1686 
	`LASSERT
(
pf
 !
NULL
);

1688 !
	`li°_em±y
(&
ns
->
ns_unu£d_li°
)) {

1689 
ldlm_pﬁicy_ªs
 
ªsu…
;

1690 
cfs_time_t
 
œ°_u£
 = 0;

1693 i‡(
ªmaöed
-- <= 0)

1697 i‡(
max
 && 
added
 >= max)

1700 
	`li°_f‹_óch_íåy_ß„
(
lock
, 
√xt
, &
ns
->
ns_unu£d_li°
,

1701 
l_Ãu
) {

1703 
	`LASSERT
(!
	`ldlm_is_bl_a°
(
lock
));

1705 i‡(
no_waô
 && 
	`ldlm_is_skù≥d
(
lock
))

1709 
œ°_u£
 = 
lock
->
l_œ°_u£d
;

1710 i‡(
œ°_u£
 =
	`cfs_time_cuºít
())

1715 i‡(!
	`ldlm_is_ˇn˚lög
(
lock
))

1718 
	`ldlm_lock_ªmove_‰om_Ãu_nﬁock
(
lock
);

1720 i‡(&
lock
->
l_Ãu
 =&
ns
->
ns_unu£d_li°
)

1723 
	`LDLM_LOCK_GET
(
lock
);

1724 
	`•ö_u∆ock
(&
ns
->
ns_lock
);

1725 
	`lu_ªf_add
(&
lock
->
l_ª„ªn˚
, 
__FUNCTION__
, 
cuºít
);

1740 
ªsu…
 = 
	`pf
(
ns
, 
lock
, 
unu£d
, 
added
, 
cou¡
);

1741 i‡(
ªsu…
 =
LDLM_POLICY_KEEP_LOCK
) {

1742 
	`lu_ªf_dñ
(&
lock
->
l_ª„ªn˚
,

1743 
__FUNCTION__
, 
cuºít
);

1744 
	`LDLM_LOCK_RELEASE
(
lock
);

1745 
	`•ö_lock
(&
ns
->
ns_lock
);

1748 i‡(
ªsu…
 =
LDLM_POLICY_SKIP_LOCK
) {

1749 
	`lu_ªf_dñ
(&
lock
->
l_ª„ªn˚
,

1750 
__func__
, 
cuºít
);

1751 
	`LDLM_LOCK_RELEASE
(
lock
);

1752 
	`•ö_lock
(&
ns
->
ns_lock
);

1756 
	`lock_ªs_™d_lock
(
lock
);

1758 i‡(
	`ldlm_is_ˇn˚lög
(
lock
) ||

1759 
	`ldlm_lock_ªmove_‰om_Ãu_check
(
lock
, 
œ°_u£
) == 0) {

1766 
	`u∆ock_ªs_™d_lock
(
lock
);

1767 
	`lu_ªf_dñ
(&
lock
->
l_ª„ªn˚
, 
__FUNCTION__
, 
cuºít
);

1768 
	`LDLM_LOCK_RELEASE
(
lock
);

1769 
	`•ö_lock
(&
ns
->
ns_lock
);

1772 
	`LASSERT
(!
lock
->
l_ªadîs
 && !lock->
l_wrôîs
);

1779 
	`ldlm_˛ór_ˇn˚l_⁄_block
(
lock
);

1787 
lock
->
l_Êags
 |
LDLM_FL_CBPENDING
 | 
LDLM_FL_CANCELING
;

1795 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_bl_a°
));

1796 
	`li°_add
(&
lock
->
l_bl_a°
, 
ˇn˚ls
);

1797 
	`u∆ock_ªs_™d_lock
(
lock
);

1798 
	`lu_ªf_dñ
(&
lock
->
l_ª„ªn˚
, 
__FUNCTION__
, 
cuºít
);

1799 
	`•ö_lock
(&
ns
->
ns_lock
);

1800 
added
++;

1801 
unu£d
--;

1803 
	`•ö_u∆ock
(&
ns
->
ns_lock
);

1804 
	`RETURN
(
added
);

1805 
	}
}

1807 
	$ldlm_ˇn˚l_Ãu_loˇl
(
ldlm_«me•a˚
 *
ns
, 
li°_hód
 *
ˇn˚ls
,

1808 
cou¡
, 
max
,

1809 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
,

1810 
ldlm_Ãu_Êags
 
Ãu_Êags
)

1812 
added
;

1814 
added
 = 
	`ldlm_¥ï¨e_Ãu_li°
(
ns
, 
ˇn˚ls
, 
cou¡
, 
max
, 
Ãu_Êags
);

1815 i‡(
added
 <= 0)

1816  
added
;

1818  
	`ldlm_˛i_ˇn˚l_li°_loˇl
(
ˇn˚ls
, 
added
, 
ˇn˚l_Êags
);

1819 
	}
}

1829 
	$ldlm_ˇn˚l_Ãu
(
ldlm_«me•a˚
 *
ns
, 
ƒ
,

1830 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
,

1831 
ldlm_Ãu_Êags
 
Ãu_Êags
)

1833 
li°_hód
 
ˇn˚ls
 = 
	`LIST_HEAD_INIT
(cancels);

1834 
cou¡
, 
rc
;

1835 
ENTRY
;

1839 
cou¡
 = 
	`ldlm_¥ï¨e_Ãu_li°
(
ns
, &
ˇn˚ls
, 
ƒ
, 0, 
Ãu_Êags
);

1840 
rc
 = 
	`ldlm_bl_to_thªad_li°
(
ns
, 
NULL
, &
ˇn˚ls
, 
cou¡
, 
ˇn˚l_Êags
);

1841 i‡(
rc
 == 0)

1842 
	`RETURN
(
cou¡
);

1844 
	`RETURN
(0);

1845 
	}
}

1852 
	$ldlm_ˇn˚l_ªsour˚_loˇl
(
ldlm_ªsour˚
 *
ªs
,

1853 
li°_hód
 *
ˇn˚ls
,

1854 
ldlm_pﬁicy_d©a
 *
pﬁicy
,

1855 
ldlm_mode
 
mode
, 
__u64
 
lock_Êags
,

1856 
ldlm_ˇn˚l_Êags
 
ˇn˚l_Êags
,

1857 *
›aque
)

1859 
ldlm_lock
 *
lock
;

1860 
cou¡
 = 0;

1861 
ENTRY
;

1863 
	`lock_ªs
(
ªs
);

1864 
	`li°_f‹_óch_íåy
(
lock
, &
ªs
->
Ã_gø¡ed
, 
l_ªs_lök
) {

1865 i‡(
›aque
 !
NULL
 && 
lock
->
l_a°_d©a
 != opaque) {

1866 
	`LDLM_ERROR
(
lock
, "data %p doesn't match opaque %p",

1867 
lock
->
l_a°_d©a
, 
›aque
);

1872 i‡(
lock
->
l_ªadîs
 ||Üock->
l_wrôîs
)

1877 i‡(
	`ldlm_is_bl_a°
(
lock
Ë|| 
	`ldlm_is_ˇn˚lög
(lock))

1880 i‡(
	`lockmode_com∑t
(
lock
->
l_gø¡ed_mode
, 
mode
))

1885 i‡(
pﬁicy
 && (
lock
->
l_ªsour˚
->
Ã_ty≥
 =
LDLM_IBITS
) &&

1886 !(
lock
->
l_pﬁicy_d©a
.
l_öodebôs
.
bôs
 &

1887 
pﬁicy
->
l_öodebôs
.
bôs
))

1891 
lock
->
l_Êags
 |
LDLM_FL_CBPENDING
 | 
LDLM_FL_CANCELING
 |

1892 
lock_Êags
;

1894 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_bl_a°
));

1895 
	`li°_add
(&
lock
->
l_bl_a°
, 
ˇn˚ls
);

1896 
	`LDLM_LOCK_GET
(
lock
);

1897 
cou¡
++;

1899 
	`u∆ock_ªs
(
ªs
);

1901 
	`RETURN
(
	`ldlm_˛i_ˇn˚l_li°_loˇl
(
ˇn˚ls
, 
cou¡
, 
ˇn˚l_Êags
));

1902 
	}
}

1903 
EXPORT_SYMBOL
(
ldlm_ˇn˚l_ªsour˚_loˇl
);

1915 
	$ldlm_˛i_ˇn˚l_li°
(
li°_hód
 *
ˇn˚ls
, 
cou¡
,

1916 
±Ãpc_ªque°
 *
ªq
,

1917 
ldlm_ˇn˚l_Êags
 
Êags
)

1919 
ldlm_lock
 *
lock
;

1920 
ªs
 = 0;

1921 
ENTRY
;

1923 i‡(
	`li°_em±y
(
ˇn˚ls
Ë|| 
cou¡
 == 0)

1924 
	`RETURN
(0);

1931 
cou¡
 > 0) {

1932 
	`LASSERT
(!
	`li°_em±y
(
ˇn˚ls
));

1933 
lock
 = 
	`li°_íåy
(
ˇn˚ls
->
√xt
, 
ldlm_lock
,

1934 
l_bl_a°
);

1935 
	`LASSERT
(
lock
->
l_c⁄n_exp‹t
);

1937 i‡(
	`exp_c⁄√˘_ˇn˚l£t
(
lock
->
l_c⁄n_exp‹t
)) {

1938 
ªs
 = 
cou¡
;

1939 i‡(
ªq
)

1940 
	`ldlm_ˇn˚l_∑ck
(
ªq
, 
ˇn˚ls
, 
cou¡
);

1942 
ªs
 = 
	`ldlm_˛i_ˇn˚l_ªq
(
lock
->
l_c⁄n_exp‹t
,

1943 
ˇn˚ls
, 
cou¡
,

1944 
Êags
);

1946 
ªs
 = 
	`ldlm_˛i_ˇn˚l_ªq
(
lock
->
l_c⁄n_exp‹t
,

1947 
ˇn˚ls
, 1, 
Êags
);

1950 i‡(
ªs
 < 0) {

1951 
	`CDEBUG_LIMIT
(
ªs
 =-
ESHUTDOWN
 ? 
D_DLMTRACE
 : 
D_ERROR
,

1952 "ldlm_˛i_ˇn˚l_li°: %d\n", 
ªs
);

1953 
ªs
 = 
cou¡
;

1956 
cou¡
 -
ªs
;

1957 
	`ldlm_lock_li°_put
(
ˇn˚ls
, 
l_bl_a°
, 
ªs
);

1959 
	`LASSERT
(
cou¡
 == 0);

1960 
	`RETURN
(0);

1961 
	}
}

1962 
EXPORT_SYMBOL
(
ldlm_˛i_ˇn˚l_li°
);

1969 
	$ldlm_˛i_ˇn˚l_unu£d_ªsour˚
(
ldlm_«me•a˚
 *
ns
,

1970 c⁄° 
ldlm_ªs_id
 *
ªs_id
,

1971 
ldlm_pﬁicy_d©a
 *
pﬁicy
,

1972 
ldlm_mode
 
mode
,

1973 
ldlm_ˇn˚l_Êags
 
Êags
, *
›aque
)

1975 
ldlm_ªsour˚
 *
ªs
;

1976 
li°_hód
 
ˇn˚ls
 = 
	`LIST_HEAD_INIT
(cancels);

1977 
cou¡
;

1978 
rc
;

1979 
ENTRY
;

1981 
ªs
 = 
	`ldlm_ªsour˚_gë
(
ns
, 
NULL
, 
ªs_id
, 0, 0);

1982 i‡(
	`IS_ERR
(
ªs
)) {

1984 
	`CDEBUG
(
D_INFO
, "Nÿªsour˚ "
LPU64
"\n", 
ªs_id
->
«me
[0]);

1985 
	`RETURN
(0);

1988 
	`LDLM_RESOURCE_ADDREF
(
ªs
);

1989 
cou¡
 = 
	`ldlm_ˇn˚l_ªsour˚_loˇl
(
ªs
, &
ˇn˚ls
, 
pﬁicy
, 
mode
,

1990 0, 
Êags
 | 
LCF_BL_AST
, 
›aque
);

1991 
rc
 = 
	`ldlm_˛i_ˇn˚l_li°
(&
ˇn˚ls
, 
cou¡
, 
NULL
, 
Êags
);

1992 i‡(
rc
 !
ELDLM_OK
)

1993 
	`CERROR
("ˇn˚lög unu£dÜock "
DLDLMRES
":Ñc = %d\n",

1994 
	`PLDLMRES
(
ªs
), 
rc
);

1996 
	`LDLM_RESOURCE_DELREF
(
ªs
);

1997 
	`ldlm_ªsour˚_puåef
(
ªs
);

1998 
	`RETURN
(0);

1999 
	}
}

2000 
EXPORT_SYMBOL
(
ldlm_˛i_ˇn˚l_unu£d_ªsour˚
);

2002 
	sldlm_˛i_ˇn˚l_¨g
 {

2003 
	mlc_Êags
;

2004 *
	mlc_›aque
;

2008 
	$ldlm_˛i_hash_ˇn˚l_unu£d
(
cfs_hash
 *
hs
, 
cfs_hash_bd
 *
bd
,

2009 
hli°_node
 *
hnode
, *
¨g
)

2011 
ldlm_ªsour˚
 *
ªs
 = 
	`cfs_hash_obje˘
(
hs
, 
hnode
);

2012 
ldlm_˛i_ˇn˚l_¨g
 *
lc
 = 
¨g
;

2014 
	`ldlm_˛i_ˇn˚l_unu£d_ªsour˚
(
	`ldlm_ªs_to_ns
(
ªs
), &ªs->
Ã_«me
,

2015 
NULL
, 
LCK_MINMODE
, 
lc
->
lc_Êags
,

2016 
lc
->
lc_›aque
);

2019 
	}
}

2027 
	$ldlm_˛i_ˇn˚l_unu£d
(
ldlm_«me•a˚
 *
ns
,

2028 c⁄° 
ldlm_ªs_id
 *
ªs_id
,

2029 
ldlm_ˇn˚l_Êags
 
Êags
, *
›aque
)

2031 
ldlm_˛i_ˇn˚l_¨g
 
¨g
 = {

2032 .
lc_Êags
 = 
Êags
,

2033 .
lc_›aque
 = 
›aque
,

2036 
ENTRY
;

2038 i‡(
ns
 =
NULL
)

2039 
	`RETURN
(
ELDLM_OK
);

2041 i‡(
ªs_id
 !
NULL
) {

2042 
	`RETURN
(
	`ldlm_˛i_ˇn˚l_unu£d_ªsour˚
(
ns
, 
ªs_id
, 
NULL
,

2043 
LCK_MINMODE
, 
Êags
,

2044 
›aque
));

2046 
	`cfs_hash_f‹_óch_nﬁock
(
ns
->
ns_rs_hash
,

2047 
ldlm_˛i_hash_ˇn˚l_unu£d
, &
¨g
, 0);

2048 
	`RETURN
(
ELDLM_OK
);

2050 
	}
}

2054 
	$ldlm_ªsour˚_f‹óch
(
ldlm_ªsour˚
 *
ªs
, 
ldlm_ôî©‹_t
 
ôî
,

2055 *
˛osuª
)

2057 
li°_hód
 *
tmp
, *
√xt
;

2058 
ldlm_lock
 *
lock
;

2059 
rc
 = 
LDLM_ITER_CONTINUE
;

2061 
ENTRY
;

2063 i‡(!
ªs
)

2064 
	`RETURN
(
LDLM_ITER_CONTINUE
);

2066 
	`lock_ªs
(
ªs
);

2067 
	`li°_f‹_óch_ß„
(
tmp
, 
√xt
, &
ªs
->
Ã_gø¡ed
) {

2068 
lock
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
, 
l_ªs_lök
);

2070 i‡(
	`ôî
(
lock
, 
˛osuª
Ë=
LDLM_ITER_STOP
)

2071 
	`GOTO
(
out
, 
rc
 = 
LDLM_ITER_STOP
);

2074 
	`li°_f‹_óch_ß„
(
tmp
, 
√xt
, &
ªs
->
Ã_c⁄vîtög
) {

2075 
lock
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
, 
l_ªs_lök
);

2077 i‡(
	`ôî
(
lock
, 
˛osuª
Ë=
LDLM_ITER_STOP
)

2078 
	`GOTO
(
out
, 
rc
 = 
LDLM_ITER_STOP
);

2081 
	`li°_f‹_óch_ß„
(
tmp
, 
√xt
, &
ªs
->
Ã_waôög
) {

2082 
lock
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
, 
l_ªs_lök
);

2084 i‡(
	`ôî
(
lock
, 
˛osuª
Ë=
LDLM_ITER_STOP
)

2085 
	`GOTO
(
out
, 
rc
 = 
LDLM_ITER_STOP
);

2087 
out
:

2088 
	`u∆ock_ªs
(
ªs
);

2089 
	`RETURN
(
rc
);

2090 
	}
}

2092 
	sôî_hñ≥r_d©a
 {

2093 
ldlm_ôî©‹_t
 
	môî
;

2094 *
	m˛osuª
;

2097 
	$ldlm_ôî_hñ≥r
(
ldlm_lock
 *
lock
, *
˛osuª
)

2099 
ôî_hñ≥r_d©a
 *
hñ≥r
 = 
˛osuª
;

2100  
hñ≥r
->
	`ôî
(
lock
, hñ≥r->
˛osuª
);

2101 
	}
}

2103 
	$ldlm_ªs_ôî_hñ≥r
(
cfs_hash
 *
hs
, 
cfs_hash_bd
 *
bd
,

2104 
hli°_node
 *
hnode
, *
¨g
)

2107 
ldlm_ªsour˚
 *
ªs
 = 
	`cfs_hash_obje˘
(
hs
, 
hnode
);

2109  
	`ldlm_ªsour˚_f‹óch
(
ªs
, 
ldlm_ôî_hñ≥r
, 
¨g
) ==

2110 
LDLM_ITER_STOP
;

2111 
	}
}

2113 
	$ldlm_«me•a˚_f‹óch
(
ldlm_«me•a˚
 *
ns
,

2114 
ldlm_ôî©‹_t
 
ôî
, *
˛osuª
)

2117 
ôî_hñ≥r_d©a
 
hñ≥r
 = { .
ôî
 = iãr, .
˛osuª
 = closure };

2119 
	`cfs_hash_f‹_óch_nﬁock
(
ns
->
ns_rs_hash
,

2120 
ldlm_ªs_ôî_hñ≥r
, &
hñ≥r
, 0);

2122 
	}
}

2129 
	$ldlm_ªsour˚_ôî©e
(
ldlm_«me•a˚
 *
ns
,

2130 c⁄° 
ldlm_ªs_id
 *
ªs_id
,

2131 
ldlm_ôî©‹_t
 
ôî
, *
d©a
)

2133 
ldlm_ªsour˚
 *
ªs
;

2134 
rc
;

2135 
ENTRY
;

2137 
	`LASSERTF
(
ns
 !
NULL
, "mustÖass inÇamespace\n");

2139 
ªs
 = 
	`ldlm_ªsour˚_gë
(
ns
, 
NULL
, 
ªs_id
, 0, 0);

2140 i‡(
	`IS_ERR
(
ªs
))

2141 
	`RETURN
(0);

2143 
	`LDLM_RESOURCE_ADDREF
(
ªs
);

2144 
rc
 = 
	`ldlm_ªsour˚_f‹óch
(
ªs
, 
ôî
, 
d©a
);

2145 
	`LDLM_RESOURCE_DELREF
(
ªs
);

2146 
	`ldlm_ªsour˚_puåef
(
ªs
);

2147 
	`RETURN
(
rc
);

2148 
	}
}

2149 
EXPORT_SYMBOL
(
ldlm_ªsour˚_ôî©e
);

2153 
	$ldlm_chaö_lock_f‹_ª∂ay
(
ldlm_lock
 *
lock
, *
˛osuª
)

2155 
li°_hód
 *
li°
 = 
˛osuª
;

2158 
	`LASSERTF
(
	`li°_em±y
(&
lock
->
l_≥ndög_chaö
),

2160 
lock
, &lock->
l_≥ndög_chaö
.
√xt
,&lock->l_≥ndög_chaö.
¥ev
);

2165 i‡(!(
lock
->
l_Êags
 & (
LDLM_FL_FAILED
|
LDLM_FL_CANCELING
))) {

2166 
	`li°_add
(&
lock
->
l_≥ndög_chaö
, 
li°
);

2167 
	`LDLM_LOCK_GET
(
lock
);

2170  
LDLM_ITER_CONTINUE
;

2171 
	}
}

2173 
	$ª∂ay_lock_öãΩªt
(c⁄° 
lu_ív
 *
ív
,

2174 
±Ãpc_ªque°
 *
ªq
,

2175 
ldlm_async_¨gs
 *
Ø
, 
rc
)

2177 
ldlm_lock
 *
lock
;

2178 
ldlm_ª∂y
 *
ª∂y
;

2179 
obd_exp‹t
 *
exp
;

2181 
ENTRY
;

2182 
	`©omic_dec
(&
ªq
->
rq_imp‹t
->
imp_ª∂ay_öÊight
);

2183 i‡(
rc
 !
ELDLM_OK
)

2184 
	`GOTO
(
out
, 
rc
);

2186 
ª∂y
 = 
	`ªq_ˇpsuÀ_£rvî_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REP
);

2187 i‡(
ª∂y
 =
NULL
)

2188 
	`GOTO
(
out
, 
rc
 = -
EPROTO
);

2190 
lock
 = 
	`ldlm_h™dÀ2lock
(&
Ø
->
lock_h™dÀ
);

2191 i‡(!
lock
) {

2192 
	`CERROR
("ª˚ivedÑïœyáck f‹ unknow¿loˇ»cookõ "
LPX64


2193 "ÑemŸêcookõ "
LPX64
 " from server %s id %s\n",

2194 
Ø
->
lock_h™dÀ
.
cookõ
, 
ª∂y
->lock_handle.cookie,

2195 
ªq
->
rq_exp‹t
->
exp_˛õ¡_uuid
.
uuid
,

2196 
	`libcfs_id2°r
(
ªq
->
rq_≥î
));

2197 
	`GOTO
(
out
, 
rc
 = -
ESTALE
);

2201 
exp
 = 
ªq
->
rq_exp‹t
;

2202 i‡(
exp
 &&Éxp->
exp_lock_hash
) {

2206 
	`cfs_hash_ªhash_key
(
exp
->
exp_lock_hash
,

2207 &
lock
->
l_ªmŸe_h™dÀ
,

2208 &
ª∂y
->
lock_h™dÀ
,

2209 &
lock
->
l_exp_hash
);

2211 
lock
->
l_ªmŸe_h™dÀ
 = 
ª∂y
->
lock_h™dÀ
;

2214 
	`LDLM_DEBUG
(
lock
, "replayedÜock:");

2215 
	`±Ãpc_imp‹t_ªcovîy_°©e_machöe
(
ªq
->
rq_imp‹t
);

2216 
	`LDLM_LOCK_PUT
(
lock
);

2217 
out
:

2218 i‡(
rc
 !
ELDLM_OK
)

2219 
	`±Ãpc_c⁄√˘_imp‹t
(
ªq
->
rq_imp‹t
);

2221 
	`RETURN
(
rc
);

2222 
	}
}

2224 
	$ª∂ay_⁄e_lock
(
obd_imp‹t
 *
imp
, 
ldlm_lock
 *
lock
)

2226 
±Ãpc_ªque°
 *
ªq
;

2227 
ldlm_async_¨gs
 *
Ø
;

2228 
ldlm_ªque°
 *
body
;

2229 
Êags
;

2230 
ENTRY
;

2234 i‡(
	`ldlm_is_ˇn˚lög
(
lock
)) {

2235 
	`LDLM_DEBUG
(
lock
, "NotÑeplaying canceledÜock:");

2236 
	`RETURN
(0);

2242 i‡(
	`ldlm_is_ˇn˚l_⁄_block
(
lock
)) {

2243 
	`LDLM_DEBUG
(
lock
, "NotÑeplayingÑeply-lessÜock:");

2244 
	`ldlm_lock_ˇn˚l
(
lock
);

2245 
	`RETURN
(0);

2262 i‡(
lock
->
l_gø¡ed_mode
 =lock->
l_ªq_mode
)

2263 
Êags
 = 
LDLM_FL_REPLAY
 | 
LDLM_FL_BLOCK_GRANTED
;

2264 i‡(
lock
->
l_gø¡ed_mode
)

2265 
Êags
 = 
LDLM_FL_REPLAY
 | 
LDLM_FL_BLOCK_CONV
;

2266 i‡(!
	`li°_em±y
(&
lock
->
l_ªs_lök
))

2267 
Êags
 = 
LDLM_FL_REPLAY
 | 
LDLM_FL_BLOCK_WAIT
;

2269 
Êags
 = 
LDLM_FL_REPLAY
;

2271 
ªq
 = 
	`±Ãpc_ªque°_Æloc_∑ck
(
imp
, &
RQF_LDLM_ENQUEUE
,

2272 
LUSTRE_DLM_VERSION
, 
LDLM_ENQUEUE
);

2273 i‡(
ªq
 =
NULL
)

2274 
	`RETURN
(-
ENOMEM
);

2277 
ªq
->
rq_£nd_°©e
 = 
LUSTRE_IMP_REPLAY_LOCKS
;

2279 
body
 = 
	`ªq_ˇpsuÀ_˛õ¡_gë
(&
ªq
->
rq_pûl
, &
RMF_DLM_REQ
);

2280 
	`ldlm_lock2desc
(
lock
, &
body
->
lock_desc
);

2281 
body
->
lock_Êags
 = 
	`ldlm_Êags_to_wúe
(
Êags
);

2283 
	`ldlm_lock2h™dÀ
(
lock
, &
body
->
lock_h™dÀ
[0]);

2284 i‡(
lock
->
l_lvb_Àn
 > 0)

2285 
	`ªq_ˇpsuÀ_exãnd
(&
ªq
->
rq_pûl
, &
RQF_LDLM_ENQUEUE_LVB
);

2286 
	`ªq_ˇpsuÀ_£t_size
(&
ªq
->
rq_pûl
, &
RMF_DLM_LVB
, 
RCL_SERVER
,

2287 
lock
->
l_lvb_Àn
);

2288 
	`±Ãpc_ªque°_£t_ª∂í
(
ªq
);

2293 
	`lu°ª_msg_£t_Êags
(
ªq
->
rq_ªqmsg
, 
MSG_REQ_REPLAY_DONE
);

2295 
	`LDLM_DEBUG
(
lock
, "replayingÜock:");

2297 
	`©omic_öc
(&
ªq
->
rq_imp‹t
->
imp_ª∂ay_öÊight
);

2298 
	`CLASSERT
((*
Ø
Ë<(
ªq
->
rq_async_¨gs
));

2299 
Ø
 = 
	`±Ãpc_ªq_async_¨gs
(
ªq
);

2300 
Ø
->
lock_h™dÀ
 = 
body
->lock_handle[0];

2301 
ªq
->
rq_öãΩªt_ª∂y
 = (
±Ãpc_öãΩãªr_t
)
ª∂ay_lock_öãΩªt
;

2302 
	`±Ãpcd_add_ªq
(
ªq
);

2304 
	`RETURN
(0);

2305 
	}
}

2317 
	$ldlm_ˇn˚l_unu£d_locks_f‹_ª∂ay
(
ldlm_«me•a˚
 *
ns
)

2319 
ˇn˚Àd
;

2320 
li°_hód
 
ˇn˚ls
 = 
	`LIST_HEAD_INIT
(cancels);

2322 
	`CDEBUG
(
D_DLMTRACE
, "Droppingás many unusedÜocksásÖossible before"

2324 
	`ldlm_ns_«me
(
ns
),Çs->
ns_ƒ_unu£d
);

2329 
ˇn˚Àd
 = 
	`ldlm_ˇn˚l_Ãu_loˇl
(
ns
, &
ˇn˚ls
,Çs->
ns_ƒ_unu£d
, 0,

2330 
LCF_LOCAL
, 
LDLM_LRU_FLAG_NO_WAIT
);

2332 
	`CDEBUG
(
D_DLMTRACE
, "Canceled %d unusedÜocks fromÇamespace %s\n",

2333 
ˇn˚Àd
, 
	`ldlm_ns_«me
(
ns
));

2334 
	}
}

2336 
	$ldlm_ª∂ay_locks
(
obd_imp‹t
 *
imp
)

2338 
ldlm_«me•a˚
 *
ns
 = 
imp
->
imp_obd
->
obd_«me•a˚
;

2339 
li°_hód
 
li°
 = 
	`LIST_HEAD_INIT
(list);

2340 
ldlm_lock
 *
lock
, *
√xt
;

2341 
rc
 = 0;

2343 
ENTRY
;

2345 
	`LASSERT
(
	`©omic_ªad
(&
imp
->
imp_ª∂ay_öÊight
) == 0);

2348 i‡(
imp
->
imp_vbr_Áûed
)

2349 
	`RETURN
(0);

2352 
	`©omic_öc
(&
imp
->
imp_ª∂ay_öÊight
);

2354 i‡(
ldlm_ˇn˚l_unu£d_locks_bef‹e_ª∂ay
)

2355 
	`ldlm_ˇn˚l_unu£d_locks_f‹_ª∂ay
(
ns
);

2357 
	`ldlm_«me•a˚_f‹óch
(
ns
, 
ldlm_chaö_lock_f‹_ª∂ay
, &
li°
);

2359 
	`li°_f‹_óch_íåy_ß„
(
lock
, 
√xt
, &
li°
, 
l_≥ndög_chaö
) {

2360 
	`li°_dñ_öô
(&
lock
->
l_≥ndög_chaö
);

2361 i‡(
rc
) {

2362 
	`LDLM_LOCK_RELEASE
(
lock
);

2365 
rc
 = 
	`ª∂ay_⁄e_lock
(
imp
, 
lock
);

2366 
	`LDLM_LOCK_RELEASE
(
lock
);

2369 
	`©omic_dec
(&
imp
->
imp_ª∂ay_öÊight
);

2371 
	`RETURN
(
rc
);

2372 
	}
}

	@ldlm_resource.c

42 
	#DEBUG_SUBSYSTEM
 
S_LDLM


	)

43 
	~<lu°ª_dlm.h
>

44 
	~<lu°ª_fid.h
>

45 
	~<obd_˛ass.h
>

46 
	~"ldlm_öã∫Æ.h
"

48 
kmem_ˇche
 *
	gldlm_ªsour˚_¶ab
, *
	gldlm_lock_¶ab
;

49 
kmem_ˇche
 *
	gldlm_öãrvÆ_åì_¶ab
;

51 
	gldlm_§v_«me•a˚_ƒ
 = 0;

52 
	gldlm_˛i_«me•a˚_ƒ
 = 0;

54 
muãx
 
	gldlm_§v_«me•a˚_lock
;

55 
li°_hód
 
	gldlm_§v_«me•a˚_li°
;

57 
muãx
 
	gldlm_˛i_«me•a˚_lock
;

61 
li°_hód
 
	gldlm_˛i_a˘ive_«me•a˚_li°
;

63 
li°_hód
 
	gldlm_˛i_öa˘ive_«me•a˚_li°
;

65 
¥oc_dú_íåy
 *
	gldlm_ty≥_¥oc_dú
;

66 
¥oc_dú_íåy
 *
	gldlm_ns_¥oc_dú
;

67 
¥oc_dú_íåy
 *
	gldlm_svc_¥oc_dú
;

71 
	gldlm_dump_gø¡ed_max
 = 256;

73 #ifde‡
CONFIG_PROC_FS


74 
ssize_t


75 
	$Õrocfs_dump_ns_£q_wrôe
(
fûe
 *fûe, c⁄° 
__u£r
 *
buf„r
,

76 
size_t
 
cou¡
, 
loff_t
 *
off
)

78 
	`ldlm_dump_Æl_«me•a˚s
(
LDLM_NAMESPACE_SERVER
, 
D_DLMTRACE
);

79 
	`ldlm_dump_Æl_«me•a˚s
(
LDLM_NAMESPACE_CLIENT
, 
D_DLMTRACE
);

80 
	`RETURN
(
cou¡
);

81 
	}
}

82 
LPROC_SEQ_FOPS_WO_TYPE
(
ldlm
, 
dump_ns
);

84 
LPROC_SEQ_FOPS_RW_TYPE
(
ldlm_rw
, 
uöt
);

85 
LPROC_SEQ_FOPS_RO_TYPE
(
ldlm
, 
uöt
);

87 #ifde‡
HAVE_SERVER_SUPPORT


89 
	$£q_w©îm¨k_show
(
£q_fûe
 *
m
, *
d©a
)

91  
	`£q_¥ötf
(
m
, 
LPU64
"\n", *(
__u64
 *)m->
¥iv©e
);

92 
	}
}

94 
ssize_t
 
	$£q_w©îm¨k_wrôe
(
fûe
 *file,

95 c⁄° 
__u£r
 *
buf„r
, 
size_t
 
cou¡
,

96 
loff_t
 *
off
)

98 
__u64
 
w©îm¨k
;

99 
__u64
 *
d©a
 = ((
£q_fûe
 *)
fûe
->
¥iv©e_d©a
)->
¥iv©e
;

100 
boﬁ
 
wm_low
 = (
d©a
 =&
ldlm_ª˛aim_thªshﬁd_mb
Ë? 
åue
 : 
Ál£
;

101 
rc
;

103 
rc
 = 
	`Õrocfs_wrôe_‰ac_u64_hñ≥r
(
buf„r
, 
cou¡
, &
w©îm¨k
, 1 << 20);

104 i‡(
rc
) {

105 
	`CERROR
("FailedÅo set %s,Ñc = %d.\n",

106 
wm_low
 ? "lock_reclaim_threshold_mb" : "lock_limit_mb",

107 
rc
);

108  
rc
;

109 } i‡(
w©îm¨k
 != 0 && watermark < (1 << 20)) {

110 
	`CERROR
("%s should be greaterÅhan 1MB.\n",

111 
wm_low
 ? "lock_reclaim_threshold_mb" : "lock_limit_mb");

112  -
EINVAL
;

114 
w©îm¨k
 >>= 20;

116 i‡(
wm_low
) {

117 i‡(
ldlm_lock_limô_mb
 !0 && 
w©îm¨k
 >Üdlm_lock_limit_mb) {

118 
	`CERROR
("lock_reclaim_threshold_mb must be smallerÅhan "

120  -
EINVAL
;

123 *
d©a
 = 
w©îm¨k
;

124 i‡(
w©îm¨k
 != 0) {

125 
w©îm¨k
 <<= 20;

126 
	`do_div
(
w©îm¨k
, (
ldlm_lock
));

128 
ldlm_ª˛aim_thªshﬁd
 = 
w©îm¨k
;

130 i‡(
ldlm_ª˛aim_thªshﬁd_mb
 != 0 &&

131 
w©îm¨k
 < 
ldlm_ª˛aim_thªshﬁd_mb
) {

132 
	`CERROR
("lock_limit_mb must be greaterÅhan "

134  -
EINVAL
;

137 *
d©a
 = 
w©îm¨k
;

138 i‡(
w©îm¨k
 != 0) {

139 
w©îm¨k
 <<= 20;

140 
	`do_div
(
w©îm¨k
, (
ldlm_lock
));

142 
ldlm_lock_limô
 = 
w©îm¨k
;

145  
cou¡
;

146 
	}
}

148 
	$£q_w©îm¨k_›í
(
öode
 *öode, 
fûe
 *file)

150  
	`sögÀ_›í
(
fûe
, 
£q_w©îm¨k_show
, 
	`PDE_DATA
(
öode
));

151 
	}
}

153 c⁄° 
fûe_›î©i⁄s
 
	gldlm_w©îm¨k_f›s
 = {

154 .
ow√r
 = 
THIS_MODULE
,

155 .
	g›í
 = 
£q_w©îm¨k_›í
,

156 .
	gªad
 = 
£q_ªad
,

157 .
	gwrôe
 = 
£q_w©îm¨k_wrôe
,

158 .
	gŒ£ek
 = 
£q_l£ek
,

159 .
	gªÀa£
 = 
Õrocfs_sögÀ_ªÀa£
,

162 
	$£q_gø¡ed_show
(
£q_fûe
 *
m
, *
d©a
)

164  
	`£q_¥ötf
(
m
, 
LPU64
"\n", 
	`≥r˝u_cou¡î_sum_posôive
(

165 (
≥r˝u_cou¡î
 *)
m
->
¥iv©e
));

166 
	}
}

168 
	$£q_gø¡ed_›í
(
öode
 *öode, 
fûe
 *file)

170  
	`sögÀ_›í
(
fûe
, 
£q_gø¡ed_show
, 
	`PDE_DATA
(
öode
));

171 
	}
}

173 c⁄° 
fûe_›î©i⁄s
 
	gldlm_gø¡ed_f›s
 = {

174 .
ow√r
 = 
THIS_MODULE
,

175 .
	g›í
 = 
£q_gø¡ed_›í
,

176 .
	gªad
 = 
£q_ªad
,

177 .
	gŒ£ek
 = 
£q_l£ek
,

178 .
	gªÀa£
 = 
£q_ªÀa£
,

183 
	$ldlm_¥oc_£tup
()

185 
rc
;

186 
Õrocfs_v¨s
 
li°
[] = {

187 { .
«me
 = "dump_namespaces",

188 .
f›s
 = &
ldlm_dump_ns_f›s
,

189 .
¥oc_mode
 = 0222 },

190 { .
«me
 = "dump_granted_max",

191 .
f›s
 = &
ldlm_rw_uöt_f›s
,

192 .
d©a
 = &
ldlm_dump_gø¡ed_max
 },

193 { .
«me
 = "cancel_unused_locks_before_replay",

194 .
f›s
 = &
ldlm_rw_uöt_f›s
,

195 .
d©a
 = &
ldlm_ˇn˚l_unu£d_locks_bef‹e_ª∂ay
 },

196 #ifde‡
HAVE_SERVER_SUPPORT


197 { .
«me
 = "lock_reclaim_threshold_mb",

198 .
f›s
 = &
ldlm_w©îm¨k_f›s
,

199 .
d©a
 = &
ldlm_ª˛aim_thªshﬁd_mb
 },

200 { .
«me
 = "lock_limit_mb",

201 .
f›s
 = &
ldlm_w©îm¨k_f›s
,

202 .
d©a
 = &
ldlm_lock_limô_mb
 },

203 { .
«me
 = "lock_granted_count",

204 .
f›s
 = &
ldlm_gø¡ed_f›s
,

205 .
d©a
 = &
ldlm_gø¡ed_tŸÆ
 },

207 { 
NULL
 }};

208 
ENTRY
;

209 
	`LASSERT
(
ldlm_ns_¥oc_dú
 =
NULL
);

211 
ldlm_ty≥_¥oc_dú
 = 
	`Õrocfs_ªgi°î
(
OBD_LDLM_DEVICENAME
,

212 
¥oc_lu°ª_roŸ
,

213 
NULL
, NULL);

214 i‡(
	`IS_ERR
(
ldlm_ty≥_¥oc_dú
)) {

215 
	`CERROR
("LProcFS failed inÜdlm-init\n");

216 
rc
 = 
	`PTR_ERR
(
ldlm_ty≥_¥oc_dú
);

217 
	`GOTO
(
îr
, 
rc
);

220 
ldlm_ns_¥oc_dú
 = 
	`Õrocfs_ªgi°î
("namespaces",

221 
ldlm_ty≥_¥oc_dú
,

222 
NULL
, NULL);

223 i‡(
	`IS_ERR
(
ldlm_ns_¥oc_dú
)) {

224 
	`CERROR
("LProcFS failed inÜdlm-init\n");

225 
rc
 = 
	`PTR_ERR
(
ldlm_ns_¥oc_dú
);

226 
	`GOTO
(
îr_ty≥
, 
rc
);

229 
ldlm_svc_¥oc_dú
 = 
	`Õrocfs_ªgi°î
("services",

230 
ldlm_ty≥_¥oc_dú
,

231 
NULL
, NULL);

232 i‡(
	`IS_ERR
(
ldlm_svc_¥oc_dú
)) {

233 
	`CERROR
("LProcFS failed inÜdlm-init\n");

234 
rc
 = 
	`PTR_ERR
(
ldlm_svc_¥oc_dú
);

235 
	`GOTO
(
îr_ns
, 
rc
);

238 
rc
 = 
	`Õrocfs_add_v¨s
(
ldlm_ty≥_¥oc_dú
, 
li°
, 
NULL
);

239 i‡(
rc
 != 0) {

240 
	`CERROR
("LProcFS failed inÜdlm-init\n");

241 
	`GOTO
(
îr_svc
, 
rc
);

244 
	`RETURN
(0);

246 
îr_svc
:

247 
	`Õrocfs_ªmove
(&
ldlm_svc_¥oc_dú
);

248 
îr_ns
:

249 
	`Õrocfs_ªmove
(&
ldlm_ns_¥oc_dú
);

250 
îr_ty≥
:

251 
	`Õrocfs_ªmove
(&
ldlm_ty≥_¥oc_dú
);

252 
îr
:

253 
ldlm_svc_¥oc_dú
 = 
NULL
;

254 
	`RETURN
(
rc
);

255 
	}
}

257 
	$ldlm_¥oc_˛ónup
()

259 i‡(
ldlm_svc_¥oc_dú
)

260 
	`Õrocfs_ªmove
(&
ldlm_svc_¥oc_dú
);

262 i‡(
ldlm_ns_¥oc_dú
)

263 
	`Õrocfs_ªmove
(&
ldlm_ns_¥oc_dú
);

265 i‡(
ldlm_ty≥_¥oc_dú
)

266 
	`Õrocfs_ªmove
(&
ldlm_ty≥_¥oc_dú
);

267 
	}
}

269 
	$Õrocfs_ns_ªsour˚s_£q_show
(
£q_fûe
 *
m
, *
v
)

271 
ldlm_«me•a˚
 *
ns
 = 
m
->
¥iv©e
;

272 
__u64
 
ªs
 = 0;

273 
cfs_hash_bd
 
bd
;

274 
i
;

277 
	`cfs_hash_f‹_óch_buckë
(
ns
->
ns_rs_hash
, &
bd
, 
i
)

278 
ªs
 +
	`cfs_hash_bd_cou¡_gë
(&
bd
);

279  
	`Õrocfs_u64_£q_show
(
m
, &
ªs
);

280 
	}
}

281 
LPROC_SEQ_FOPS_RO
(
Õrocfs_ns_ªsour˚s
);

283 
	$Õrocfs_ns_locks_£q_show
(
£q_fûe
 *
m
, *
v
)

285 
ldlm_«me•a˚
 *
ns
 = 
m
->
¥iv©e
;

286 
__u64
 
locks
;

288 
locks
 = 
	`Õrocfs_°©s_cﬁÀ˘‹
(
ns
->
ns_°©s
, 
LDLM_NSS_LOCKS
,

289 
LPROCFS_FIELDS_FLAGS_SUM
);

290  
	`Õrocfs_u64_£q_show
(
m
, &
locks
);

291 
	}
}

292 
LPROC_SEQ_FOPS_RO
(
Õrocfs_ns_locks
);

294 
	$Õrocfs_Ãu_size_£q_show
(
£q_fûe
 *
m
, *
v
)

296 
ldlm_«me•a˚
 *
ns
 = 
m
->
¥iv©e
;

297 
__u32
 *
ƒ
 = &
ns
->
ns_max_unu£d
;

299 i‡(
	`ns_c⁄√˘_Ãu_ªsize
(
ns
))

300 
ƒ
 = &
ns
->
ns_ƒ_unu£d
;

301  
	`Õrocfs_uöt_£q_show
(
m
, 
ƒ
);

302 
	}
}

304 
ssize_t
 
	$Õrocfs_Ãu_size_£q_wrôe
(
fûe
 *file,

305 c⁄° 
__u£r
 *
buf„r
,

306 
size_t
 
cou¡
, 
loff_t
 *
off
)

308 
ldlm_«me•a˚
 *
ns
 = ((
£q_fûe
 *)
fûe
->
¥iv©e_d©a
)->
¥iv©e
;

309 
dummy
[
MAX_STRING_SIZE
 + 1], *
íd
;

310 
tmp
;

311 
Ãu_ªsize
;

313 
dummy
[
MAX_STRING_SIZE
] = '\0';

314 i‡(
	`c›y_‰om_u£r
(
dummy
, 
buf„r
, 
MAX_STRING_SIZE
))

315  -
EFAULT
;

317 i‡(
	`°∫cmp
(
dummy
, "clear", 5) == 0) {

318 
	`CDEBUG
(
D_DLMTRACE
,

320 
	`ldlm_ns_«me
(
ns
));

321 i‡(
	`ns_c⁄√˘_Ãu_ªsize
(
ns
)) {

322 
ˇn˚Àd
, 
unu£d
 = 
ns
->
ns_ƒ_unu£d
;

325 
ˇn˚Àd
 = 
	`ldlm_ˇn˚l_Ãu
(
ns
, 
unu£d
, 0,

326 
LDLM_LRU_FLAG_PASSED
);

327 i‡(
ˇn˚Àd
 < 
unu£d
) {

328 
	`CDEBUG
(
D_DLMTRACE
,

330 "ªque°ed: %d, c™˚Àd: %d\n", 
unu£d
,

331 
ˇn˚Àd
);

332  -
EINVAL
;

335 
tmp
 = 
ns
->
ns_max_unu£d
;

336 
ns
->
ns_max_unu£d
 = 0;

337 
	`ldlm_ˇn˚l_Ãu
(
ns
, 0, 0, 
LDLM_LRU_FLAG_PASSED
);

338 
ns
->
ns_max_unu£d
 = 
tmp
;

340  
cou¡
;

343 
tmp
 = 
	`sim∂e_°πoul
(
dummy
, &
íd
, 0);

344 i‡(
dummy
 =
íd
) {

345 
	`CERROR
("invalid value written\n");

346  -
EINVAL
;

348 
Ãu_ªsize
 = (
tmp
 == 0);

350 i‡(
	`ns_c⁄√˘_Ãu_ªsize
(
ns
)) {

351 i‡(!
Ãu_ªsize
)

352 
ns
->
ns_max_unu£d
 = 
tmp
;

354 i‡(
tmp
 > 
ns
->
ns_ƒ_unu£d
)

355 
tmp
 = 
ns
->
ns_ƒ_unu£d
;

356 
tmp
 = 
ns
->
ns_ƒ_unu£d
 -Åmp;

358 
	`CDEBUG
(
D_DLMTRACE
,

360 
	`ldlm_ns_«me
(
ns
),Çs->
ns_ƒ_unu£d
,

361 ()
tmp
);

362 
	`ldlm_ˇn˚l_Ãu
(
ns
, 
tmp
, 
LCF_ASYNC
, 
LDLM_LRU_FLAG_PASSED
);

364 i‡(!
Ãu_ªsize
) {

365 
	`CDEBUG
(
D_DLMTRACE
,

367 
	`ldlm_ns_«me
(
ns
));

368 
ns
->
ns_c⁄√˘_Êags
 &~
OBD_CONNECT_LRU_RESIZE
;

371 
	`CDEBUG
(
D_DLMTRACE
,

373 
	`ldlm_ns_«me
(
ns
),Çs->
ns_max_unu£d
,

374 ()
tmp
);

375 
ns
->
ns_max_unu£d
 = ()
tmp
;

376 
	`ldlm_ˇn˚l_Ãu
(
ns
, 0, 
LCF_ASYNC
, 
LDLM_LRU_FLAG_PASSED
);

380 i‡(
Ãu_ªsize
 &&

381 (
ns
->
ns_‹ig_c⁄√˘_Êags
 & 
OBD_CONNECT_LRU_RESIZE
)) {

382 
	`CDEBUG
(
D_DLMTRACE
,

384 
	`ldlm_ns_«me
(
ns
));

385 
ns
->
ns_c⁄√˘_Êags
 |
OBD_CONNECT_LRU_RESIZE
;

389  
cou¡
;

390 
	}
}

391 
LPROC_SEQ_FOPS
(
Õrocfs_Ãu_size
);

393 
	$Õrocfs_ñc_£q_show
(
£q_fûe
 *
m
, *
v
)

395 
ldlm_«me•a˚
 *
ns
 = 
m
->
¥iv©e
;

396 
suµ
 = 
	`ns_c⁄√˘_ˇn˚l£t
(
ns
);

398  
	`Õrocfs_uöt_£q_show
(
m
, &
suµ
);

399 
	}
}

401 
ssize_t
 
	$Õrocfs_ñc_£q_wrôe
(
fûe
 *file,

402 c⁄° 
__u£r
 *
buf„r
,

403 
size_t
 
cou¡
, 
loff_t
 *
off
)

405 
ldlm_«me•a˚
 *
ns
 = ((
£q_fûe
 *)
fûe
->
¥iv©e_d©a
)->
¥iv©e
;

406 
suµ
 = -1;

407 
rc
;

409 
rc
 = 
	`Õrocfs_wr_uöt
(
fûe
, 
buf„r
, 
cou¡
, &
suµ
);

410 i‡(
rc
 < 0)

411  
rc
;

413 i‡(
suµ
 == 0)

414 
ns
->
ns_c⁄√˘_Êags
 &~
OBD_CONNECT_CANCELSET
;

415 i‡(
ns
->
ns_‹ig_c⁄√˘_Êags
 & 
OBD_CONNECT_CANCELSET
)

416 
ns
->
ns_c⁄√˘_Êags
 |
OBD_CONNECT_CANCELSET
;

417  
cou¡
;

418 
	}
}

419 
LPROC_SEQ_FOPS
(
Õrocfs_ñc
);

421 
	$ldlm_«me•a˚_¥oc_uƒegi°î
(
ldlm_«me•a˚
 *
ns
)

423 i‡(
ns
->
ns_¥oc_dú_íåy
 =
NULL
)

424 
	`CERROR
("dlmÇamespace %s hasÇoÖrocfs dir?\n",

425 
	`ldlm_ns_«me
(
ns
));

427 
	`Õrocfs_ªmove
(&
ns
->
ns_¥oc_dú_íåy
);

429 i‡(
ns
->
ns_°©s
 !
NULL
)

430 
	`Õrocfs_‰ì_°©s
(&
ns
->
ns_°©s
);

431 
	}
}

433 
	$ldlm_«me•a˚_¥oc_ªgi°î
(
ldlm_«me•a˚
 *
ns
)

435 
Õrocfs_v¨s
 
lock_v¨s
[2];

436 
lock_«me
[
MAX_STRING_SIZE
 + 1];

437 
¥oc_dú_íåy
 *
ns_pde
;

439 
	`LASSERT
(
ns
 !
NULL
);

440 
	`LASSERT
(
ns
->
ns_rs_hash
 !
NULL
);

442 i‡(
ns
->
ns_¥oc_dú_íåy
 !
NULL
) {

443 
ns_pde
 = 
ns
->
ns_¥oc_dú_íåy
;

445 
ns_pde
 = 
	`¥oc_mkdú
(
	`ldlm_ns_«me
(
ns
), 
ldlm_ns_¥oc_dú
);

446 i‡(
ns_pde
 =
NULL
)

447  -
ENOMEM
;

448 
ns
->
ns_¥oc_dú_íåy
 = 
ns_pde
;

451 
ns
->
ns_°©s
 = 
	`Õrocfs_Æloc_°©s
(
LDLM_NSS_LAST
, 0);

452 i‡(
ns
->
ns_°©s
 =
NULL
)

453  -
ENOMEM
;

455 
	`Õrocfs_cou¡î_öô
(
ns
->
ns_°©s
, 
LDLM_NSS_LOCKS
,

456 
LPROCFS_CNTR_AVGMINMAX
, "locks", "locks");

458 
lock_«me
[
MAX_STRING_SIZE
] = '\0';

460 
	`mem£t
(
lock_v¨s
, 0, (lock_vars));

461 
lock_v¨s
[0].
«me
 = 
lock_«me
;

463 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "ªsour˚_cou¡", 
ns
,

464 &
Õrocfs_ns_ªsour˚s_f›s
);

465 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "lock_cou¡", 
ns
,

466 &
Õrocfs_ns_locks_f›s
);

468 i‡(
	`ns_is_˛õ¡
(
ns
)) {

469 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "lock_unused_count",

470 &
ns
->
ns_ƒ_unu£d
, &
ldlm_uöt_f›s
);

471 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "Ãu_size", 
ns
,

472 &
Õrocfs_Ãu_size_f›s
);

473 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "lru_max_age",

474 &
ns
->
ns_max_age
, &
ldlm_rw_uöt_f›s
);

475 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "early_lock_cancel",

476 
ns
, &
Õrocfs_ñc_f›s
);

478 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "ctime_age_limit",

479 &
ns
->
ns_˘ime_age_limô
, &
ldlm_rw_uöt_f›s
);

480 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "lock_timeouts",

481 &
ns
->
ns_timeouts
, &
ldlm_uöt_f›s
);

482 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "max_nolock_bytes",

483 &
ns
->
ns_max_nﬁock_size
, &
ldlm_rw_uöt_f›s
);

484 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "contention_seconds",

485 &
ns
->
ns_c⁄ã¡i⁄_time
, &
ldlm_rw_uöt_f›s
);

486 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "contended_locks",

487 &
ns
->
ns_c⁄ãnded_locks
, &
ldlm_rw_uöt_f›s
);

488 
	`ldlm_add_v¨
(&
lock_v¨s
[0], 
ns_pde
, "max_parallel_ast",

489 &
ns
->
ns_max_∑øŒñ_a°
, &
ldlm_rw_uöt_f›s
);

492 
	}
}

493 #unde‡
MAX_STRING_SIZE


496 
	#ldlm_«me•a˚_¥oc_uƒegi°î
(
ns
Ë({;})

	)

497 
	#ldlm_«me•a˚_¥oc_ªgi°î
(
ns
Ë({0;})

	)

501 
	$ldlm_ªs_h›_hash
(
cfs_hash
 *
hs
,

502 c⁄° *
key
, 
mask
)

504 c⁄° 
ldlm_ªs_id
 *
id
 = 
key
;

505 
vÆ
 = 0;

506 
i
;

508 
i
 = 0; i < 
RES_NAME_SIZE
; i++)

509 
vÆ
 +
id
->
«me
[
i
];

510  
vÆ
 & 
mask
;

511 
	}
}

513 
	$ldlm_ªs_h›_fid_hash
(
cfs_hash
 *
hs
,

514 c⁄° *
key
, 
mask
)

516 c⁄° 
ldlm_ªs_id
 *
id
 = 
key
;

517 
lu_fid
 
fid
;

518 
__u32
 
hash
;

519 
__u32
 
vÆ
;

521 
fid
.
f_£q
 = 
id
->
«me
[
LUSTRE_RES_ID_SEQ_OFF
];

522 
fid
.
f_oid
 = (
__u32
)
id
->
«me
[
LUSTRE_RES_ID_VER_OID_OFF
];

523 
fid
.
f_vî
 = (
__u32
)(
id
->
«me
[
LUSTRE_RES_ID_VER_OID_OFF
] >> 32);

525 
hash
 = 
	`fid_Ê©ãn32
(&
fid
);

526 
hash
 += (hash >> 4) + (hash << 12);

527 i‡(
id
->
«me
[
LUSTRE_RES_ID_HSH_OFF
] != 0) {

528 
vÆ
 = 
id
->
«me
[
LUSTRE_RES_ID_HSH_OFF
];

529 
hash
 +(
vÆ
 >> 5) + (val << 11);

531 
vÆ
 = 
	`fid_oid
(&
fid
);

533 
hash
 = 
	`hash_l⁄g
(hash, 
hs
->
hs_bkt_bôs
);

535 
hash
 -
	`hash_l⁄g
(()
hs
, 
vÆ
 % 11 + 3);

537 
hash
 <<
hs
->
hs_cur_bôs
 - hs->
hs_bkt_bôs
;

538 
hash
 |
	`ldlm_ªs_h›_hash
(
hs
, 
key
, 
	`CFS_HASH_NBKT
(hs) - 1);

540  
hash
 & 
mask
;

541 
	}
}

543 *
	$ldlm_ªs_h›_key
(
hli°_node
 *
hnode
)

545 
ldlm_ªsour˚
 *
ªs
;

547 
ªs
 = 
	`hli°_íåy
(
hnode
, 
ldlm_ªsour˚
, 
Ã_hash
);

548  &
ªs
->
Ã_«me
;

549 
	}
}

551 
	$ldlm_ªs_h›_keycmp
(c⁄° *
key
, 
hli°_node
 *
hnode
)

553 
ldlm_ªsour˚
 *
ªs
;

555 
ªs
 = 
	`hli°_íåy
(
hnode
, 
ldlm_ªsour˚
, 
Ã_hash
);

556  
	`ldlm_ªs_eq
((c⁄° 
ldlm_ªs_id
 *)
key
,

557 (c⁄° 
ldlm_ªs_id
 *)&
ªs
->
Ã_«me
);

558 
	}
}

560 *
	$ldlm_ªs_h›_obje˘
(
hli°_node
 *
hnode
)

562  
	`hli°_íåy
(
hnode
, 
ldlm_ªsour˚
, 
Ã_hash
);

563 
	}
}

566 
	$ldlm_ªs_h›_gë_locked
(
cfs_hash
 *
hs
, 
hli°_node
 *
hnode
)

568 
ldlm_ªsour˚
 *
ªs
;

570 
ªs
 = 
	`hli°_íåy
(
hnode
, 
ldlm_ªsour˚
, 
Ã_hash
);

571 
	`ldlm_ªsour˚_gëªf
(
ªs
);

572 
	}
}

575 
	$ldlm_ªs_h›_put_locked
(
cfs_hash
 *
hs
, 
hli°_node
 *
hnode
)

577 
ldlm_ªsour˚
 *
ªs
;

579 
ªs
 = 
	`hli°_íåy
(
hnode
, 
ldlm_ªsour˚
, 
Ã_hash
);

581 
	`ldlm_ªsour˚_puåef_locked
(
ªs
);

582 
	}
}

584 
	$ldlm_ªs_h›_put
(
cfs_hash
 *
hs
, 
hli°_node
 *
hnode
)

586 
ldlm_ªsour˚
 *
ªs
;

588 
ªs
 = 
	`hli°_íåy
(
hnode
, 
ldlm_ªsour˚
, 
Ã_hash
);

589 
	`ldlm_ªsour˚_puåef
(
ªs
);

590 
	}
}

592 
cfs_hash_›s
 
	gldlm_ns_hash_›s
 = {

593 .
hs_hash
 = 
ldlm_ªs_h›_hash
,

594 .
	ghs_key
 = 
ldlm_ªs_h›_key
,

595 .
	ghs_keycmp
 = 
ldlm_ªs_h›_keycmp
,

596 .
	ghs_key˝y
 = 
NULL
,

597 .
	ghs_obje˘
 = 
ldlm_ªs_h›_obje˘
,

598 .
	ghs_gë
 = 
ldlm_ªs_h›_gë_locked
,

599 .
	ghs_put_locked
 = 
ldlm_ªs_h›_put_locked
,

600 .
	ghs_put
 = 
ldlm_ªs_h›_put


603 
cfs_hash_›s
 
	gldlm_ns_fid_hash_›s
 = {

604 .
hs_hash
 = 
ldlm_ªs_h›_fid_hash
,

605 .
	ghs_key
 = 
ldlm_ªs_h›_key
,

606 .
	ghs_keycmp
 = 
ldlm_ªs_h›_keycmp
,

607 .
	ghs_key˝y
 = 
NULL
,

608 .
	ghs_obje˘
 = 
ldlm_ªs_h›_obje˘
,

609 .
	ghs_gë
 = 
ldlm_ªs_h›_gë_locked
,

610 .
	ghs_put_locked
 = 
ldlm_ªs_h›_put_locked
,

611 .
	ghs_put
 = 
ldlm_ªs_h›_put


614 
	sldlm_ns_hash_def
 {

615 
ldlm_ns_ty≥
 
	mnsd_ty≥
;

617 
	mnsd_bkt_bôs
;

619 
	mnsd_Æl_bôs
;

621 
cfs_hash_›s
 *
	mnsd_h›s
;

622 } 
	tldlm_ns_hash_def_t
;

624 
ldlm_ns_hash_def
 
	gldlm_ns_hash_defs
[] =

627 .
nsd_ty≥
 = 
LDLM_NS_TYPE_MDC
,

628 .
	gnsd_bkt_bôs
 = 11,

629 .
	gnsd_Æl_bôs
 = 16,

630 .
	gnsd_h›s
 = &
ldlm_ns_fid_hash_›s
,

633 .
	gnsd_ty≥
 = 
LDLM_NS_TYPE_MDT
,

634 .
	gnsd_bkt_bôs
 = 14,

635 .
	gnsd_Æl_bôs
 = 21,

636 .
	gnsd_h›s
 = &
ldlm_ns_fid_hash_›s
,

639 .
	gnsd_ty≥
 = 
LDLM_NS_TYPE_OSC
,

640 .
	gnsd_bkt_bôs
 = 8,

641 .
	gnsd_Æl_bôs
 = 12,

642 .
	gnsd_h›s
 = &
ldlm_ns_hash_›s
,

645 .
	gnsd_ty≥
 = 
LDLM_NS_TYPE_OST
,

646 .
	gnsd_bkt_bôs
 = 11,

647 .
	gnsd_Æl_bôs
 = 17,

648 .
	gnsd_h›s
 = &
ldlm_ns_hash_›s
,

651 .
	gnsd_ty≥
 = 
LDLM_NS_TYPE_MGC
,

652 .
	gnsd_bkt_bôs
 = 4,

653 .
	gnsd_Æl_bôs
 = 4,

654 .
	gnsd_h›s
 = &
ldlm_ns_hash_›s
,

657 .
	gnsd_ty≥
 = 
LDLM_NS_TYPE_MGT
,

658 .
	gnsd_bkt_bôs
 = 4,

659 .
	gnsd_Æl_bôs
 = 4,

660 .
	gnsd_h›s
 = &
ldlm_ns_hash_›s
,

663 .
	gnsd_ty≥
 = 
LDLM_NS_TYPE_UNKNOWN
,

670 
ldlm_«me•a˚
 *
	$ldlm_«me•a˚_√w
(
obd_devi˚
 *
obd
, *
«me
,

671 
ldlm_side
 
˛õ¡
,

672 
ldlm_≠≥tôe
 
≠t
,

673 
ldlm_ns_ty≥
 
ns_ty≥
)

675 
ldlm_«me•a˚
 *
ns
 = 
NULL
;

676 
ldlm_ns_buckë
 *
nsb
;

677 
ldlm_ns_hash_def
 *
nsd
;

678 
cfs_hash_bd
 
bd
;

679 
idx
;

680 
rc
;

681 
ENTRY
;

683 
	`LASSERT
(
obd
 !
NULL
);

685 
rc
 = 
	`ldlm_gë_ªf
();

686 i‡(
rc
) {

687 
	`CERROR
("ldlm_gë_ª‡Áûed: %d\n", 
rc
);

688 
	`RETURN
(
NULL
);

691 
idx
 = 0;;idx++) {

692 
nsd
 = &
ldlm_ns_hash_defs
[
idx
];

693 i‡(
nsd
->
nsd_ty≥
 =
LDLM_NS_TYPE_UNKNOWN
) {

694 
	`CERROR
("Unknow¿ty≥ %d f‹Ç†%s\n", 
ns_ty≥
, 
«me
);

695 
	`GOTO
(
out_ªf
, 
NULL
);

698 i‡(
nsd
->
nsd_ty≥
 =
ns_ty≥
)

702 
	`OBD_ALLOC_PTR
(
ns
);

703 i‡(!
ns
)

704 
	`GOTO
(
out_ªf
, 
NULL
);

706 
ns
->
ns_rs_hash
 = 
	`cfs_hash_¸óã
(
«me
,

707 
nsd
->
nsd_Æl_bôs
,Çsd->nsd_all_bits,

708 
nsd
->
nsd_bkt_bôs
, (*
nsb
),

709 
CFS_HASH_MIN_THETA
,

710 
CFS_HASH_MAX_THETA
,

711 
nsd
->
nsd_h›s
,

712 
CFS_HASH_DEPTH
 |

713 
CFS_HASH_BIGNAME
 |

714 
CFS_HASH_SPIN_BKTLOCK
 |

715 
CFS_HASH_NO_ITEMREF
);

716 i‡(
ns
->
ns_rs_hash
 =
NULL
)

717 
	`GOTO
(
out_ns
, 
NULL
);

719 
	`cfs_hash_f‹_óch_buckë
(
ns
->
ns_rs_hash
, &
bd
, 
idx
) {

720 
nsb
 = 
	`cfs_hash_bd_exåa_gë
(
ns
->
ns_rs_hash
, &
bd
);

721 
	`©_öô
(&
nsb
->
nsb_©_e°im©e
, 
ldlm_íqueue_mö
, 0);

722 
nsb
->
nsb_«me•a˚
 = 
ns
;

723 
nsb
->
nsb_ª˛aim_°¨t
 = 0;

726 
ns
->
ns_obd
 = 
obd
;

727 
ns
->
ns_≠≥tôe
 = 
≠t
;

728 
ns
->
ns_˛õ¡
 = 
˛õ¡
;

730 
	`INIT_LIST_HEAD
(&
ns
->
ns_li°_chaö
);

731 
	`INIT_LIST_HEAD
(&
ns
->
ns_unu£d_li°
);

732 
	`•ö_lock_öô
(&
ns
->
ns_lock
);

733 
	`©omic_£t
(&
ns
->
ns_bªf
, 0);

734 
	`öô_waôqueue_hód
(&
ns
->
ns_waôq
);

736 
ns
->
ns_max_nﬁock_size
 = 
NS_DEFAULT_MAX_NOLOCK_BYTES
;

737 
ns
->
ns_c⁄ã¡i⁄_time
 = 
NS_DEFAULT_CONTENTION_SECONDS
;

738 
ns
->
ns_c⁄ãnded_locks
 = 
NS_DEFAULT_CONTENDED_LOCKS
;

740 
ns
->
ns_max_∑øŒñ_a°
 = 
LDLM_DEFAULT_PARALLEL_AST_LIMIT
;

741 
ns
->
ns_ƒ_unu£d
 = 0;

742 
ns
->
ns_max_unu£d
 = 
LDLM_DEFAULT_LRU_SIZE
;

743 
ns
->
ns_max_age
 = 
LDLM_DEFAULT_MAX_ALIVE
;

744 
ns
->
ns_˘ime_age_limô
 = 
LDLM_CTIME_AGE_LIMIT
;

745 
ns
->
ns_timeouts
 = 0;

746 
ns
->
ns_‹ig_c⁄√˘_Êags
 = 0;

747 
ns
->
ns_c⁄√˘_Êags
 = 0;

748 
ns
->
ns_°›pög
 = 0;

749 
ns
->
ns_ª˛aim_°¨t
 = 0;

750 
rc
 = 
	`ldlm_«me•a˚_¥oc_ªgi°î
(
ns
);

751 i‡(
rc
 != 0) {

752 
	`CERROR
("C™'àöôülizên†¥oc,Ñ¯%d\n", 
rc
);

753 
	`GOTO
(
out_hash
, 
rc
);

756 
idx
 = 
	`ldlm_«me•a˚_ƒ_ªad
(
˛õ¡
);

757 
rc
 = 
	`ldlm_poﬁ_öô
(&
ns
->
ns_poﬁ
,Çs, 
idx
, 
˛õ¡
);

758 i‡(
rc
) {

759 
	`CERROR
("C™'àöôülizêlockÖoﬁ,Ñ¯%d\n", 
rc
);

760 
	`GOTO
(
out_¥oc
, 
rc
);

763 
	`ldlm_«me•a˚_ªgi°î
(
ns
, 
˛õ¡
);

764 
	`RETURN
(
ns
);

765 
out_¥oc
:

766 
	`ldlm_«me•a˚_¥oc_uƒegi°î
(
ns
);

767 
	`ldlm_«me•a˚_˛ónup
(
ns
, 0);

768 
out_hash
:

769 
	`cfs_hash_puåef
(
ns
->
ns_rs_hash
);

770 
out_ns
:

771 
	`OBD_FREE_PTR
(
ns
);

772 
out_ªf
:

773 
	`ldlm_put_ªf
();

774 
	`RETURN
(
NULL
);

775 
	}
}

776 
EXPORT_SYMBOL
(
ldlm_«me•a˚_√w
);

778 
ldlm_lock
 *
ldlm_lock_gë
(ldlm_lock *
lock
);

788 
	$˛ónup_ªsour˚
(
ldlm_ªsour˚
 *
ªs
, 
li°_hód
 *
q
,

789 
__u64
 
Êags
)

791 
li°_hód
 *
tmp
;

792 
rc
 = 0, 
˛õ¡
 = 
	`ns_is_˛õ¡
(
	`ldlm_ªs_to_ns
(
ªs
));

793 
boﬁ
 
loˇl_⁄ly
 = !!(
Êags
 & 
LDLM_FL_LOCAL_ONLY
);

796 
ldlm_lock
 *
lock
 = 
NULL
;

800 
	`lock_ªs
(
ªs
);

801 
	`li°_f‹_óch
(
tmp
, 
q
) {

802 
lock
 = 
	`li°_íåy
(
tmp
, 
ldlm_lock
,

803 
l_ªs_lök
);

804 i‡(
	`ldlm_is_˛ó√d
(
lock
)) {

805 
lock
 = 
NULL
;

808 
	`LDLM_LOCK_GET
(
lock
);

809 
	`ldlm_£t_˛ó√d
(
lock
);

813 i‡(
lock
 =
NULL
) {

814 
	`u∆ock_ªs
(
ªs
);

820 
	`ldlm_£t_cb≥ndög
(
lock
);

821 
	`ldlm_£t_Áûed
(
lock
);

822 
lock
->
l_Êags
 |
Êags
;

825 i‡(
loˇl_⁄ly
)

826 
	`ldlm_£t_loˇl_⁄ly
(
lock
);

828 i‡(
loˇl_⁄ly
 && (
lock
->
l_ªadîs
 ||Üock->
l_wrôîs
)) {

833 
	`u∆ock_ªs
(
ªs
);

834 
	`LDLM_DEBUG
(
lock
, "setting FL_LOCAL_ONLY");

835 i‡(
lock
->
l_Êags
 & 
LDLM_FL_FAIL_LOC
) {

836 
	`£t_cuºít_°©e
(
TASK_UNINTERRUPTIBLE
);

837 
	`scheduÀ_timeout
(
	`cfs_time_£c⁄ds
(4));

838 
	`£t_cuºít_°©e
(
TASK_RUNNING
);

840 i‡(
lock
->
l_com∂ëi⁄_a°
)

841 
lock
->
	`l_com∂ëi⁄_a°
(lock,

842 
LDLM_FL_FAILED
, 
NULL
);

843 
	`LDLM_LOCK_RELEASE
(
lock
);

847 i‡(
˛õ¡
) {

848 
lu°ª_h™dÀ
 
lockh
;

850 
	`u∆ock_ªs
(
ªs
);

851 
	`ldlm_lock2h™dÀ
(
lock
, &
lockh
);

852 
rc
 = 
	`ldlm_˛i_ˇn˚l
(&
lockh
, 
LCF_LOCAL
);

853 i‡(
rc
)

854 
	`CERROR
("ldlm_˛i_ˇn˚l: %d\n", 
rc
);

856 
	`u∆ock_ªs
(
ªs
);

857 
	`LDLM_DEBUG
(
lock
, "FreeingáÜock still held byá "

859 
	`ldlm_lock_ˇn˚l
(
lock
);

861 
	`LDLM_LOCK_RELEASE
(
lock
);

863 
	}
}

865 
	$ldlm_ªsour˚_˛ón
(
cfs_hash
 *
hs
, 
cfs_hash_bd
 *
bd
,

866 
hli°_node
 *
hnode
, *
¨g
)

868 
ldlm_ªsour˚
 *
ªs
 = 
	`cfs_hash_obje˘
(
hs
, 
hnode
);

869 
__u64
 
Êags
 = *(__u64 *)
¨g
;

871 
	`˛ónup_ªsour˚
(
ªs
, &ªs->
Ã_gø¡ed
, 
Êags
);

872 
	`˛ónup_ªsour˚
(
ªs
, &ªs->
Ã_c⁄vîtög
, 
Êags
);

873 
	`˛ónup_ªsour˚
(
ªs
, &ªs->
Ã_waôög
, 
Êags
);

876 
	}
}

878 
	$ldlm_ªsour˚_com∂aö
(
cfs_hash
 *
hs
, 
cfs_hash_bd
 *
bd
,

879 
hli°_node
 *
hnode
, *
¨g
)

881 
ldlm_ªsour˚
 *
ªs
 = 
	`cfs_hash_obje˘
(
hs
, 
hnode
);

883 
	`lock_ªs
(
ªs
);

884 
	`CERROR
("%s:Çame•a˚Ñesour˚ "
DLDLMRES
" (%p)ÑefcountÇonzero "

886 
	`ldlm_ns_«me
(
	`ldlm_ªs_to_ns
(
ªs
)), 
	`PLDLMRES
(res),Ñes,

887 
	`©omic_ªad
(&
ªs
->
Ã_ªfcou¡
) - 1);

889 
	`ldlm_ªsour˚_dump
(
D_ERROR
, 
ªs
);

890 
	`u∆ock_ªs
(
ªs
);

892 
	}
}

901 
	$ldlm_«me•a˚_˛ónup
(
ldlm_«me•a˚
 *
ns
, 
__u64
 
Êags
)

903 i‡(
ns
 =
NULL
) {

904 
	`CDEBUG
(
D_INFO
, "NULLÇs, skipping cleanup\n");

905  
ELDLM_OK
;

908 
	`cfs_hash_f‹_óch_nﬁock
(
ns
->
ns_rs_hash
, 
ldlm_ªsour˚_˛ón
,

909 &
Êags
, 0);

910 
	`cfs_hash_f‹_óch_nﬁock
(
ns
->
ns_rs_hash
, 
ldlm_ªsour˚_com∂aö
,

911 
NULL
, 0);

912  
ELDLM_OK
;

913 
	}
}

914 
EXPORT_SYMBOL
(
ldlm_«me•a˚_˛ónup
);

921 
	$__ldlm_«me•a˚_‰ì
(
ldlm_«me•a˚
 *
ns
, 
f‹˚
)

923 
ENTRY
;

926 
	`ldlm_«me•a˚_˛ónup
(
ns
, 
f‹˚
 ? 
LDLM_FL_LOCAL_ONLY
 : 0);

928 i‡(
	`©omic_ªad
(&
ns
->
ns_bªf
) > 0) {

929 
l_waô_öfo
 
lwi
 = 
	`LWI_INTR
(
LWI_ON_SIGNAL_NOOP
, 
NULL
);

930 
rc
;

931 
	`CDEBUG
(
D_DLMTRACE
,

933 
	`ldlm_ns_«me
(
ns
), 
	`©omic_ªad
(&ns->
ns_bªf
));

934 
f‹˚_waô
:

935 i‡(
f‹˚
)

936 
lwi
 = 
	`LWI_TIMEOUT
(
	`m£cs_to_jiffõs
(
obd_timeout
 *

937 
MSEC_PER_SEC
Ë/ 4, 
NULL
, NULL);

939 
rc
 = 
	`l_waô_evít
(
ns
->
ns_waôq
,

940 
	`©omic_ªad
(&
ns
->
ns_bªf
Ë=0, &
lwi
);

944 i‡(
f‹˚
 && 
rc
 =-
ETIMEDOUT
) {

945 
	`LCONSOLE_ERROR
("Forced cleanup waiting for %s "

947 "‘c=%d)\n", 
	`ldlm_ns_«me
(
ns
),

948 
	`©omic_ªad
(&
ns
->
ns_bªf
), 
rc
);

949 
	`GOTO
(
f‹˚_waô
, 
rc
);

952 i‡(
	`©omic_ªad
(&
ns
->
ns_bªf
)) {

953 
	`LCONSOLE_ERROR
("Cleanup waiting for %sÇamespace "

955 
	`ldlm_ns_«me
(
ns
),

956 
	`©omic_ªad
(&
ns
->
ns_bªf
), 
rc
);

957 
	`RETURN
(
ELDLM_NAMESPACE_EXISTS
);

959 
	`CDEBUG
(
D_DLMTRACE
, "dlmÇamespace %s free done waiting\n",

960 
	`ldlm_ns_«me
(
ns
));

963 
	`RETURN
(
ELDLM_OK
);

964 
	}
}

975 
	$ldlm_«me•a˚_‰ì_¥i‹
(
ldlm_«me•a˚
 *
ns
,

976 
obd_imp‹t
 *
imp
,

977 
f‹˚
)

979 
rc
;

980 
ENTRY
;

981 i‡(!
ns
) {

982 
EXIT
;

986 
	`•ö_lock
(&
ns
->
ns_lock
);

987 
ns
->
ns_°›pög
 = 1;

988 
	`•ö_u∆ock
(&
ns
->
ns_lock
);

993 
rc
 = 
	`__ldlm_«me•a˚_‰ì
(
ns
, 
f‹˚
);

994 i‡(
rc
 !
ELDLM_OK
) {

995 i‡(
imp
) {

996 
	`±Ãpc_disc⁄√˘_imp‹t
(
imp
, 0);

997 
	`±Ãpc_övÆid©e_imp‹t
(
imp
);

1004 
rc
 = 
	`__ldlm_«me•a˚_‰ì
(
ns
, 1);

1005 
	`LASSERT
(
rc
 == 0);

1007 
EXIT
;

1008 
	}
}

1009 
EXPORT_SYMBOL
(
ldlm_«me•a˚_‰ì_¥i‹
);

1016 
	$ldlm_«me•a˚_‰ì_po°
(
ldlm_«me•a˚
 *
ns
)

1018 
ENTRY
;

1019 i‡(!
ns
) {

1020 
EXIT
;

1025 
	`ldlm_«me•a˚_uƒegi°î
(
ns
,Çs->
ns_˛õ¡
);

1029 
	`ldlm_poﬁ_föi
(&
ns
->
ns_poﬁ
);

1031 
	`ldlm_«me•a˚_¥oc_uƒegi°î
(
ns
);

1032 
	`cfs_hash_puåef
(
ns
->
ns_rs_hash
);

1036 
	`LASSERT
(
	`li°_em±y
(&
ns
->
ns_li°_chaö
));

1037 
	`OBD_FREE_PTR
(
ns
);

1038 
	`ldlm_put_ªf
();

1039 
EXIT
;

1040 
	}
}

1041 
EXPORT_SYMBOL
(
ldlm_«me•a˚_‰ì_po°
);

1061 
	$ldlm_«me•a˚_‰ì
(
ldlm_«me•a˚
 *
ns
,

1062 
obd_imp‹t
 *
imp
,

1063 
f‹˚
)

1065 
	`ldlm_«me•a˚_‰ì_¥i‹
(
ns
, 
imp
, 
f‹˚
);

1066 
	`ldlm_«me•a˚_‰ì_po°
(
ns
);

1067 
	}
}

1068 
EXPORT_SYMBOL
(
ldlm_«me•a˚_‰ì
);

1070 
	$ldlm_«me•a˚_gë
(
ldlm_«me•a˚
 *
ns
)

1072 
	`©omic_öc
(&
ns
->
ns_bªf
);

1073 
	}
}

1076 
	$ldlm_«me•a˚_gë_ªtu∫
(
ldlm_«me•a˚
 *
ns
)

1078  
	`©omic_öc_ªtu∫
(&
ns
->
ns_bªf
);

1079 
	}
}

1081 
	$ldlm_«me•a˚_put
(
ldlm_«me•a˚
 *
ns
)

1083 i‡(
	`©omic_dec_™d_lock
(&
ns
->
ns_bªf
, &ns->
ns_lock
)) {

1084 
	`wake_up
(&
ns
->
ns_waôq
);

1085 
	`•ö_u∆ock
(&
ns
->
ns_lock
);

1087 
	}
}

1090 
	$ldlm_«me•a˚_ªgi°î
(
ldlm_«me•a˚
 *
ns
, 
ldlm_side
 
˛õ¡
)

1092 
	`muãx_lock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1093 
	`LASSERT
(
	`li°_em±y
(&
ns
->
ns_li°_chaö
));

1094 
	`li°_add
(&
ns
->
ns_li°_chaö
, 
	`ldlm_«me•a˚_öa˘ive_li°
(
˛õ¡
));

1095 
	`ldlm_«me•a˚_ƒ_öc
(
˛õ¡
);

1096 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1097 
	}
}

1100 
	$ldlm_«me•a˚_uƒegi°î
(
ldlm_«me•a˚
 *
ns
, 
ldlm_side
 
˛õ¡
)

1102 
	`muãx_lock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1103 
	`LASSERT
(!
	`li°_em±y
(&
ns
->
ns_li°_chaö
));

1107 
	`li°_dñ_öô
(&
ns
->
ns_li°_chaö
);

1108 
	`ldlm_«me•a˚_ƒ_dec
(
˛õ¡
);

1109 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1110 
	}
}

1113 
	$ldlm_«me•a˚_move_to_a˘ive_locked
(
ldlm_«me•a˚
 *
ns
,

1114 
ldlm_side
 
˛õ¡
)

1116 
	`LASSERT
(!
	`li°_em±y
(&
ns
->
ns_li°_chaö
));

1117 
	`LASSERT
(
	`muãx_is_locked
(
	`ldlm_«me•a˚_lock
(
˛õ¡
)));

1118 
	`li°_move_èû
(&
ns
->
ns_li°_chaö
, 
	`ldlm_«me•a˚_li°
(
˛õ¡
));

1119 
	}
}

1122 
	$ldlm_«me•a˚_move_to_öa˘ive_locked
(
ldlm_«me•a˚
 *
ns
,

1123 
ldlm_side
 
˛õ¡
)

1125 
	`LASSERT
(!
	`li°_em±y
(&
ns
->
ns_li°_chaö
));

1126 
	`LASSERT
(
	`muãx_is_locked
(
	`ldlm_«me•a˚_lock
(
˛õ¡
)));

1127 
	`li°_move_èû
(&
ns
->
ns_li°_chaö
,

1128 
	`ldlm_«me•a˚_öa˘ive_li°
(
˛õ¡
));

1129 
	}
}

1132 
ldlm_«me•a˚
 *
	$ldlm_«me•a˚_fú°_locked
(
ldlm_side
 
˛õ¡
)

1134 
	`LASSERT
(
	`muãx_is_locked
(
	`ldlm_«me•a˚_lock
(
˛õ¡
)));

1135 
	`LASSERT
(!
	`li°_em±y
(
	`ldlm_«me•a˚_li°
(
˛õ¡
)));

1136  
	`c⁄èöî_of
(
	`ldlm_«me•a˚_li°
(
˛õ¡
)->
√xt
,

1137 
ldlm_«me•a˚
, 
ns_li°_chaö
);

1138 
	}
}

1141 
ldlm_ªsour˚
 *
	$ldlm_ªsour˚_√w
(
ldlm_ty≥
Üdlm_type)

1143 
ldlm_ªsour˚
 *
ªs
;

1144 
idx
;

1146 
	`OBD_SLAB_ALLOC_PTR_GFP
(
ªs
, 
ldlm_ªsour˚_¶ab
, 
GFP_NOFS
);

1147 i‡(
ªs
 =
NULL
)

1148  
NULL
;

1150 i‡(
ldlm_ty≥
 =
LDLM_EXTENT
) {

1151 
	`OBD_SLAB_ALLOC
(
ªs
->
Ã_ôªe
, 
ldlm_öãrvÆ_åì_¶ab
,

1152 (*
ªs
->
Ã_ôªe
Ë* 
LCK_MODE_NUM
);

1153 i‡(
ªs
->
Ã_ôªe
 =
NULL
) {

1154 
	`OBD_SLAB_FREE_PTR
(
ªs
, 
ldlm_ªsour˚_¶ab
);

1155  
NULL
;

1158 
idx
 = 0; idx < 
LCK_MODE_NUM
; idx++) {

1159 
ªs
->
Ã_ôªe
[
idx
].
lô_size
 = 0;

1160 
ªs
->
Ã_ôªe
[
idx
].
lô_mode
 = 1 << idx;

1161 
ªs
->
Ã_ôªe
[
idx
].
lô_roŸ
 = 
NULL
;

1165 
	`INIT_LIST_HEAD
(&
ªs
->
Ã_gø¡ed
);

1166 
	`INIT_LIST_HEAD
(&
ªs
->
Ã_c⁄vîtög
);

1167 
	`INIT_LIST_HEAD
(&
ªs
->
Ã_waôög
);

1169 
	`©omic_£t
(&
ªs
->
Ã_ªfcou¡
, 1);

1170 
	`•ö_lock_öô
(&
ªs
->
Ã_lock
);

1171 
	`lu_ªf_öô
(&
ªs
->
Ã_ª„ªn˚
);

1175 
	`muãx_öô
(&
ªs
->
Ã_lvb_muãx
);

1176 
ªs
->
Ã_lvb_öôülized
 = 
Ál£
;

1178  
ªs
;

1179 
	}
}

1187 
ldlm_ªsour˚
 *

1188 
	$ldlm_ªsour˚_gë
(
ldlm_«me•a˚
 *
ns
, 
ldlm_ªsour˚
 *
∑ª¡
,

1189 c⁄° 
ldlm_ªs_id
 *
«me
, 
ldlm_ty≥
 
ty≥
,

1190 
¸óã
)

1192 
hli°_node
 *
hnode
;

1193 
ldlm_ªsour˚
 *
ªs
 = 
NULL
;

1194 
cfs_hash_bd
 
bd
;

1195 
__u64
 
vîsi⁄
;

1196 
ns_ªfcou¡
 = 0;

1198 
	`LASSERT
(
ns
 !
NULL
);

1199 
	`LASSERT
(
∑ª¡
 =
NULL
);

1200 
	`LASSERT
(
ns
->
ns_rs_hash
 !
NULL
);

1201 
	`LASSERT
(
«me
->name[0] != 0);

1203 
	`cfs_hash_bd_gë_™d_lock
(
ns
->
ns_rs_hash
, (*)
«me
, &
bd
, 0);

1204 
hnode
 = 
	`cfs_hash_bd_lookup_locked
(
ns
->
ns_rs_hash
, &
bd
, (*)
«me
);

1205 i‡(
hnode
 !
NULL
) {

1206 
	`cfs_hash_bd_u∆ock
(
ns
->
ns_rs_hash
, &
bd
, 0);

1207 
	`GOTO
(
found
, 
ªs
);

1210 
vîsi⁄
 = 
	`cfs_hash_bd_vîsi⁄_gë
(&
bd
);

1211 
	`cfs_hash_bd_u∆ock
(
ns
->
ns_rs_hash
, &
bd
, 0);

1213 i‡(
¸óã
 == 0)

1214  
	`ERR_PTR
(-
ENOENT
);

1216 
	`LASSERTF
(
ty≥
 >
LDLM_MIN_TYPE
 &&Åy≥ < 
LDLM_MAX_TYPE
,

1217 "ty≥: %d\n", 
ty≥
);

1218 
ªs
 = 
	`ldlm_ªsour˚_√w
(
ty≥
);

1219 i‡(
ªs
 =
NULL
)

1220  
	`ERR_PTR
(-
ENOMEM
);

1222 
ªs
->
Ã_ns_buckë
 = 
	`cfs_hash_bd_exåa_gë
(
ns
->
ns_rs_hash
, &
bd
);

1223 
ªs
->
Ã_«me
 = *
«me
;

1224 
ªs
->
Ã_ty≥
 = 
ty≥
;

1226 
	`cfs_hash_bd_lock
(
ns
->
ns_rs_hash
, &
bd
, 1);

1227 
hnode
 = (
vîsi⁄
 =
	`cfs_hash_bd_vîsi⁄_gë
(&
bd
)Ë? 
NULL
 :

1228 
	`cfs_hash_bd_lookup_locked
(
ns
->
ns_rs_hash
, &
bd
, (*)
«me
);

1230 i‡(
hnode
 !
NULL
) {

1232 
	`cfs_hash_bd_u∆ock
(
ns
->
ns_rs_hash
, &
bd
, 1);

1234 
	`lu_ªf_föi
(&
ªs
->
Ã_ª„ªn˚
);

1235 i‡(
ªs
->
Ã_ôªe
 !
NULL
)

1236 
	`OBD_SLAB_FREE
(
ªs
->
Ã_ôªe
, 
ldlm_öãrvÆ_åì_¶ab
,

1237 (*
ªs
->
Ã_ôªe
Ë* 
LCK_MODE_NUM
);

1238 
	`OBD_SLAB_FREE
(
ªs
, 
ldlm_ªsour˚_¶ab
,  *res);

1239 
found
:

1240 
ªs
 = 
	`hli°_íåy
(
hnode
, 
ldlm_ªsour˚
, 
Ã_hash
);

1241  
ªs
;

1244 
	`cfs_hash_bd_add_locked
(
ns
->
ns_rs_hash
, &
bd
, &
ªs
->
Ã_hash
);

1245 i‡(
	`cfs_hash_bd_cou¡_gë
(&
bd
) == 1)

1246 
ns_ªfcou¡
 = 
	`ldlm_«me•a˚_gë_ªtu∫
(
ns
);

1248 
	`cfs_hash_bd_u∆ock
(
ns
->
ns_rs_hash
, &
bd
, 1);

1250 
	`OBD_FAIL_TIMEOUT
(
OBD_FAIL_LDLM_CREATE_RESOURCE
, 2);

1256 i‡(
	`ns_is_˛õ¡
(
ns
Ë&& 
ns_ªfcou¡
 == 1) {

1257 
	`muãx_lock
(
	`ldlm_«me•a˚_lock
(
LDLM_NAMESPACE_CLIENT
));

1258 
	`ldlm_«me•a˚_move_to_a˘ive_locked
(
ns
, 
LDLM_NAMESPACE_CLIENT
);

1259 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
LDLM_NAMESPACE_CLIENT
));

1262  
ªs
;

1263 
	}
}

1264 
EXPORT_SYMBOL
(
ldlm_ªsour˚_gë
);

1266 
ldlm_ªsour˚
 *
	$ldlm_ªsour˚_gëªf
(
ldlm_ªsour˚
 *
ªs
)

1268 
	`LASSERT
(
ªs
 !
NULL
);

1269 
	`LASSERT
(
ªs
 !
LP_POISON
);

1270 
	`©omic_öc
(&
ªs
->
Ã_ªfcou¡
);

1271 
	`CDEBUG
(
D_INFO
, "gëª‡ªs: %∞cou¡: %d\n", 
ªs
,

1272 
	`©omic_ªad
(&
ªs
->
Ã_ªfcou¡
));

1273  
ªs
;

1274 
	}
}

1276 
	$__ldlm_ªsour˚_puåef_föÆ
(
cfs_hash_bd
 *
bd
,

1277 
ldlm_ªsour˚
 *
ªs
)

1279 
ldlm_ns_buckë
 *
nsb
 = 
ªs
->
Ã_ns_buckë
;

1281 i‡(!
	`li°_em±y
(&
ªs
->
Ã_gø¡ed
)) {

1282 
	`ldlm_ªsour˚_dump
(
D_ERROR
, 
ªs
);

1283 
	`LBUG
();

1286 i‡(!
	`li°_em±y
(&
ªs
->
Ã_c⁄vîtög
)) {

1287 
	`ldlm_ªsour˚_dump
(
D_ERROR
, 
ªs
);

1288 
	`LBUG
();

1291 i‡(!
	`li°_em±y
(&
ªs
->
Ã_waôög
)) {

1292 
	`ldlm_ªsour˚_dump
(
D_ERROR
, 
ªs
);

1293 
	`LBUG
();

1296 
	`cfs_hash_bd_dñ_locked
(
nsb
->
nsb_«me•a˚
->
ns_rs_hash
,

1297 
bd
, &
ªs
->
Ã_hash
);

1298 
	`lu_ªf_föi
(&
ªs
->
Ã_ª„ªn˚
);

1299 i‡(
	`cfs_hash_bd_cou¡_gë
(
bd
) == 0)

1300 
	`ldlm_«me•a˚_put
(
nsb
->
nsb_«me•a˚
);

1301 
	}
}

1304 
	$ldlm_ªsour˚_puåef
(
ldlm_ªsour˚
 *
ªs
)

1306 
ldlm_«me•a˚
 *
ns
 = 
	`ldlm_ªs_to_ns
(
ªs
);

1307 
cfs_hash_bd
 
bd
;

1309 
	`LASSERT_ATOMIC_GT_LT
(&
ªs
->
Ã_ªfcou¡
, 0, 
LI_POISON
);

1310 
	`CDEBUG
(
D_INFO
, "putrefÑes: %p count: %d\n",

1311 
ªs
, 
	`©omic_ªad
(&ªs->
Ã_ªfcou¡
) - 1);

1313 
	`cfs_hash_bd_gë
(
ns
->
ns_rs_hash
, &
ªs
->
Ã_«me
, &
bd
);

1314 i‡(
	`cfs_hash_bd_dec_™d_lock
(
ns
->
ns_rs_hash
, &
bd
, &
ªs
->
Ã_ªfcou¡
)) {

1315 
	`__ldlm_ªsour˚_puåef_föÆ
(&
bd
, 
ªs
);

1316 
	`cfs_hash_bd_u∆ock
(
ns
->
ns_rs_hash
, &
bd
, 1);

1317 i‡(
ns
->
ns_lvbo
 &&Çs->ns_lvbo->
lvbo_‰ì
)

1318 
ns
->
ns_lvbo
->
	`lvbo_‰ì
(
ªs
);

1319 i‡(
ªs
->
Ã_ôªe
 !
NULL
)

1320 
	`OBD_SLAB_FREE
(
ªs
->
Ã_ôªe
, 
ldlm_öãrvÆ_åì_¶ab
,

1321 (*
ªs
->
Ã_ôªe
Ë* 
LCK_MODE_NUM
);

1322 
	`OBD_SLAB_FREE
(
ªs
, 
ldlm_ªsour˚_¶ab
,  *res);

1326 
	}
}

1327 
EXPORT_SYMBOL
(
ldlm_ªsour˚_puåef
);

1330 
	$ldlm_ªsour˚_puåef_locked
(
ldlm_ªsour˚
 *
ªs
)

1332 
ldlm_«me•a˚
 *
ns
 = 
	`ldlm_ªs_to_ns
(
ªs
);

1334 
	`LASSERT_ATOMIC_GT_LT
(&
ªs
->
Ã_ªfcou¡
, 0, 
LI_POISON
);

1335 
	`CDEBUG
(
D_INFO
, "putrefÑes: %p count: %d\n",

1336 
ªs
, 
	`©omic_ªad
(&ªs->
Ã_ªfcou¡
) - 1);

1338 i‡(
	`©omic_dec_™d_ã°
(&
ªs
->
Ã_ªfcou¡
)) {

1339 
cfs_hash_bd
 
bd
;

1341 
	`cfs_hash_bd_gë
(
	`ldlm_ªs_to_ns
(
ªs
)->
ns_rs_hash
,

1342 &
ªs
->
Ã_«me
, &
bd
);

1343 
	`__ldlm_ªsour˚_puåef_föÆ
(&
bd
, 
ªs
);

1344 
	`cfs_hash_bd_u∆ock
(
ns
->
ns_rs_hash
, &
bd
, 1);

1350 i‡(
ns
->
ns_lvbo
 &&Çs->ns_lvbo->
lvbo_‰ì
)

1351 
ns
->
ns_lvbo
->
	`lvbo_‰ì
(
ªs
);

1352 i‡(
ªs
->
Ã_ôªe
 !
NULL
)

1353 
	`OBD_SLAB_FREE
(
ªs
->
Ã_ôªe
, 
ldlm_öãrvÆ_åì_¶ab
,

1354 (*
ªs
->
Ã_ôªe
Ë* 
LCK_MODE_NUM
);

1355 
	`OBD_SLAB_FREE
(
ªs
, 
ldlm_ªsour˚_¶ab
,  *res);

1357 
	`cfs_hash_bd_lock
(
ns
->
ns_rs_hash
, &
bd
, 1);

1361 
	}
}

1366 
	$ldlm_ªsour˚_add_lock
(
ldlm_ªsour˚
 *
ªs
, 
li°_hód
 *
hód
,

1367 
ldlm_lock
 *
lock
)

1369 
	`check_ªs_locked
(
ªs
);

1371 
	`LDLM_DEBUG
(
lock
, "AboutÅoáddÅhisÜock:\n");

1373 i‡(
	`ldlm_is_de°royed
(
lock
)) {

1374 
	`CDEBUG
(
D_OTHER
, "Lock destroyed,ÇotáddingÅoÑesource\n");

1378 
	`LASSERT
(
	`li°_em±y
(&
lock
->
l_ªs_lök
));

1380 
	`li°_add_èû
(&
lock
->
l_ªs_lök
, 
hód
);

1381 
	}
}

1388 
	$ldlm_ªsour˚_ö£π_lock_a·î
(
ldlm_lock
 *
‹igöÆ
,

1389 
ldlm_lock
 *
√w
)

1391 
ldlm_ªsour˚
 *
ªs
 = 
‹igöÆ
->
l_ªsour˚
;

1393 
	`check_ªs_locked
(
ªs
);

1395 
	`ldlm_ªsour˚_dump
(
D_INFO
, 
ªs
);

1396 
	`LDLM_DEBUG
(
√w
, "Abouàtÿö£πÅhi†locká·î %p:\n", 
‹igöÆ
);

1398 i‡(
	`ldlm_is_de°royed
(
√w
)) {

1399 
	`CDEBUG
(
D_OTHER
, "Lock destroyed,ÇotáddingÅoÑesource\n");

1400 
out
;

1403 
	`LASSERT
(
	`li°_em±y
(&
√w
->
l_ªs_lök
));

1405 
	`li°_add
(&
√w
->
l_ªs_lök
, &
‹igöÆ
->l_res_link);

1406 
out
:;

1407 
	}
}

1409 
	$ldlm_ªsour˚_u∆ök_lock
(
ldlm_lock
 *
lock
)

1411 
ty≥
 = 
lock
->
l_ªsour˚
->
Ã_ty≥
;

1413 
	`check_ªs_locked
(
lock
->
l_ªsour˚
);

1414 i‡(
ty≥
 =
LDLM_IBITS
 ||Åy≥ =
LDLM_PLAIN
)

1415 
	`ldlm_u∆ök_lock_skùli°
(
lock
);

1416 i‡(
ty≥
 =
LDLM_EXTENT
)

1417 
	`ldlm_exã¡_u∆ök_lock
(
lock
);

1418 
	`li°_dñ_öô
(&
lock
->
l_ªs_lök
);

1419 
	}
}

1420 
EXPORT_SYMBOL
(
ldlm_ªsour˚_u∆ök_lock
);

1422 
	$ldlm_ªs2desc
(
ldlm_ªsour˚
 *
ªs
, 
ldlm_ªsour˚_desc
 *
desc
)

1424 
desc
->
Ã_ty≥
 = 
ªs
->lr_type;

1425 
desc
->
Ã_«me
 = 
ªs
->lr_name;

1426 
	}
}

1432 
	$ldlm_dump_Æl_«me•a˚s
(
ldlm_side
 
˛õ¡
, 
Àvñ
)

1434 
li°_hód
 *
tmp
;

1436 i‡(!((
libcfs_debug
 | 
D_ERROR
Ë& 
Àvñ
))

1439 
	`muãx_lock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1441 
	`li°_f‹_óch
(
tmp
, 
	`ldlm_«me•a˚_li°
(
˛õ¡
)) {

1442 
ldlm_«me•a˚
 *
ns
;

1444 
ns
 = 
	`li°_íåy
(
tmp
, 
ldlm_«me•a˚
, 
ns_li°_chaö
);

1445 
	`ldlm_«me•a˚_dump
(
Àvñ
, 
ns
);

1448 
	`muãx_u∆ock
(
	`ldlm_«me•a˚_lock
(
˛õ¡
));

1449 
	}
}

1451 
	$ldlm_ªs_hash_dump
(
cfs_hash
 *
hs
, 
cfs_hash_bd
 *
bd
,

1452 
hli°_node
 *
hnode
, *
¨g
)

1454 
ldlm_ªsour˚
 *
ªs
 = 
	`cfs_hash_obje˘
(
hs
, 
hnode
);

1455 
Àvñ
 = ()()
¨g
;

1457 
	`lock_ªs
(
ªs
);

1458 
	`ldlm_ªsour˚_dump
(
Àvñ
, 
ªs
);

1459 
	`u∆ock_ªs
(
ªs
);

1462 
	}
}

1468 
	$ldlm_«me•a˚_dump
(
Àvñ
, 
ldlm_«me•a˚
 *
ns
)

1470 i‡(!((
libcfs_debug
 | 
D_ERROR
Ë& 
Àvñ
))

1473 
	`CDEBUG
(
Àvñ
, "--- Namespace: %s (rc: %d, side: %s)\n",

1474 
	`ldlm_ns_«me
(
ns
), 
	`©omic_ªad
(&ns->
ns_bªf
),

1475 
	`ns_is_˛õ¡
(
ns
) ? "client" : "server");

1477 i‡(
	`cfs_time_bef‹e
(
	`cfs_time_cuºít
(), 
ns
->
ns_√xt_dump
))

1480 
	`cfs_hash_f‹_óch_nﬁock
(
ns
->
ns_rs_hash
,

1481 
ldlm_ªs_hash_dump
,

1482 (*)()
Àvñ
, 0);

1483 
	`•ö_lock
(&
ns
->
ns_lock
);

1484 
ns
->
ns_√xt_dump
 = 
	`cfs_time_shi·
(10);

1485 
	`•ö_u∆ock
(&
ns
->
ns_lock
);

1486 
	}
}

1491 
	$ldlm_ªsour˚_dump
(
Àvñ
, 
ldlm_ªsour˚
 *
ªs
)

1493 
ldlm_lock
 *
lock
;

1494 
gø¡ed
 = 0;

1496 
	`CLASSERT
(
RES_NAME_SIZE
 == 4);

1498 i‡(!((
libcfs_debug
 | 
D_ERROR
Ë& 
Àvñ
))

1501 
	`CDEBUG
(
Àvñ
, "--- Resour˚: "
DLDLMRES
" (%p)Ñefcount = %d\n",

1502 
	`PLDLMRES
(
ªs
),Ñes, 
	`©omic_ªad
(&ªs->
Ã_ªfcou¡
));

1504 i‡(!
	`li°_em±y
(&
ªs
->
Ã_gø¡ed
)) {

1505 
	`CDEBUG
(
Àvñ
, "GrantedÜocks (inÑeverse order):\n");

1506 
	`li°_f‹_óch_íåy_ªvî£
(
lock
, &
ªs
->
Ã_gø¡ed
,

1507 
l_ªs_lök
) {

1508 
	`LDLM_DEBUG_LIMIT
(
Àvñ
, 
lock
, "###");

1509 i‡(!(
Àvñ
 & 
D_CANTMASK
) &&

1510 ++
gø¡ed
 > 
ldlm_dump_gø¡ed_max
) {

1511 
	`CDEBUG
(
Àvñ
, "only dump %d grantedÜocksÅo "

1512 "avoid DDOS.\n", 
gø¡ed
);

1517 i‡(!
	`li°_em±y
(&
ªs
->
Ã_c⁄vîtög
)) {

1518 
	`CDEBUG
(
Àvñ
, "ConvertingÜocks:\n");

1519 
	`li°_f‹_óch_íåy
(
lock
, &
ªs
->
Ã_c⁄vîtög
, 
l_ªs_lök
)

1520 
	`LDLM_DEBUG_LIMIT
(
Àvñ
, 
lock
, "###");

1522 i‡(!
	`li°_em±y
(&
ªs
->
Ã_waôög
)) {

1523 
	`CDEBUG
(
Àvñ
, "WaitingÜocks:\n");

1524 
	`li°_f‹_óch_íåy
(
lock
, &
ªs
->
Ã_waôög
, 
l_ªs_lök
)

1525 
	`LDLM_DEBUG_LIMIT
(
Àvñ
, 
lock
, "###");

1527 
	}
}

1528 
EXPORT_SYMBOL
(
ldlm_ªsour˚_dump
);

	@
1
.
1
/usr/include
14
192
interval_tree.c
l_lock.c
ldlm_extent.c
ldlm_flock.c
ldlm_inodebits.c
ldlm_internal.h
ldlm_lib.c
ldlm_lock.c
ldlm_lockd.c
ldlm_plain.c
ldlm_pool.c
ldlm_reclaim.c
ldlm_request.c
ldlm_resource.c
